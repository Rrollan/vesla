<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #2a2a2a;
        color: #fff;
        min-height: 100vh;
        overflow-x: hidden;
    }

    body {
       user-select: none;
       -webkit-user-select: none;
       -moz-user-select: none;
       -ms-user-select: none;
    }

    .modal-body, .order-info, .user-details, .blocked-slot-info, .report-link, .user-name-phone, .order-id, .subtitle, p, h1, h2, h3, h4, label, li, a, span {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
    }
    
    input, textarea, select {
        user-select: auto;
        -webkit-user-select: auto;
        -moz-user-select: auto;
        -ms-user-select: auto;
    }


    .container {
        max-width: 420px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .welcome-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        text-align: center;
        animation: fadeIn 0.6s ease-out;
    }

    .logo-container {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #00b4d8, #ff6b35);
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 180, 216, 0.3);
        animation: pulse 2s infinite;
    }

    .logo-icon {
        font-size: 60px;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 30px;
    }


    h1 {
        font-size: 28px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #00b4d8, #ff6b35);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .subtitle {
        color: #999;
        font-size: 16px;
        margin-bottom: 40px;
        line-height: 1.5;
    }

    .btn-primary {
        background: linear-gradient(135deg, #00b4d8, #ff6b35);
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        width: 100%;
        margin-top: 20px;
    }
    
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-secondary {
        background: #4a4a4a;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        width: 100%;
    }

    .btn-secondary:hover {
        background: #5a5a5a;
    }

    .btn-small {
        padding: 10px 20px;
        font-size: 14px;
        margin: 5px;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger-icon {
        background: transparent;
        border: none;
        color: #dc3545;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s;
    }
    .btn-danger-icon:hover {
        color: #ff6b6b;
    }

    .btn-icon, .btn-icon-block, .btn-icon-unblock {
         background: transparent;
         border: none;
         font-size: 20px;
         cursor: pointer;
         padding: 5px;
         transition: color 0.2s, opacity 0.2s;
    }
    .btn-icon:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .btn-icon-block {
        color: #ffc107;
    }
    .btn-icon-block:hover:not(:disabled) {
        color: #ffdd7a;
    }
    .btn-icon-unblock {
        color: #28a745;
    }
    .btn-icon-unblock:hover:not(:disabled) {
        color: #34ce57;
    }


    .btn-danger:hover {
        background: #c82333;
    }

    .form-screen {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .form-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px 0;
    }

    .form-header h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        color: #ccc;
        font-size: 14px;
        font-weight: 500;
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    input[type="password"],
    select,
    textarea {
        width: 100%;
        padding: 15px;
        background: #3a3a3a;
        border: 2px solid #4a4a4a;
        border-radius: 12px;
        color: #fff;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #00b4d8;
        background: #404040;
    }

    .input-error {
        border-color: #dc3545 !important;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .btn-back {
        background: #4a4a4a;
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: #5a5a5a;
    }

    .dashboard {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .user-card {
        background: linear-gradient(135deg, #3a3a3a, #4a4a4a);
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .user-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(0, 180, 216, 0.1), transparent);
        transform: rotate(45deg);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% { transform: rotate(45deg) translateX(-100%); }
        100% { transform: rotate(45deg) translateX(100%); }
    }

    .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00b4d8, #ff6b35);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto 20px;
        position: relative;
        z-index: 1;
        padding: 0; 
        overflow: hidden; 
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover; 
    }

    .user-name {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }

    .user-level {
        display: inline-block;
        background: linear-gradient(135deg, #00b4d8, #ff6b35);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }

    .user-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
        position: relative;
        z-index: 1;
    }

    .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 12px;
        text-align: center;
    }

    .stat-number {
        font-size: 18px;
        font-weight: 600;
        color: #00b4d8;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }

    .dashboard-actions {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
    }

    .action-card {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #4a4a4a;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    .report-action-card {
        border-color: #ffc107;
    }
    
    .strikes-panel {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 14px;
    }


    .action-card:hover {
        border-color: #00b4d8;
        transform: translateY(-2px);
    }

    .action-icon {
        font-size: 24px;
        margin-bottom: 10px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    .action-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .action-desc {
        font-size: 14px;
        color: #999;
    }

    .crm-screen {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .crm-header {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
    }

    .crm-tabs, .schedule-city-tabs {
        display: flex;
        background: #3a3a3a;
        border-radius: 15px;
        margin-bottom: 20px;
        overflow-x: auto;
    }

    .crm-tab, .schedule-city-tab {
        flex: 1;
        padding: 15px 10px;
        background: transparent;
        border: none;
        color: #999;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
    }

    .crm-tab.active, .schedule-city-tab.active {
        background: #00b4d8;
        color: white;
    }

    .crm-tab:hover, .schedule-city-tab:hover {
        color: white;
    }
    
    .schedule-form {
        display: none;
    }
    
    .schedule-form.active {
        display: block;
    }


    .crm-content {
        display: none;
    }

    .crm-content.active {
        display: block;
    }

    .crm-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .crm-stat-card {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
    }

    .crm-stat-number {
        font-size: 24px;
        font-weight: 600;
        color: #00b4d8;
    }

    .crm-stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }

    .orders-list {
        background: #3a3a3a;
        border-radius: 15px;
        overflow: hidden;
    }

    .order-item {
        padding: 20px;
        border-bottom: 1px solid #4a4a4a;
        transition: background 0.3s ease;
        cursor: pointer;
    }

    .order-item:hover {
        background: #404040;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .order-id {
        font-weight: 600;
        color: #00b4d8;
    }

    .order-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-new { background: #ff6b35; color: white; }
    .status-confirmed { background: #00b4d8; color: white; }
    .status-delivered { background: #28a745; color: white; }
    .status-awaiting_review { background: #6f42c1; color: white; }
    .status-completed { background: #17a2b8; color: white; }
    .status-rejected { background: #6c757d; color: white; }


    .order-info {
        font-size: 14px;
        color: #ccc;
        line-height: 1.5;
    }
    .report-link {
        display: block;
        margin-top: 10px;
        color: #00b4d8;
        font-weight: bold;
        word-break: break-all;
    }

    .blocked-slots {
        margin-bottom: 20px;
    }

    .blocked-slot {
        background: #3a3a3a;
        border: 1px solid #4a4a4a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .blocked-slot-info {
        flex: 1;
    }

    .blocked-slot-city {
        font-weight: 600;
        color: #00b4d8;
    }

    .blocked-slot-time {
        color: #ccc;
        font-size: 14px;
    }

    .user-item {
        background: #3a3a3a;
        border: 1px solid #4a4a4a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer; 
        transition: background 0.3s ease;
    }
    .user-item.blocked {
        border-left: 4px solid #dc3545;
    }
    
    .user-item.hidden-item {
        opacity: 0.6;
        background: #333;
    }


    .user-item:hover {
        background: #404040;
    }

    .user-details {
        flex-grow: 1;
        display: flex;
        align-items: center;
    }


    .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .user-name-phone {
        font-weight: 600;
        color: #00b4d8;
    }
    
    .user-rating {
        font-size: 14px;
        font-weight: bold;
        color: #ffc107;
    }

    .user-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .user-admin-badge {
        font-size: 12px;
        color: #28a745;
        font-weight: bold;
        text-transform: capitalize;
    }
    
    .user-blocked-badge {
        font-size: 12px;
        color: #dc3545;
        font-weight: bold;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: #3a3a3a;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 350px;
        width: 90%;
        animation: fadeIn 0.3s ease-out;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        text-align: left;
    }
    .modal-header h2 {
        margin: 0;
    }
    .modal-body {
        text-align: left;
        font-size: 14px;
        color: #ccc;
        line-height: 1.6;
    }
    .modal-body strong {
        color: #fff;
    }
    
    .tags-container {
        margin-top: 10px;
        min-height: 30px;
    }
    .tag {
        display: inline-block;
        background-color: #00b4d8;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin: 2px;
    }
    .tag .remove-tag {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .input-with-button {
        display: flex;
        align-items: center;
        background: #3a3a3a;
        border: 2px solid #4a4a4a;
        border-radius: 12px;
        transition: border-color: 0.3s ease;
        margin-top: 15px;
    }
    .input-with-button:focus-within {
        border-color: #00b4d8;
    }
    .input-with-button input {
        flex-grow: 1;
        border: none;
        background: transparent;
        padding: 15px;
        color: #fff;
        font-size: 16px;
        outline: none;
    }
    .input-with-button button {
        background: #00b4d8;
        border: none;
        color: white;
        font-size: 24px;
        font-weight: bold;
        padding: 0 20px;
        height: 54px;
        border-radius: 0 10px 10px 0;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .input-with-button button:hover {
        background: #0099b8;
    }


    .success-icon {
        font-size: 60px;
        margin-bottom: 20px;
        color: #28a745;
    }

    .error-icon {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ff4444;
    }

    .warning-icon {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ffc107;
    }
    
    
    .file-upload {
        position: relative;
        display: inline-block;
        width: 100%;
        margin: 10px 0;
    }

    .file-upload input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-upload-label {
        display: block;
        padding: 15px;
        background: #3a3a3a;
        border: 2px dashed #4a4a4a;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload-label:hover {
        border-color: #00b4d8;
    }

    .warning-message {
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
    }
    .blocked-message {
         background: #dc3545;
         color: white;
         padding: 20px;
         border-radius: 15px;
         margin-bottom: 20px;
         text-align: left;
         line-height: 1.5;
    }


    .admin-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
    }

    .admin-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b35, #00b4d8);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .admin-btn:hover {
        transform: scale(1.1);
    }

    .set-selection {
        display: none;
    }

    .set-item {
        background: #3a3a3a;
        border: 2px solid #4a4a4a;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .set-item:hover {
        border-color: #00b4d8;
        transform: translateY(-2px);
    }

    .set-item.selected {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.1);
    }

    .set-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .set-description {
        color: #999;
        font-size: 14px;
        line-height: 1.4;
    }

    .datetime-selection {
        display: none;
    }

    .instructions {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
    }

    .checklist {
        list-style: none;
        margin: 15px 0;
    }

    .checklist li {
        padding: 8px 0;
        position: relative;
        padding-left: 30px;
    }

    .checklist li:before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #00b4d8;
        font-weight: bold;
    }

    .loading-indicator {
        color: #00b4d8;
        font-size: 14px;
        padding: 15px;
        text-align: center;
        background: rgba(0, 180, 216, 0.1);
        border-radius: 10px;
        margin: 20px 0;
    }
    
    .empty-state {
        color: #999;
        font-size: 14px;
        padding: 40px 20px;
        text-align: center;
        background: #3a3a3a;
        border-radius: 15px;
        margin: 20px 0;
    }

    .telegram-info {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        border-left: 4px solid #00b4d8;
    }

    .admin-contact {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
    }

    .contact-link {
        display: inline-block;
        background: #00b4d8;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        text-decoration: none;
        margin: 10px;
        transition: all 0.3s ease;
    }

    .contact-link:hover {
        background: #0099b8;
        transform: translateY(-2px);
    }

    .migration-info {
        background: #ff6b35;
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
    }
    
    /* --- –ù–û–í–´–ï/–ò–ó–ú–ï–ù–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–ï–ù–Æ --- */
    .menu-screen {
        padding-bottom: 150px; /* –£–≤–µ–ª–∏—á–µ–Ω–æ –º–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–π –ø–ª–∞—à–∫–∏ */
    }

    .menu-header-sticky {
        position: sticky;
        top: 0;
        background: #2a2a2a;
        padding-top: 5px;
        z-index: 100;
        margin: -20px -20px 0 -20px;
        padding: 0 20px 0 20px;
        display: flex;
        flex-direction: column;
    }
    
    .menu-top-bar {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-top: 15px;
    }

    .menu-top-bar .btn-back {
        margin-bottom: 0;
        margin-right: 10px;
        padding: 10px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .menu-info-bar {
       flex-grow: 1;
       text-align: left;
    }
    .menu-info-bar h2 {
        font-size: 20px;
        margin-bottom: 4px;
        text-align: left;
    }
    .menu-budget-display {
        background: #3a3a3a;
        border: 1px solid #4a4a4a;
        border-radius: 12px;
        padding: 6px 12px;
        display: inline-flex;
        align-items: center;
        font-size: 14px;
        font-weight: 500;
        color: #ffc107;
    }

    .menu-categories {
        display: flex;
        overflow-x: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
        padding-bottom: 15px;
    }
    .menu-categories::-webkit-scrollbar {
        display: none;
    }

    .menu-category-tab {
        padding: 8px 18px;
        cursor: pointer;
        white-space: nowrap;
        color: #999;
        transition: all 0.2s ease-in-out;
        border: 2px solid #4a4a4a;
        background: #3a3a3a;
        font-size: 14px;
        font-weight: 600;
        border-radius: 20px;
        text-decoration: none;
        margin-right: 10px;
    }

    .menu-category-tab.active {
        color: white;
        background: #00b4d8;
        border-color: #00b4d8;
    }

    .menu-section {
        margin-bottom: 30px;
        padding-top: 10px;
    }

    .menu-category-title {
        font-size: 22px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #4a4a4a;
    }
    .menu-subcategory-title {
        font-size: 18px;
        color: #ccc;
        margin-top: 20px;
        margin-bottom: 15px;
    }

    .menu-items-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .menu-item-card {
        background: #3a3a3a;
        border-radius: 15px;
        overflow: hidden;
        display: flex;
        border: 1px solid #4a4a4a;
    }

    .menu-item-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        flex-shrink: 0;
        border-radius: 14px 0 0 14px;
    }

    .menu-item-info {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        height: 120px;
    }
    
    .menu-item-content-wrapper {
        flex-grow: 1;
    }

    .menu-item-name {
        font-weight: 600;
        font-size: 16px;
        line-height: 1.3;
        margin-bottom: 5px;
    }
    
    .menu-item-desc {
        font-size: 12px;
        color: #999;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .menu-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }

    .menu-item-price {
        font-weight: bold;
        font-size: 18px;
        color: #fff;
        display: flex;
        align-items: center;
    }

    .menu-item-controls {
        display: flex;
        align-items: center;
        background: #4a4a4a;
        border-radius: 20px;
    }

    .quantity-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 24px;
        font-weight: 400;
        cursor: pointer;
        padding: 4px 14px;
    }

    .item-quantity {
        padding: 0 5px;
        font-size: 16px;
        font-weight: 500;
        min-width: 20px;
        text-align: center;
    }

    .cart-fab {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(42, 42, 42, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 15px 20px 20px 20px;
        z-index: 998;
        border-top: 1px solid #4a4a4a;
    }

    .cart-fab-content {
        max-width: 380px;
        margin: 0 auto;
    }
    .cart-fab-content button {
        margin-top: 15px;
    }

    .cart-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #ccc;
    }
    .cart-summary-value {
        font-weight: 600;
        font-size: 16px;
        color: #fff;
        display: flex;
        align-items: center;
    }

    .cart-progress-bar-container {
        height: 6px;
        background-color: #4a4a4a;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 8px;
    }
    .cart-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #00b4d8, #0099b8);
        border-radius: 3px;
        transition: width 0.3s ease-out;
    }
    .cart-progress-bar.overdraft {
        background: linear-gradient(90deg, #ff6b35, #dc3545);
    }
    
    .v-bonus-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #ffdd7a, #ffc107);
        border-radius: 50%;
        color: #4a2b00;
        font-weight: bold;
        font-size: 13px;
        margin-left: 4px;
        vertical-align: -3px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */

    @media (max-width: 380px) {
        .container {
            padding: 15px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .btn-primary {
            padding: 15px 30px;
            font-size: 16px;
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #2a2a2a;
    }

    ::-webkit-scrollbar-thumb {
        background: #4a4a4a;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #5a5a5a;
    }

    .form-row {
        display: flex;
        gap: 15px;
    }

    .form-row .form-group {
        flex: 1;
    }

     .search-container {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
    }
    .search-container .search-input {
        margin-bottom: 0;
        flex-grow: 1;
    }
    .search-container .btn-secondary {
        margin-top: 0;
        width: auto;
        flex-shrink: 0;
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 8px;
    }

    .search-input {
        width: 100%;
        background: #3a3a3a;
        border: 1px solid #4a4a4a;
        border-radius: 8px;
        padding: 10px;
        color: #fff;
        margin-bottom: 15px;
    }

    .search-input:focus {
        border-color: #00b4d8;
        outline: none;
    }
    
    .analytics-filters {
        background: #3a3a3a;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .analytics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    .chart-container {
        background: #3a3a3a;
        padding: 20px 15px;
        border-radius: 15px;
        height: 300px;
        display: flex;
        flex-direction: column;
    }
    .chart-container h3 {
        text-align: center;
        margin-bottom: 15px;
        color: #ccc;
        font-size: 16px;
        font-weight: 500;
    }
    .chart-container canvas {
        max-height: 220px;
    }
    
    .tag-suggestions-container {
        max-height: 150px;
        overflow-y: auto;
        background: #404040;
        border: 1px solid #4a4a4a;
        border-radius: 8px;
        margin-top: 5px;
        display: none;
        position: absolute;
        width: calc(100% - 40px);
        z-index: 1001;
    }
    .tag-suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .tag-suggestion-item:hover {
        background: #5a5a5a;
    }
    .tag-suggestion-item .user-count {
        color: #999;
        font-size: 12px;
        background: #333;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .placeholder-tag {
        cursor: pointer;
        background: #4a4a4a;
        padding: 2px 6px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .placeholder-tag:hover {
        background: #5a5a5a;
    }

</style>
</head>
<body>
    <div class="container">
        <!-- –≠–ö–†–ê–ù: –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ -->
        <div id="criticalErrorScreen" class="welcome-screen" style="display: none;">
            <div class="logo-container" style="background: #dc3545;">
                <div class="logo-icon" style="font-size: 50px;">üîå</div>
            </div>
            <h1>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h1>
            <p class="subtitle" id="criticalErrorMessage">–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å Telegram.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
            <button class="btn-primary" onclick="window.location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <!-- –≠–ö–†–ê–ù: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="logo.png" alt="logo">
                </div>
            </div>
            <h1>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</h1>
            <p class="subtitle">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ<br>–¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ –∏ –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä–æ–≤</p>
            <div class="welcome-buttons">
                 <button class="btn-primary" onclick="app.showRegistration()">–ù–∞—á–∞—Ç—å</button>
                 <button class="btn-secondary" onclick="app.showLogin()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
            <div class="auto-login-info" id="autoLoginInfo" style="display: none;">
                <div class="loading-indicator">
                    üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram...
                </div>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù: –í—Ö–æ–¥ -->
        <div id="loginScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <p class="subtitle">–î–ª—è —Å—Ç–∞—Ä—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –ø–∞—Ä–æ–ª–µ–º</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="loginPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="loginInstagram">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="loginInstagram" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="loginPassword" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitLogin(this)">–í–æ–π—Ç–∏</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
            <div class="telegram-info">
                <h4 style="color: #00b4d8; margin-bottom: 10px;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</h4>
                <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                    –ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. 
                    –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–æ–ª—å.
                </p>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="registrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</p>
            </div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">–ò–º—è *</label>
                    <input type="text" id="firstName" required placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="instagramLogin">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="instagramLogin" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="followersCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ *</label>
                    <input type="number" id="followersCount" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" min="1" max="10000000">
                </div>
                <div class="form-group">
                    <label for="avgViews">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å *</label>
                    <input type="number" id="avgViews" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" min="1" max="10000000">
                </div>
                 <div class="form-group">
                    <label for="regPassword">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="regPassword" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitRegistration(this)">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <!-- –≠–ö–†–ê–ù: –ú–∏–≥—Ä–∞—Ü–∏—è (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è) -->
        <div id="migrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è</h2>
                <p class="subtitle">–î–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</p>
            </div>
            <div class="migration-info">
                <p>–ú—ã –Ω–∞—à–ª–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø–∞—Ä–æ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
            </div>
            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPassword" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                <div class="form-group">
                    <label for="migrationPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitMigration(this)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <!-- –≠–ö–†–ê–ù: –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
        <div id="dashboardScreen" class="dashboard" style="display: none;">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-name" id="userName"></div>
                <div id="userLevel" class="user-level"></div>
                <div class="user-stats">
                    <div class="stat-item" id="vcoinStatItem" style="display: none;">
                        <div class="stat-number" id="vcoinBalanceDisplay">0</div>
                        <div class="stat-label">V-–ë–æ–Ω—É—Å—ã</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="followersDisplay">0</div>
                        <div class="stat-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="viewsDisplay">0</div>
                        <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                    </div>
                </div>
            </div>
             <div id="blockedPanel" class="blocked-message" style="display: none;"></div>
             <div id="strikesPanel" class="strikes-panel" style="display: none;"></div>
             <div id="statusPanel" class="action-card" style="display: none; border-color: #00b4d8; text-align: left;"></div>
             <div id="cooldownPanel" class="action-card" style="display: none; background: #4a4a4a; border-color: #5a5a5a; text-align: center; cursor: default;"></div>
             <div id="loyaltyPanel" class="action-card" style="display: none; border-color: #ffc107; text-align: center; cursor: default;"></div>
             <div id="reportActionsPanel" class="dashboard-actions" style="margin-top: 20px;"></div>
            <div class="dashboard-actions">
                <div id="newCollaborationBtn" class="action-card" onclick="app.startCollaboration()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                    </div>
                    <div class="action-title">–ù–æ–≤–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</div>
                    <div class="action-desc">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –±–∞—Ä—Ç–µ—Ä</div>
                </div>
                <div class="action-card" onclick="app.showOrderHistory()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    </div>
                    <div class="action-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="action-desc">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–∫–∞–∑—ã</div>
                </div>
                <div class="action-card" onclick="app.editProfile()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </div>
                    <div class="action-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="action-desc">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                </div>
                <div class="action-card" onclick="app.contactAdmin()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <div class="action-title">–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</div>
                    <div class="action-desc">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å</div>
                </div>
            </div>
            <button class="btn-secondary" onclick="app.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>

        <!-- –≠–ö–†–ê–ù: CRM -->
        <div id="crmScreen" class="crm-screen" style="display: none;">
            <div class="crm-header">
                <h2>üîß –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <button class="btn-back" onclick="app.showDashboard()">‚Üê –í –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
            </div>
            <div class="crm-tabs">
                <button class="crm-tab active" data-tab="overview" onclick="app.showCrmTab('overview', this)">–û–±–∑–æ—Ä</button>
                <button class="crm-tab" data-tab="analytics" onclick="app.showCrmTab('analytics', this)">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                <button class="crm-tab" data-tab="orders" onclick="app.showCrmTab('orders', this)">–ó–∞–∫–∞–∑—ã</button>
                <button class="crm-tab" data-tab="users" onclick="app.showCrmTab('users', this)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="crm-tab" data-tab="schedule" onclick="app.showCrmTab('schedule', this)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                <button class="crm-tab" data-tab="blocks" onclick="app.showCrmTab('blocks', this)">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</button>
                <button class="crm-tab" data-tab="broadcast" onclick="app.showCrmTab('broadcast', this)">–†–∞—Å—Å—ã–ª–∫–∞</button>
                <button class="crm-tab" data-tab="menu" onclick="app.showCrmTab('menu', this)">–ú–µ–Ω—é</button>
                <button class="crm-tab" data-tab="admins" onclick="app.showCrmTab('admins', this)">–ê–¥–º–∏–Ω—ã</button>
            </div>
            <div id="crmOverview" class="crm-content active">
                <div class="crm-stats">
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalUsers">0</div>
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalOrders">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="newOrders">0</div>
                        <div class="stat-label">–ù–æ–≤—ã–µ</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="blockedSlots">0</div>
                        <div class="stat-label">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                    </div>
                </div>
                <div class="admin-contact">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <a href="https://t.me/oderefyu" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                </div>
                <div style="background: #3a3a3a; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cooldownSetting">–ü–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏ (–≤ –¥–Ω—è—Ö, –¥–ª—è –º–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä–æ–≤)</label>
                        <input type="number" id="cooldownSetting" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7">
                        <button class="btn-primary" onclick="app.saveSettings(this)" style="margin-top: 15px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
                    </div>
                </div>
            </div>
            <div id="crmAnalytics" class="crm-content">
                 <div class="analytics-filters">
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥:</label>
                        <div class="form-row">
                            <input type="date" id="analyticsStartDate">
                            <input type="date" id="analyticsEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="analyticsCity">–ì–æ—Ä–æ–¥:</label>
                        <select id="analyticsCity" onchange="app.applyAnalyticsFilters()">
                            <option value="all">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                            <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                            <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="app.applyAnalyticsFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h3>
                        <canvas id="ordersTrendChart"></canvas>
                    </div>
                    <div class="chart-container" id="cityChartContainer">
                        <h3>–ó–∞–∫–∞–∑—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º</h3>
                        <canvas id="cityChart"></canvas>
                    </div>
                     <div class="chart-container">
                        <h3>–£—Ä–æ–≤–Ω–∏ –±–ª–æ–≥–µ—Ä–æ–≤</h3>
                        <canvas id="bloggerLevelChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</h3>
                        <canvas id="followersDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="crmOrders" class="crm-content">
                <div class="search-container">
                    <input type="text" id="orderSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, Instagram –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞..." onkeyup="app.filterOrders()">
                    <button id="exportOrdersBtn" class="btn-secondary" onclick="app.exportOrdersToExcel(this)">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </div>
                <div class="orders-list" id="ordersList"></div>
            </div>
            <div id="crmUsers" class="crm-content">
                <div class="search-container">
                    <input type="text" id="userSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." onkeyup="app.filterUsers()">
                    <button id="exportUsersBtn" class="btn-secondary" onclick="app.exportUsersToExcel(this)">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </div>
                <div id="usersList"></div>
            </div>
             <div id="crmSchedule" class="crm-content">
                 <div class="form-header">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h2>
                    <p class="subtitle">–£–∫–∞–∂–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Å—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "10:00-14:00" –∏–ª–∏ "10:00-12:00, 14:00-18:00".<br>–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º.</p>
                </div>
                <div id="scheduleCityTabs" class="schedule-city-tabs"></div>
                <div id="scheduleFormsContainer"></div>
                <button class="btn-primary" onclick="app.saveSchedule(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            </div>
            <div id="crmBlocks" class="crm-content">
                <button class="btn-primary" onclick="app.showAddBlockModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</button>
                <div id="blockedSlotsList"></div>
            </div>
             <div id="crmBroadcast" class="crm-content">
                <div class="form-header">
                    <h2>–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h2>
                    <p class="subtitle">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</p>
                </div>
                <div class="form-group">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º (—Ä–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∏–º–µ—é—â–∏–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤)</label>
                    <div id="broadcastTagsContainer" class="tags-container" style="min-height: 40px; background: #3a3a3a; padding: 5px; border-radius: 12px; border: 2px solid #4a4a4a;">
                    </div>
                    <div style="position: relative;">
                         <input type="text" id="broadcastTagInput" placeholder="–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–≥ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..." style="margin-top: 10px;">
                         <div id="tagSuggestions" class="tag-suggestions-container"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                    <textarea id="broadcastMessage" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..."></textarea>
                </div>
                <div class="telegram-info" style="margin-top: -10px; margin-bottom: 20px; font-size: 13px; padding: 15px; border-left-color: #ffc107;">
                    <h4 style="color: #00b4d8; margin-bottom: 10px;">‚ú® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)</h4>
                    <p style="color: #ccc; line-height: 1.8;">
                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                        <br><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã:</strong><br>
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{firstName}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{instagramLogin}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{followersCount}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{level}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{rating}</code>
                    </p>
                </div>
                <button class="btn-primary" onclick="app.sendBroadcast(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
                <div class="telegram-info" style="margin-top: 20px;">
                     <h4 style="color: #ffc107; margin-bottom: 10px;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</h4>
                     <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                         –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏. –û—Ç—á–µ—Ç –ø—Ä–∏–¥–µ—Ç –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
                     </p>
                </div>
            </div>
            <div id="crmAdmins" class="crm-content">
                <button class="btn-primary" onclick="app.showAddAdminModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
                <div id="adminsList"></div>
            </div>
            <div id="crmMenu" class="crm-content">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-primary" onclick="app.showMenuItemModal()" style="flex: 1;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
                    <input type="file" id="menuFileInput" onchange="app.handleMenuFileSelect(event)" accept=".xlsx, .xls" style="display: none;" />
                    <button id="importMenuBtn" class="btn-secondary" onclick="app.triggerMenuImport()" style="flex: 1;">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>
                </div>
                <div class="search-container" style="margin-bottom: 20px;">
                    <input type="text" id="menuSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –±–ª—é–¥–∞..." onkeyup="app.filterMenuItems()">
                </div>
                <div id="menuItemsListCrm"></div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù–´ –ü—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞ -->
        <div id="setSelectionScreen" class="form-screen set-selection" style="display: none;">
            <button class="btn-back" onclick="app.showDashboard()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–±–æ—Ä</h2>
            </div>
            <div class="set-item" data-set-name="–°–µ—Ç 1" onclick="app.selectSet(this, 'set1')">
                <div class="set-title">–°–µ—Ç 1</div>
                <div class="set-description">–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è —Å –æ–≥—É—Ä—Ü–æ–º, –ì–µ–π—à–∞, –õ–æ—Å–æ—Å—å —Å —á—É–∫–æ–π –∏ –º–∏–Ω–¥–∞–ª—ë–º</div>
            </div>
            <div class="set-item" data-set-name="–°–µ—Ç 2" onclick="app.selectSet(this, 'set2')">
                <div class="set-title">–°–µ—Ç 2</div>
                <div class="set-description">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –§–∏–ª–∞, –ó–∞–ø–µ—á—ë–Ω–Ω—ã–π —Å –∫—Ä–µ–≤–µ—Ç–∫–æ–π, –°—ç–Ω–¥–≤–∏—á —Å –∫—É—Ä–∏—Ü–µ–π</div>
            </div>
            <button type="button" id="nextFromSet" class="btn-primary" onclick="app.proceedToAddressFromSet()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="addressScreen" class="form-screen" style="display: none;">
            <button class="btn-back" id="backFromAddress" onclick="app.showDashboard()">‚Üê –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            <div class="form-header">
                <h2>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
            </div>
            <form id="addressForm">
                <div class="form-group">
                    <label for="city">–ì–æ—Ä–æ–¥ *</label>
                    <select id="city" required onchange="app.handleCityChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                        <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                        <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                        <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                        <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                        <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="street">–£–ª–∏—Ü–∞, –¥–æ–º *</label>
                    <input type="text" id="street" required placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10">
                </div>
                <div class="form-group">
                    <label for="entrance">–ü–æ–¥—ä–µ–∑–¥</label>
                    <input type="text" id="entrance" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="floor">–≠—Ç–∞–∂</label>
                    <input type="text" id="floor" placeholder="5">
                </div>
                <div class="form-group">
                    <label for="recipientPhone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</label>
                    <input type="tel" id="recipientPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="comment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"></textarea>
                </div>
                <button type="button" class="btn-primary" onclick="app.submitAddressAndShowDateTime()">–î–∞–ª–µ–µ</button>
            </form>
        </div>

        <div id="menuSelectionScreen" class="form-screen menu-screen" style="display: none;">
            <div class="menu-header-sticky">
                <div class="menu-top-bar">
                    <button class="btn-back" onclick="app.showAddressForm()">‚Üê</button>
                    <div class="menu-info-bar">
                        <h2>–°–æ–±–µ—Ä–∏—Ç–µ –≤–∞—à –∑–∞–∫–∞–∑</h2>
                        <div id="menuBudgetDisplay" class="menu-budget-display">–í–∞—à –±—é–¥–∂–µ—Ç: 0</div>
                    </div>
                </div>
                <div id="menu-categories" class="menu-categories"></div>
            </div>
            <div id="menu-items-container"></div>
            <div id="cart-fab" class="cart-fab" style="display: none;">
                <div class="cart-fab-content">
                    <div class="cart-summary">
                        <span class="cart-summary-label">–ò—Ç–æ–≥–æ / –ë—é–¥–∂–µ—Ç</span>
                        <span id="cart-summary-value" class="cart-summary-value"></span>
                    </div>
                    <div class="cart-progress-bar-container">
                        <div id="cart-progress-bar" class="cart-progress-bar"></div>
                    </div>
                    <button class="btn-primary" onclick="app.checkBalanceAndProceed()">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        </div>

        <div id="dateTimeScreen" class="form-screen datetime-selection" style="display: none;">
            <button class="btn-back" id="backFromDateTime">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
                <h4 id="todaysDateHeader" style="color: #ccc; font-weight: 400; margin-top: -15px;"></h4>
            </div>
            <div class="form-group">
                <label for="deliveryTime">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</label>
                <input type="time" id="deliveryTime" required onchange="app.validateTimeSelection()">
                <div id="timeSelectionInfo" class="telegram-info" style="font-size: 14px; padding: 15px; margin-top: 15px; display: none;"></div>
            </div>
            <button type="button" id="nextFromDateTime" class="btn-primary" onclick="app.showInstructions()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="instructionsScreen" class="form-screen" style="display: none;">
            <button class="btn-back" onclick="app.showDateTimeSelection()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å—Ç–æ—Ä–∏—Å</h2>
            </div>
            <div class="instructions">
                <h3>–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏—Å:</h3>
                <ul class="checklist">
                    <li>–£–ø–æ–º—è–Ω—É—Ç—å –±—Ä–µ–Ω–¥ –≤ —Å—Ç–æ—Ä–∏—Å</li>
                    <li>–û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—à Instagram @vesla.kz</li>
                    <li>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É –∏ –µ–¥—É</li>
                    <li>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</li>
                </ul>
                <div style="margin-top: 20px;">
                    <strong>–ü—Ä–∏–º–µ—Ä —Ç–µ–∑–∏—Å–∞:</strong><br>
                    <em>"–Ø –∑–∞–∫–∞–∑–∞–ª–∞ —É @vesla.kz ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–æ—Å–º–æ—Å! –û—á–µ–Ω—å –≤–∫—É—Å–Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ!"</em>
                </div>
            </div>
            <div class="warning-message" id="warningMessage">
                ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–Ω–∏—Ç–µ: 3 –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞ ‚Äî –∏ –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ú—ã —É–≤–µ—Ä–µ–Ω—ã, –¥–æ —ç—Ç–æ–≥–æ –Ω–µ –¥–æ–π–¥–µ—Ç! üòä
            </div>
            <button type="button" class="btn-primary" onclick="app.submitOrder(this)">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div id="successModal" class="modal">
            <div class="modal-content">
                <div class="success-icon">‚úÖ</div>
                <h2 id="successTitle">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>
                <p class="subtitle" id="successMessage">–ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤–∞–º –ø—Ä–∏–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ—Ç—á–µ—Ç–µ</p>
                <button id="successModalCloseBtn" class="btn-primary" onclick="app.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="errorModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">‚ùå</div>
                <h2 id="errorTitle">–û—à–∏–±–∫–∞</h2>
                <p class="subtitle" id="errorMessage"></p>
                <button class="btn-primary" onclick="app.closeErrorModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
        <div id="overdraftModal" class="modal">
            <div class="modal-content">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h2 id="overdraftTitle">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–ª–∞—Ç–∞</h2>
                <p class="subtitle" id="overdraftMessage" style="text-align: left; line-height: 1.6;"></p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" onclick="app.proceedToDateTimeSelection()" style="flex: 1;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('overdraftModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        <div id="rejectionModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">üòî</div>
                <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å!</h2>
                <p class="subtitle">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π –æ—Ç 300 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞—à–∏–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å–∫–æ—Ä–æ —ç—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è!</p>
                <button class="btn-primary" onclick="app.closeRejectionModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
        <div id="orderHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
                <div id="orderHistoryList" style="text-align: left; max-height: 40vh; overflow-y: auto; margin: 20px 0;"></div>
                <button class="btn-primary" onclick="app.closeOrderHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="orderDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="orderDetailTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
                     <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="markReportAcceptedBtn" class="btn-icon btn-icon-unblock" title="–û—Ç—á–µ—Ç —Å–¥–∞–Ω –∏ –ø—Ä–∏–Ω—è—Ç">‚úîÔ∏è</button>
                        <button id="markNoReportBtn" class="btn-icon btn-icon-block" title="–û—Ç—á–µ—Ç –Ω–µ —Å–¥–∞–Ω">üö©</button>
                        <button class="btn-danger-icon" id="deleteOrderBtn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑">üóëÔ∏è</button>
                     </div>
                </div>
                <div id="orderDetailBody" class="modal-body"></div>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label for="orderStatusSelect">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <select id="orderStatusSelect" style="width: 100%;">
                         <option value="new">–ù–æ–≤—ã–π</option>
                         <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                         <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                         <option value="awaiting_review">–û—Ç—á–µ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                         <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                         <option value="rejected">–û—Ç—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="app.updateOrderStatus(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn-secondary" onclick="app.closeOrderDetailModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="userDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="userDetailTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                </div>
                <div id="userDetailBody" class="modal-body"></div>
                <hr style="border-color: #4a4a4a; margin: 20px 0;">
                <div style="text-align: left;">
                    <label>–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏:</label>
                    <div id="userTagsContainer" class="tags-container"></div>
                    <div class="form-group">
                        <label for="newTagInput" style="margin-top: 15px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥ –≤—Ä—É—á–Ω—É—é</label>
                        <div class="input-with-button">
                            <input type="text" id="newTagInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞">
                            <button onclick="app.addUserTag()">+</button>
                        </div>
                    </div>
                </div>
                
                <hr style="border-color: #4a4a4a; margin: 20px 0;">
                <div id="vcoinManagementBlock" style="text-align: left; display: none;">
                    <label for="vcoinManageAmount">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ V-–ë–æ–Ω—É—Å–∞–º–∏</label>
                    <div class="form-row" style="align-items: center; margin-top: 8px; gap: 8px;">
                        <input type="number" id="vcoinManageAmount" placeholder="–°—É–º–º–∞" style="flex-grow: 1; margin: 0;">
                        <button class="btn-primary btn-small" onclick="app.manageVcoins('add')" style="margin: 0; flex-shrink: 0;">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                        <button class="btn-danger btn-small" onclick="app.manageVcoins('remove')" style="margin: 0; flex-shrink: 0;">–°–ø–∏—Å–∞—Ç—å</button>
                    </div>
                </div>
                
                <button class="btn-secondary" id="resetCooldownBtn" onclick="app.resetOrderCooldown()" style="margin-top: 20px; display: none;">–°–±—Ä–æ—Å–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</button>
                <button class="btn-secondary" onclick="app.closeUserDetailModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <h2 id="reportModalTitle">–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç</h2>
                <p class="subtitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–æ—Ä–∏—Å –∏–ª–∏ –ø–æ—Å—Ç</p>
                <div class="form-group" style="text-align: left;">
                    <label for="reportLink">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç *</label>
                    <input type="text" id="reportLink" placeholder="https://instagram.com/stories/...">
                </div>
                <button class="btn-primary" onclick="app.submitReport(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" onclick="app.closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div id="editProfileModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <form id="editProfileForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="editFirstName">–ò–º—è *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editInstagram">Instagram *</label>
                        <input type="text" id="editInstagram" required>
                    </div>
                    <div class="form-group">
                        <label for="editFollowers">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ *</label>
                        <input type="number" id="editFollowers" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editViews">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã *</label>
                        <input type="number" id="editViews" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ)</label>
                        <input type="password" id="editPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label for="editVcoinAllowance">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç V-–ë–æ–Ω—É—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)</label>
                        <input type="number" id="editVcoinAllowance" min="0">
                    </div>
                </form>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="app.saveProfile(this)" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeEditProfile()" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="addBlockModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</h2>
                <form id="addBlockForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="blockCity">–ì–æ—Ä–æ–¥ *</label>
                        <select id="blockCity" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                            <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                            <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockDate">–î–∞—Ç–∞ *</label>
                        <input type="date" id="blockDate" required>
                    </div>
                    <div class="form-group">
                        <label for="blockType">–¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ *</label>
                        <select id="blockType" required onchange="app.toggleBlockTime()">
                            <option value="range">–î–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏</option>
                            <option value="fullday">–í–µ—Å—å –¥–µ–Ω—å</option>
                        </select>
                    </div>
                    <div id="blockTimeGroup">
                        <div class="form-row">
                             <div class="form-group">
                                <label for="blockStartTime">–° *</label>
                                <input type="time" id="blockStartTime">
                             </div>
                             <div class="form-group">
                                <label for="blockEndTime">–î–æ *</label>
                                <input type="time" id="blockEndTime">
                             </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="blockReason">–ü—Ä–∏—á–∏–Ω–∞</label>
                        <input type="text" id="blockReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                </form>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="app.addBlock(this)" style="flex: 1;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeAddBlockModal()" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="addAdminModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <div class="form-group" style="text-align: left;">
                    <label for="adminRoleSelect">–†–æ–ª—å</label>
                    <select id="adminRoleSelect">
                        <option value="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <input type="text" id="adminUserSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è..." onkeyup="app.filterAdminUsers()">
                <div id="adminUsersList" style="text-align: left; max-height: 40vh; overflow-y: auto;"></div>
                <button class="btn-secondary" onclick="app.closeAddAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="contactModal" class="modal">
            <div class="modal-content">
                <h2>–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h2>
                <p class="subtitle">–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram</p>
                <a href="https://t.me/oderefyu" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                <button class="btn-secondary" onclick="app.closeContactModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="menuItemModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2 id="menuItemModalTitle">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h2>
                <form id="menuItemForm" style="margin: 20px 0; text-align: left;">
                    <input type="hidden" id="menuItemEditId">
                    <input type="hidden" id="menuItemOldImageUrl">
                    <div class="form-group">
                        <label for="menuItemName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="menuItemName" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="menuItemDesc" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="menuItemPrice">–¶–µ–Ω–∞ (–≤ —Ç–µ–Ω–≥–µ)</label>
                        <input type="number" id="menuItemPrice" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="menuItemCategory" required>
                            <option value="–°–µ—Ç—ã">–°–µ—Ç—ã</option>
                            <option value="–†–æ–ª–ª—ã">–†–æ–ª–ª—ã</option>
                            <option value="–ü–∏—Ü—Ü–∞">–ü–∏—Ü—Ü–∞</option>
                            <option value="–í–û–ö / –¢–û–ú-–Ø–ú">–í–û–ö / –¢–û–ú-–Ø–ú</option>
                            <option value="–ó–∞–∫—É—Å–∫–∏">–ó–∞–∫—É—Å–∫–∏</option>
                            <option value="–ù–∞–ø–∏—Ç–∫–∏">–ù–∞–ø–∏—Ç–∫–∏</option>
                            <option value="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label for="menuItemSubcategory">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ä–æ–ª–ª–æ–≤)</label>
                         <input type="text" id="menuItemSubcategory" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è, –ó–∞–ø–µ—á—ë–Ω–Ω—ã–µ">
                     </div>
                     <div class="form-group">
                        <label for="menuItemImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–±—É–¥–µ—Ç –æ–±—Ä–µ–∑–∞–Ω–æ –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞)</label>
                        <input type="file" id="menuItemImage" accept="image/*">
                    </div>
                </form>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="app.saveMenuItem(this)" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('menuItemModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
    </div>

    <div class="admin-panel" id="adminPanel" style="display: none;">
        <button class="admin-btn" onclick="app.showCRM()" title="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">‚öôÔ∏è</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
   <script>
    const app = (function() {

        const BACKEND_URL = 'https://vesla.onrender.com';
        
        const firebaseConfig = {
            apiKey: "AIzaSyATmIapS6SJi7KnvKrJp5sfD9VMXxKMCgA",
            authDomain: "vesla-barter.firebaseapp.com",
            projectId: "vesla-barter",
            storageBucket: "vesla-barter.appspot.com",
            messagingSenderId: "730193371508",
            appId: "1:730193371508:web:a6517d156f2766ece50c21",
            measurementId: "G-1QJ9RRS1L6"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const COLLECTIONS = {
            USERS: 'users',
            ORDERS: 'orders',
            ADMINS: 'admins',
            BLOCKED_SLOTS: 'blockedSlots',
            SCHEDULES: 'schedules',
            SETTINGS: 'settings',
            MENU: 'menu'
        };
        const SCREENS = {
            WELCOME: 'welcomeScreen',
            REGISTRATION: 'registrationScreen',
            LOGIN: 'loginScreen',
            MIGRATION: 'migrationScreen',
            DASHBOARD: 'dashboardScreen',
            CRM: 'crmScreen',
            SET_SELECTION: 'setSelectionScreen',
            ADDRESS: 'addressScreen',
            MENU_SELECTION: 'menuSelectionScreen',
            DATE_TIME: 'dateTimeScreen',
            INSTRUCTIONS: 'instructionsScreen',
            CRITICAL_ERROR: 'criticalErrorScreen'
        };

        let tg;
        let telegramUser = null;
        let currentUserId = null;
        let userData = {};
        let migrationUser = null;
        let currentOrderData = {};
        let currentUserRole = null;
        let cityChart, ordersTrendChart, bloggerLevelChart, followersDistributionChart;
        let currentEditingOrderId = null;
        let currentReportingOrderId = null;
        let currentUserDetailId = null;
        let userListenerUnsubscribe = null;
        let menuObserver = null;
        let appSettings = { orderCooldownDays: 7 };
        let cart = {};
        const LOYALTY_THRESHOLD = 5;
        const VCOIN_RATE = 10;
        
        const CITIES = ["–ü–∞–≤–ª–æ–¥–∞—Ä", "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫", "–ö–æ–∫—à–µ—Ç–∞—É", "–ö–æ—Å—Ç–∞–Ω–∞–π", "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫"];

        function showCriticalError(message) {
            document.getElementById('criticalErrorMessage').innerHTML = message;
            document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen').forEach(s => s.style.display = 'none');
            document.getElementById(SCREENS.CRITICAL_ERROR).style.display = 'flex';
        }
        
        async function apiFetch(endpoint, options = {}) {
            if (!tg || !tg.initData) {
                 showCriticalError("–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                 throw new Error("Telegram initData is missing.");
            }

            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${tg.initData}`
            };
            
            if (options.body instanceof FormData) {
                delete defaultHeaders['Content-Type'];
            }

            const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers,
                },
            });

            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.error || `–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ${response.status}`);
            }

            if (response.status === 204) return;
            return response.json();
        }

        function ensureAuthenticated() {
            if (!currentUserId || !telegramUser) {
                console.error("Authentication lost. Reloading...");
                window.location.reload();
                return false;
            }
            return true;
        }

        async function generateOrderNumber(city) {
            const cityCodes = {'–ü–∞–≤–ª–æ–¥–∞—Ä':'PVL', '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫':'PPK', '–ö–æ–∫—à–µ—Ç–∞—É':'KOK', '–ö–æ—Å—Ç–∞–Ω–∞–π':'KSN', '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫':'UKK'};
            const cityCode = cityCodes[city] || 'UNK';
            
            const counterRef = db.collection(COLLECTIONS.SETTINGS).doc('orderCounter');
            
            const newOrderNumber = await db.runTransaction(async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                let nextNumber;
                if (!counterDoc.exists) {
                    nextNumber = 101;
                } else {
                    const current = counterDoc.data().currentNumber || 100;
                    nextNumber = current + 1;
                }
                transaction.set(counterRef, { currentNumber: nextNumber }, { merge: true });
                return nextNumber;
            });

            return `${cityCode}-${newOrderNumber}`;
        }
        
		function initTelegram() {
			try {
				if (window.Telegram && window.Telegram.WebApp) {
					tg = window.Telegram.WebApp;
					tg.ready();
					tg.expand();
					if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
						telegramUser = tg.initDataUnsafe.user;
						currentUserId = 'tg_' + telegramUser.id;
						return true;
					}
				}
			} catch (error) {
				console.error('Error initializing Telegram:', error);
			}
			return false;
		}
        
        function attachUserListener(userId) {
            if (userListenerUnsubscribe) userListenerUnsubscribe();
            userListenerUnsubscribe = db.collection(COLLECTIONS.USERS).doc(userId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        userData = { userId: doc.id, ...doc.data() };
                        updateDashboard();
                    } else {
                        logout();
                    }
                }, (error) => {
                    console.error("Error with real-time listener: ", error);
                });
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash &= hash;
            }
            return hash.toString();
        }
        
        function validatePassword(password) { return password && password.length >= 6; }

        async function getUserRole(userId) {
            if (!userId) return null;
            const checkId = String(userId).replace('tg_','');
            try {
                const adminDoc = await db.collection(COLLECTIONS.ADMINS).doc(checkId).get();
                return adminDoc.exists ? adminDoc.data().role : null;
            } catch (error) {
                console.error("Error checking admin status:", error);
                return null;
            }
        }
        
        async function checkAndSetUserRole() {
            const checkId = telegramUser ? telegramUser.id : (userData.telegramId || null);
            currentUserRole = await getUserRole(checkId);
        }

        function migrateOldAccount(userInfo) {
            if (userInfo && userInfo.registration && !userInfo.registration.password) {
                migrationUser = userInfo;
                return true; 
            }
            return false;
        }

       async function saveUser(userId, data) {
            if (!userId) throw new Error("User ID is missing");
            try {
                await db.collection(COLLECTIONS.USERS).doc(userId).set(data, { merge: true });
            } catch (error) {
                console.error("Error saving data to Firestore: ", error);
                showError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
                throw error;
            }
        }

        async function loadUser(userId) {
            try {
                const doc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
                return doc.exists ? { userId: doc.id, ...doc.data() } : null;
            } catch (error) {
                console.error("Error loading user from Firestore:", error);
                return null;
            }
        }
        
        async function findUserByCredentials(phone, instagram, password) {
            try {
                const snapshot = await db.collection(COLLECTIONS.USERS)
                    .where('registration.phone', '==', phone)
                    .where('registration.instagramLogin', '==', instagram.toLowerCase())
                    .get();
                if (snapshot.empty) return null;
                for (const doc of snapshot.docs) {
                    const foundUser = { userId: doc.id, ...doc.data() };
                    if (foundUser.registration.password === hashPassword(password)) return foundUser;
                }
                return null;
            } catch (error) {
                console.error("Error finding user by credentials:", error);
                return null;
            }
        }
        
        async function findUserByPhoneAndInstagram(phone, instagram) {
            try {
                const snapshot = await db.collection(COLLECTIONS.USERS)
                    .where('registration.phone', '==', phone)
                    .where('registration.instagramLogin', '==', instagram.toLowerCase())
                    .get();
                if (snapshot.empty) return null;
                const userDoc = snapshot.docs[0];
                const foundUser = { userId: userDoc.id, ...userDoc.data() };
                return !foundUser.registration.password ? foundUser : null;
            } catch (error) {
                console.error("Error finding user for migration:", error);
                return null;
            }
        }
        
        async function checkForDuplicateRegistration(phone, instagram, excludeUserId = null) {
            try {
                const phoneQuery = db.collection(COLLECTIONS.USERS).where('registration.phone', '==', phone).get();
                const instagramQuery = db.collection(COLLECTIONS.USERS).where('registration.instagramLogin', '==', instagram.toLowerCase()).get();
                const [phoneSnapshot, instagramSnapshot] = await Promise.all([phoneQuery, instagramQuery]);
                const phoneExists = !phoneSnapshot.empty && phoneSnapshot.docs[0].id !== excludeUserId;
                const instagramExists = !instagramSnapshot.empty && instagramSnapshot.docs[0].id !== excludeUserId;
                return { phoneExists, instagramExists, canRegister: !phoneExists && !instagramExists };
            } catch (error) {
                console.error("Error checking for duplicates:", error);
                return { phoneExists: true, instagramExists: true, canRegister: false };
            }
        }

        async function attemptTelegramAutoLogin() {
            if (!telegramUser) return false;
            document.getElementById('autoLoginInfo').style.display = 'block';
            const existingUser = await loadUser('tg_' + telegramUser.id);
            document.getElementById('autoLoginInfo').style.display = 'none';

            if (existingUser) {
                if (migrateOldAccount(existingUser)) {
                    showScreen(SCREENS.MIGRATION);
                    return false;
                }
                currentUserId = existingUser.userId;
                await saveUser(currentUserId, { lastActivity: new Date().toISOString() });
                await checkAndSetUserRole();
                attachUserListener(currentUserId);
                return true;
            }
            return false;
        }

        function fillTelegramData() {
            if (telegramUser && telegramUser.first_name) {
                document.getElementById('firstName').value = telegramUser.first_name;
            }
        }

        function determineBloggerLevel(followersCount) {
            const count = Number(followersCount) || 0;
            if (count <= 6000) return { level: 'micro', text: '–ú–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä' };
            if (count <= 10500) return { level: 'macro-a', text: '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø A' };
            return { level: 'macro-b', text: '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø B' };
        }

        function showScreen(screenId) {
            document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen, #criticalErrorScreen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = (screenId === SCREENS.WELCOME || screenId === SCREENS.CRITICAL_ERROR) ? 'flex' : 'block';
        }

        function showDashboard() {
            if (!ensureAuthenticated()) return;
            showScreen(SCREENS.DASHBOARD);
            document.getElementById('adminPanel').style.display = currentUserRole ? 'block' : 'none';
        }

        function showWelcomeScreen() { showScreen(SCREENS.WELCOME); }
        function showRegistration() {
            if (!telegramUser) {
                return showCriticalError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
            }
            showScreen(SCREENS.REGISTRATION); 
            fillTelegramData();
        }
        function showLogin() { showScreen(SCREENS.LOGIN); }
        function showSetSelection() { showScreen(SCREENS.SET_SELECTION); }
        function showAddressForm() { showScreen(SCREENS.ADDRESS); }
        function showDateTimeSelection() { showScreen(SCREENS.DATE_TIME); }
        function showInstructions() { showScreen(SCREENS.INSTRUCTIONS); }
        function showMenuScreen() { showScreen(SCREENS.MENU_SELECTION); loadAndRenderMenu(); }


        async function showCRM() {
            if (!ensureAuthenticated()) return;
            if (!currentUserRole) {
                showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ CRM.');
                return;
            }
            showScreen(SCREENS.CRM);
            
            document.querySelectorAll('.crm-tab').forEach(tab => {
                const tabName = tab.dataset.tab;
                let isVisible = false;
                if (currentUserRole === 'admin') {
                    isVisible = true;
                } else if (currentUserRole === 'operator') {
                    const operatorTabs = ['overview', 'orders', 'users', 'schedule', 'blocks'];
                    isVisible = operatorTabs.includes(tabName);
                }
                tab.style.display = isVisible ? 'flex' : 'none';
            });

            const firstVisibleTab = document.querySelector('.crm-tab[style*="display: flex"]');
            if (firstVisibleTab) {
                showCrmTab(firstVisibleTab.dataset.tab, firstVisibleTab);
            }
            updateCRMData();
        }

        function showCrmTab(tabName, element) {
            if (!ensureAuthenticated()) return;
            document.querySelectorAll('.crm-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('crm' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            element.classList.add('active');
            
            switch(tabName) {
                case 'overview': 
                    updateCRMStats(); 
                    document.getElementById('cooldownSetting').value = appSettings.orderCooldownDays;
                    break;
                case 'analytics': applyAnalyticsFilters(); break;
                case 'orders': updateOrdersList(); break;
                case 'users': updateUsersList(); break;
                case 'schedule': loadSchedule(); break;
                case 'blocks': updateBlockedSlotsList(); break;
                case 'admins': updateAdminsList(); break;
                case 'broadcast': setupBroadcastTagInput(); break;
                case 'menu': updateMenuItemsListCrm(); break;
            }
        }
        
        async function withLoading(button, asyncFunction) {
            if (!button || button.disabled) return;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                await asyncFunction();
            } catch (error) {
                console.error("Operation failed:", error);
                showError("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        async function submitLogin(button) {
            await withLoading(button, async () => {
                const phone = document.getElementById('loginPhone').value.trim();
                const instagram = document.getElementById('loginInstagram').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                if (!phone || !instagram || !password) return showError('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                
                const oldUser = await findUserByPhoneAndInstagram(phone, instagram);
                if (oldUser) {
                    migrationUser = oldUser;
                    showScreen(SCREENS.MIGRATION);
                    return;
                }
                
                const existingUser = await findUserByCredentials(phone, instagram, password);
                if (existingUser) {
                    currentUserId = existingUser.userId;
                    if (telegramUser && !existingUser.telegramId) {
                        await saveUser(currentUserId, { telegramId: telegramUser.id, merge: true });
                    }
                    await saveUser(currentUserId, { lastActivity: new Date().toISOString() });
                    await checkAndSetUserRole();
                    attachUserListener(currentUserId);
                    showDashboard();
                } else {
                    showError('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.');
                }
            });
        }

        async function submitMigration(button) {
            await withLoading(button, async () => {
                const password = document.getElementById('migrationPassword').value.trim();
                const passwordConfirm = document.getElementById('migrationPasswordConfirm').value.trim();
                if (!validatePassword(password) || password !== passwordConfirm) {
                   return showError('–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –∏–ª–∏ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.');
                }

                if (migrationUser) {
                    migrationUser.registration.password = hashPassword(password);
                    migrationUser.lastActivity = new Date().toISOString();
                    if (telegramUser && !migrationUser.telegramId) migrationUser.telegramId = telegramUser.id;
                    await saveUser(migrationUser.userId, migrationUser);
                    currentUserId = migrationUser.userId;
                    migrationUser = null;
                    await checkAndSetUserRole();
                    attachUserListener(currentUserId);
                    showDashboard();
                }
            });
        }

        async function submitRegistration(button) {
            if (!ensureAuthenticated()) return;
            await withLoading(button, async () => {
                const firstName = document.getElementById('firstName').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const instagramLogin = document.getElementById('instagramLogin').value.trim().toLowerCase();
                const followersCount = parseInt(document.getElementById('followersCount').value);
                const avgViews = parseInt(document.getElementById('avgViews').value);
                const password = document.getElementById('regPassword').value.trim();
                const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();


                if (!firstName || !phone || !instagramLogin || isNaN(followersCount) || isNaN(avgViews)) {
                    return showError('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                }
                if (avgViews < 300) return showRejectionModal();

                if (!validatePassword(password) || password !== passwordConfirm) {
                   return showError('–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –∏–ª–∏ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.');
                }
                
                const duplicateCheck = await checkForDuplicateRegistration(phone, instagramLogin);
                if (!duplicateCheck.canRegister) {
                    return showError('–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', '–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Instagram —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.');
                }

                const bloggerData = determineBloggerLevel(followersCount);
                const newUserId = 'tg_' + telegramUser.id;
                
                const newUser = {
                    registration: { 
                        firstName, phone, instagramLogin, followersCount, avgViews, 
                        password: hashPassword(password) 
                    },
                    level: bloggerData.level,
                    orders: [],
                    telegramId: telegramUser.id,
                    registrationDate: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    isBlocked: false,
                    blockReason: '',
                    strikes: 0,
                    tags: [bloggerData.level],
                    loyaltyStatus: 'standard',
                    lastOrderTimestamp: null,
                    cooldownNotified: true,
                    vcoin_balance: 0,
                    vcoin_allowance: 0
                };

                await saveUser(newUserId, newUser);
                currentUserId = newUserId;
                await checkAndSetUserRole();
                attachUserListener(currentUserId);
                showDashboard();
            });
        }

        function getStatusInfo(status) {
            const statuses = {
                'new': { text: '–ù–æ–≤—ã–π', className: 'status-new' },
                'confirmed': { text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', className: 'status-confirmed' },
                'delivered': { text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', className: 'status-delivered' },
                'awaiting_review': { text: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', className: 'status-awaiting_review' },
                'completed': { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', className: 'status-completed' },
                'rejected': { text: '–û—Ç–∫–ª–æ–Ω–µ–Ω', className: 'status-rejected' }
            };
            return statuses[status] || { text: status, className: '' };
        }

        function formatVBonus(amount) {
            return `<span>${Number(amount).toFixed(1)}</span><span class="v-bonus-icon">V</span>`;
        }
        
        function updateDashboard() {
            const dataSource = userData.registration || userData;
            if (!dataSource || !dataSource.firstName) return;

            const { firstName, followersCount, avgViews } = dataSource;
            
            document.getElementById('blockedPanel').style.display = userData.isBlocked ? 'block' : 'none';
            if (userData.isBlocked) {
                document.getElementById('blockedPanel').innerHTML = `<h4>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h4><p>${userData.blockReason || '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'}</p>`;
            }

            const strikesPanel = document.getElementById('strikesPanel');
            if (userData.strikes && userData.strikes > 0) {
                strikesPanel.innerHTML = `‚ö†Ô∏è –£ –≤–∞—Å <strong>${userData.strikes}</strong> –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤. –ü–æ–º–Ω–∏—Ç–µ: 3 —à—Ç—Ä–∞—Ñ–∞ –ø—Ä–∏–≤–µ–¥—É—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ.`;
                strikesPanel.style.display = 'block';
            } else {
                strikesPanel.style.display = 'none';
            }

            document.getElementById('userName').textContent = firstName;
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.innerHTML = telegramUser?.photo_url ? `<img src="${telegramUser.photo_url}" alt="${firstName}">` : (firstName ? firstName.charAt(0).toUpperCase() : 'üë§');
            
            const pleasantTitles = ['–ò–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä', '–õ–∏–¥–µ—Ä –º–Ω–µ–Ω–∏–π', '–°–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞', '–¢—Ä–µ–Ω–¥—Å–µ—Ç—Ç–µ—Ä', '–ê–º–±–∞—Å—Å–∞–¥–æ—Ä'];
            const randomTitle = pleasantTitles[Math.floor(Math.random() * pleasantTitles.length)];
            document.getElementById('userLevel').textContent = randomTitle;

            const vcoinStatBlock = document.getElementById('vcoinStatItem');
            const userStatsGrid = document.querySelector('.user-stats');
            const isMacro = userData.level && userData.level.startsWith('macro');

            if (isMacro) {
                vcoinStatBlock.style.display = 'block';
                userStatsGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            } else {
                vcoinStatBlock.style.display = 'none';
                userStatsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            }
            
            document.getElementById('vcoinBalanceDisplay').innerHTML = formatVBonus(userData.vcoin_balance || 0);
            document.getElementById('followersDisplay').textContent = (followersCount || 0).toLocaleString('ru-RU');
            document.getElementById('viewsDisplay').textContent = (avgViews || 0).toLocaleString('ru-RU');

            const statusPanel = document.getElementById('statusPanel');
            statusPanel.style.display = 'none';
            if (userData.orders && userData.orders.length > 0) {
                const latestOrder = [...userData.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                let statusMessage = '';
                if (latestOrder.status === 'new') statusMessage = `‚è≥ <strong>–í–∞—à –∑–∞–∫–∞–∑ #${latestOrder.orderNumber} –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ.</strong>`;
                if (latestOrder.status === 'confirmed') statusMessage = `‚úÖ <strong>–í–∞—à –∑–∞–∫–∞–∑ #${latestOrder.orderNumber} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</strong>`;
                if (latestOrder.status === 'delivered') statusMessage = `üöö <strong>–í–∞—à –∑–∞–∫–∞–∑ #${latestOrder.orderNumber} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!</strong>`;
                
                if (statusMessage) {
                    statusPanel.innerHTML = statusMessage;
                    statusPanel.style.display = 'block';
                }
            }

            const reportPanel = document.getElementById('reportActionsPanel');
            reportPanel.innerHTML = '';
            (userData.orders || []).filter(o => o.status === 'delivered').forEach(order => {
                const card = document.createElement('div');
                card.className = 'action-card report-action-card';
                card.onclick = () => showReportModal(order.id, order.orderNumber);
                card.innerHTML = `<div class="action-icon">üì§</div><div class="action-title">–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É</div><div class="action-desc">${order.orderNumber}</div>`;
                reportPanel.appendChild(card);
            });

            const newCollabCard = document.getElementById('newCollaborationBtn');
            const cooldownPanel = document.getElementById('cooldownPanel');
            cooldownPanel.style.display = 'none';
            newCollabCard.style.opacity = '1';
            newCollabCard.style.cursor = 'pointer';
            newCollabCard.onclick = () => app.startCollaboration(); // Reset onclick handler

            if (userData.level === 'micro') {
                if (userData.lastOrderTimestamp) {
                    const lastOrderDate = new Date(userData.lastOrderTimestamp);
                    const nextAvailableDate = new Date(new Date(lastOrderDate).setDate(lastOrderDate.getDate() + appSettings.orderCooldownDays));
                    
                    if (new Date() < nextAvailableDate) {
                        newCollabCard.style.opacity = '0.5';
                        newCollabCard.style.cursor = 'not-allowed';
                        newCollabCard.onclick = null; // Prevent click
                        cooldownPanel.innerHTML = `‚è≥ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: <strong>${nextAvailableDate.toLocaleDateString('ru-RU')}</strong>`;
                        cooldownPanel.style.display = 'block';
                    }
                }
            } else if (userData.level && userData.level.startsWith('macro')) {
                if (!userData.vcoin_balance || userData.vcoin_balance <= 0) {
                    newCollabCard.style.opacity = '0.5';
                    newCollabCard.style.cursor = 'not-allowed';
                    newCollabCard.onclick = null; // Prevent click
                    cooldownPanel.innerHTML = `üí∞ –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à –±–∞–ª–∞–Ω—Å V-Coin.`;
                    cooldownPanel.style.display = 'block';
                }
            }
        }

        async function updateCRMData() { updateCRMStats(); }

        async function updateCRMStats() {
            try {
                const [usersSnap, ordersSnap, newOrdersSnap, blocksSnap] = await Promise.all([
                    db.collection(COLLECTIONS.USERS).get(),
                    db.collection(COLLECTIONS.ORDERS).get(),
                    db.collection(COLLECTIONS.ORDERS).where('status', '==', 'new').get(),
                    db.collection(COLLECTIONS.BLOCKED_SLOTS).get()
                ]);
                document.getElementById('totalUsers').textContent = usersSnap.size;
                document.getElementById('totalOrders').textContent = ordersSnap.size;
                document.getElementById('newOrders').textContent = newOrdersSnap.size;
                document.getElementById('blockedSlots').textContent = blocksSnap.size;
            } catch (error) { console.error("Error updating CRM stats:", error); }
        }
        
        async function applyAnalyticsFilters() {
            const startDate = document.getElementById('analyticsStartDate').value;
            const endDate = document.getElementById('analyticsEndDate').value;
            const city = document.getElementById('analyticsCity').value;
            document.getElementById('cityChartContainer').style.display = (city && city !== 'all') ? 'none' : 'flex';
            updateAllAnalytics({ startDate, endDate, city });
        }

        async function updateAllAnalytics(filters = {}) {
            try {
                let ordersQuery = db.collection(COLLECTIONS.ORDERS);
                if (filters.startDate) ordersQuery = ordersQuery.where('createdAt', '>=', new Date(filters.startDate).toISOString());
                if (filters.endDate) ordersQuery = ordersQuery.where('createdAt', '<=', new Date(filters.endDate).toISOString());
                if (filters.city && filters.city !== 'all') ordersQuery = ordersQuery.where('city', '==', filters.city);

                const [ordersSnap, usersSnap] = await Promise.all([ordersQuery.get(), db.collection(COLLECTIONS.USERS).get()]);
                
                const ordersByDate = {};
                ordersSnap.forEach(doc => {
                    const dateString = new Date(doc.data().createdAt).toISOString().split('T')[0];
                    ordersByDate[dateString] = (ordersByDate[dateString] || 0) + 1;
                });
                const sortedDates = Object.keys(ordersByDate).sort();
                renderChart('ordersTrendChart', 'line', sortedDates, sortedDates.map(date => ordersByDate[date]), '–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤');

                const cityCounts = {};
                ordersSnap.forEach(doc => {
                    const city = doc.data().city;
                    if (city) cityCounts[city] = (cityCounts[city] || 0) + 1;
                });
                renderChart('cityChart', 'bar', Object.keys(cityCounts), Object.values(cityCounts), '–ó–∞–∫–∞–∑—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º');

                const levelCounts = { '–ú–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä': 0, '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø A': 0, '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø B': 0 };
                const followerRanges = { '1-5k': 0, '5-10k': 0, '10-20k': 0, '20k+': 0 };
                usersSnap.forEach(doc => {
                    const followers = (doc.data().registration || doc.data()).followersCount || 0;
                    const levelText = determineBloggerLevel(followers).text;
                    if (levelCounts.hasOwnProperty(levelText)) levelCounts[levelText]++;
                    if (followers <= 5000) followerRanges['1-5k']++;
                    else if (followers <= 10000) followerRanges['5-10k']++;
                    else if (followers <= 20000) followerRanges['10-20k']++;
                    else followerRanges['20k+']++;
                });
                renderChart('bloggerLevelChart', 'doughnut', Object.keys(levelCounts), Object.values(levelCounts), '–£—Ä–æ–≤–Ω–∏ –±–ª–æ–≥–µ—Ä–æ–≤');
                renderChart('followersDistributionChart', 'pie', Object.keys(followerRanges), Object.values(followerRanges), '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏');

            } catch(e) { console.error("Analytics error:", e) }
        }
        
        function renderChart(canvasId, type, labels, data, label) {
            let chartInstance;
            if (canvasId === 'cityChart') chartInstance = cityChart;
            else if (canvasId === 'ordersTrendChart') chartInstance = ordersTrendChart;
            else if (canvasId === 'bloggerLevelChart') chartInstance = bloggerLevelChart;
            else if (canvasId === 'followersDistributionChart') chartInstance = followersDistributionChart;
            
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            
            const chartColors = ['rgba(0, 180, 216, 0.7)', 'rgba(255, 107, 53, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)'];
            const newChartInstance = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: chartColors, borderColor: chartColors, borderWidth: 1, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: (type === 'line' || type === 'bar') ? { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } : {}, plugins: { legend: { labels: { color: '#fff' } } } }
            });
            
            if (canvasId === 'cityChart') cityChart = newChartInstance;
            else if (canvasId === 'ordersTrendChart') ordersTrendChart = newChartInstance;
            else if (canvasId === 'bloggerLevelChart') bloggerLevelChart = newChartInstance;
            else if (canvasId === 'followersDistributionChart') followersDistributionChart = newChartInstance;
        }

        async function updateOrdersList() {
            const list = document.getElementById('ordersList');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const snapshot = await db.collection(COLLECTIONS.ORDERS).orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
                    return;
                }
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const statusInfo = getStatusInfo(order.status);
                    const el = document.createElement('div');
                    el.className = 'order-item';
                    el.dataset.search = `${order.userName} ${order.phone} ${order.instagram} ${order.orderNumber}`.toLowerCase();
                    el.onclick = () => showOrderDetailModal(order.id);
                    el.innerHTML = `
                        <div class="order-header">
                            <span class="order-id">${order.orderNumber}</span>
                            <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                        </div>
                        <div class="order-info">
                            <strong>${order.userName}</strong> (${order.city})<br>
                            <small>–°–æ–∑–¥–∞–Ω: ${new Date(order.createdAt).toLocaleString('ru-RU')}</small>
                        </div>`;
                    list.appendChild(el);
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                list.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
            }
        }
        
        function calculateBloggerRating(user) {
            const { followersCount = 0, avgViews = 0 } = user.registration || user;
            const strikes = user.strikes || 0;
            const followersScore = followersCount > 0 ? Math.log10(followersCount) * 2.5 : 0;
            const viewsScore = avgViews > 0 ? Math.log10(avgViews) * 4.5 : 0;
            let rating = ((followersScore + viewsScore - (strikes * 1.5)) / 25) * 10;
            return Math.max(1, Math.min(10, rating)).toFixed(1);
        }
        
        async function updateUsersList() {
            const list = document.getElementById('usersList');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const [usersSnapshot, adminsSnapshot] = await Promise.all([
                     db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get(),
                     db.collection(COLLECTIONS.ADMINS).get()
                ]);
                const adminData = new Map(adminsSnapshot.docs.map(doc => [doc.id, doc.data()]));
                if (usersSnapshot.empty) {
                    list.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</div>';
                    return;
                }
                list.innerHTML = '';
                usersSnapshot.forEach(doc => {
                    const user = { userId: doc.id, ...doc.data() };
                    const reg = user.registration || user;
                    if (!reg.firstName) return;

                    const adminInfo = adminData.get(String(user.telegramId));
                    const rating = calculateBloggerRating(user);
                    const el = document.createElement('div');
                    el.className = `user-item ${user.isBlocked ? 'blocked' : ''}`;
                    el.dataset.search = `${reg.firstName} ${reg.phone} ${reg.instagramLogin}`.toLowerCase();
                    el.onclick = () => showUserDetailModal(user.userId);
                    
                    let badges = '';
                    if (user.loyaltyStatus === 'premium') badges += `<span class="user-admin-badge" style="background-color: #ffc107;">Premium</span>`;
                    if(adminInfo) badges += `<span class="user-admin-badge" style="margin-left: 5px;">${adminInfo.role}</span>`;
                    if(user.isBlocked) badges += `<span class="user-blocked-badge" style="margin-left: 5px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>`;

                    el.innerHTML = `
                        <div class="user-details">
                            <div class="user-header">
                               <span class="user-name-phone">${reg.firstName}</span>
                               <span class="user-rating">‚≠ê ${rating}</span>
                            </div>
                            <div style="font-size: 14px; color: #ccc;">
                                <a href="https://www.instagram.com/${reg.instagramLogin.replace('@','')}" target="_blank" style="color: #ccc; text-decoration: none;">
                                    @${reg.instagramLogin}
                                </a>
                            </div>
                            ${badges ? `<div style="margin-top:5px;">${badges}</div>` : ''}
                        </div>
                        <div class="user-controls">
                           ${user.isBlocked 
                                ? `<button class="btn-icon-unblock" title="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', false)">üîì</button>`
                                : `<button class="btn-icon-block" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', true)">üîí</button>`
                           }
                           <button class="btn-danger-icon" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); app.removeUser('${user.userId}', '${reg.firstName}')">üóëÔ∏è</button>
                        </div>`;
                    list.appendChild(el);
                });
            } catch (error) {
                console.error("Error fetching users:", error);
                list.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
            }
        }
        
        async function updateBlockedSlotsList() {
            const list = document.getElementById('blockedSlotsList');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const snapshot = await db.collection(COLLECTIONS.BLOCKED_SLOTS).get();
                if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-state">–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.</div>';
                    return;
                }
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const block = { id: doc.id, ...doc.data() };
                    let timeInfo = '–í–µ—Å—å –¥–µ–Ω—å';
                    if (block.type === 'range') {
                        timeInfo = `—Å ${block.startTime} –¥–æ ${block.endTime}`;
                    }

                    const el = document.createElement('div');
                    el.className = 'blocked-slot';
                    el.innerHTML = `
                        <div class="blocked-slot-info">
                            <div class="blocked-slot-city">${block.city}</div>
                            <div class="blocked-slot-time">${block.date} (${timeInfo})</div>
                        </div>
                        <button class="btn-danger-icon" onclick="app.removeBlock('${block.id}')">üóëÔ∏è</button>`;
                    list.appendChild(el);
                });
            } catch (error) {
                console.error("Error fetching blocks:", error);
                list.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
            }
        }
        
        async function updateAdminsList() {
            const list = document.getElementById('adminsList');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const snapshot = await db.collection(COLLECTIONS.ADMINS).get();
                 if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</div>';
                    return;
                }
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const admin = { id: doc.id, ...doc.data() };
                    const receivesNotifications = admin.receivesNotifications !== false;
                    const el = document.createElement('div');
                    el.className = 'user-item';
                    el.innerHTML = `
                        <div class="user-details">
                            <span class="user-name-phone">${admin.name || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'}</span>
                            <div style="margin-top: 5px;"><span class="user-admin-badge">${admin.role}</span></div>
                        </div>
                        <div class="user-controls">
                            <button class="btn-icon" 
                                    title="${receivesNotifications ? '–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' : '–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}" 
                                    onclick="event.stopPropagation(); app.toggleAdminNotifications('${admin.id}', ${receivesNotifications})">
                                ${receivesNotifications ? 'üîî' : 'üîï'}
                            </button>
                            ${admin.id !== '1345815453' ? `<button class="btn-danger-icon" onclick="event.stopPropagation(); app.removeAdmin('${admin.id}')">üóëÔ∏è</button>` : ''}
                        </div>`;
                    list.appendChild(el);
                });
            } catch (error) {
                console.error("Error fetching admins:", error);
                list.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
            }
        }

        async function updateOrderStatus(button) {
            await withLoading(button, async () => {
                if (!currentEditingOrderId) return;
                const newStatus = document.getElementById('orderStatusSelect').value;
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentEditingOrderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) throw new Error("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω");
                const orderData = orderDoc.data();
                const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);
                const batch = db.batch();
                batch.update(orderRef, { status: newStatus });
                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const orders = userDoc.data().orders || [];
                    const orderIndex = orders.findIndex(o => o.id === currentEditingOrderId);
                    if (orderIndex > -1) {
                        orders[orderIndex].status = newStatus;
                        batch.update(userRef, { orders: orders });
                    }
                    if (userDoc.data().telegramId) {
                        if (newStatus === 'confirmed') await sendTelegramNotification(userDoc.data().telegramId, `‚úÖ –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ${orderData.orderNumber} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!`);
                        if (newStatus === 'delivered') await sendTelegramNotification(userDoc.data().telegramId, `üöö –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ${orderData.orderNumber} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω! –°–∫–æ—Ä–æ –º—ã –±—É–¥–µ–º –∂–¥–∞—Ç—å –æ—Ç –≤–∞—Å –æ—Ç—á–µ—Ç.`);
                        if (newStatus === 'completed') await sendTelegramNotification(userDoc.data().telegramId, `üéâ –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –ø–æ –∑–∞–∫–∞–∑—É ‚Ññ${orderData.orderNumber} –∑–∞–≤–µ—Ä—à–µ–Ω–æ.`);
                    }
                }
                await batch.commit();

                if (newStatus === 'completed') {
                    await checkAndUpgradeLoyaltyStatus(orderData.userId);
                }
                
                closeOrderDetailModal();
                showCrmSuccess('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                updateOrdersList();
            });
        }

        function filter(inputId, listSelector, itemSelector) {
            const query = document.getElementById(inputId).value.toLowerCase();
            document.querySelectorAll(`${listSelector} ${itemSelector}`).forEach(item => {
                item.style.display = (item.dataset.search || '').includes(query) ? '' : 'none';
            });
        }
        function filterOrders() { filter('orderSearch', '#ordersList', '.order-item'); }
        function filterUsers() { filter('userSearch', '#usersList', '.user-item'); }
        function filterAdminUsers() { filter('adminUserSearch', '#adminUsersList', '.user-item'); }
        function filterMenuItems() { filter('menuSearch', '#menuItemsListCrm', '.user-item'); }
        
        async function addBlock(button) {
            await withLoading(button, async () => {
                const city = document.getElementById('blockCity').value;
                const date = document.getElementById('blockDate').value;
                const type = document.getElementById('blockType').value;
                const reason = document.getElementById('blockReason').value.trim();
                
                if (!city || !date) {
                    return showError('–û—à–∏–±–∫–∞', '–ì–æ—Ä–æ–¥ –∏ –¥–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.');
                }

                let blockData;
                let blockId;

                if (type === 'fullday') {
                    blockId = `${city}_${date}_fullday`;
                    blockData = { city, date, type, reason };
                } else { // type is 'range'
                    const startTime = document.getElementById('blockStartTime').value;
                    const endTime = document.getElementById('blockEndTime').value;
                    if (!startTime || !endTime || startTime >= endTime) {
                        return showError('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ (–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è).');
                    }
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Firestore-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π ID
                    blockId = db.collection('blockedSlots').doc().id;
                    blockData = { city, date, type, reason, startTime, endTime };
                }

                await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).set(blockData);
                closeAddBlockModal();
                updateBlockedSlotsList();
                showCrmSuccess('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
            });
        }

        async function removeBlock(blockId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?')) {
                await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).delete();
                updateBlockedSlotsList();
            }
        }
        
        async function toggleUserBlock(userId, shouldBlock) {
            const reason = shouldBlock ? prompt("–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", "") : '';
            if (shouldBlock && reason === null) return;
            await db.collection(COLLECTIONS.USERS).doc(userId).update({ isBlocked: shouldBlock, blockReason: shouldBlock ? reason : '' });
            showCrmSuccess(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${shouldBlock ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}.`);
            updateUsersList();
        }
        
        async function removeUser(userId, userName) {
            const confirmationText = '–£–î–ê–õ–ò–¢–¨';
            const promptResult = prompt(`–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName}, –≤–≤–µ–¥–∏—Ç–µ "${confirmationText}" –≤ –ø–æ–ª–µ –Ω–∏–∂–µ.`);
            
            if (promptResult === confirmationText) {
                const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;

                const user = userDoc.data();
                if (user.telegramId) {
                    const adminRole = await getUserRole(user.telegramId);
                    if (adminRole) {
                        showError("–î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ", "–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º. –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —Å –Ω–µ–≥–æ –ø—Ä–∞–≤–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ê–¥–º–∏–Ω—ã'.");
                        return;
                    }
                }

                const batch = db.batch();
                batch.delete(userRef);
                (user.orders || []).forEach(order => {
                    batch.delete(db.collection(COLLECTIONS.ORDERS).doc(order.id));
                });
                await batch.commit();
                showCrmSuccess(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} —É–¥–∞–ª–µ–Ω.`);
                updateUsersList();
            } else if (promptResult !== null) {
                showError("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", "–¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ.");
            }
        }

        async function addAdmin(userId, userName, role) {
            if (!userId) return;
            const userDoc = await loadUser(userId);
            const telegramId = userDoc?.telegramId;
            if(!telegramId) return showError("–û—à–∏–±–∫–∞", "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç Telegram ID.");
            
            const newAdmin = { 
                name: userName, 
                role: role, 
                addedAt: new Date().toISOString(),
                receivesNotifications: true 
            };
            await db.collection(COLLECTIONS.ADMINS).doc(String(telegramId)).set(newAdmin);

            const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
            const tags = userDoc.tags || [];
            if (!tags.includes(role)) tags.push(role);
            await userRef.update({ tags: tags });

            closeAddAdminModal();
            updateAdminsList();
            showCrmSuccess(`${userName} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ä–æ–ª—å: ${role}!`);
        }

        async function toggleAdminNotifications(adminId, currentState) {
            const adminRef = db.collection(COLLECTIONS.ADMINS).doc(adminId);
            try {
                await adminRef.update({ receivesNotifications: !currentState });
                showCrmSuccess('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                updateAdminsList();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
                showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
            }
        }

        async function removeAdmin(adminId) {
            if (adminId === '1345815453') return showError('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?`)) {
                const adminRef = db.collection(COLLECTIONS.ADMINS).doc(adminId);
                const adminDoc = await adminRef.get();
                if (!adminDoc.exists) return;
                const role = adminDoc.data().role;

                const usersSnapshot = await db.collection(COLLECTIONS.USERS).where('telegramId', '==', Number(adminId)).get();
                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    const tags = userDoc.data().tags.filter(t => t !== role);
                    await db.collection(COLLECTIONS.USERS).doc(userDoc.id).update({ tags: tags });
                }

                await adminRef.delete();
                updateAdminsList();
                showCrmSuccess('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω!');
            }
        }
        
        async function removeOrder(orderId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                await withLoading(document.getElementById('deleteOrderBtn'), async () => {
                    const orderRef = db.collection(COLLECTIONS.ORDERS).doc(orderId);
                    const orderDoc = await orderRef.get();
                    if (!orderDoc.exists) return;
                    const userId = orderDoc.data().userId;
                    const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                    const batch = db.batch();
                    batch.delete(orderRef);
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const updatedOrders = (userDoc.data().orders || []).filter(o => o.id !== orderId);
                        batch.update(userRef, { orders: updatedOrders });
                    }
                    await batch.commit();
                    closeOrderDetailModal();
                    updateOrdersList(); 
                    showCrmSuccess('–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω.');
                });
            }
        }
        
        async function markReportAccepted(button) {
            if (button.disabled) return;
            if (!confirm('–û—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç? –≠—Ç–æ –∑–∞—Å—á–∏—Ç–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.')) return;
            await withLoading(button, async () => {
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentEditingOrderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) return;
                const orderData = orderDoc.data();
                const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);

                const batch = db.batch();
                batch.update(orderRef, { status: 'completed', reportAccepted: true });
                
                const userDoc = await userRef.get();
                if(userDoc.exists) {
                    const orders = (userDoc.data().orders || []).map(o => o.id === currentEditingOrderId ? {...o, status: 'completed'} : o);
                    batch.update(userRef, { orders: orders });
                }
                await batch.commit();
                await checkAndUpgradeLoyaltyStatus(orderData.userId);
                
                showCrmSuccess('–û—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç, –∑–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.');
                closeOrderDetailModal();
                updateOrdersList();
                updateUsersList();
            });
        }

        async function checkAndUpgradeLoyaltyStatus(userId) {
            const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
            const userDoc = await userRef.get();
            if (!userDoc.exists) return;

            const user = userDoc.data();
            if (user.loyaltyStatus === 'premium') return;

            const completedOrders = (user.orders || []).filter(o => o.status === 'completed').length;
            
            if (completedOrders >= LOYALTY_THRESHOLD) {
                await userRef.update({ loyaltyStatus: 'premium' });
                if (user.telegramId) {
                    const message = `‚≠ê –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, ${user.registration.firstName}! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —É—á–∞—Å—Ç–∏–µ!`;
                    await sendTelegramNotification(user.telegramId, message);
                }
            }
        }

        async function markNoReport(button, orderId, orderNumber) {
            if (button.disabled) return;
            const orderRef = db.collection(COLLECTIONS.ORDERS).doc(orderId);
            const orderDoc = await orderRef.get();
            if (orderDoc.exists && orderDoc.data().reportMissed) {
                showError('–û—à–∏–±–∫–∞', '–ù–∞ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –±—ã–ª –Ω–∞–ª–æ–∂–µ–Ω —à—Ç—Ä–∞—Ñ.');
                return;
            }

            if (!confirm('–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É –Ω–µ —Å–¥–∞–Ω? –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç —à—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª.')) return;
            
            await withLoading(button, async () => {
                const orderData = orderDoc.data();
                const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);
                
                const userDoc = await userRef.get();
                if(!userDoc.exists) throw new Error("User not found!");

                const newStrikes = (userDoc.data().strikes || 0) + 1;
                const updates = { strikes: newStrikes };
                if (newStrikes >= 3) {
                    updates.isBlocked = true;
                    updates.blockReason = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: ${newStrikes} –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞.`;
                }
                
                const batch = db.batch();
                batch.update(userRef, updates);
                const orders = (userDoc.data().orders || []).map(o => o.id === orderId ? {...o, status: 'completed'} : o);
                batch.update(userRef, { orders: orders });
                batch.update(orderRef, { reportMissed: true, status: 'completed' });
                
                await batch.commit();
                
                if (userDoc.data().telegramId) {
                    const message = `üö© –í–Ω–∏–º–∞–Ω–∏–µ: –í—ã –Ω–µ —Å–¥–∞–ª–∏ –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É #${orderNumber} –≤–æ–≤—Ä–µ–º—è. –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω 1 —à—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª. –ü–æ—Å–ª–µ 3-—Ö —à—Ç—Ä–∞—Ñ–æ–≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`;
                    await sendTelegramNotification(userDoc.data().telegramId, message);
                }

                showCrmSuccess('–®—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª –¥–æ–±–∞–≤–ª–µ–Ω, –∑–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç.');
                closeOrderDetailModal();
                updateUsersList(); 
            });
        }

        async function sendBroadcast(button) {
            await withLoading(button, async () => {
                const message = document.getElementById('broadcastMessage').value.trim();
                const selectedTags = Array.from(document.querySelectorAll('#broadcastTagsContainer .tag')).map(el => el.textContent.replace(' √ó', ''));
                
                if (!message) {
                    return showError('–û—à–∏–±–∫–∞', '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
                }

                await apiFetch('/api/broadcast', {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        tags: selectedTags,
                        senderChatId: telegramUser.id
                    })
                });
                
                showCrmSuccess("–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç!", "–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û—Ç—á–µ—Ç –ø—Ä–∏–¥–µ—Ç –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.");
            });
        }

        function startCollaboration() {
            if (userData.isBlocked) return;
            currentOrderData = {};
            cart = {};

            // === –õ–û–ì–ò–ö–ê –†–ê–ó–î–ï–õ–ï–ù–ò–Ø –ü–û –£–†–û–í–ù–Æ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
            if (userData.level === 'micro') {
                if (userData.lastOrderTimestamp) {
                    const lastOrderDate = new Date(userData.lastOrderTimestamp);
                    const nextAvailableDate = new Date(new Date(lastOrderDate).setDate(lastOrderDate.getDate() + appSettings.orderCooldownDays));
                    if (new Date() < nextAvailableDate) {
                        showError("–ó–∞–∫–∞–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", `–°–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω ${nextAvailableDate.toLocaleDateString('ru-RU')}.`);
                        return;
                    }
                }
                showSetSelection();
            } 
            else if (userData.level && userData.level.startsWith('macro')) {
                if (!userData.vcoin_balance || userData.vcoin_balance <= 0) {
                    showError("–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤", "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à –±–∞–ª–∞–Ω—Å V-Coin.");
                    return;
                }
                showAddressForm();
                document.getElementById('backFromAddress').onclick = () => app.showDashboard();
            }
            else {
                // –§–æ–ª–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —É—Ä–æ–≤–Ω—è
                showError("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à —É—Ä–æ–≤–µ–Ω—å. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.");
            }
        }
        
        function proceedToAddressFromSet() {
            document.getElementById('backFromAddress').onclick = () => app.showSetSelection();
            showAddressForm();
        }

        function handleCityChange() {}

        function selectSet(element, setId) {
            document.querySelectorAll('.set-item').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');
            currentOrderData.set = setId;
            currentOrderData.setName = element.dataset.setName;
            document.getElementById('nextFromSet').disabled = false;
        }
        
        function submitAddressAndShowDateTime() {
            if (!validateAddressForm()) return;
            currentOrderData.city = document.getElementById('city').value;
            currentOrderData.street = document.getElementById('street').value;
            currentOrderData.entrance = document.getElementById('entrance').value;
            currentOrderData.floor = document.getElementById('floor').value;
            currentOrderData.recipientPhone = document.getElementById('recipientPhone').value;
            currentOrderData.comment = document.getElementById('comment').value;

            const backButton = document.getElementById('backFromDateTime');
            
            const isMacro = userData.level && userData.level.startsWith('macro');

            if (isMacro) {
                backButton.onclick = () => app.showMenuScreen();
                showMenuScreen();
            } 
            else { // isMicro
                backButton.onclick = () => app.showAddressForm();
                showDateTimeSelection();
                setupTimeSelection();
            }
        }

        // START: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–ë–û–†–ê –í–†–ï–ú–ï–ù–ò
        async function setupTimeSelection() {
            currentOrderData.time = '';
            const nextButton = document.getElementById('nextFromDateTime');
            const timeInput = document.getElementById('deliveryTime');
            const timeInfo = document.getElementById('timeSelectionInfo');
            
            nextButton.disabled = true;
            timeInput.value = '';
            timeInfo.style.display = 'none';
            timeInfo.style.color = '#ccc';

            const today = new Date();
            const dateValue = today.toISOString().split('T')[0];
            const formattedDate = today.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            document.getElementById('todaysDateHeader').textContent = `–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, ${formattedDate}`;
            currentOrderData.date = dateValue;
            
            const city = currentOrderData.city;
            
            const schedulePromise = db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
            const blocksPromise = db.collection(COLLECTIONS.BLOCKED_SLOTS).where('city', '==', city).where('date', '==', dateValue).get();
            const [scheduleDoc, blocksSnapshot] = await Promise.all([schedulePromise, blocksPromise]);

            const blockedRanges = [];
            blocksSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.type === 'fullday') {
                    timeInfo.innerHTML = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                    timeInfo.style.display = 'block';
                    timeInput.disabled = true;
                    return;
                }
                if (data.type === 'range') {
                    blockedRanges.push({ start: data.startTime, end: data.endTime });
                }
            });
            currentOrderData.blockedRanges = blockedRanges;

            if (!scheduleDoc.exists) {
                timeInfo.innerHTML = '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ.';
                timeInfo.style.display = 'block';
                timeInput.disabled = true;
                return;
            }

            const scheduleData = scheduleDoc.data();
            const dayKey = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][today.getDay()];
            const daySchedule = scheduleData[dayKey] || '';
            
            if (!daySchedule) {
                timeInfo.innerHTML = '–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π. –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                timeInfo.style.display = 'block';
                timeInput.disabled = true;
                return;
            }

            const availableRanges = daySchedule.split(',').map(rangeStr => {
                const [start, end] = rangeStr.trim().split('-');
                return { start, end };
            }).filter(range => range.start && range.end);

            if (availableRanges.length === 0) {
                timeInfo.innerHTML = '–°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏.';
                timeInfo.style.display = 'block';
                timeInput.disabled = true;
                return;
            }
            
            currentOrderData.availableRanges = availableRanges;

            const now = new Date();
            now.setMinutes(now.getMinutes() + 45); // –ë—É—Ñ–µ—Ä
            const earliestTime = now.toTimeString().slice(0, 5);
            
            const firstAvailableSlotStart = availableRanges[0].start;
            const lastAvailableSlotEnd = availableRanges[availableRanges.length - 1].end;
            
            const effectiveMinTime = earliestTime > firstAvailableSlotStart ? earliestTime : firstAvailableSlotStart;

            if (effectiveMinTime >= lastAvailableSlotEnd) {
                timeInfo.innerHTML = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—Å–µ —Å–ª–æ—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –ø—Ä–æ—à–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!';
                timeInfo.style.display = 'block';
                timeInput.disabled = true;
                return;
            }

            timeInput.min = effectiveMinTime;
            timeInput.max = lastAvailableSlotEnd;
            timeInput.disabled = false;
            
            timeInfo.innerHTML = `–î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è: <strong>${daySchedule}</strong>.`;
            timeInfo.style.display = 'block';
        }

        function validateTimeSelection() {
            const timeInput = document.getElementById('deliveryTime');
            const timeInfo = document.getElementById('timeSelectionInfo');
            const nextButton = document.getElementById('nextFromDateTime');
            const selectedTime = timeInput.value;

            nextButton.disabled = true;
            timeInfo.style.color = '#ccc';
            const scheduleText = currentOrderData.availableRanges.map(r => `${r.start}-${r.end}`).join(', ');
            timeInfo.innerHTML = `–î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è: <strong>${scheduleText}</strong>.`;

            if (!selectedTime) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –≤—Ä–µ–º—è –≤ –æ–¥–∏–Ω –∏–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
            const isInSchedule = currentOrderData.availableRanges.some(range => {
                return selectedTime >= range.start && selectedTime < range.end;
            });

            if (!isInSchedule) {
                timeInfo.innerHTML = `–í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (${selectedTime}) –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã.`;
                timeInfo.style.color = '#dc3545';
                timeInput.value = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ª–∏ —ç—Ç–æ –≤—Ä–µ–º—è
            for (const range of currentOrderData.blockedRanges) {
                if (selectedTime >= range.start && selectedTime < range.end) {
                    timeInfo.innerHTML = `–í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (${selectedTime}) –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.`;
                    timeInfo.style.color = '#dc3545';
                    timeInput.value = '';
                    return;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –≤—Ä–µ–º—è –≤ –ø—Ä–æ—à–ª–æ–º (—Å —É—á–µ—Ç–æ–º –±—É—Ñ–µ—Ä–∞)
            const now = new Date();
            now.setMinutes(now.getMinutes() + 45);
            const earliestTime = now.toTimeString().slice(0, 5);
            if (selectedTime < earliestTime) {
                timeInfo.innerHTML = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Äî ${earliestTime}.`;
                timeInfo.style.color = '#dc3545';
                timeInput.value = '';
                return;
            }

            // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
            currentOrderData.time = selectedTime;
            nextButton.disabled = false;
        }
        // END: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–ë–û–†–ê –í–†–ï–ú–ï–ù–ò

        function validateAddressForm() {
            const city = document.getElementById('city').value;
            const street = document.getElementById('street').value;
            const phone = document.getElementById('recipientPhone').value;
            if (!city || !street || !phone) {
                showError('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, —Ç–µ–ª–µ—Ñ–æ–Ω.');
                return false;
            }
            return true;
        }

        async function submitOrder(button) {
            await withLoading(button, async () => {
                const orderId = db.collection(COLLECTIONS.ORDERS).doc().id;
                const dataSource = userData.registration || userData;
                
                const newOrder = {
                    ...currentOrderData, 
                    id: orderId, 
                    status: 'new',
                    orderNumber: await generateOrderNumber(currentOrderData.city),
                    userId: currentUserId, 
                    userName: dataSource.firstName,
                    instagram: dataSource.instagramLogin, 
                    phone: dataSource.phone,
                    followersCount: dataSource.followersCount, 
                    createdAt: new Date().toISOString(),
                    reminderSent: false,
                    reportMissed: false,
                    budget: currentOrderData.budget // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—é–¥–∂–µ—Ç –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞
                };
                
                // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                await apiFetch('/api/create-order', {
                    method: 'POST',
                    body: JSON.stringify({ order: newOrder })
                });
                
                showSuccessMessage("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!", "–í–∞–º –ø—Ä–∏–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.");
            });
        }
        
        function showOrderHistory() {
            const list = document.getElementById('orderHistoryList');
            const sortedOrders = (userData.orders || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (sortedOrders.length === 0) {
                list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
            } else {
                list.innerHTML = sortedOrders.map(order => {
                    const statusInfo = getStatusInfo(order.status);
                    return `<div class="order-item">
                        <div class="order-header">
                            <span class="order-id">${order.orderNumber}</span>
                            <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('orderHistoryModal').style.display = 'flex';
        }

        function editProfile() {
            const reg = userData.registration || userData;
            document.getElementById('editFirstName').value = reg.firstName;
            document.getElementById('editPhone').value = reg.phone;
            document.getElementById('editInstagram').value = reg.instagramLogin;
            document.getElementById('editFollowers').value = reg.followersCount;
            document.getElementById('editViews').value = reg.avgViews;
            document.getElementById('editPassword').value = '';
            
            const vcoinInput = document.getElementById('editVcoinAllowance');
            vcoinInput.value = userData.vcoin_allowance || 0;
            vcoinInput.parentElement.style.display = currentUserRole === 'admin' ? 'block' : 'none';

            document.getElementById('editProfileModal').style.display = 'flex';
        }

        async function saveProfile(button) {
            await withLoading(button, async () => {
                const reg = userData.registration || userData;
                const newPhone = document.getElementById('editPhone').value.trim();
                const newInstagram = document.getElementById('editInstagram').value.trim().toLowerCase();
                if (newPhone !== reg.phone || newInstagram !== reg.instagramLogin) {
                    const { canRegister } = await checkForDuplicateRegistration(newPhone, newInstagram, currentUserId);
                    if (!canRegister) return showError('–î–∞–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç—ã', '–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Instagram —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.');
                }
                
                const newFollowers = parseInt(document.getElementById('editFollowers').value);
                const levelData = determineBloggerLevel(newFollowers);
                const oldLevelTags = ['micro', 'macro-a', 'macro-b'];
                const currentTags = userData.tags || [];
                const updatedTags = currentTags.filter(t => !oldLevelTags.includes(t));
                if(!updatedTags.includes(levelData.level)) updatedTags.push(levelData.level);

                const updates = {
                    'registration.firstName': document.getElementById('editFirstName').value.trim(),
                    'registration.phone': newPhone, 'registration.instagramLogin': newInstagram,
                    'registration.followersCount': newFollowers,
                    'registration.avgViews': parseInt(document.getElementById('editViews').value),
                    'level': levelData.level, 'tags': updatedTags
                };

                if (currentUserRole === 'admin') {
                    updates.vcoin_allowance = parseInt(document.getElementById('editVcoinAllowance').value) || 0;
                }

                const newPassword = document.getElementById('editPassword').value.trim();
                if (validatePassword(newPassword)) updates['registration.password'] = hashPassword(newPassword);
                
                await db.collection(COLLECTIONS.USERS).doc(currentUserId).update(updates);
                closeEditProfile();
                showSuccessMessage('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
            });
        }

        function logout() {
            if (userListenerUnsubscribe) userListenerUnsubscribe();
            userData = {}; currentUserId = null; telegramUser = null; currentUserRole = null;
            window.location.reload();
        }
        
        function showSuccessMessage(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModalCloseBtn').onclick = () => app.closeModal();
            document.getElementById('successModal').style.display = 'flex';
        }

        function showCrmSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message || '';
            document.getElementById('successModalCloseBtn').onclick = () => app.closeSimpleModal('successModal');
            document.getElementById('successModal').style.display = 'flex';
        }

        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }
        
        async function showOrderDetailModal(orderId) {
            currentEditingOrderId = orderId;
            const orderDoc = await db.collection(COLLECTIONS.ORDERS).doc(orderId).get();
            if(!orderDoc.exists) return;
            const order = orderDoc.data();
            
            let itemsHtml = '';
            if (order.vcoin_cost) {
                const itemsList = order.items.map(item => `<li>${item.name} (x${item.quantity}) - ${formatVBonus((item.price / VCOIN_RATE) * item.quantity)}</li>`).join('');
                itemsHtml = `<strong>–ó–∞–∫–∞–∑:</strong><ul>${itemsList}</ul>`
                + `<strong>–ò—Ç–æ–≥–æ:</strong> ${formatVBonus(order.vcoin_cost)}<br>`
                + `<strong>–ö –¥–æ–ø–ª–∞—Ç–µ:</strong> ${(order.payment_due_tenge || 0).toFixed(0)} ‚Ç∏<br>`;
            } else if (order.setName) {
                itemsHtml = `<strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä:</strong> ${order.setName}<br>`;
            }

            document.getElementById('orderDetailTitle').textContent = `–ó–∞–∫–∞–∑ ${order.orderNumber}`;
            document.getElementById('orderDetailBody').innerHTML = `<strong>–ë–ª–æ–≥–µ—Ä:</strong> ${order.userName}<br><strong>Instagram:</strong> <a href="https://www.instagram.com/${order.instagram.replace('@','')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${order.instagram}</a><br><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone}<br><strong>–ì–æ—Ä–æ–¥:</strong> ${order.city}<br><strong>–ê–¥—Ä–µ—Å:</strong> ${order.street}<br>${itemsHtml}<strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment || '-'}<br><strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç:</strong> ${order.reportLink ? `<a href="${order.reportLink}" target="_blank" class="report-link">${order.reportLink}</a>` : '-'}`;
            document.getElementById('orderStatusSelect').value = order.status;
            
            const markNoReportBtn = document.getElementById('markNoReportBtn');
            const markReportAcceptedBtn = document.getElementById('markReportAcceptedBtn');

            const isActionable = !order.reportMissed && order.status !== 'completed';
            
            markNoReportBtn.disabled = !isActionable;
            markReportAcceptedBtn.disabled = !isActionable;

            document.getElementById('deleteOrderBtn').onclick = () => removeOrder(order.id);
            markNoReportBtn.onclick = () => markNoReport(markNoReportBtn, order.id, order.orderNumber);
            markReportAcceptedBtn.onclick = () => markReportAccepted(markReportAcceptedBtn);
            
            document.getElementById('orderDetailModal').style.display = 'flex';
        }
        async function showAddAdminModal() { 
            document.getElementById('addAdminModal').style.display = 'flex';
            const list = document.getElementById('adminUsersList');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const [usersSnapshot, adminsSnapshot] = await Promise.all([
                 db.collection(COLLECTIONS.USERS).get(), db.collection(COLLECTIONS.ADMINS).get()
            ]);
            const adminIds = new Set(adminsSnapshot.docs.map(doc => doc.id));
            list.innerHTML = '';
            usersSnapshot.forEach(doc => {
                const user = { userId: doc.id, ...doc.data() };
                const reg = user.registration || user;
                if (!reg.firstName || !user.telegramId) return;
                const isAlreadyAdmin = adminIds.has(String(user.telegramId));
                const el = document.createElement('div');
                el.className = 'user-item';
                el.dataset.search = `${reg.firstName} ${reg.instagramLogin}`.toLowerCase();
                el.innerHTML = `<div><strong>${reg.firstName}</strong><div style="font-size: 12px; color: #999;">@${reg.instagramLogin}</div></div>
                    ${isAlreadyAdmin ? '<span class="user-admin-badge">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>' : `<button class="btn-primary btn-small" onclick="app.addAdmin('${user.userId}', '${reg.firstName}', document.getElementById('adminRoleSelect').value)">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>`}`;
                list.appendChild(el);
            });
        }
        
        async function resetOrderCooldown() {
            if (!currentUserDetailId) return;
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) {
                const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    await userRef.update({
                        lastOrderTimestamp: FieldValue.delete()
                    });
                    if (userData.telegramId) {
                        const message = `üéâ –û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, ${userData.registration.firstName}! –ú—ã —Å–±—Ä–æ—Å–∏–ª–∏ –¥–ª—è –≤–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ!`;
                        await sendTelegramNotification(userData.telegramId, message);
                    }
                    showCrmSuccess("–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.");
                } else {
                    showError("–û—à–∏–±–∫–∞", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                }
                closeUserDetailModal();
            }
        }
        
        function closeModal() { document.getElementById('successModal').style.display = 'none'; showDashboard(); }
        function closeSimpleModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function showRejectionModal() { document.getElementById('rejectionModal').style.display = 'flex'; }
        function closeErrorModal() { document.getElementById('errorModal').style.display = 'none'; }
        function closeRejectionModal() { document.getElementById('rejectionModal').style.display = 'none'; }
        function closeOrderHistory() { document.getElementById('orderHistoryModal').style.display = 'none'; }
        function closeEditProfile() { document.getElementById('editProfileModal').style.display = 'none'; }
        function contactAdmin() { document.getElementById('contactModal').style.display = 'flex'; }
        function closeContactModal() { document.getElementById('contactModal').style.display = 'none'; }
        function closeOrderDetailModal() { document.getElementById('orderDetailModal').style.display = 'none'; }
        function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
        function closeUserDetailModal() { document.getElementById('userDetailModal').style.display = 'none'; }
        
        function toggleBlockTime() { 
            document.getElementById('blockTimeGroup').style.display = document.getElementById('blockType').value === 'range' ? 'block' : 'none';
        }
        
        function showAddBlockModal() { document.getElementById('addBlockModal').style.display = 'flex'; toggleBlockTime(); }
        function closeAddBlockModal() { document.getElementById('addBlockModal').style.display = 'none'; }
        function closeAddAdminModal() { document.getElementById('addAdminModal').style.display = 'none'; }
        
        function setupPhoneMask(inputId) {
            const phoneInput = document.getElementById(inputId);
            if (phoneInput) phoneInput.addEventListener('input', () => {
                let digits = phoneInput.value.replace(/\D/g, '');
                if (digits.startsWith('7') || digits.startsWith('8')) digits = digits.substring(1);
                let formatted = '+7 (';
                if (digits.length > 0) formatted += digits.substring(0, 3);
                if (digits.length > 3) formatted += `) ${digits.substring(3, 6)}`;
                if (digits.length > 6) formatted += `-${digits.substring(6, 8)}`;
                if (digits.length > 8) formatted += `-${digits.substring(8, 10)}`;
                phoneInput.value = formatted;
            });
        }
        
        async function fetchSettings() {
            try {
                const settingsDoc = await db.collection(COLLECTIONS.SETTINGS).doc('config').get();
                if (settingsDoc.exists) {
                    appSettings = { ...appSettings, ...settingsDoc.data() };
                }
            } catch(error) {
                console.error("Error fetching settings:", error);
            }
        }

        async function saveSettings(button) {
            await withLoading(button, async() => {
                const cooldownInput = document.getElementById('cooldownSetting');
                const newCooldown = parseInt(cooldownInput.value);
                if (isNaN(newCooldown) || newCooldown < 0) {
                    return showError("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π (0 –∏–ª–∏ –±–æ–ª—å—à–µ).");
                }
                await db.collection(COLLECTIONS.SETTINGS).doc('config').set({ orderCooldownDays: newCooldown }, { merge: true });
                appSettings.orderCooldownDays = newCooldown;
                showCrmSuccess("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
            });
        }

        async function initializeApp() {
            await fetchSettings();
            if (!initTelegram()) {
                showCriticalError("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.");
                return;
            }
            
            if (!(await attemptTelegramAutoLogin())) {
                showWelcomeScreen();
            } else {
                showDashboard();
            }
        }

        function showScheduleForCity(city, element) {
            document.querySelectorAll('.schedule-city-tab, .schedule-form').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById(`schedule-form-${city}`).classList.add('active');
        }

        async function loadSchedule() {
            const tabsContainer = document.getElementById('scheduleCityTabs');
            const formsContainer = document.getElementById('scheduleFormsContainer');
            tabsContainer.innerHTML = '';
            formsContainer.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const days = { monday: "–ü–Ω", tuesday: "–í—Ç", wednesday: "–°—Ä", thursday: "–ß—Ç", friday: "–ü—Ç", saturday: "–°–±", sunday: "–í—Å" };
            let formsHtml = '';
            for (const city of CITIES) {
                 const tab = document.createElement('button');
                 tab.className = 'schedule-city-tab';
                 tab.textContent = city;
                 tab.onclick = () => showScheduleForCity(city, tab);
                 tabsContainer.appendChild(tab);
                 let formHtml = `<div class="schedule-form" id="schedule-form-${city}">`;
                 const scheduleDoc = await db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
                 const scheduleData = scheduleDoc.exists ? scheduleDoc.data() : {};
                 for (const dayKey in days) {
                    formHtml += `<div class="form-group"><label>${days[dayKey]}</label><input type="text" id="schedule_${city}_${dayKey}" value="${scheduleData[dayKey] || ''}" placeholder="12:00-18:00"></div>`;
                 }
                 formsHtml += formHtml + `</div>`;
            }
            formsContainer.innerHTML = formsHtml;
            if(tabsContainer.firstChild) tabsContainer.firstChild.click();
        }

        async function saveSchedule(button) {
            await withLoading(button, async() => {
                const batch = db.batch();
                for (const city of CITIES) {
                    const scheduleRef = db.collection(COLLECTIONS.SCHEDULES).doc(city);
                    const scheduleData = {};
                    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(dayKey => {
                        scheduleData[dayKey] = document.getElementById(`schedule_${city}_${dayKey}`).value.trim();
                    });
                    batch.set(scheduleRef, scheduleData);
                }
                await batch.commit();
                showCrmSuccess("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            });
        }

        async function showUserDetailModal(userId) {
            currentUserDetailId = userId;
            const userDoc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
            if (!userDoc.exists) return;
            const user = userDoc.data();
            const reg = user.registration || user;
            document.getElementById('userDetailTitle').textContent = reg.firstName;
            document.getElementById('userDetailBody').innerHTML = `<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${reg.phone}<br><strong>Instagram:</strong> <a href="https://www.instagram.com/${reg.instagramLogin.replace('@','')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${reg.instagramLogin}</a><br><strong>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:</strong> ${reg.followersCount}<br><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${reg.avgViews}<br><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê ${calculateBloggerRating(user)}<br><strong>–ë–∞–ª–∞–Ω—Å V-–ë–æ–Ω—É—Å–æ–≤:</strong> ${formatVBonus(user.vcoin_balance || 0)}<br><strong>–õ–∏–º–∏—Ç V-–ë–æ–Ω—É—Å–æ–≤:</strong> ${formatVBonus(user.vcoin_allowance || 0)}`;
            
            const resetCooldownBtn = document.getElementById('resetCooldownBtn');
            const vcoinManagementBlock = document.getElementById('vcoinManagementBlock');
            if (user.level === 'micro') {
                resetCooldownBtn.style.display = 'block';
                vcoinManagementBlock.style.display = 'none';
            } else if (user.level && user.level.startsWith('macro')) {
                resetCooldownBtn.style.display = 'none';
                vcoinManagementBlock.style.display = 'block';
            } else {
                resetCooldownBtn.style.display = 'none';
                vcoinManagementBlock.style.display = 'none';
            }

            renderTags(user.tags || []);
            document.getElementById('userDetailModal').style.display = 'flex';
        }
        
        async function manageVcoins(action) {
            if (!currentUserDetailId) return;
            const amountInput = document.getElementById('vcoinManageAmount');
            const amount = parseInt(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                return showError("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.");
            }
            
            const actionText = action === 'add' ? '–Ω–∞—á–∏—Å–ª–∏—Ç—å' : '—Å–ø–∏—Å–∞—Ç—å';
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${actionText} ${amount} V-–ë–æ–Ω—É—Å–æ–≤?`)) {
                return;
            }

            try {
                const response = await apiFetch('/api/manage-vcoins', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: currentUserDetailId,
                        amount: amount,
                        action: action
                    })
                });
                
                showCrmSuccess("–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω!", response.message);
                amountInput.value = ''; // Clear input
                await showUserDetailModal(currentUserDetailId); // Refresh the modal data
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ ${action === 'add' ? '–Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏' : '—Å–ø–∏—Å–∞–Ω–∏–∏'} V-–ë–æ–Ω—É—Å–æ–≤:`, error);
                showError("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error.message);
            }
        }

        function renderTags(tags) {
            const container = document.getElementById('userTagsContainer');
            container.innerHTML = tags.length ? tags.map(tag => `<span class="tag">${tag} <span class="remove-tag" onclick="app.removeUserTag('${tag}')">√ó</span></span>`).join('') : `<p style="font-size: 12px; color: #999;">–¢–µ–≥–æ–≤ –Ω–µ—Ç.</p>`;
        }

        async function addUserTag() {
            const input = document.getElementById('newTagInput');
            const newTag = input.value.trim().toLowerCase();
            if (!newTag || !currentUserDetailId) return;

            const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw "User not found";
                const tags = userDoc.data().tags || [];
                if (!tags.includes(newTag)) {
                    tags.push(newTag);
                    transaction.update(userRef, { tags: tags });
                    renderTags(tags);
                }
            });
            input.value = '';
        }

        async function removeUserTag(tagToRemove) {
            if (!tagToRemove || !currentUserDetailId) return;
            const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw "User not found";
                const tags = userDoc.data().tags || [];
                const updatedTags = tags.filter(t => t !== tagToRemove);
                transaction.update(userRef, { tags: updatedTags });
                renderTags(updatedTags);
            });
        }
        
        function showReportModal(orderId, orderNumber) {
            currentReportingOrderId = orderId;
            document.getElementById('reportModalTitle').textContent = `–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É ${orderNumber}`;
            document.getElementById('reportModal').style.display = 'flex';
        }

        async function submitReport(button) {
            await withLoading(button, async() => {
                const reportLink = document.getElementById('reportLink').value.trim();
                if (!reportLink.startsWith('http')) return showError('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É.');
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentReportingOrderId);
                const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserId);
                const batch = db.batch();
                batch.update(orderRef, { status: 'awaiting_review', reportLink: reportLink });
                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const orders = (userDoc.data().orders || []).map(o => o.id === currentReportingOrderId ? {...o, status: 'awaiting_review'} : o);
                    batch.update(userRef, { orders: orders });
                }
                await batch.commit();
                closeReportModal();
                showSuccessMessage("–í–∞—à –æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!");
            });
        }
        
        async function getTagStats() {
            const tagStats = {};
            const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
            usersSnapshot.forEach(doc => {
                (doc.data().tags || []).forEach(tag => {
                    tagStats[tag] = (tagStats[tag] || 0) + 1;
                });
            });
            return tagStats;
        }
        
        async function setupBroadcastTagInput() {
            const input = document.getElementById('broadcastTagInput');
            const suggestionsContainer = document.getElementById('tagSuggestions');
            const selectedContainer = document.getElementById('broadcastTagsContainer');
            const tagStats = await getTagStats();
            const availableTags = Object.keys(tagStats);

            const addTag = (tag) => {
                if (!tag || Array.from(selectedContainer.children).some(el => el.dataset.tag === tag)) return;
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.dataset.tag = tag;
                tagEl.innerHTML = `${tag} <span class="remove-tag">√ó</span>`;
                tagEl.querySelector('.remove-tag').onclick = () => {
                    tagEl.remove();
                };
                selectedContainer.appendChild(tagEl);
                input.value = '';
                suggestionsContainer.style.display = 'none';
            };

            input.addEventListener('focus', () => {
                renderSuggestions('');
                suggestionsContainer.style.display = 'block';
            });

            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') addTag(input.value.trim().toLowerCase());
                else renderSuggestions(input.value.toLowerCase());
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#broadcastTagInput') && !e.target.closest('#tagSuggestions')) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            function renderSuggestions(filter) {
                suggestionsContainer.innerHTML = '';
                availableTags.filter(tag => tag.includes(filter)).forEach(tag => {
                    const item = document.createElement('div');
                    item.className = 'tag-suggestion-item';
                    item.innerHTML = `<span>${tag}</span> <span class="user-count">${tagStats[tag]} —á–µ–ª.</span>`;
                    item.onclick = () => addTag(tag);
                    suggestionsContainer.appendChild(item);
                });
            }
        }

        function copyPlaceholder(element) {
            const textToCopy = element.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = element.textContent;
                element.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                element.style.background = '#28a745';
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.background = '#4a4a4a';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        
        async function updateMenuItemsListCrm() {
            const list = document.getElementById('menuItemsListCrm');
            list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</div>';
            try {
                const snapshot = await db.collection(COLLECTIONS.MENU).orderBy('name').get();
                if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-state">–ë–ª—é–¥ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ!</div>';
                    return;
                }
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const el = document.createElement('div');
                    el.className = `user-item ${item.isVisible === false ? 'hidden-item' : ''}`;
                    el.dataset.search = item.name.toLowerCase();

                    const imageHtml = item.imageUrl 
                        ? `<img src="${item.imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px;">` 
                        : `<div style="width: 50px; height: 50px; background: #4a4a4a; border-radius: 8px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üç¥</div>`;

                    el.innerHTML = `
                        <div class="user-details">
                            ${imageHtml}
                            <div>
                                <span class="user-name-phone">${item.name}</span>
                                <div style="font-size: 14px; color: #ccc;">
                                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.category} | –¶–µ–Ω–∞: ${item.price} ‚Ç∏
                                </div>
                            </div>
                        </div>
                        <div class="user-controls">
                           <button class="btn-secondary btn-small" onclick="event.stopPropagation(); app.toggleMenuItemVisibility('${item.id}', ${item.isVisible !== false})">
                                ${item.isVisible !== false ? 'üëÅÔ∏è –°–∫—Ä—ã—Ç—å' : 'üôà –ü–æ–∫–∞–∑–∞—Ç—å'}
                           </button>
                           <button class="btn-secondary btn-small" onclick="event.stopPropagation(); app.showMenuItemModal('${item.id}')">–†–µ–¥.</button>
                           <button class="btn-danger-icon" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); app.deleteMenuItem('${item.id}')">üóëÔ∏è</button>
                        </div>`;
                    list.appendChild(el);
                });
            } catch (error) {
                console.error("Error fetching menu items:", error);
                list.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é.</div>';
            }
        }
        
        async function toggleMenuItemVisibility(itemId, currentVisibility) {
            const itemRef = db.collection(COLLECTIONS.MENU).doc(itemId);
            try {
                await itemRef.update({ isVisible: !currentVisibility });
                updateMenuItemsListCrm();
            } catch (error) {
                console.error("Error toggling visibility:", error);
                showError("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª—é–¥–∞.");
            }
        }


        async function showMenuItemModal(itemId = null) {
            const form = document.getElementById('menuItemForm');
            form.reset();
            const title = document.getElementById('menuItemModalTitle');
            const idField = document.getElementById('menuItemEditId');
            const oldImageUrlField = document.getElementById('menuItemOldImageUrl');

            if (itemId) {
                title.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ";
                idField.value = itemId;
                const doc = await db.collection(COLLECTIONS.MENU).doc(itemId).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('menuItemName').value = data.name;
                    document.getElementById('menuItemDesc').value = data.description || '';
                    document.getElementById('menuItemPrice').value = data.price;
                    document.getElementById('menuItemCategory').value = data.category;
                    document.getElementById('menuItemSubcategory').value = data.subcategory || '';
                    oldImageUrlField.value = data.imageUrl || '';
                }
            } else {
                title.textContent = "–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ";
                idField.value = '';
                oldImageUrlField.value = '';
            }
            document.getElementById('menuItemModal').style.display = 'flex';
        }

        async function saveMenuItem(button) {
             await withLoading(button, async() => {
                const editId = document.getElementById('menuItemEditId').value;
                const name = document.getElementById('menuItemName').value;
                const description = document.getElementById('menuItemDesc').value;
                const price = parseFloat(document.getElementById('menuItemPrice').value);
                const category = document.getElementById('menuItemCategory').value;
                const subcategory = document.getElementById('menuItemSubcategory').value;
                const imageFile = document.getElementById('menuItemImage').files[0];
                let imageUrl = document.getElementById('menuItemOldImageUrl').value; 

                if (!name || isNaN(price)) {
                    return showError("–û—à–∏–±–∫–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                }

                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);

                    try {
                        button.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ...';
                        const result = await apiFetch('/api/upload-menu-image', {
                            method: 'POST',
                            body: formData
                        });
                        if (!result.success) {
                            throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.');
                        }
                        imageUrl = result.imageUrl;
                    } catch (error) {
                        console.error(error);
                        return showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', error.message);
                    }
                }
                
                const menuItemData = { name, description, price, category, subcategory, imageUrl, isVisible: true };
                
                if (editId) {
                    await db.collection(COLLECTIONS.MENU).doc(editId).set(menuItemData, { merge: true });
                } else {
                    await db.collection(COLLECTIONS.MENU).add(menuItemData);
                }

                closeSimpleModal('menuItemModal');
                showCrmSuccess("–ë–ª—é–¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                updateMenuItemsListCrm();
            });
        }

        async function deleteMenuItem(itemId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ? –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Å–∞–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–∏–Ω–≥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è.')) {
                try {
                    await db.collection(COLLECTIONS.MENU).doc(itemId).delete();
                    showCrmSuccess("–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ.");
                    updateMenuItemsListCrm();
                } catch(error) {
                    console.error("Error deleting menu item:", error);
                    showError("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ.");
                }
            }
        }

        async function exportToExcel(button, dataType) {
            await withLoading(button, async () => {
                let data;
                if (dataType === 'orders') {
                    const snapshot = await db.collection(COLLECTIONS.ORDERS).orderBy('createdAt', 'desc').get();
                    data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    const snapshot = await db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get();
                    data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                await apiFetch(`/api/export-${dataType}`, {
                    method: 'POST',
                    body: JSON.stringify({ data: data, chatId: telegramUser.id })
                });

                showCrmSuccess("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!", `Excel-—Ñ–∞–π–ª –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.`);
            });
        }
        
        async function loadAndRenderMenu() {
            const container = document.getElementById('menu-items-container');
            const mainTabsContainer = document.getElementById('menu-categories');
            
            container.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</div>';
            mainTabsContainer.innerHTML = '';
            cart = {};
            
            const budget = userData.vcoin_balance || 0;
            currentOrderData.budget = budget;
            document.getElementById('menuBudgetDisplay').innerHTML = `–í–∞—à –±—é–¥–∂–µ—Ç: <strong>${formatVBonus(budget)}</strong>`;
            
            updateCartView();

            try {
                const snapshot = await db.collection(COLLECTIONS.MENU).where("isVisible", "==", true).get();
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state">–ú–µ–Ω—é –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ.</div>';
                    return;
                }
                container.innerHTML = '';

                const menuData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const categoryOrder = ["–°–µ—Ç—ã", "–†–æ–ª–ª—ã", "–ü–∏—Ü—Ü–∞", "–í–û–ö / –¢–û–ú-–Ø–ú", "–ó–∞–∫—É—Å–∫–∏", "–ù–∞–ø–∏—Ç–∫–∏", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ"];
                const categories = {};
                menuData.forEach(item => {
                    if (!categories[item.category]) categories[item.category] = {};
                    const subcategory = item.subcategory || '–û—Å–Ω–æ–≤–Ω–æ–µ';
                    if (!categories[item.category][subcategory]) categories[item.category][subcategory] = [];
                    categories[item.category][subcategory].push(item);
                });

                const sortedCategories = Object.keys(categories).sort((a, b) => {
                    const indexA = categoryOrder.indexOf(a);
                    const indexB = categoryOrder.indexOf(b);
                    if (indexA === -1) return 1; if (indexB === -1) return -1;
                    return indexA - indexB;
                });
                
                sortedCategories.forEach((catName) => {
                    const categoryId = `category-${catName.replace(/[\s/]/g, '-')}`;
                    const tab = document.createElement('a');
                    tab.className = 'menu-category-tab';
                    tab.textContent = catName;
                    tab.href = `#${categoryId}`;
                    tab.dataset.categoryId = categoryId;
                    mainTabsContainer.appendChild(tab);

                    const section = document.createElement('div');
                    section.className = 'menu-section';
                    section.id = categoryId;
                    
                    const catTitle = document.createElement('h2');
                    catTitle.className = 'menu-category-title';
                    catTitle.textContent = catName;
                    section.appendChild(catTitle);

                    for (const subcatName in categories[catName]) {
                        if (Object.keys(categories[catName]).length > 1 && subcatName !== '–û—Å–Ω–æ–≤–Ω–æ–µ') {
                            const subcatTitle = document.createElement('h3');
                            subcatTitle.className = 'menu-subcategory-title';
                            subcatTitle.textContent = subcatName;
                            section.appendChild(subcatTitle);
                        }

                        const grid = document.createElement('div');
                        grid.className = 'menu-items-grid';
                        categories[catName][subcatName].forEach(item => {
                           grid.appendChild(createMenuItemCard(item));
                        });
                        section.appendChild(grid);
                    }
                    container.appendChild(section);
                });
                setupMenuObserver();

            } catch (error) {
                console.error("Error loading menu:", error);
                container.innerHTML = '<div class="empty-state">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é.</div>';
            }
        }
        
        function setupMenuObserver() {
            if (menuObserver) menuObserver.disconnect();

            const options = {
                root: null, 
                rootMargin: '-40% 0px -60% 0px',
                threshold: 0
            };

            menuObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const tab = document.querySelector(`.menu-category-tab[data-category-id="${id}"]`);
                    if (entry.isIntersecting && tab) {
                        document.querySelectorAll('.menu-category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                });
            }, options);

            document.querySelectorAll('.menu-section').forEach(section => {
                menuObserver.observe(section);
            });
        }

        function createMenuItemCard(item) {
             const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" class="menu-item-image" alt="${item.name}">
                    <div class="menu-item-info">
                        <div class="menu-item-content-wrapper">
                            <div class="menu-item-name">${item.name}</div>
                            <div class="menu-item-desc">${item.description || ''}</div>
                        </div>
                        <div class="menu-item-footer">
                            <div class="menu-item-price">${formatVBonus(item.price / VCOIN_RATE)}</div>
                            <div class="menu-item-controls">
                                <button class="quantity-btn" onclick="app.removeFromCart('${item.id}')">-</button>
                                <span class="item-quantity">0</span>
                                <button class="quantity-btn" onclick="app.addToCart({id: '${item.id}', name: '${item.name}', price: ${item.price}})">+</button>
                            </div>
                        </div>
                    </div>
                `;
            return card;
        }

        function addToCart(item) {
            if (!cart[item.id]) {
                cart[item.id] = { ...item, quantity: 0 };
            }
            cart[item.id].quantity++;
            updateCartView();
        }

        function removeFromCart(itemId) {
            if (cart[itemId]) {
                cart[itemId].quantity--;
                if (cart[itemId].quantity <= 0) {
                    delete cart[itemId];
                }
                updateCartView();
            }
        }

        function updateCartView() {
            let totalVCoins = 0;
            let count = 0;

            document.querySelectorAll('.menu-item-card').forEach(card => {
                const itemId = card.dataset.id;
                const quantityEl = card.querySelector('.item-quantity');
                quantityEl.textContent = cart[itemId] ? cart[itemId].quantity : 0;
            });

            for (const itemId in cart) {
                totalVCoins += (cart[itemId].price / VCOIN_RATE) * cart[itemId].quantity;
                count += cart[itemId].quantity;
            }

            const cartFab = document.getElementById('cart-fab');
            if (count > 0) {
                const budget = currentOrderData.budget || 0;
                const summaryEl = document.getElementById('cart-summary-value');
                let summaryHTML = `${formatVBonus(totalVCoins)} / ${formatVBonus(budget)}`;
                
                const progressBar = document.getElementById('cart-progress-bar');
                const progressPercent = Math.min((totalVCoins / budget) * 100, 100);
                progressBar.style.width = `${progressPercent}%`;

                if (totalVCoins > budget) {
                    const overdraftTenge = (totalVCoins - budget) * VCOIN_RATE;
                    summaryHTML += ` <strong style="color: #ff6b35; margin-left: 8px;">(+${overdraftTenge.toFixed(0)} ‚Ç∏)</strong>`;
                    summaryEl.style.color = '#fff';
                    progressBar.classList.add('overdraft');
                } else {
                    summaryEl.style.color = '#fff';
                    progressBar.classList.remove('overdraft');
                }
                summaryEl.innerHTML = summaryHTML;
                cartFab.style.display = 'block';
            } else {
                cartFab.style.display = 'none';
            }
        }

        function checkBalanceAndProceed() {
            const totalVCoins = Object.values(cart).reduce((sum, item) => sum + (item.price / VCOIN_RATE) * item.quantity, 0);
            const budget = currentOrderData.budget || 0;

            currentOrderData.items = Object.values(cart).map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity }));
            currentOrderData.vcoin_cost = totalVCoins;
            currentOrderData.payment_due_tenge = 0;
            
            if (totalVCoins > budget) {
                const overdraftVCoins = totalVCoins - budget;
                const overdraftTenge = overdraftVCoins * VCOIN_RATE;
                currentOrderData.payment_due_tenge = overdraftTenge;

                const totalTenge = totalVCoins * VCOIN_RATE;
                const message = `
                    <strong>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</strong> ${formatVBonus(totalVCoins)} (~${totalTenge.toLocaleString('ru-RU')} ‚Ç∏)<br>
                    <strong>–í–∞—à –±—é–¥–∂–µ—Ç:</strong> ${formatVBonus(budget)}<br>
                    <hr style="border-color: #4a4a4a; margin: 10px 0;">
                    <strong>–ö –¥–æ–ø–ª–∞—Ç–µ: ${overdraftTenge.toLocaleString('ru-RU')} ‚Ç∏</strong><br><br>
                    –°—É–º–º—É –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—É–¥–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?
                `;
                document.getElementById('overdraftMessage').innerHTML = message;
                document.getElementById('overdraftModal').style.display = 'flex';
            } else {
                proceedToDateTimeSelection();
            }
        }
        
        function proceedToDateTimeSelection() {
            closeSimpleModal('overdraftModal');
            showDateTimeSelection();
            setupTimeSelection();
        }
        
        const exportOrdersToExcel = (btn) => exportToExcel(btn, 'orders');
        const exportUsersToExcel = (btn) => exportToExcel(btn, 'users');
        
        function triggerMenuImport() {
            document.getElementById('menuFileInput').click();
        }

        async function handleMenuFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const importButton = document.getElementById('importMenuBtn');
            
            await withLoading(importButton, async () => {
                const formData = new FormData();
                formData.append('menuFile', file);

                const result = await apiFetch('/api/import-menu-from-file', {
                    method: 'POST',
                    body: formData
                });
                
                showCrmSuccess("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!", result.message);
                updateMenuItemsListCrm();
            });
            event.target.value = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            ['loginPhone', 'phone', 'recipientPhone', 'editPhone'].forEach(setupPhoneMask);
            setTimeout(initializeApp, 100);
        });

        return {
            showRegistration, showLogin, showWelcomeScreen, submitLogin, submitRegistration, 
            submitMigration, showDashboard, logout, startCollaboration, proceedToAddressFromSet,
            showOrderHistory, editProfile, contactAdmin, showCRM, showCrmTab, filterOrders, 
            filterUsers, filterAdminUsers, filterMenuItems, removeBlock, removeAdmin, removeUser, toggleUserBlock, 
            sendBroadcast, saveSettings, addBlock, addAdmin, selectSet, showSetSelection, 
            showAddressForm, showDateTimeSelection, showInstructions, handleCityChange, 
            submitAddressAndShowDateTime, setupTimeSelection, validateTimeSelection, submitOrder, saveProfile, closeModal, 
            closeSimpleModal, closeErrorModal, closeRejectionModal, closeOrderHistory, 
            closeEditProfile, closeContactModal, showAddBlockModal, closeAddBlockModal, 
            showAddAdminModal, closeAddAdminModal, closeOrderDetailModal, toggleBlockTime, 
            updateOrderStatus, showReportModal, closeReportModal, submitReport, loadSchedule, 
            saveSchedule, showUserDetailModal, closeUserDetailModal, addUserTag, removeUserTag, 
            resetOrderCooldown, showScheduleForCity, applyAnalyticsFilters, toggleAdminNotifications,
            markNoReport, markReportAccepted, copyPlaceholder,
            exportOrdersToExcel, exportUsersToExcel,
            updateMenuItemsListCrm, showMenuItemModal, saveMenuItem, deleteMenuItem,
            showMenuScreen, addToCart, removeFromCart,
            triggerMenuImport, handleMenuFileSelect, toggleMenuItemVisibility,
            manageVcoins,
            checkBalanceAndProceed, proceedToDateTimeSelection
        };
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бартер для блогеров</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS стили остаются без изменений */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2a2a2a;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Стиль для корректного копирования текста */
        .modal-body, .order-info, .user-details, .blocked-slot-info, .report-link, .user-name-phone, .order-id, .subtitle {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Главная страница */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }

        .logo-container {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 180, 216, 0.3);
            animation: pulse 2s infinite;
        }

        .logo-icon {
            font-size: 60px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 30px;
        }


        h1 {
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #999;
            font-size: 16px;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a5a5a;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            margin: 5px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger-icon {
            background: transparent;
            border: none;
            color: #dc3545;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .btn-danger-icon:hover {
            color: #ff6b6b;
        }

        /* СТИЛИ ДЛЯ ИКОНОК */
        .btn-icon, .btn-icon-block, .btn-icon-unblock {
             background: transparent;
             border: none;
             font-size: 20px;
             cursor: pointer;
             padding: 5px;
             transition: color 0.2s, opacity 0.2s;
        }
        .btn-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-icon-block {
            color: #ffc107;
        }
        .btn-icon-block:hover:not(:disabled) {
            color: #ffdd7a;
        }
        .btn-icon-unblock {
            color: #28a745;
        }
        .btn-icon-unblock:hover:not(:disabled) {
            color: #34ce57;
        }


        .btn-danger:hover {
            background: #c82333;
        }

        /* Формы */
        .form-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .form-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 14px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #00b4d8;
            background: #404040;
        }

        .input-error {
            border-color: #dc3545 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .btn-back {
            background: #4a4a4a;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #5a5a5a;
        }

        /* Личный кабинет */
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .user-card {
            background: linear-gradient(135deg, #3a3a3a, #4a4a4a);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 180, 216, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(45deg) translateX(-100%); }
            100% { transform: rotate(45deg) translateX(100%); }
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
            position: relative;
            z-index: 1;
            padding: 0; 
            overflow: hidden; 
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        .user-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .user-level {
            display: inline-block;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .user-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #00b4d8;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .dashboard-actions {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4a4a4a;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .report-action-card {
            border-color: #ffc107;
        }
        
        .strikes-panel {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }


        .action-card:hover {
            border-color: #00b4d8;
            transform: translateY(-2px);
        }

        .action-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .action-desc {
            font-size: 14px;
            color: #999;
        }

        /* CRM панель */
        .crm-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .crm-header {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .crm-tabs, .schedule-city-tabs {
            display: flex;
            background: #3a3a3a;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .crm-tab, .schedule-city-tab {
            flex: 1;
            padding: 15px 10px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .crm-tab.active, .schedule-city-tab.active {
            background: #00b4d8;
            color: white;
        }

        .crm-tab:hover, .schedule-city-tab:hover {
            color: white;
        }
        
        .schedule-form {
            display: none;
        }
        
        .schedule-form.active {
            display: block;
        }


        .crm-content {
            display: none;
        }

        .crm-content.active {
            display: block;
        }

        .crm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .crm-stat-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .crm-stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #00b4d8;
        }

        .crm-stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .orders-list {
            background: #3a3a3a;
            border-radius: 15px;
            overflow: hidden;
        }

        .order-item {
            padding: 20px;
            border-bottom: 1px solid #4a4a4a;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .order-item:hover {
            background: #404040;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: 600;
            color: #00b4d8;
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new { background: #ff6b35; color: white; }
        .status-confirmed { background: #00b4d8; color: white; }
        .status-delivered { background: #28a745; color: white; }
        .status-awaiting_review { background: #6f42c1; color: white; }
        .status-completed { background: #17a2b8; color: white; }
        .status-rejected { background: #6c757d; color: white; }


        .order-info {
            font-size: 14px;
            color: #ccc;
            line-height: 1.5;
        }
        .report-link {
            display: block;
            margin-top: 10px;
            color: #00b4d8;
            font-weight: bold;
            word-break: break-all;
        }

        /* Блокировки времени */
        .blocked-slots {
            margin-bottom: 20px;
        }

        .blocked-slot {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .blocked-slot-info {
            flex: 1;
        }

        .blocked-slot-city {
            font-weight: 600;
            color: #00b4d8;
        }

        .blocked-slot-time {
            color: #ccc;
            font-size: 14px;
        }

        /* Управление пользователями */
        .user-item {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
            transition: background 0.3s ease;
        }
        .user-item.blocked {
            border-left: 4px solid #dc3545;
        }

        .user-item:hover {
            background: #404040;
        }

        .user-details {
            flex-grow: 1;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-name-phone {
            font-weight: 600;
            color: #00b4d8;
        }
        
        .user-rating {
            font-size: 14px;
            font-weight: bold;
            color: #ffc107;
        }

        .user-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-admin-badge {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            text-transform: capitalize;
        }
        
        .user-blocked-badge {
            font-size: 12px;
            color: #dc3545;
            font-weight: bold;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #3a3a3a;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            animation: fadeIn 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            text-align: left;
        }
        .modal-header h2 {
            margin: 0;
        }
        .modal-body {
            text-align: left;
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
        }
        .modal-body strong {
            color: #fff;
        }
        
        /* Теги */
        .tags-container {
            margin-top: 10px;
            min-height: 30px;
        }
        .tag {
            display: inline-block;
            background-color: #00b4d8;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }
        .tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .input-with-button {
            display: flex;
            align-items: center;
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 12px;
            transition: border-color 0.3s ease;
            margin-top: 15px;
        }
        .input-with-button:focus-within {
            border-color: #00b4d8;
        }
        .input-with-button input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 15px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }
        .input-with-button button {
            background: #00b4d8;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 0 20px;
            height: 54px;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .input-with-button button:hover {
            background: #0099b8;
        }


        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #28a745;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ff4444;
        }
        
        
        /* Файловая загрузка */
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
            margin: 10px 0;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            background: #3a3a3a;
            border: 2px dashed #4a4a4a;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            border-color: #00b4d8;
        }

        .warning-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        .blocked-message {
             background: #dc3545;
             color: white;
             padding: 20px;
             border-radius: 15px;
             margin-bottom: 20px;
             text-align: left;
             line-height: 1.5;
        }


        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }

        .admin-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #00b4d8);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            transform: scale(1.1);
        }

        /* Выбор набора */
        .set-selection {
            display: none;
        }

        .set-item {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .set-item:hover {
            border-color: #00b4d8;
            transform: translateY(-2px);
        }

        .set-item.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .set-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .set-description {
            color: #999;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Календарь и время */
        .datetime-selection {
            display: none;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            border-color: #00b4d8;
        }

        .time-slot.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #555;
            display: none; 
        }

        /* Инструкции */
        .instructions {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .checklist {
            list-style: none;
            margin: 15px 0;
        }

        .checklist li {
            padding: 8px 0;
            position: relative;
            padding-left: 30px;
        }

        .checklist li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #00b4d8;
            font-weight: bold;
        }

        /* Статус индикаторы */
        .loading-indicator {
            color: #00b4d8;
            font-size: 14px;
            padding: 15px;
            text-align: center;
            background: rgba(0, 180, 216, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .empty-state {
            color: #999;
            font-size: 14px;
            padding: 40px 20px;
            text-align: center;
            background: #3a3a3a;
            border-radius: 15px;
            margin: 20px 0;
        }

        .telegram-info {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #00b4d8;
        }

        /* Контакты администратора */
        .admin-contact {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .contact-link {
            display: inline-block;
            background: #00b4d8;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .contact-link:hover {
            background: #0099b8;
            transform: translateY(-2px);
        }

        /* Миграция данных */
        .migration-info {
            background: #ff6b35;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        /* Адаптивность */
        @media (max-width: 380px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .btn-primary {
                padding: 15px 30px;
                font-size: 16px;
            }
        }

        /* Scrollbar стилизация */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Дополнительные стили для форм */
        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .search-input {
            width: 100%;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            margin-bottom: 15px;
        }

        .search-input:focus {
            border-color: #00b4d8;
            outline: none;
        }
        
       /* Новые стили для Аналитики */
        .analytics-filters {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .chart-container {
            background: #3a3a3a;
            padding: 20px 15px;
            border-radius: 15px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
        }
        .chart-container canvas {
            max-height: 220px;
        }
        
        /* Стили для подсказок тегов */
        .tag-suggestions-container {
            max-height: 150px;
            overflow-y: auto;
            background: #404040;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
            position: absolute;
            width: calc(100% - 40px);
            z-index: 1001;
        }
        .tag-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tag-suggestion-item:hover {
            background: #5a5a5a;
        }
        .tag-suggestion-item .user-count {
            color: #999;
            font-size: 12px;
            background: #333;
            padding: 2px 8px;
            border-radius: 10px;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- ЭКРАН: Для критических ошибок -->
        <div id="criticalErrorScreen" class="welcome-screen" style="display: none;">
            <div class="logo-container" style="background: #dc3545;">
                <div class="logo-icon" style="font-size: 50px;">🔌</div>
            </div>
            <h1>Ошибка подключения</h1>
            <p class="subtitle" id="criticalErrorMessage">Потеряна связь с Telegram.<br>Пожалуйста, перезагрузите приложение.</p>
            <button class="btn-primary" onclick="window.location.reload()">Перезагрузить</button>
        </div>

        <!-- ЭКРАН: Приветственный (ЗАМЕНЕН) -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="https://i.ibb.co/bJCb3N5/logo.png" alt="logo">
                </div>
            </div>
            <h1>Бартер для блогеров</h1>
            <p class="subtitle">Эксклюзивное предложение<br>для блогеров и инфлюенсеров</p>
            <div class="welcome-buttons">
                 <button class="btn-primary" onclick="app.showRegistration()">Начать</button>
                 <button class="btn-secondary" onclick="app.showLogin()" style="margin-top: 15px;">У меня есть аккаунт</button>
                 
                 <!-- Кнопки отладки -->
                 <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #4a4a4a;">
                     <p style="font-size: 14px; color: #999; margin-bottom: 15px;">Отладка входа:</p>
                     <button class="btn-secondary btn-small" onclick="app.testTelegram()" style="margin: 5px;">🔍 Проверить Telegram</button>
                     <button class="btn-secondary btn-small" onclick="app.forceLogin()" style="margin: 5px;">🔄 Принудительный вход</button>
                     <button class="btn-secondary btn-small" onclick="showTelegramDebugInfo()" style="margin: 5px;">📋 Показать данные</button>
                 </div>
            </div>
            <div class="auto-login-info" id="autoLoginInfo" style="display: none;">
                <div class="loading-indicator">
                    🔄 Выполняется автоматический вход через Telegram...
                </div>
            </div>
            
            <!-- Панель отладочной информации -->
            <div id="debugInfo" style="display: none; margin-top: 20px; padding: 15px; background: #3a3a3a; border-radius: 12px; text-align: left; font-size: 12px; font-family: monospace; max-width: 100%; word-break: break-all;">
                <h4>Отладочная информация:</h4>
                <div id="debugContent"></div>
            </div>
        </div>

        <!-- ЭКРАН: Вход -->
        <div id="loginScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Вход в аккаунт</h2>
                <p class="subtitle">Для старых аккаунтов с паролем</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">Номер телефона *</label>
                    <input type="tel" id="loginPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="loginInstagram">Логин Instagram *</label>
                    <input type="text" id="loginInstagram" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль *</label>
                    <input type="password" id="loginPassword" required placeholder="Введите пароль">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitLogin(this)">Войти</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
            <div class="telegram-info">
                <h4 style="color: #00b4d8; margin-bottom: 10px;">💡 Автоматический вход</h4>
                <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                    Если вы открыли приложение через Telegram бот, система попытается найти ваш аккаунт автоматически. 
                    Эта форма входа нужна только для аккаунтов, у которых был установлен пароль.
                </p>
            </div>
        </div>

        <!-- ЭКРАН: Регистрация -->
        <div id="registrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Регистрация</h2>
                <p class="subtitle">Заполните информацию о себе</p>
            </div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">Имя *</label>
                    <input type="text" id="firstName" required placeholder="Ваше имя">
                </div>
                <div class="form-group">
                    <label for="phone">Номер телефона *</label>
                    <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="instagramLogin">Логин Instagram *</label>
                    <input type="text" id="instagramLogin" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="followersCount">Количество подписчиков *</label>
                    <input type="number" id="followersCount" required placeholder="Например: 5000" min="1" max="10000000">
                </div>
                <div class="form-group">
                    <label for="avgViews">Среднее количество просмотров сторис *</label>
                    <input type="number" id="avgViews" required placeholder="Например: 500" min="1" max="10000000">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitRegistration(this)">Зарегистрироваться</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
        </div>

        <!-- ЭКРАН: Миграция (установка пароля) -->
        <div id="migrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Установка пароля</h2>
                <p class="subtitle">Для вашего старого аккаунта нужно установить пароль</p>
            </div>
            <div class="migration-info">
                <p>Мы нашли ваш аккаунт, но у него нет пароля. Пожалуйста, установите новый пароль для безопасности.</p>
            </div>
            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationPassword">Новый пароль *</label>
                    <input type="password" id="migrationPassword" required placeholder="Придумайте пароль (минимум 6 символов)">
                </div>
                <div class="form-group">
                    <label for="migrationPasswordConfirm">Повторите пароль *</label>
                    <input type="password" id="migrationPasswordConfirm" required placeholder="Повторите пароль">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitMigration(this)">Установить пароль</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
        </div>

        <!-- ЭКРАН: Личный кабинет -->
        <div id="dashboardScreen" class="dashboard" style="display: none;">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">👤</div>
                <div class="user-name" id="userName"></div>
                <div id="userLevel" class="user-level"></div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="followersDisplay">0</div>
                        <div class="stat-label">Подписчики</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="viewsDisplay">0</div>
                        <div class="stat-label">Просмотры</div>
                    </div>
                </div>
            </div>
             <div id="blockedPanel" class="blocked-message" style="display: none;"></div>
             <div id="strikesPanel" class="strikes-panel" style="display: none;"></div>
             <div id="statusPanel" class="action-card" style="display: none; border-color: #00b4d8; text-align: left;"></div>
             <div id="cooldownPanel" class="action-card" style="display: none; background: #4a4a4a; border-color: #5a5a5a; text-align: center; cursor: default;"></div>
             <div id="loyaltyPanel" class="action-card" style="display: none; border-color: #ffc107; text-align: center; cursor: default;"></div>
             <div id="reportActionsPanel" class="dashboard-actions" style="margin-top: 20px;"></div>
            <div class="dashboard-actions">
                <div id="newCollaborationBtn" class="action-card" onclick="app.startCollaboration()">
                    <div class="action-icon">🎯</div>
                    <div class="action-title">Новое сотрудничество</div>
                    <div class="action-desc">Оформить заказ на бартер</div>
                </div>
                <div class="action-card" onclick="app.showOrderHistory()">
                    <div class="action-icon">📋</div>
                    <div class="action-title">История заказов</div>
                    <div class="action-desc">Просмотреть предыдущие заказы</div>
                </div>
                <div class="action-card" onclick="app.editProfile()">
                    <div class="action-icon">⚙️</div>
                    <div class="action-title">Редактировать профиль</div>
                    <div class="action-desc">Изменить данные аккаунта</div>
                </div>
                <div class="action-card" onclick="app.contactAdmin()">
                    <div class="action-icon">📞</div>
                    <div class="action-title">Связаться с администратором</div>
                    <div class="action-desc">Задать вопрос или получить помощь</div>
                </div>
            </div>
            <button class="btn-secondary" onclick="app.logout()">Выйти из аккаунта</button>
        </div>

        <!-- Остальные экраны и модальные окна остаются без изменений... -->
        
    </div>

    <div class="admin-panel" id="adminPanel" style="display: none;">
        <button class="admin-btn" onclick="app.showCRM()" title="Панель управления">⚙️</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        const app = (function() {
    
            const BACKEND_URL = 'https://vesla.onrender.com';
            const TELEGRAM_BOT_TOKEN = '8227812944:AAFy8ydOkUeCj3Qkjg7_Xsq6zyQpcUyMShY';
            
            const firebaseConfig = {
                apiKey: "AIzaSyATmIapS6SJi7KnvKrJp5sfD9VMXxKMCgA",
                authDomain: "vesla-barter.firebaseapp.com",
                projectId: "vesla-barter",
                storageBucket: "vesla-barter.firebasestorage.app",
                messagingSenderId: "730193371508",
                appId: "1:730193371508:web:a6517d156f2766ece50c21",
                measurementId: "G-1QJ9RRS1L6"
            };
            
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const FieldValue = firebase.firestore.FieldValue;

            const COLLECTIONS = {
                USERS: 'users',
                ORDERS: 'orders',
                ADMINS: 'admins',
                BLOCKED_SLOTS: 'blockedSlots',
                SCHEDULES: 'schedules',
                SETTINGS: 'settings'
            };
            const SCREENS = {
                WELCOME: 'welcomeScreen',
                REGISTRATION: 'registrationScreen',
                LOGIN: 'loginScreen',
                MIGRATION: 'migrationScreen',
                DASHBOARD: 'dashboardScreen',
                CRM: 'crmScreen',
                SET_SELECTION: 'setSelectionScreen',
                ADDRESS: 'addressScreen',
                DATE_TIME: 'dateTimeScreen',
                INSTRUCTIONS: 'instructionsScreen',
                CRITICAL_ERROR: 'criticalErrorScreen'
            };

            let tg;
            let telegramUser = null;
            let currentUserId = null;
            let userData = {};
            let migrationUser = null;
            let currentOrderData = {};
            let currentUserRole = null;
            let cityChart, ordersTrendChart, bloggerLevelChart, followersDistributionChart;
            let currentEditingOrderId = null;
            let currentReportingOrderId = null;
            let currentUserDetailId = null;
            let userListenerUnsubscribe = null;
            let appSettings = { orderCooldownDays: 7 };
            const LOYALTY_THRESHOLD = 5;
            
            const CITIES = ["Павлодар", "Петропавловск", "Кокшетау", "Костанай", "Усть-Каменогорск"];

            function showCriticalError(message) {
                document.getElementById('criticalErrorMessage').innerHTML = message;
                document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen').forEach(s => s.style.display = 'none');
                document.getElementById(SCREENS.CRITICAL_ERROR).style.display = 'flex';
            }
            
            // =================================================================
            // НАЧАЛО: НОВЫЙ БЛОК ИНИЦИАЛИЗАЦИИ TELEGRAM
            // =================================================================
            
            let telegramInitAttempts = 0;
            const MAX_TELEGRAM_INIT_ATTEMPTS = 100;

            // Функция для получения Telegram данных с множественными попытками
            function getTelegramData() {
                console.log('=== Getting Telegram Data - Attempt', telegramInitAttempts + 1, '===');
                
                if (!window.Telegram) {
                    console.log('window.Telegram not available');
                    return null;
                }
                
                if (!window.Telegram.WebApp) {
                    console.log('window.Telegram.WebApp not available');
                    return null;
                }
                
                const tg = window.Telegram.WebApp;
                console.log('Telegram WebApp object:', tg);
                console.log('initData:', tg.initData);
                console.log('initDataUnsafe:', tg.initDataUnsafe);
                
                // Метод 1: initDataUnsafe.user
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    console.log('✅ Found user via initDataUnsafe.user');
                    return {
                        tg: tg,
                        user: tg.initDataUnsafe.user
                    };
                }
                
                // Метод 2: Парсинг initData вручную
                if (tg.initData && tg.initData.length > 0) {
                    console.log('Trying to parse initData manually...');
                    try {
                        const params = new URLSearchParams(tg.initData);
                        const userStr = params.get('user');
                        if (userStr) {
                            const userData = JSON.parse(decodeURIComponent(userStr));
                            console.log('✅ Found user via initData parsing:', userData);
                            return {
                                tg: tg,
                                user: userData
                            };
                        }
                    } catch (e) {
                        console.log('Failed to parse initData:', e);
                    }
                }
                
                // Метод 3: Попытка получить ID из других источников
                if (tg.initDataUnsafe) {
                    console.log('Checking for alternative user data sources...');
                    const alternatives = ['from', 'chat', 'sender'];
                    for (const alt of alternatives) {
                        if (tg.initDataUnsafe[alt] && tg.initDataUnsafe[alt].id) {
                            console.log(`✅ Found user ID via ${alt}:`, tg.initDataUnsafe[alt]);
                            return {
                                tg: tg,
                                user: tg.initDataUnsafe[alt]
                            };
                        }
                    }
                }
                
                console.log('❌ No user data found');
                return { tg: tg, user: null };
            }

            // Новая функция инициализации Telegram
            function initTelegramWithRetry() {
                return new Promise((resolve) => {
                    const attemptInit = () => {
                        telegramInitAttempts++;
                        console.log(`Telegram init attempt ${telegramInitAttempts}/${MAX_TELEGRAM_INIT_ATTEMPTS}`);
                        
                        const result = getTelegramData();
                        
                        if (result && result.user && result.user.id) {
                            tg = result.tg;
                            tg.ready();
                            tg.expand();
                            
                            telegramUser = result.user;
                            currentUserId = 'tg_' + telegramUser.id;
                            
                            console.log('✅ Telegram initialized successfully');
                            console.log('User:', telegramUser);
                            console.log('Generated user ID:', currentUserId);
                            
                            resolve(true);
                            return;
                        }
                        
                        if (telegramInitAttempts >= MAX_TELEGRAM_INIT_ATTEMPTS) {
                            console.log('❌ Max attempts reached, Telegram init failed');
                            resolve(false);
                            return;
                        }
                        
                        setTimeout(attemptInit, 100);
                    };
                    
                    attemptInit();
                });
            }

            // Обновленная функция initializeApp
            async function initializeApp() {
                console.log('=== App Initialization Started ===');
                
                try {
                    await fetchSettings();
                    
                    console.log('Waiting for Telegram initialization...');
                    const telegramSuccess = await initTelegramWithRetry();
                    
                    if (!telegramSuccess) {
                        console.log('Telegram init failed, checking environment...');
                        
                        const isTestEnvironment = window.location.hostname.includes('localhost') || 
                                                window.location.hostname.includes('127.0.0.1') ||
                                                window.location.hostname.includes('.local');
                        
                        if (isTestEnvironment) {
                            console.log('Test environment detected, using mock data');
                            telegramUser = { id: 123456789, first_name: 'Test User', username: 'testuser' };
                            currentUserId = 'tg_' + telegramUser.id;
                        } else {
                            showCriticalError(`
                                Не удалось подключиться к Telegram WebApp.<br><br>
                                • Приложение запущено не через Telegram бота<br>
                                • Проблемы с загрузкой скрипта Telegram<br>
                                • Устаревшая версия Telegram<br><br>
                                <b>Попробуйте:</b><br>
                                • Перезагрузить страницу<br>
                                • Обновить Telegram до последней версии<br>
                                • Запустить через бота заново
                            `);
                            return;
                        }
                    }
                    
                    console.log('Attempting automatic login...');
                    document.getElementById('autoLoginInfo').style.display = 'block';
                    
                    try {
                        const existingUser = await loadUser(currentUserId);
                        
                        if (existingUser) {
                            console.log('Found existing user:', existingUser);
                            
                            if (migrateOldAccount(existingUser)) {
                                console.log('User needs migration');
                                document.getElementById('autoLoginInfo').style.display = 'none';
                                showScreen(SCREENS.MIGRATION);
                                return;
                            }
                            
                            userData = existingUser;
                            await saveUser(currentUserId, { 
                                lastActivity: new Date().toISOString(),
                                telegramData: telegramUser 
                            });
                            
                            await checkAndSetUserRole();
                            attachUserListener(currentUserId);
                            
                            document.getElementById('autoLoginInfo').style.display = 'none';
                            showDashboard();
                            return;
                        }
                    } catch (error) {
                        console.error('Error during auto login:', error);
                        showError('Ошибка входа', 'Произошла ошибка при попытке входа: ' + error.message);
                    }
                    
                    document.getElementById('autoLoginInfo').style.display = 'none';
                    showWelcomeScreen();
                    
                } catch (error) {
                    console.error('Critical error during initialization:', error);
                    showCriticalError('Критическая ошибка: ' + error.message);
                }
            }

            function testTelegramConnection() {
                console.log('=== Manual Telegram Test ===');
                getTelegramData();
                
                console.log('Available Telegram objects in window:');
                for (let key in window) {
                    if (key.toLowerCase().includes('telegram')) {
                        console.log(`window.${key}:`, window[key]);
                    }
                }
                showTelegramDebugInfo();
            }

            function forceLogin() {
                console.log('=== Force Login ===');
                // Сбрасываем счетчик попыток и запускаем инициализацию заново
                telegramInitAttempts = 0;
                initializeApp();
            }

            // =================================================================
            // КОНЕЦ: НОВЫЙ БЛОК ИНИЦИАЛИЗАЦИИ TELEGRAM
            // =================================================================

            function ensureAuthenticated() {
                if (!currentUserId || !telegramUser) {
                    console.error("Authentication lost. Reloading...");
                    window.location.reload();
                    return false;
                }
                return true;
            }

            async function generateOrderNumber(city) {
                // ... (остальной код остается без изменений)
            }

            // ... (ВЕСЬ ОСТАЛЬНОЙ КОД ВАШЕГО ПРИЛОЖЕНИЯ) ...
            // Убедитесь, что все ваши старые функции, такие как saveUser, loadUser, 
            // showDashboard, submitRegistration и т.д., остаются здесь.
            // Я оставил заглушки для наглядности.
            
            function attachUserListener(userId) { /* ... ваш код ... */ }
            function hashPassword(password) { /* ... ваш код ... */ }
            function validatePassword(password) { /* ... ваш код ... */ }
            async function getUserRole(userId) { /* ... ваш код ... */ }
            async function checkAndSetUserRole() { /* ... ваш код ... */ }
            function migrateOldAccount(userInfo) { /* ... ваш код ... */ }
            async function saveUser(userId, data) { /* ... ваш код ... */ }
            async function loadUser(userId) { /* ... ваш код ... */ }
            async function findUserByCredentials(phone, instagram, password) { /* ... ваш код ... */ }
            // ... и так далее для всех ваших функций
            
            // ОБНОВИТЕ ЭТОТ БЛОК
            return {
                showRegistration, showLogin, showWelcomeScreen, submitLogin, submitRegistration, 
                submitMigration, showDashboard, logout, startCollaboration, proceedToAddressFromSet,
                showOrderHistory, editProfile, contactAdmin, showCRM, showCrmTab, filterOrders, 
                filterUsers, filterAdminUsers, removeBlock, removeAdmin, removeUser, toggleUserBlock, 
                sendBroadcast, saveSettings, addBlock, addAdmin, selectSet, showSetSelection, 
                showAddressForm, showDateTimeSelection, showInstructions, handleCityChange, 
                submitAddressAndShowDateTime, updateTimeSlots, submitOrder, saveProfile, closeModal, 
                closeSimpleModal, closeErrorModal, closeRejectionModal, closeOrderHistory, 
                closeEditProfile, closeContactModal, showAddBlockModal, closeAddBlockModal, 
                showAddAdminModal, closeAddAdminModal, closeOrderDetailModal, toggleBlockTime, 
                updateOrderStatus, showReportModal, closeReportModal, submitReport, loadSchedule, 
                saveSchedule, showUserDetailModal, closeUserDetailModal, addUserTag, removeUserTag, 
                resetOrderCooldown, showScheduleForCity, applyAnalyticsFilters, toggleAdminNotifications,
                markNoReport, markReportAccepted,
                // Новые функции для отладки
                forceLogin,
                testTelegram: testTelegramConnection
            };
        })();

        // =================================================================
        // НАЧАЛО: НОВЫЙ ОБРАБОТЧИК ЗАГРУЗКИ DOM
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            
            ['loginPhone', 'phone', 'recipientPhone', 'editPhone'].forEach(setupPhoneMask);
            
            window.testTelegram = app.testTelegram;
            console.log('Use testTelegram() in console to debug');
            
            // Увеличиваем задержку до 1 секунды для надежности
            setTimeout(app.initializeApp, 1000); 
        });
        
        // Эта функция была в вашем исходном коде, оставляем ее на всякий случай, если DOM уже загружен
        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            console.log('Document already loaded, initializing after a delay');
            setTimeout(() => {
                ['loginPhone', 'phone', 'recipientPhone', 'editPhone'].forEach(setupPhoneMask);
                app.initializeApp();
            }, 1000);
        }
        // =================================================================
        // КОНЕЦ: НОВЫЙ ОБРАБОТЧИК ЗАГРУЗКИ DOM
        // =================================================================
    </script>

    <!-- НОВЫЙ СКРИПТ ДЛЯ ОТОБРАЖЕНИЯ ОТЛАДОЧНОЙ ИНФОРМАЦИИ -->
    <script>
    function showTelegramDebugInfo() {
        const debugPanel = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        
        let info = '';
        
        info += `<b>window.Telegram:</b> ${!!window.Telegram}<br>`;
        info += `<b>window.Telegram.WebApp:</b> ${!!window.Telegram?.WebApp}<br>`;
        
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            info += `<b>WebApp.ready:</b> ${typeof tg.ready}<br>`;
            info += `<b>WebApp.initData:</b> ${tg.initData ? `есть (${tg.initData.length} симв.)` : 'пусто'}<br>`;
            info += `<b>WebApp.initDataUnsafe:</b> ${tg.initDataUnsafe ? 'есть объект' : 'пусто'}<br>`;
            
            if (tg.initDataUnsafe) {
                info += `<b>initDataUnsafe.user:</b> ${tg.initDataUnsafe.user ? 'есть' : 'нет'}<br>`;
                if (tg.initDataUnsafe.user) {
                    info += `... User ID: ${tg.initDataUnsafe.user.id}<br>`;
                    info += `... User Name: ${tg.initDataUnsafe.user.first_name}<br>`;
                }
            }
            
            if (tg.initData) {
                info += `<b>Raw initData:</b> ${tg.initData.substring(0, 100)}...<br>`;
            }
        }
        
        info += `<b>Current User ID:</b> ${currentUserId || 'не установлен'}<br>`;
        info += `<b>Telegram User:</b> ${telegramUser ? JSON.stringify(telegramUser) : 'не найден'}<br>`;
        
        info += `<br><b>Среда:</b><br>`;
        info += `URL: ${window.location.href}<br>`;
        info += `User Agent: ${navigator.userAgent.substring(0, 50)}...<br>`;
        
        debugContent.innerHTML = info;
        debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
    }

    // Глобальная функция для вызова из консоли
    window.showDebugInfo = showTelegramDebugInfo;
    
    // Вспомогательная функция для масок (если она не была в основном скрипте)
    function setupPhoneMask(inputId) {
        const phoneInput = document.getElementById(inputId);
        if (phoneInput) phoneInput.addEventListener('input', () => {
            let digits = phoneInput.value.replace(/\D/g, '');
            if (digits.startsWith('7') || digits.startsWith('8')) digits = digits.substring(1);
            let formatted = '+7 (';
            if (digits.length > 0) formatted += digits.substring(0, 3);
            if (digits.length > 3) formatted += `) ${digits.substring(3, 6)}`;
            if (digits.length > 6) formatted += `-${digits.substring(6, 8)}`;
            if (digits.length > 8) formatted += `-${digits.substring(8, 10)}`;
            phoneInput.value = formatted;
        });
    }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2a2a2a;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }

        .logo-container {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 180, 216, 0.3);
            animation: pulse 2s infinite;
        }

        .logo-icon {
            font-size: 60px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 30px;
        }


        h1 {
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #999;
            font-size: 16px;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #4a4a4a;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a5a5a;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            margin: 5px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger-icon {
            background: transparent;
            border: none;
            color: #dc3545;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .btn-danger-icon:hover {
            color: #ff6b6b;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ö–û–ù–û–ö –ë–õ–û–ö–ò–†–û–í–ö–ò */
        .btn-icon-block, .btn-icon-unblock {
             background: transparent;
             border: none;
             font-size: 20px;
             cursor: pointer;
             padding: 5px;
             transition: color 0.2s;
        }
        .btn-icon-block {
            color: #ffc107;
        }
        .btn-icon-block:hover {
            color: #ffdd7a;
        }
        .btn-icon-unblock {
            color: #28a745;
        }
        .btn-icon-unblock:hover {
            color: #34ce57;
        }


        .btn-danger:hover {
            background: #c82333;
        }

        /* –§–æ—Ä–º—ã */
        .form-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .form-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 14px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #00b4d8;
            background: #404040;
        }

        .input-error {
            border-color: #dc3545 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .btn-back {
            background: #4a4a4a;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #5a5a5a;
        }

        /* –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç */
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .user-card {
            background: linear-gradient(135deg, #3a3a3a, #4a4a4a);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 180, 216, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(45deg) translateX(-100%); }
            100% { transform: rotate(45deg) translateX(100%); }
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
            position: relative;
            z-index: 1;
            padding: 0; 
            overflow: hidden; 
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        .user-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .user-level {
            display: inline-block;
            background: linear-gradient(135deg, #00b4d8, #ff6b35);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .user-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #00b4d8;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .dashboard-actions {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4a4a4a;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .report-action-card {
            border-color: #ffc107;
        }

        .action-card:hover {
            border-color: #00b4d8;
            transform: translateY(-2px);
        }

        .action-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .action-desc {
            font-size: 14px;
            color: #999;
        }

        /* CRM –ø–∞–Ω–µ–ª—å */
        .crm-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .crm-header {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .crm-tabs, .schedule-city-tabs {
            display: flex;
            background: #3a3a3a;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .crm-tab, .schedule-city-tab {
            flex: 1;
            padding: 15px 10px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .crm-tab.active, .schedule-city-tab.active {
            background: #00b4d8;
            color: white;
        }

        .crm-tab:hover, .schedule-city-tab:hover {
            color: white;
        }
        
        .schedule-form {
            display: none;
        }
        
        .schedule-form.active {
            display: block;
        }


        .crm-content {
            display: none;
        }

        .crm-content.active {
            display: block;
        }

        .crm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .crm-stat-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .crm-stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #00b4d8;
        }

        .crm-stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .orders-list {
            background: #3a3a3a;
            border-radius: 15px;
            overflow: hidden;
        }

        .order-item {
            padding: 20px;
            border-bottom: 1px solid #4a4a4a;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .order-item:hover {
            background: #404040;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: 600;
            color: #00b4d8;
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new { background: #ff6b35; color: white; }
        .status-confirmed { background: #00b4d8; color: white; }
        .status-delivered { background: #28a745; color: white; }
        .status-awaiting_review { background: #6f42c1; color: white; }
        .status-completed { background: #17a2b8; color: white; }
        .status-rejected { background: #6c757d; color: white; }


        .order-info {
            font-size: 14px;
            color: #ccc;
            line-height: 1.5;
        }
        .report-link {
            display: block;
            margin-top: 10px;
            color: #00b4d8;
            font-weight: bold;
            word-break: break-all;
        }

        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ */
        .blocked-slots {
            margin-bottom: 20px;
        }

        .blocked-slot {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .blocked-slot-info {
            flex: 1;
        }

        .blocked-slot-city {
            font-weight: 600;
            color: #00b4d8;
        }

        .blocked-slot-time {
            color: #ccc;
            font-size: 14px;
        }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ */
        .user-item {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
            transition: background 0.3s ease;
        }
        .user-item.blocked {
            border-left: 4px solid #dc3545;
        }

        .user-item:hover {
            background: #404040;
        }

        .user-details {
            flex-grow: 1;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-name-phone {
            font-weight: 600;
            color: #00b4d8;
        }
        
        .user-rating {
            font-size: 14px;
            font-weight: bold;
            color: #ffc107;
        }

        .user-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-admin-badge {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
        }
        
        .user-blocked-badge {
            font-size: 12px;
            color: #dc3545;
            font-weight: bold;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #3a3a3a;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            animation: fadeIn 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            text-align: left;
        }
        .modal-header h2 {
            margin: 0;
        }
        .modal-body {
            text-align: left;
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
        }
        .modal-body strong {
            color: #fff;
        }
        
        /* –¢–µ–≥–∏ */
        .tags-container {
            margin-top: 10px;
            min-height: 30px;
        }
        .tag {
            display: inline-block;
            background-color: #00b4d8;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }
        .tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-tag-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }


        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #28a745;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ff4444;
        }
        
        
        /* –§–∞–π–ª–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ */
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
            margin: 10px 0;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            background: #3a3a3a;
            border: 2px dashed #4a4a4a;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            border-color: #00b4d8;
        }

        .warning-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        .blocked-message {
             background: #dc3545;
             color: white;
             padding: 20px;
             border-radius: 15px;
             margin-bottom: 20px;
             text-align: left;
             line-height: 1.5;
        }


        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }

        .admin-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #00b4d8);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            transform: scale(1.1);
        }

        /* –í—ã–±–æ—Ä –Ω–∞–±–æ—Ä–∞ */
        .set-selection {
            display: none;
        }

        .set-item {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .set-item:hover {
            border-color: #00b4d8;
            transform: translateY(-2px);
        }

        .set-item.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .set-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .set-description {
            color: #999;
            font-size: 14px;
            line-height: 1.4;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≤—Ä–µ–º—è */
        .datetime-selection {
            display: none;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            border-color: #00b4d8;
        }

        .time-slot.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #555;
            display: none; 
        }

        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
        .instructions {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .checklist {
            list-style: none;
            margin: 15px 0;
        }

        .checklist li {
            padding: 8px 0;
            position: relative;
            padding-left: 30px;
        }

        .checklist li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #00b4d8;
            font-weight: bold;
        }

        /* –°—Ç–∞—Ç—É—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .loading-indicator {
            color: #00b4d8;
            font-size: 14px;
            padding: 15px;
            text-align: center;
            background: rgba(0, 180, 216, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .empty-state {
            color: #999;
            font-size: 14px;
            padding: 40px 20px;
            text-align: center;
            background: #3a3a3a;
            border-radius: 15px;
            margin: 20px 0;
        }

        .telegram-info {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #00b4d8;
        }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
        .admin-contact {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .contact-link {
            display: inline-block;
            background: #00b4d8;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .contact-link:hover {
            background: #0099b8;
            transform: translateY(-2px);
        }

        /* –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö */
        .migration-info {
            background: #ff6b35;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 380px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .btn-primary {
                padding: 15px 30px;
                font-size: 16px;
            }
        }

        /* Scrollbar —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º */
        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .search-input {
            width: 100%;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            margin-bottom: 15px;
        }

        .search-input:focus {
            border-color: #00b4d8;
            outline: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π–¥–µ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
        .analytics-slider {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .analytics-wrapper {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .analytics-slide {
            flex: 0 0 100%;
            width: 100%;
            padding: 0 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –ø–æ –±–æ–∫–∞–º */
        }
        .chart-container {
            background: #3a3a3a;
            padding: 20px 15px;
            border-radius: 15px;
            height: 300px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
            display: flex;
            flex-direction: column;
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
        }
        .chart-container canvas {
            max-height: 220px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Å–∞–º–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ */
        }
        .slider-dots {
            text-align: center;
            margin-top: 15px;
        }
        .slider-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4a4a4a;
            margin: 0 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .slider-dot.active {
            background: #00b4d8;
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="welcomeScreen" class="welcome-screen">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø">
                </div>
            </div>
            <h1>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</h1>
            <p class="subtitle">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ<br>–¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ –∏ –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä–æ–≤</p>
            <div class="welcome-buttons">
                 <button class="btn-primary" onclick="app.showRegistration()">–ù–∞—á–∞—Ç—å</button>
            </div>
            <div class="auto-login-info" id="autoLoginInfo" style="display: none;">
                <div class="loading-indicator">
                    üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram...
                </div>
            </div>
        </div>

        <div id="loginScreen" class="form-screen">
            <div class="form-header">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <p class="subtitle">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="loginPhone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div class="form-group">
                    <label for="loginInstagram">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="loginInstagram" required placeholder="@username">
                </div>

                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="loginPassword" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>

                <button type="button" class="btn-primary" onclick="app.submitLogin(this)">–í–æ–π—Ç–∏</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>

            <div class="telegram-info">
                <h4 style="color: #00b4d8; margin-bottom: 10px;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</h4>
                <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                    –ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. 
                    –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, Instagram –∏ –ø–∞—Ä–æ–ª—å –∏–∑ –≤–∞—à–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
                </p>
            </div>
        </div>

        <div id="registrationScreen" class="form-screen">
            <div class="form-header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</p>
            </div>

            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">–ò–º—è *</label>
                    <input type="text" id="firstName" required placeholder="–í–∞—à–µ –∏–º—è">
                </div>

                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div class="form-group">
                    <label for="instagramLogin">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="instagramLogin" required placeholder="@username">
                </div>

                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="password" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    <div class="error-message" id="passwordError">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                </div>

                <div class="form-group">
                    <label for="followersCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ *</label>
                    <input type="number" id="followersCount" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" min="1" max="10000000">
                    <div class="error-message" id="followersError">–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (–æ—Ç 1 –¥–æ 10,000,000)</div>
                </div>

                <div class="form-group">
                    <label for="avgViews">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å *</label>
                    <input type="number" id="avgViews" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" min="1" max="10000000">
                    <div class="error-message" id="viewsError">–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–æ—Ç 1 –¥–æ 10,000,000)</div>
                </div>

                <button type="button" class="btn-primary" onclick="app.submitRegistration(this)">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <div id="migrationScreen" class="form-screen">
            <div class="form-header">
                <h2>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è</h2>
                <p class="subtitle">–î–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</p>
            </div>

            <div class="migration-info">
                <p>–ú—ã –Ω–∞—à–ª–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø–∞—Ä–æ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
            </div>

            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPassword" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    <div class="error-message" id="migrationPasswordError">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                </div>

                <div class="form-group">
                    <label for="migrationPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <div class="error-message" id="migrationPasswordConfirmError">–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>
                </div>

                <button type="button" class="btn-primary" onclick="app.submitMigration(this)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <div id="dashboardScreen" class="dashboard">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-name" id="userName"></div>
                <div id="userLevel" class="user-level"></div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="followersDisplay">0</div>
                        <div class="stat-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="viewsDisplay">0</div>
                        <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                    </div>
                </div>
            </div>

             <div id="blockedPanel" class="blocked-message" style="display: none;"></div>
             <div id="statusPanel" class="action-card" style="display: none; border-color: #00b4d8; text-align: left;"></div>
             <div id="reportActionsPanel" class="dashboard-actions" style="margin-top: 20px;"></div>

            <div class="dashboard-actions">
                <div class="action-card" onclick="app.startCollaboration()">
                    <div class="action-icon">üéØ</div>
                    <div class="action-title">–ù–æ–≤–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</div>
                    <div class="action-desc">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –±–∞—Ä—Ç–µ—Ä</div>
                </div>
                <div class="action-card" onclick="app.showOrderHistory()">
                    <div class="action-icon">üìã</div>
                    <div class="action-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="action-desc">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–∫–∞–∑—ã</div>
                </div>
                <div class="action-card" onclick="app.editProfile()">
                    <div class="action-icon">‚öôÔ∏è</div>
                    <div class="action-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="action-desc">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                </div>
                <div class="action-card" onclick="app.contactAdmin()">
                    <div class="action-icon">üìû</div>
                    <div class="action-title">–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</div>
                    <div class="action-desc">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å</div>
                </div>
            </div>

            <button class="btn-secondary" onclick="app.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>

        <div id="crmScreen" class="crm-screen">
            <div class="crm-header">
                <h2>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <button class="btn-back" onclick="app.showDashboard()">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <div class="crm-tabs">
                <button class="crm-tab active" onclick="app.showCrmTab('overview', this)">–û–±–∑–æ—Ä</button>
                <button class="crm-tab" onclick="app.showCrmTab('analytics', this)">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                <button class="crm-tab" onclick="app.showCrmTab('orders', this)">–ó–∞–∫–∞–∑—ã</button>
                <button class="crm-tab" onclick="app.showCrmTab('users', this)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="crm-tab" onclick="app.showCrmTab('schedule', this)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                <button class="crm-tab" onclick="app.showCrmTab('blocks', this)">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</button>
                <button class="crm-tab" onclick="app.showCrmTab('broadcast', this)">–†–∞—Å—Å—ã–ª–∫–∞</button>
                <button class="crm-tab" onclick="app.showCrmTab('admins', this)">–ê–¥–º–∏–Ω—ã</button>
            </div>

            <div id="crmOverview" class="crm-content active">
                <div class="crm-stats">
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalUsers">0</div>
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalOrders">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="newOrders">0</div>
                        <div class="stat-label">–ù–æ–≤—ã–µ</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="blockedSlots">0</div>
                        <div class="stat-label">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                    </div>
                </div>

                <div class="admin-contact">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <a href="https://t.me/AdamRogozhin" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                    <a href="mailto:adamrogozhin@gmail.com" class="contact-link">üìß Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                </div>
            </div>
            
            <div id="crmAnalytics" class="crm-content">
                <h3 style="text-align: center; margin-bottom: 20px;">–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                <div class="analytics-slider">
                    <div class="analytics-wrapper">
                        <div class="analytics-slide">
                            <div class="chart-container">
                                <h3>–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (30 –¥–Ω–µ–π)</h3>
                                <canvas id="ordersTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-slide">
                            <div class="chart-container">
                                <h3>–ó–∞–∫–∞–∑—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º</h3>
                                <canvas id="cityChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-slide">
                             <div class="chart-container">
                                <h3>–£—Ä–æ–≤–Ω–∏ –±–ª–æ–≥–µ—Ä–æ–≤</h3>
                                <canvas id="bloggerLevelChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-slide">
                             <div class="chart-container">
                                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</h3>
                                <canvas id="followersDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="slider-dots" id="analyticsSliderDots"></div>
            </div>

            <div id="crmOrders" class="crm-content">
                <input type="text" id="orderSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, Instagram –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞..." onkeyup="app.filterOrders()">
                <div class="orders-list" id="ordersList"></div>
            </div>

            <div id="crmUsers" class="crm-content">
                <input type="text" id="userSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." onkeyup="app.filterUsers()">
                <div id="usersList"></div>
            </div>

             <div id="crmSchedule" class="crm-content">
                 <div class="form-header">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h2>
                    <p class="subtitle">–£–∫–∞–∂–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Å—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "10:00-14:00" –∏–ª–∏ "10:00-12:00, 14:00-18:00".<br>–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º.</p>
                </div>
                <div id="scheduleCityTabs" class="schedule-city-tabs"></div>
                <div id="scheduleFormsContainer"></div>
                <button class="btn-primary" onclick="app.saveSchedule(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            </div>

            <div id="crmBlocks" class="crm-content">
                <button class="btn-primary" onclick="app.showAddBlockModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</button>
                <div id="blockedSlotsList"></div>
            </div>

             <div id="crmBroadcast" class="crm-content">
                <div class="form-header">
                    <h2>–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h2>
                    <p class="subtitle">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</p>
                </div>
                <div class="form-group">
                    <label for="broadcastTagFilter">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ–º)</label>
                    <input type="text" id="broadcastTagFilter" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ñ—É–¥-–±–ª–æ–≥–µ—Ä">
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                    <textarea id="broadcastMessage" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..."></textarea>
                </div>
                <button class="btn-primary" onclick="app.sendBroadcast(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
                <div class="telegram-info" style="margin-top: 20px;">
                     <h4 style="color: #ffc107; margin-bottom: 10px;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</h4>
                     <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                         –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏. –î–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
                     </p>
                </div>
            </div>

            <div id="crmAdmins" class="crm-content">
                <button class="btn-primary" onclick="app.showAddAdminModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
                <div id="adminsList"></div>
            </div>
        </div>

        <div id="setSelectionScreen" class="form-screen set-selection">
            <button class="btn-back" onclick="app.showDashboard()">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="form-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–±–æ—Ä</h2>
            </div>

            <div class="set-item" data-set-name="–ù–∞–±–æ—Ä 1 '–ö–ª–∞—Å—Å–∏–∫'" onclick="app.selectSet(this, 'set1')">
                <div class="set-title">–ù–∞–±–æ—Ä 1 "–ö–ª–∞—Å—Å–∏–∫"</div>
                <div class="set-description">32 —Ä–æ–ª–ª—ã: –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è –∫–ª–∞—Å—Å–∏–∫ (8—à—Ç), –ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è —Å –∫—Ä–∞–±–æ–º (8—à—Ç), –õ–æ—Å–æ—Å—å —Ç–µ—Ä–∏—è–∫–∏ (8—à—Ç), –¢—É–Ω–µ—Ü —Å–ø–∞–π—Å–∏ (8—à—Ç)</div>
            </div>

            <div class="set-item" data-set-name="–ù–∞–±–æ—Ä 2 '–ü—Ä–µ–º–∏—É–º'" onclick="app.selectSet(this, 'set2')">
                <div class="set-title">–ù–∞–±–æ—Ä 2 "–ü—Ä–µ–º–∏—É–º"</div>
                <div class="set-description">28 —Ä–æ–ª–ª–æ–≤: –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è —Å –ª–æ—Å–æ—Å–µ–º (8—à—Ç), –î—Ä–∞–∫–æ–Ω (6—à—Ç), –†–∞–¥—É–≥–∞ (8—à—Ç), –¢–µ–º–ø—É—Ä–∞ –º–∏–∫—Å (6—à—Ç)</div>
            </div>

            <div class="set-item" data-set-name="–ù–∞–±–æ—Ä 3 '–ú–∏–∫—Å'" onclick="app.selectSet(this, 'set3')">
                <div class="set-title">–ù–∞–±–æ—Ä 3 "–ú–∏–∫—Å"</div>
                <div class="set-description">40 —Ä–æ–ª–ª–æ–≤: –ê—Å—Å–æ—Ä—Ç–∏ –∏–∑ –ª—É—á—à–∏—Ö —Ä–æ–ª–ª–æ–≤ –Ω–µ–¥–µ–ª–∏ + –±–æ–Ω—É—Å–Ω—ã–µ –º–∞–∫–∏ (8—à—Ç)</div>
            </div>

            <button type="button" id="nextFromSet" class="btn-primary" onclick="app.showAddressForm()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="addressScreen" class="form-screen">
            <button class="btn-back" id="backFromAddress" onclick="app.showDashboard()">‚Üê –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            
            <div class="form-header">
                <h2>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
            </div>

            <form id="addressForm">
                <div class="form-group">
                    <label for="city">–ì–æ—Ä–æ–¥ *</label>
                    <select id="city" required onchange="app.handleCityChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                        <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                        <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                        <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                        <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                        <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="street">–£–ª–∏—Ü–∞, –¥–æ–º *</label>
                    <input type="text" id="street" required placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10">
                </div>

                <div class="form-group">
                    <label for="entrance">–ü–æ–¥—ä–µ–∑–¥</label>
                    <input type="text" id="entrance" placeholder="1">
                </div>

                <div class="form-group">
                    <label for="floor">–≠—Ç–∞–∂</label>
                    <input type="text" id="floor" placeholder="5">
                </div>

                <div class="form-group">
                    <label for="recipientPhone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</label>
                    <input type="tel" id="recipientPhone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div id="orderScreenshotGroup" class="form-group" style="display: none;">
                    <label>–°–∫—Ä–∏–Ω—à–æ—Ç –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å—É–º–º—É –±–∞—Ä—Ç–µ—Ä–∞ *</label>
                    <div class="file-upload">
                        <input type="file" id="orderScreenshot" accept="image/*">
                        <label for="orderScreenshot" class="file-upload-label">
                            üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∑–∞–∫–∞–∑–∞
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"></textarea>
                </div>

                <button type="button" class="btn-primary" onclick="app.submitAddressAndShowDateTime()">–î–∞–ª–µ–µ</button>
            </form>
        </div>

        <div id="dateTimeScreen" class="form-screen datetime-selection">
            <button class="btn-back" id="backFromDateTime" onclick="app.showAddressForm()">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="form-header">
                <h2>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
            </div>

            <div class="form-group">
                <label for="deliveryDate">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
                <input type="date" id="deliveryDate" required onchange="app.updateTimeSlots()">
            </div>

            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</label>
                <div class="time-slots" id="timeSlots"></div>
            </div>

            <button type="button" id="nextFromDateTime" class="btn-primary" onclick="app.showInstructions()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="instructionsScreen" class="form-screen">
            <button class="btn-back" onclick="app.showDateTimeSelection()">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="form-header">
                <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å—Ç–æ—Ä–∏—Å</h2>
            </div>

            <div class="instructions">
                <h3>–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏—Å:</h3>
                <ul class="checklist">
                    <li>–£–ø–æ–º—è–Ω—É—Ç—å –±—Ä–µ–Ω–¥ –≤ —Å—Ç–æ—Ä–∏—Å</li>
                    <li>–û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—à Instagram @vesla.kz</li>
                    <li>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É –∏ –µ–¥—É</li>
                    <li>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</li>
                </ul>
                
                <div style="margin-top: 20px;">
                    <strong>–ü—Ä–∏–º–µ—Ä —Ç–µ–∑–∏—Å–∞:</strong><br>
                    <em>"–Ø –∑–∞–∫–∞–∑–∞–ª–∞ —É @vesla.kz ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–æ—Å–º–æ—Å! –û—á–µ–Ω—å –≤–∫—É—Å–Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ!"</em>
                </div>
            </div>

            <div class="warning-message" id="warningMessage">
                ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–Ω–∏—Ç–µ: 3 –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞ ‚Äî –∏ –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ú—ã —É–≤–µ—Ä–µ–Ω—ã, –¥–æ —ç—Ç–æ–≥–æ –Ω–µ –¥–æ–π–¥–µ—Ç! üòä
            </div>

            <button type="button" class="btn-primary" onclick="app.submitOrder(this)">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <div id="successModal" class="modal">
            <div class="modal-content">
                <div class="success-icon">‚úÖ</div>
                <h2 id="successTitle">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>
                <p class="subtitle" id="successMessage">–ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤–∞–º –ø—Ä–∏–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ—Ç—á–µ—Ç–µ</p>
                <button class="btn-primary" onclick="app.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="errorModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">‚ùå</div>
                <h2 id="errorTitle">–û—à–∏–±–∫–∞</h2>
                <p class="subtitle" id="errorMessage"></p>
                <button class="btn-primary" onclick="app.closeErrorModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>

        <div id="rejectionModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">üòî</div>
                <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å!</h2>
                <p class="subtitle">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π –æ—Ç 300 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞—à–∏–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å–∫–æ—Ä–æ —ç—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è!</p>
                <button class="btn-primary" onclick="app.closeRejectionModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>

        <div id="orderHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
                <div id="orderHistoryList" style="text-align: left; max-height: 40vh; overflow-y: auto; margin: 20px 0;"></div>
                <button class="btn-primary" onclick="app.closeOrderHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        
        <div id="orderDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="orderDetailTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
                     <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="markNoReportBtn" class="btn-icon-block" title="–û—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –æ—Ç—á–µ—Ç –Ω–µ —Å–¥–∞–Ω">üö©</button>
                        <button class="btn-danger-icon" id="deleteOrderBtn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑">üóëÔ∏è</button>
                     </div>
                </div>
                <div id="orderDetailBody" class="modal-body"></div>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label for="orderStatusSelect">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <select id="orderStatusSelect" style="width: 100%;">
                         <option value="new">–ù–æ–≤—ã–π</option>
                         <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                         <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                         <option value="awaiting_review">–û—Ç—á–µ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                         <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                         <option value="rejected">–û—Ç—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="app.updateOrderStatus(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn-secondary" onclick="app.closeOrderDetailModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        
        <div id="userDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="userDetailTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                </div>
                <div id="userDetailBody" class="modal-body"></div>
                
                <hr style="border-color: #4a4a4a; margin: 20px 0;">
                
                <div style="text-align: left;">
                    <label>–¢–µ–≥–∏:</label>
                     <div class="add-tag-form">
                        <input type="text" id="newTagInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥..." style="flex: 1; margin-bottom: 0;">
                        <button class="btn-primary btn-small" onclick="app.addUserTag()">+</button>
                    </div>
                    <div id="userTagsContainer" class="tags-container"></div>
                </div>

                <button class="btn-secondary" onclick="app.closeUserDetailModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="reportModal" class="modal">
            <div class="modal-content">
                <h2 id="reportModalTitle">–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç</h2>
                <p class="subtitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–æ—Ä–∏—Å –∏–ª–∏ –ø–æ—Å—Ç</p>
                <div class="form-group" style="text-align: left;">
                    <label for="reportLink">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç *</label>
                    <input type="text" id="reportLink" placeholder="https://instagram.com/stories/...">
                </div>
                <button class="btn-primary" onclick="app.submitReport(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" onclick="app.closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="editProfileModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <form id="editProfileForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="editFirstName">–ò–º—è *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editInstagram">Instagram *</label>
                        <input type="text" id="editInstagram" required>
                    </div>
                    <div class="form-group">
                        <label for="editFollowers">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ *</label>
                        <input type="number" id="editFollowers" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editViews">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã *</label>
                        <input type="number" id="editViews" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ)</label>
                        <input type="password" id="editPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>
                </form>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="app.saveProfile(this)" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeEditProfile()" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="addBlockModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</h2>
                <form id="addBlockForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="blockCity">–ì–æ—Ä–æ–¥ *</label>
                        <select id="blockCity" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                            <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                            <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockDate">–î–∞—Ç–∞ *</label>
                        <input type="date" id="blockDate" required>
                    </div>
                    <div class="form-group">
                        <label for="blockType">–¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ *</label>
                        <select id="blockType" required onchange="app.toggleBlockTime()">
                            <option value="time">–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è</option>
                            <option value="fullday">–í–µ—Å—å –¥–µ–Ω—å</option>
                        </select>
                    </div>
                    <div class="form-group" id="blockTimeGroup">
                        <label for="blockTime">–í—Ä–µ–º—è *</label>
                        <input type="time" id="blockTime">
                    </div>
                    <div class="form-group">
                        <label for="blockReason">–ü—Ä–∏—á–∏–Ω–∞</label>
                        <input type="text" id="blockReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏">
                    </div>
                </form>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="app.addBlock(this)" style="flex: 1;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeAddBlockModal()" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="addAdminModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <input type="text" id="adminUserSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è..." onkeyup="app.filterAdminUsers()">
                <div id="adminUsersList" style="text-align: left; max-height: 40vh; overflow-y: auto;"></div>
                <button class="btn-secondary" onclick="app.closeAddAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="contactModal" class="modal">
            <div class="modal-content">
                <h2>–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h2>
                <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏</p>
                <a href="https://t.me/oderefyu" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                <a href="mailto:adamrogozhin@gmail.com" class="contact-link">üìß Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                <button class="btn-secondary" onclick="app.closeContactModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel" style="display: none;">
        <button class="admin-btn" onclick="app.showCRM()" title="–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å">‚öôÔ∏è</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
const app = (function() {

    // –í–ê–ñ–ù–û: –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. 
    // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –î–û–õ–ñ–ï–ù –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
    const TELEGRAM_BOT_TOKEN = '8227812944:AAFy8ydOkUeCj3Qkjg7_Xsq6zyQpcUyMShY';
    
    const firebaseConfig = {
        apiKey: "AIzaSyATmIapS6SJi7KnvKrJp5sfD9VMXxKMCgA",
        authDomain: "vesla-barter.firebaseapp.com",
        projectId: "vesla-barter",
        storageBucket: "vesla-barter.firebasestorage.app",
        messagingSenderId: "730193371508",
        appId: "1:730193371508:web:a6517d156f2766ece50c21",
        measurementId: "G-1QJ9RRS1L6"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const COLLECTIONS = {
        USERS: 'users',
        ORDERS: 'orders',
        ADMINS: 'admins',
        BLOCKED_SLOTS: 'blockedSlots',
        SCHEDULES: 'schedules'
    };
    const SCREENS = {
        WELCOME: 'welcomeScreen',
        REGISTRATION: 'registrationScreen',
        LOGIN: 'loginScreen',
        MIGRATION: 'migrationScreen',
        DASHBOARD: 'dashboardScreen',
        CRM: 'crmScreen',
        SET_SELECTION: 'setSelectionScreen',
        ADDRESS: 'addressScreen',
        DATE_TIME: 'dateTimeScreen',
        INSTRUCTIONS: 'instructionsScreen'
    };

    let tg;
    let telegramUser = null;
    let currentUserId = null;
    let userData = {};
    let migrationUser = null;
    let currentOrderData = {};
    let isCurrentUserAdmin = false;
    let cityChart, ordersTrendChart, bloggerLevelChart, followersDistributionChart;
    let currentEditingOrderId = null;
    let currentReportingOrderId = null;
    let currentUserDetailId = null;
    let userListenerUnsubscribe = null;

    let currentSlide = 0;
    const totalSlides = 4;
    
    const CITIES = ["–ü–∞–≤–ª–æ–¥–∞—Ä", "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫", "–ö–æ–∫—à–µ—Ç–∞—É", "–ö–æ—Å—Ç–∞–Ω–∞–π", "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫"];

    function generateOrderNumber(city, date, firestoreId) {
        const cityCodes = {
            '–ü–∞–≤–ª–æ–¥–∞—Ä': 'PVL',
            '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫': 'PPK',
            '–ö–æ–∫—à–µ—Ç–∞—É': 'KOK',
            '–ö–æ—Å—Ç–∞–Ω–∞–π': 'KSN',
            '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫': 'UKK'
        };
        const cityCode = cityCodes[city] || 'UNK';
        const dateObj = new Date(date);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = String(dateObj.getFullYear()).slice(-2);
        
        const shortId = firestoreId.substring(0, 4).toUpperCase();
        
        return `${cityCode}-${day}${month}${year}-${shortId}`;
    }

    async function sendTelegramNotification(chatId, message) {
        if (!chatId) return;
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            const result = await response.json();
            if (!result.ok) throw new Error(result.description);
            console.log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –¥–ª—è ${chatId} —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`);
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –¥–ª—è ${chatId}:`, error);
            // –í–∞–∂–Ω–æ: –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        }
    }
    
    async function sendAdminNotification(orderData, screenshotFile) {
        const ADMIN_CHAT_ID = '1345815453';

        let message = `*–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±–∞—Ä—Ç–µ—Ä*

üìù *–ó–∞–∫–∞–∑:* \`${orderData.orderNumber}\`
        
üë§ *–ë–ª–æ–≥–µ—Ä:*
–ò–º—è: ${orderData.userName}
–¢–µ–ª–µ—Ñ–æ–Ω: \`${orderData.phone}\`
Instagram: @${orderData.instagram}
–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${orderData.followersCount.toLocaleString('ru-RU')}
–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã: ${orderData.avgViews.toLocaleString('ru-RU')}
–£—Ä–æ–≤–µ–Ω—å: ${determineBloggerLevel(orderData.followersCount).text}`;
        
        if (orderData.setName) {
            message += `\nüç± *–í—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä:* ${orderData.setName}`;
        }

        message += `

üóì *–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:*
–î–∞—Ç–∞: ${orderData.date}
–í—Ä–µ–º—è: ${orderData.time}

üìç *–î–æ—Å—Ç–∞–≤–∫–∞:*
–ì–æ—Ä–æ–¥: ${orderData.city}
–ê–¥—Ä–µ—Å: ${orderData.street}
–ü–æ–¥—ä–µ–∑–¥: ${orderData.entrance || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–≠—Ç–∞–∂: ${orderData.floor || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è: \`${orderData.recipientPhone}\``;
        
        try {
            if (screenshotFile) {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;
                const formData = new FormData();
                formData.append('chat_id', ADMIN_CHAT_ID);
                formData.append('photo', screenshotFile);
                formData.append('caption', message);
                formData.append('parse_mode', 'Markdown');

                const response = await fetch(url, { method: 'POST', body: formData });
                const result = await response.json();
                if (!result.ok) throw new Error(result.description);

            } else {
                await sendTelegramNotification(ADMIN_CHAT_ID, message);
            }
            console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:', error);
        }
    }

    function initTelegram() {
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    telegramUser = tg.initDataUnsafe.user;
                    currentUserId = 'tg_' + telegramUser.id;
                }
            }
        } catch (error) {
            console.error('Error initializing Telegram:', error);
        }
    }
    
    function attachUserListener(userId) {
        if (userListenerUnsubscribe) {
            userListenerUnsubscribe();
        }
        userListenerUnsubscribe = db.collection(COLLECTIONS.USERS).doc(userId)
            .onSnapshot((doc) => {
                console.log("User data updated in real-time.");
                if (doc.exists) {
                    userData = { userId: doc.id, ...doc.data() };
                    updateDashboard();
                } else {
                    console.log("User document deleted.");
                    logout();
                }
            }, (error) => {
                console.error("Error with real-time listener: ", error);
            });
    }

    function hashPassword(password) {
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
            const char = password.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash &= hash;
        }
        return hash.toString();
    }
    
    function validatePassword(password) { return password && password.length >= 6; }
    function validateNumber(value, min = 1, max = 10000000) {
        const num = parseInt(value);
        return !isNaN(num) && num >= min && num <= max;
    }

    async function isAdmin(userId) {
        if (!userId) return false;
        const checkId = String(userId).replace('tg_','');
        try {
            const adminDoc = await db.collection(COLLECTIONS.ADMINS).doc(checkId).get();
            return adminDoc.exists;
        } catch (error) {
            console.error("Error checking admin status:", error);
            return false;
        }
    }
    
    async function checkAndSetAdminStatus() {
        const checkId = telegramUser ? telegramUser.id : (userData.telegramId || null);
        isCurrentUserAdmin = await isAdmin(checkId);
    }

    function migrateOldAccount(userInfo) {
        if (userInfo && userInfo.registration && !userInfo.registration.password) {
            migrationUser = userInfo;
            return true; 
        }
        return false;
    }

   async function saveUser(userId, data) {
        if (!userId) {
            console.error("User ID is missing, cannot save data.");
            showError("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞", "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
            throw new Error("User ID is missing");
        }
        try {
            await db.collection(COLLECTIONS.USERS).doc(userId).set(data, { merge: true });
        } catch (error) {
            console.error("Error saving data to Firestore: ", error);
            showError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            throw error;
        }
    }

    async function loadUser(userId) {
        try {
            const doc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
            return doc.exists ? { userId: doc.id, ...doc.data() } : null;
        } catch (error) {
            console.error("Error loading user from Firestore:", error);
            return null;
        }
    }
    
    async function findUserByCredentials(phone, instagram, password) {
        try {
            const snapshot = await db.collection(COLLECTIONS.USERS)
                .where('registration.phone', '==', phone)
                .where('registration.instagramLogin', '==', instagram.toLowerCase())
                .get();

            if (snapshot.empty) return null;

            for (const doc of snapshot.docs) {
                const foundUser = { userId: doc.id, ...doc.data() };
                if (foundUser.registration.password === hashPassword(password)) {
                    return foundUser;
                }
            }
            return null;
        } catch (error) {
            console.error("Error finding user by credentials:", error);
            return null;
        }
    }
    
    async function findUserByPhoneAndInstagram(phone, instagram) {
        try {
            const snapshot = await db.collection(COLLECTIONS.USERS)
                .where('registration.phone', '==', phone)
                .where('registration.instagramLogin', '==', instagram.toLowerCase())
                .get();

            if (snapshot.empty) return null;
            
            const userDoc = snapshot.docs[0];
            const foundUser = { userId: userDoc.id, ...userDoc.data() };

            return !foundUser.registration.password ? foundUser : null;
        } catch (error) {
            console.error("Error finding user for migration:", error);
            return null;
        }
    }
    
    async function checkForDuplicateRegistration(phone, instagram, excludeUserId = null) {
        try {
            const phoneQuery = db.collection(COLLECTIONS.USERS).where('registration.phone', '==', phone).get();
            const instagramQuery = db.collection(COLLECTIONS.USERS).where('registration.instagramLogin', '==', instagram.toLowerCase()).get();

            const [phoneSnapshot, instagramSnapshot] = await Promise.all([phoneQuery, instagramQuery]);

            const phoneExists = !phoneSnapshot.empty && phoneSnapshot.docs[0].id !== excludeUserId;
            const instagramExists = !instagramSnapshot.empty && instagramSnapshot.docs[0].id !== excludeUserId;

            return { phoneExists, instagramExists, canRegister: !phoneExists && !instagramExists };
        } catch (error) {
            console.error("Error checking for duplicates:", error);
            return { phoneExists: true, instagramExists: true, canRegister: false };
        }
    }

    async function attemptTelegramAutoLogin() {
        if (!telegramUser) return false;
        
        document.getElementById('autoLoginInfo').style.display = 'block';
        const existingUser = await loadUser('tg_' + telegramUser.id);
        document.getElementById('autoLoginInfo').style.display = 'none';

        if (existingUser) {
            if (migrateOldAccount(existingUser)) {
                showScreen(SCREENS.MIGRATION);
                return false;
            }
            
            currentUserId = existingUser.userId;
            await saveUser(currentUserId, { lastActivity: new Date().toISOString() });
            await checkAndSetAdminStatus();
            attachUserListener(currentUserId);
            return true;
        }
        return false;
    }

    function fillTelegramData() {
        if (telegramUser && telegramUser.first_name) {
            const firstNameField = document.getElementById('firstName');
            if (firstNameField) firstNameField.value = telegramUser.first_name;
        }
    }

    function determineBloggerLevel(followersCount) {
        const count = Number(followersCount) || 0;
        if (count <= 6000) return { level: 'micro', text: '–ú–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä' };
        if (count <= 10500) return { level: 'macro-a', text: '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø A' };
        return { level: 'macro-b', text: '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø B' };
    }

    async function isSlotBlocked(city, date, time) {
        try {
            const timeBlockId = `${city}_${date}_${time}`;
            const timeBlockDoc = db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(timeBlockId).get();
            const dayBlockId = `${city}_${date}_fullday`;
            const dayBlockDoc = db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(dayBlockId).get();
            const [timeBlock, dayBlock] = await Promise.all([timeBlockDoc, dayBlockDoc]);
            return timeBlock.exists || dayBlock.exists;
        } catch (error)
        {
            console.error("Error checking blocked slot:", error);
            return true;
        }
    }

    function showScreen(screenId) {
        document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen').forEach(s => s.style.display = 'none');
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.style.display = (screenId === SCREENS.WELCOME) ? 'flex' : 'block';
        }
    }

    function showDashboard() {
        showScreen(SCREENS.DASHBOARD);
        document.getElementById('adminPanel').style.display = isCurrentUserAdmin ? 'block' : 'none';
    }

    function showWelcomeScreen() { showScreen(SCREENS.WELCOME); }
    function showRegistration() { showScreen(SCREENS.REGISTRATION); fillTelegramData(); }
    function showLogin() { showScreen(SCREENS.LOGIN); }
    function showSetSelection() { showScreen(SCREENS.SET_SELECTION); }
    function showAddressForm() { showScreen(SCREENS.ADDRESS); }
    function showDateTimeSelection() { showScreen(SCREENS.DATE_TIME); }
    function showInstructions() { showScreen(SCREENS.INSTRUCTIONS); }

    async function showCRM() {
        if (!isCurrentUserAdmin) {
            showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
            return;
        }
        showScreen(SCREENS.CRM);
        updateCRMData();
    }

    function showCrmTab(tabName, element) {
        document.querySelectorAll('.crm-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('crm' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        element.classList.add('active');
        
        switch(tabName) {
            case 'overview': updateCRMStats(); break;
            case 'analytics': 
                updateAllAnalytics(); 
                setTimeout(() => goToSlide(0), 10);
                break;
            case 'orders': updateOrdersList(); break;
            case 'users': updateUsersList(); break;
            case 'schedule': loadSchedule(); break;
            case 'blocks': updateBlockedSlotsList(); break;
            case 'admins': updateAdminsList(); break;
            case 'broadcast': break;
        }
    }
    
    async function withLoading(button, asyncFunction) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        try {
            await asyncFunction();
        } catch (error) {
            console.error("Operation failed:", error);
            showError("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. " + error.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }
    
    async function submitLogin(button) {
        await withLoading(button, async () => {
            const phone = document.getElementById('loginPhone').value.trim();
            const instagram = document.getElementById('loginInstagram').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!phone || !instagram || !password) return showError('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            
            const oldUser = await findUserByPhoneAndInstagram(phone, instagram);
            if (oldUser) {
                migrationUser = oldUser;
                showScreen(SCREENS.MIGRATION);
                return;
            }
            
            const existingUser = await findUserByCredentials(phone, instagram, password);
            if (existingUser) {
                currentUserId = existingUser.userId;
                if (telegramUser && !existingUser.telegramId) {
                    await saveUser(currentUserId, { telegramId: telegramUser.id, merge: true });
                }
                await saveUser(currentUserId, { lastActivity: new Date().toISOString() });
                await checkAndSetAdminStatus();
                attachUserListener(currentUserId);
                showDashboard();
            } else {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');
            }
        });
    }

    async function submitMigration(button) {
        await withLoading(button, async () => {
            const password = document.getElementById('migrationPassword').value.trim();
            const passwordConfirm = document.getElementById('migrationPasswordConfirm').value.trim();
            
            if (!validatePassword(password) || password !== passwordConfirm) {
               return showError('–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –∏–ª–∏ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.');
            }

            if (migrationUser) {
                migrationUser.registration.password = hashPassword(password);
                migrationUser.lastActivity = new Date().toISOString();
                if (telegramUser && !migrationUser.telegramId) migrationUser.telegramId = telegramUser.id;
                
                await saveUser(migrationUser.userId, migrationUser);
                
                currentUserId = migrationUser.userId;
                migrationUser = null;
                await checkAndSetAdminStatus();
                attachUserListener(currentUserId);
                showDashboard();
            }
        });
    }

    async function submitRegistration(button) {
        await withLoading(button, async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const instagramLogin = document.getElementById('instagramLogin').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            const followersCount = parseInt(document.getElementById('followersCount').value);
            const avgViews = parseInt(document.getElementById('avgViews').value);

            if (!firstName || !phone || !instagramLogin || !password || isNaN(followersCount) || isNaN(avgViews)) {
                return showError('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            }

            if (avgViews < 300) return showRejectionModal();
            
            const duplicateCheck = await checkForDuplicateRegistration(phone, instagramLogin);
            if (!duplicateCheck.canRegister) {
                let msg = '–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.';
                if (duplicateCheck.phoneExists) msg += '\n‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                if (duplicateCheck.instagramExists) msg += '\n‚Ä¢ Instagram —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                return showError('–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', msg);
            }

            const bloggerData = determineBloggerLevel(followersCount);
            if (!currentUserId) currentUserId = (telegramUser ? 'tg_' + telegramUser.id : db.collection(COLLECTIONS.USERS).doc().id);
            
            const newUser = {
                registration: { firstName, phone, instagramLogin, followersCount, avgViews, password: hashPassword(password) },
                level: bloggerData.level,
                orders: [],
                telegramId: telegramUser ? telegramUser.id : null,
                registrationDate: new Date().toISOString(),
                lastActivity: new Date().toISOString(),
                isBlocked: false,
                blockReason: '',
                strikes: 0,
                tags: []
            };

            await saveUser(currentUserId, newUser);
            await checkAndSetAdminStatus();
            attachUserListener(currentUserId);
            showDashboard();
        });
    }

    function getStatusInfo(status) {
        const statuses = {
            'new': { text: '–ù–æ–≤—ã–π', className: 'status-new' },
            'confirmed': { text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', className: 'status-confirmed' },
            'delivered': { text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', className: 'status-delivered' },
            'awaiting_review': { text: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', className: 'status-awaiting_review' },
            'completed': { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', className: 'status-completed' },
            'rejected': { text: '–û—Ç–∫–ª–æ–Ω–µ–Ω', className: 'status-rejected' }
        };
        return statuses[status] || { text: status, className: '' };
    }

    function updateDashboard() {
        const dataSource = userData.registration || userData;
        if (!dataSource || !dataSource.firstName) return;

        const { firstName, followersCount, avgViews } = dataSource;
        const levelInfo = determineBloggerLevel(followersCount);
        
        const blockedPanel = document.getElementById('blockedPanel');
        if (userData.isBlocked) {
            blockedPanel.innerHTML = `<h4>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h4><p>${userData.blockReason || '–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'}</p>`;
            blockedPanel.style.display = 'block';
        } else {
            blockedPanel.style.display = 'none';
        }


        document.getElementById('userName').textContent = firstName;
        
        const userAvatar = document.getElementById('userAvatar');
        if (telegramUser && telegramUser.photo_url) {
            userAvatar.innerHTML = `<img src="${telegramUser.photo_url}" alt="${firstName}">`;
        } else {
            userAvatar.innerHTML = ''; 
            userAvatar.textContent = firstName ? firstName.charAt(0).toUpperCase() : 'üë§';
        }

        document.getElementById('userLevel').textContent = levelInfo.text;
        document.getElementById('followersDisplay').textContent = (followersCount || 0).toLocaleString('ru-RU');
        document.getElementById('viewsDisplay').textContent = (avgViews || 0).toLocaleString('ru-RU');

        const statusPanel = document.getElementById('statusPanel');
        if (userData.orders && userData.orders.length > 0) {
            const latestOrder = [...userData.orders].sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date))[0];
            let statusMessage = '';
            
            if (latestOrder.status === 'new') {
                statusMessage = `‚è≥ <strong>–í–∞—à –∑–∞–∫–∞–∑ #${latestOrder.orderNumber.split('-')[2]} –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ.</strong> –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`;
            } else if (latestOrder.status === 'confirmed') {
                statusMessage = `‚úÖ <strong>–í–∞—à –∑–∞–∫–∞–∑ #${latestOrder.orderNumber.split('-')[2]} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</strong> –û–∂–∏–¥–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É.`;
            } else if (latestOrder.status === 'awaiting_review') {
                statusMessage = `üôå <strong>–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É #${latestOrder.orderNumber.split('-')[2]} –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ.</strong>`;
            } else if (latestOrder.status === 'rejected') {
                 statusMessage = `‚ùå <strong>–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É #${latestOrder.orderNumber.split('-')[2]} –æ—Ç–∫–ª–æ–Ω–µ–Ω.</strong> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.`;
            }

            if (statusMessage) {
                statusPanel.innerHTML = statusMessage;
                statusPanel.style.display = 'block';
            } else {
                statusPanel.style.display = 'none';
            }
        } else {
            statusPanel.style.display = 'none';
        }

        const reportPanel = document.getElementById('reportActionsPanel');
        reportPanel.innerHTML = '';
        const ordersToReport = (userData.orders || []).filter(order => order.status === 'delivered');
        if(ordersToReport.length > 0) {
            ordersToReport.forEach(order => {
                const card = document.createElement('div');
                card.className = 'action-card report-action-card';
                card.onclick = () => showReportModal(order.id, order.orderNumber);
                card.innerHTML = `
                    <div class="action-icon">üì§</div>
                    <div class="action-title">–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É</div>
                    <div class="action-desc">${order.orderNumber}</div>`;
                reportPanel.appendChild(card);
            });
        }
    }

    // --- CRM –§—É–Ω–∫—Ü–∏–∏ ---
    async function updateCRMData() {
        updateCRMStats();
        const activeTab = document.querySelector('.crm-tab.active');
        if (activeTab) {
            activeTab.click();
        }
    }

    async function updateCRMStats() {
        try {
            const [usersSnap, ordersSnap, newOrdersSnap, blocksSnap] = await Promise.all([
                db.collection(COLLECTIONS.USERS).get(),
                db.collection(COLLECTIONS.ORDERS).get(),
                db.collection(COLLECTIONS.ORDERS).where('status', '==', 'new').get(),
                db.collection(COLLECTIONS.BLOCKED_SLOTS).get()
            ]);

            document.getElementById('totalUsers').textContent = usersSnap.size;
            document.getElementById('totalOrders').textContent = ordersSnap.size;
            document.getElementById('newOrders').textContent = newOrdersSnap.size;
            document.getElementById('blockedSlots').textContent = blocksSnap.size;
        } catch (error) {
            console.error("Error updating CRM stats:", error);
        }
    }
    
    function setupAnalyticsSlider() {
        const wrapper = document.querySelector('.analytics-wrapper');
        const dotsContainer = document.getElementById('analyticsSliderDots');
        if (!wrapper || !dotsContainer) return;

        dotsContainer.innerHTML = '';
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('span');
            dot.classList.add('slider-dot');
            if (i === 0) dot.classList.add('active');
            dot.onclick = () => goToSlide(i);
            dotsContainer.appendChild(dot);
        }

        let startX = 0;
        let endX = 0;

        wrapper.addEventListener('touchstart', (e) => startX = e.touches[0].clientX, { passive: true });
        wrapper.addEventListener('touchend', (e) => {
            endX = e.changedTouches[0].clientX;
            if (startX > endX + 50) {
                goToSlide(currentSlide + 1);
            } else if (startX < endX - 50) {
                goToSlide(currentSlide - 1);
            }
        }, { passive: true });
    }

    function goToSlide(slideIndex) {
        const wrapper = document.querySelector('.analytics-wrapper');
        if (!wrapper) return;
        
        if (slideIndex >= totalSlides) slideIndex = 0;
        if (slideIndex < 0) slideIndex = totalSlides - 1;

        currentSlide = slideIndex;
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;

        document.querySelectorAll('.slider-dot').forEach((dot, index) => {
            dot.classList.toggle('active', index === currentSlide);
        });
    }

    async function updateAllAnalytics() {
        try {
            const [ordersSnap, usersSnap] = await Promise.all([
                db.collection(COLLECTIONS.ORDERS).get(),
                db.collection(COLLECTIONS.USERS).get()
            ]);

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const ordersByDate = {};
            ordersSnap.forEach(doc => {
                const createdAt = new Date(doc.data().createdAt);
                if (createdAt >= thirtyDaysAgo) {
                    const dateString = createdAt.toISOString().split('T')[0];
                    ordersByDate[dateString] = (ordersByDate[dateString] || 0) + 1;
                }
            });
            const sortedDates = Object.keys(ordersByDate).sort();
            const ordersTrendData = sortedDates.map(date => ordersByDate[date]);
            renderChart('ordersTrendChart', 'line', sortedDates, ordersTrendData, '–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤', ordersTrendChart);

            const cityCounts = {};
            ordersSnap.forEach(doc => {
                const city = doc.data().city;
                if (city) cityCounts[city] = (cityCounts[city] || 0) + 1;
            });
            renderChart('cityChart', 'bar', Object.keys(cityCounts), Object.values(cityCounts), '–ó–∞–∫–∞–∑—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º', cityChart);

            const levelCounts = { '–ú–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä': 0, '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø A': 0, '–ú–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä —Ç–∏–ø B': 0 };
            const followerRanges = { '1-5k': 0, '5-10k': 0, '10-20k': 0, '20k+': 0 };
            usersSnap.forEach(doc => {
                const userDocData = doc.data();
                const dataSource = userDocData.registration || userDocData;
                const followers = dataSource.followersCount || 0;
                const levelText = determineBloggerLevel(followers).text;
                if (levelCounts.hasOwnProperty(levelText)) levelCounts[levelText]++;

                if (followers <= 5000) followerRanges['1-5k']++;
                else if (followers <= 10000) followerRanges['5-10k']++;
                else if (followers <= 20000) followerRanges['10-20k']++;
                else followerRanges['20k+']++;
            });
            renderChart('bloggerLevelChart', 'doughnut', Object.keys(levelCounts), Object.values(levelCounts), '–£—Ä–æ–≤–Ω–∏ –±–ª–æ–≥–µ—Ä–æ–≤', bloggerLevelChart);
            renderChart('followersDistributionChart', 'pie', Object.keys(followerRanges), Object.values(followerRanges), '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏', followersDistributionChart);

        } catch(e) { console.error("Analytics error:", e) }
    }
    
    function renderChart(canvasId, type, labels, data, label, chartInstance) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return;
        
        if (chartInstance) chartInstance.destroy();

        const chartColors = [
            'rgba(0, 180, 216, 0.7)',
            'rgba(255, 107, 53, 0.7)',
            'rgba(40, 167, 69, 0.7)',
            'rgba(255, 193, 7, 0.7)',
            'rgba(111, 66, 193, 0.7)'
        ];
        const chartBorderColors = [
            'rgba(0, 180, 216, 1)',
            'rgba(255, 107, 53, 1)',
            'rgba(40, 167, 69, 1)',
            'rgba(255, 193, 7, 1)',
            'rgba(111, 66, 193, 1)'
        ];

        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(0, 180, 216, 0.5)');
        gradient.addColorStop(1, 'rgba(0, 180, 216, 0)');

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: (type === 'line' || type === 'bar') ? { 
                y: { beginAtZero: true, ticks: { color: '#fff', stepSize: 1 } }, 
                x: { ticks: { color: '#fff' } } 
            } : {},
            plugins: { 
                legend: { labels: { color: '#fff' } },
                tooltip: { titleFont: { size: 14 }, bodyFont: { size: 12 } }
            }
        };

        const newChartInstance = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: (type === 'doughnut' || type === 'pie' || type === 'bar') ? chartColors : (type === 'line' ? gradient : '#00b4d8'),
                    borderColor: (type === 'doughnut' || type === 'pie' || type === 'bar') ? chartBorderColors : '#ff6b35',
                    borderWidth: (type === 'doughnut' || type === 'pie' || type === 'bar') ? 1 : 2,
                    tension: 0.3,
                    fill: type === 'line'
                }]
            },
            options: chartOptions
        });
        
        if (canvasId === 'cityChart') cityChart = newChartInstance;
        else if (canvasId === 'ordersTrendChart') ordersTrendChart = newChartInstance;
        else if (canvasId === 'bloggerLevelChart') bloggerLevelChart = newChartInstance;
        else if (canvasId === 'followersDistributionChart') followersDistributionChart = newChartInstance;
    }

    async function updateOrdersList() {
        const list = document.getElementById('ordersList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
        try {
            const snapshot = await db.collection(COLLECTIONS.ORDERS).orderBy('createdAt', 'desc').get();
            if (snapshot.empty) {
                list.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞.</div>';
                return;
            }
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const order = { id: doc.id, ...doc.data() };
                const statusInfo = getStatusInfo(order.status);
                const el = document.createElement('div');
                el.className = 'order-item';
                el.dataset.search = `${order.userName} ${order.phone} ${order.instagram} ${order.orderNumber}`.toLowerCase();
                el.onclick = () => showOrderDetailModal(order.id);
                el.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">${order.orderNumber || `#${order.id.substring(0, 6)}`}</span>
                        <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                    </div>
                    <div class="order-info">
                        <strong>${order.userName}</strong> (${order.city})<br>
                        ${new Date(order.date).toLocaleDateString('ru-RU')} - ${order.time}<br>
                        <small>–°–æ–∑–¥–∞–Ω: ${new Date(order.createdAt).toLocaleString('ru-RU')}</small>
                    </div>`;
                list.appendChild(el);
            });
        } catch (error) {
            console.error("Error fetching orders:", error);
            list.innerHTML = '<p style="color:red;text-align:center;padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    }
    
    function calculateBloggerRating(user) {
        const dataSource = user.registration || user;
        const followers = dataSource.followersCount || 0;
        const views = dataSource.avgViews || 0;
        const strikes = user.strikes || 0;

        const followersWeight = 2.5;
        const viewsWeight = 4.5;
        const strikePenalty = 1.5;

        const followersScore = followers > 0 ? Math.log10(followers) * followersWeight : 0;
        const viewsScore = views > 0 ? Math.log10(views) * viewsWeight : 0;
        
        let totalScore = followersScore + viewsScore - (strikes * strikePenalty);
        
        let rating = (totalScore / 25) * 10;
        rating = Math.max(1, Math.min(10, rating));
        
        return rating.toFixed(1);
    }
    
    async function updateUsersList() {
        const list = document.getElementById('usersList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
        try {
            const [usersSnapshot, adminsSnapshot] = await Promise.all([
                 db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get(),
                 db.collection(COLLECTIONS.ADMINS).get()
            ]);

            const adminIds = new Set(adminsSnapshot.docs.map(doc => doc.id));
            
            if (usersSnapshot.empty) {
                list.innerHTML = '<div class="empty-state">–ï—â–µ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è.</div>';
                return;
            }
            list.innerHTML = '';
            usersSnapshot.forEach(doc => {
                const user = { userId: doc.id, ...doc.data() };
                const reg = user.registration || user;
                if (!reg.firstName) return;

                const isUserAdmin = adminIds.has(String(user.telegramId));
                const rating = calculateBloggerRating(user);

                const el = document.createElement('div');
                el.className = `user-item ${user.isBlocked ? 'blocked' : ''}`;
                el.dataset.search = `${reg.firstName} ${reg.phone} ${reg.instagramLogin}`.toLowerCase();
                el.onclick = () => showUserDetailModal(user.userId);
                
                let badges = '';
                if(isUserAdmin) badges += '<span class="user-admin-badge">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>';
                if(user.isBlocked) badges += `<span class="user-blocked-badge" style="margin-left: 5px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (${user.strikes || 0} —Å—Ç—Ä.)</span>`;

                el.innerHTML = `
                    <div class="user-details">
                        <div class="user-header" style="margin-bottom: 5px;">
                           <span class="user-name-phone">${reg.firstName} (${reg.phone})</span>
                           <span class="user-rating">‚≠ê ${rating}</span>
                        </div>
                        <div style="font-size: 14px; color: #ccc;">
                            Instagram: ${reg.instagramLogin}<br>
                            –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${(reg.followersCount || 0).toLocaleString('ru-RU')} | –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: ${(reg.avgViews || 0).toLocaleString('ru-RU')}
                            ${badges ? `<div style="margin-top:5px;">${badges}</div>` : ''}
                        </div>
                    </div>
                    <div class="user-controls">
                       ${user.isBlocked 
                            ? `<button class="btn-icon-unblock" title="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', false)">üîì</button>`
                            : `<button class="btn-icon-block" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', true)">üîí</button>`
                       }
                       <button class="btn-danger-icon" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); app.removeUser('${user.userId}', '${reg.firstName}')">üóëÔ∏è</button>
                    </div>`;

                list.appendChild(el);
            });
        } catch (error) {
            console.error("Error fetching users:", error);
            list.innerHTML = '<p style="color:red;text-align:center;padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    }
    
    async function updateBlockedSlotsList() {
        const list = document.getElementById('blockedSlotsList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        try {
            const snapshot = await db.collection(COLLECTIONS.BLOCKED_SLOTS).get();
            if (snapshot.empty) {
                list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.</div>';
                return;
            }
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const block = { id: doc.id, ...doc.data() };
                const el = document.createElement('div');
                el.className = 'blocked-slot';
                const timeDisplay = block.type === 'fullday' ? '–í–µ—Å—å –¥–µ–Ω—å' : `–≤ ${block.time}`;
                el.innerHTML = `
                    <div class="blocked-slot-info">
                        <div class="blocked-slot-city">${block.city}</div>
                        <div class="blocked-slot-time">${block.date} (${timeDisplay})</div>
                        ${block.reason ? `<div style="font-size: 12px; color: #999;">${block.reason}</div>` : ''}
                    </div>
                     <button class="btn-danger-icon" onclick="app.removeBlock('${block.id}')" title="–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É">üóëÔ∏è</button>`;
                list.appendChild(el);
            });
        } catch (error) {
            console.error("Error fetching blocks:", error);
            list.innerHTML = '<p style="color:red;text-align:center;padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    }
    
    async function updateAdminsList() {
        const list = document.getElementById('adminsList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        try {
            const snapshot = await db.collection(COLLECTIONS.ADMINS).get();
             if (snapshot.empty) {
                list.innerHTML = '<div class="empty-state">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.</div>';
                return;
            }
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const admin = { id: doc.id, ...doc.data() };
                const el = document.createElement('div');
                el.className = 'user-item';
                el.innerHTML = `
                    <div class="user-header">
                        <span class="user-name-phone">${admin.name || '–ê–¥–º–∏–Ω'} (ID: ${admin.id})</span>
                        <div class="user-controls">
                            ${admin.id !== '1345815453' ? `<button class="btn-danger-icon" onclick="app.removeAdmin('${admin.id}')">üóëÔ∏è</button>` : '<span style="color:#999;font-size:12px;">–ì–ª–∞–≤–Ω—ã–π</span>'}
                        </div>
                    </div>`;
                list.appendChild(el);
            });
        } catch (error) {
            console.error("Error fetching admins:", error);
            list.innerHTML = '<p style="color:red;text-align:center;padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    }

    async function updateOrderStatus(button) {
        await withLoading(button, async () => {
            if (!currentEditingOrderId) return;

            const newStatus = document.getElementById('orderStatusSelect').value;
            try {
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentEditingOrderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) throw new Error("Order not found");

                const orderData = orderDoc.data();
                const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);

                const batch = db.batch();
                batch.update(orderRef, { status: newStatus });

                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const userDataFromDB = userDoc.data();
                    const orders = userDataFromDB.orders || [];
                    const orderIndex = orders.findIndex(o => o.id === currentEditingOrderId);
                    if (orderIndex > -1) {
                        orders[orderIndex].status = newStatus;
                        batch.update(userRef, { orders: orders });
                    }
                }

                await batch.commit();

                if (userDoc.exists && userDoc.data().telegramId) {
                    const bloggerTelegramId = userDoc.data().telegramId;
                    if (newStatus === 'confirmed') {
                        const message = `‚úÖ –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ${orderData.orderNumber} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É ${orderData.date} –≤ ${orderData.time}.`;
                        await sendTelegramNotification(bloggerTelegramId, message);
                    } else if (newStatus === 'completed') {
                        const message = `üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç—á–µ—Ç! –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –ø–æ –∑–∞–∫–∞–∑—É ‚Ññ${orderData.orderNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.`;
                        await sendTelegramNotification(bloggerTelegramId, message);
                    }
                }

                showSuccessMessage('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                closeOrderDetailModal();
                updateOrdersList();
            } catch (error) {
                console.error("Error updating order status: ", error);
                showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.');
            }
        });
    }

    function filter(inputId, listSelector, itemSelector, emptyStateSelector) {
        const query = document.getElementById(inputId).value.toLowerCase();
        let visibleCount = 0;
        document.querySelectorAll(`${listSelector} ${itemSelector}`).forEach(item => {
            const searchableText = item.dataset.search || '';
            const isVisible = searchableText.includes(query);
            item.style.display = isVisible ? '' : 'none';
            if(isVisible) visibleCount++;
        });

        const emptyState = document.querySelector(`${listSelector} ${emptyStateSelector}`);
        if(emptyState) {
            emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    }

    function filterOrders() { filter('orderSearch', '#ordersList', '.order-item', '.empty-state'); }
    function filterUsers() { filter('userSearch', '#usersList', '.user-item', '.empty-state'); }
    function filterAdminUsers() { filter('adminUserSearch', '#adminUsersList', '.user-item', '.empty-state'); }
    
    async function addBlock(button) {
        await withLoading(button, async () => {
            const city = document.getElementById('blockCity').value;
            const date = document.getElementById('blockDate').value;
            const type = document.getElementById('blockType').value;
            const time = document.getElementById('blockTime').value;
            const reason = document.getElementById('blockReason').value.trim();

            if (!city || !date) return;
            if (type === 'time' && !time) return showError('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.');

            let blockId;
            let newBlock = { city, date, type, reason, addedAt: new Date().toISOString(), addedBy: telegramUser ? telegramUser.id : 'unknown' };

            if (type === 'fullday') {
                blockId = `${city}_${date}_fullday`;
            } else {
                blockId = `${city}_${date}_${time}`;
                newBlock.time = time;
            }
            
            await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).set(newBlock);
            closeAddBlockModal();
            updateBlockedSlotsList();
            showSuccessMessage('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        });
    }

    async function removeBlock(blockId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?')) {
            await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).delete();
            updateBlockedSlotsList();
            showSuccessMessage('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
        }
    }
    
    async function toggleUserBlock(userId, shouldBlock) {
        const reason = shouldBlock ? prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º):", "") : '';
        if (shouldBlock && reason === null) return; // User cancelled prompt

        try {
            await db.collection(COLLECTIONS.USERS).doc(userId).update({
                isBlocked: shouldBlock,
                blockReason: shouldBlock ? reason : ''
            });
            showSuccessMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${shouldBlock ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}.`);
            updateUsersList();
        } catch (e) {
            showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
            console.error(e);
        }
    }
    
    async function removeUser(userId, userName) {
        if (confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName}? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –∑–∞–∫–∞–∑—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
            try {
                const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                     showError('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                     updateUsersList();
                     return;
                }

                const ordersToDelete = userDoc.data().orders || [];
                
                const batch = db.batch();
                
                batch.delete(userRef);
                
                ordersToDelete.forEach(order => {
                    const orderRef = db.collection(COLLECTIONS.ORDERS).doc(order.id);
                    batch.delete(orderRef);
                });
                
                await batch.commit();
                
                showSuccessMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} –∏ –≤—Å–µ –µ–≥–æ –∑–∞–∫–∞–∑—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.`);
                updateUsersList();

            } catch (e) {
                showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ.');
                console.error(e);
            }
        }
    }

    async function addAdmin(userId, userName) {
        if (!userId) return;
        const userDoc = await loadUser(userId);
        const telegramId = userDoc?.telegramId;

        if(!telegramId) return showError("–û—à–∏–±–∫–∞", "–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram ID.");

        const newAdmin = { name: userName, addedAt: new Date().toISOString(), addedBy: telegramUser ? telegramUser.id : 'unknown' };
        await db.collection(COLLECTIONS.ADMINS).doc(String(telegramId)).set(newAdmin);

        closeAddAdminModal();
        updateAdminsList();
        showSuccessMessage(`${userName} –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!`);
    }

    async function removeAdmin(adminId) {
        if (adminId === '1345815453') return showError('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?`)) {
            await db.collection(COLLECTIONS.ADMINS).doc(adminId).delete();
            updateAdminsList();
            showSuccessMessage('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω!');
        }
    }
    
    async function removeOrder(orderId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
            try {
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(orderId);
                const orderDoc = await orderRef.get();

                if (!orderDoc.exists) {
                    showError('–û—à–∏–±–∫–∞', '–ó–∞–∫–∞–∑ —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                    updateOrdersList();
                    return;
                }
                
                const userId = orderDoc.data().userId;
                const userRef = db.collection(COLLECTIONS.USERS).doc(userId);

                const batch = db.batch();
                batch.delete(orderRef);

                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const currentOrders = userDoc.data().orders || [];
                    const updatedOrders = currentOrders.filter(o => o.id !== orderId);
                    batch.update(userRef, { orders: updatedOrders });
                }

                await batch.commit();

                closeOrderDetailModal();
                updateOrdersList();
                showSuccessMessage('–ó–∞–∫–∞–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω.');

            } catch (e) {
                console.error("Error completely removing order: ", e);
                showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑.');
            }
        }
    }

    
    async function markNoReport(orderId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –æ—Ç—á–µ—Ç –ø–æ —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É –Ω–µ –±—ã–ª —Å–¥–∞–Ω? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ–±–∞–≤–∏—Ç —à—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.')) return;
        
        try {
            const orderDoc = await db.collection(COLLECTIONS.ORDERS).doc(orderId).get();
            if (!orderDoc.exists) return showError('–û—à–∏–±–∫–∞', '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.');

            const orderData = orderDoc.data();
            const userId = orderData.userId;
            const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
            const batch = db.batch();

            const userDoc = await userRef.get();
            if(!userDoc.exists) throw "User not found!";
            
            const currentStrikes = userDoc.data().strikes || 0;
            const newStrikes = currentStrikes + 1;
            
            const updates = { strikes: newStrikes };
            if (newStrikes >= 3) {
                updates.isBlocked = true;
                updates.blockReason = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: ${newStrikes} –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞.`;
            }
            batch.update(userRef, updates);

            const orders = userDoc.data().orders || [];
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if(orderIndex > -1) {
                orders[orderIndex].status = 'completed';
                batch.update(userRef, { orders: orders });
            }

            batch.update(orderRef, { reportMissed: true, status: 'completed' });
            
            await batch.commit();
            
            showSuccessMessage('–®—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª –¥–æ–±–∞–≤–ª–µ–Ω, –∑–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç.');
            closeOrderDetailModal();
            updateUsersList(); 

        } catch (error) {
            console.error('Error marking no report:', error);
            showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ.');
        }
    }

    async function sendBroadcast(button) {
        const message = document.getElementById('broadcastMessage').value.trim();
        const tag = document.getElementById('broadcastTagFilter').value.trim();
        if (!message) return showError('–û—à–∏–±–∫–∞', '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');

        let confirmationMessage = tag 
            ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–ß–ê–¢–¨ —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ç–µ–≥–æ–º "${tag}"? –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç—É –≤–∫–ª–∞–¥–∫—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.`
            : '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–ß–ê–¢–¨ —Ä–∞—Å—Å—ã–ª–∫—É –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º? –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç—É –≤–∫–ª–∞–¥–∫—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.';

        if (!confirm(confirmationMessage)) return;

        const originalText = button.innerHTML;
        button.disabled = true;

        try {
            let usersQuery = db.collection(COLLECTIONS.USERS);
            if (tag) {
                usersQuery = usersQuery.where("tags", "array-contains", tag);
            }

            const usersSnapshot = await usersQuery.get();
            if (usersSnapshot.empty) {
                showError('–ù–µ –Ω–∞–π–¥–µ–Ω–æ', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ç–∞–∫–∏–º —Ç–µ–≥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
                button.disabled = false;
                return;
            }

            const usersToSend = [];
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (user.telegramId) {
                    usersToSend.push(user.telegramId);
                }
            });

            if (usersToSend.length === 0) {
                 showError('–ù–µ –Ω–∞–π–¥–µ–Ω–æ', '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram ID.');
                 button.disabled = false;
                 return;
            }

            let successCount = 0;
            const totalCount = usersToSend.length;
            
            for (let i = 0; i < totalCount; i++) {
                const chatId = usersToSend[i];
                button.innerHTML = `–û—Ç–ø—Ä–∞–≤–∫–∞... ${i + 1} / ${totalCount}`;
                
                try {
                    await sendTelegramNotification(chatId, message);
                    successCount++;
                } catch (e) {
                    console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${chatId}:`, e);
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showSuccessMessage(`–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successCount} –∏–∑ ${totalCount} —Å–æ–æ–±—â–µ–Ω–∏–π.`);

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—Å—ã–ª–∫–µ:", e);
            showError('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É.');
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
            document.getElementById('broadcastMessage').value = '';
            document.getElementById('broadcastTagFilter').value = '';
        }
    }

    function startCollaboration() {
        if(userData.isBlocked) {
            showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, —Ç–∞–∫ –∫–∞–∫ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
            return;
        }
        currentOrderData = {};
        const dataSource = userData.registration || userData;
        if (dataSource.level === 'micro') {
            showSetSelection();
        } else {
            showAddressForm();
        }
    }

    function handleCityChange() {
        const dataSource = userData.registration || userData;
        const isMacro = dataSource.level !== 'micro';
        document.getElementById('orderScreenshotGroup').style.display = isMacro ? 'block' : 'none';
    }

    function selectSet(element, setId) {
        document.querySelectorAll('.set-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        currentOrderData.set = setId;
        currentOrderData.setName = element.dataset.setName;
        document.getElementById('nextFromSet').disabled = false;
    }
    
    function submitAddressAndShowDateTime() {
        if (!validateAddressForm()) return;
        
        currentOrderData.city = document.getElementById('city').value;
        currentOrderData.street = document.getElementById('street').value;
        currentOrderData.entrance = document.getElementById('entrance').value;
        currentOrderData.floor = document.getElementById('floor').value;
        currentOrderData.recipientPhone = document.getElementById('recipientPhone').value;
        currentOrderData.comment = document.getElementById('comment').value;

        showDateTimeSelection();
        setupDateInput();
    }

    function setupDateInput() {
        const dateInput = document.getElementById('deliveryDate');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.min = `${yyyy}-${mm}-${dd}`;
        dateInput.value = '';
        document.getElementById('timeSlots').innerHTML = '';
        document.getElementById('nextFromDateTime').disabled = true;
    }

    async function updateTimeSlots() {
        const dateValue = document.getElementById('deliveryDate').value;
        currentOrderData.time = '';
        document.getElementById('nextFromDateTime').disabled = true;

        const timeSlotsContainer = document.getElementById('timeSlots');
        timeSlotsContainer.innerHTML = '<div class="loading-indicator">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏...</div>';

        if (!dateValue) {
            timeSlotsContainer.innerHTML = '';
            return;
        }
        currentOrderData.date = dateValue;
        
        const city = document.getElementById('city').value;
        
        const scheduleDoc = await db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
        const scheduleData = scheduleDoc.exists ? scheduleDoc.data() : {};
        
        const dayOfWeek = new Date(dateValue).getDay(); // 0=Sun, 1=Mon...
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayKey = days[dayOfWeek];
        const daySchedule = scheduleData[dayKey] || '';

        const timeSlots = [];
        if (daySchedule) {
            const ranges = daySchedule.split(',');
            ranges.forEach(range => {
                const [start, end] = range.trim().split('-');
                if (start && end) {
                    let startHour = parseInt(start.split(':')[0]);
                    let endHour = parseInt(end.split(':')[0]);
                    for(let h = startHour; h < endHour; h++) {
                        timeSlots.push(`${String(h).padStart(2, '0')}:00`);
                    }
                }
            });
        }
        
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentHour = now.getHours();
        
        timeSlotsContainer.innerHTML = '';
        for (const time of timeSlots) {
            const [slotHour] = time.split(':').map(Number);
            
            if (dateValue === todayStr && slotHour <= currentHour) {
                continue;
            }
            
            if (await isSlotBlocked(city, dateValue, time)) {
                continue;
            }

            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.textContent = time;
            slot.onclick = () => selectTimeSlot(slot, time);
            timeSlotsContainer.appendChild(slot);
        }

        if (timeSlotsContainer.innerHTML === '') {
            timeSlotsContainer.innerHTML = '<p style="text-align:center;color:#999;">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>';
        }
    }


    function selectTimeSlot(element, time) {
        document.querySelectorAll('.time-slot').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        currentOrderData.time = time;
        document.getElementById('nextFromDateTime').disabled = false;
    }

    function validateAddressForm() {
        const city = document.getElementById('city').value;
        const street = document.getElementById('street').value;
        const phone = document.getElementById('recipientPhone').value;
        if (!city || !street || !phone) {
            showError('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, —Ç–µ–ª–µ—Ñ–æ–Ω.');
            return false;
        }
        const dataSource = userData.registration || userData;
        const isMacro = dataSource.level !== 'micro';
        const screenshotInput = document.getElementById('orderScreenshot');
        if (isMacro && (!screenshotInput.files || screenshotInput.files.length === 0)) {
            showError('–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–Ω—à–æ—Ç', '–î–ª—è –º–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∑–∞–∫–∞–∑–∞.');
            return false;
        }
        
        return true;
    }

    async function submitOrder(button) {
        await withLoading(button, async () => {
            const orderId = db.collection(COLLECTIONS.ORDERS).doc().id;
            const dataSource = userData.registration || userData;
            
            const newOrder = {
                ...currentOrderData,
                id: orderId,
                orderNumber: generateOrderNumber(currentOrderData.city, currentOrderData.date, orderId),
                userId: currentUserId,
                userName: dataSource.firstName,
                avgViews: dataSource.avgViews,
                followersCount: dataSource.followersCount,
                instagram: dataSource.instagramLogin,
                phone: dataSource.phone,
                status: 'new',
                createdAt: new Date().toISOString(),
                reportMissed: false,
                reportLink: null
            };
            
            newOrder.set = newOrder.set ?? null;
            
            const userOrders = userData.orders || [];
            userOrders.push({ 
                id: orderId, 
                date: newOrder.date,
                orderNumber: newOrder.orderNumber, 
                set: newOrder.set,
                status: newOrder.status, 
                createdAt: newOrder.createdAt 
            });
            
            const batch = db.batch();
            batch.set(db.collection(COLLECTIONS.ORDERS).doc(orderId), newOrder);
            batch.update(db.collection(COLLECTIONS.USERS).doc(currentUserId), { orders: userOrders });
            await batch.commit();

            const screenshotInput = document.getElementById('orderScreenshot');
            const screenshotFile = screenshotInput.files && screenshotInput.files.length > 0 ? screenshotInput.files[0] : null;

            await sendAdminNotification(newOrder, screenshotFile);
            
            showSuccessModal();
        });
    }
    
    function showOrderHistory() {
        const list = document.getElementById('orderHistoryList');
        const sortedOrders = (userData.orders || []).sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
        
        if (sortedOrders.length === 0) {
            list.innerHTML = '<div class="empty-state">–£ –≤–∞—Å –µ—â–µ –Ω–µ –±—ã–ª–æ –∑–∞–∫–∞–∑–æ–≤.</div>';
        } else {
            list.innerHTML = '';
            sortedOrders.forEach(order => {
                const statusInfo = getStatusInfo(order.status);
                const item = document.createElement('div');
                item.className = 'order-item';
                item.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">${order.orderNumber || '–ó–∞–∫–∞–∑ –æ—Ç ' + new Date(order.createdAt || order.date).toLocaleDateString()}</span>
                        <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                    </div>
                    <div class="order-info">${order.setName || '–ó–∞–∫–∞–∑ –º–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä–∞'}</div>`;
                list.appendChild(item);
            });
        }
        document.getElementById('orderHistoryModal').style.display = 'flex';
    }

    function editProfile() {
        const reg = userData.registration || userData;
        document.getElementById('editFirstName').value = reg.firstName;
        document.getElementById('editPhone').value = reg.phone;
        document.getElementById('editInstagram').value = reg.instagramLogin;
        document.getElementById('editFollowers').value = reg.followersCount;
        document.getElementById('editViews').value = reg.avgViews;
        document.getElementById('editPassword').value = '';
        document.getElementById('editProfileModal').style.display = 'flex';
    }

    async function saveProfile(button) {
        await withLoading(button, async () => {
            const reg = userData.registration || userData;
            const newPhone = document.getElementById('editPhone').value.trim();
            const newInstagram = document.getElementById('editInstagram').value.trim().toLowerCase();
            const newFirstName = document.getElementById('editFirstName').value.trim();
            const newFollowers = parseInt(document.getElementById('editFollowers').value);
            const newViews = parseInt(document.getElementById('editViews').value);
            
            if (!newFirstName || !newPhone || !newInstagram || isNaN(newFollowers) || isNaN(newViews)) {
                return showError('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
            }

            if (newPhone !== reg.phone || newInstagram !== reg.instagramLogin) {
                const duplicateCheck = await checkForDuplicateRegistration(newPhone, newInstagram, currentUserId);
                if (!duplicateCheck.canRegister) {
                    return showError('–î–∞–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç—ã', '–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Instagram —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.');
                }
            }
            
            const updates = {
                'registration.firstName': newFirstName,
                'registration.phone': newPhone,
                'registration.instagramLogin': newInstagram,
                'registration.followersCount': newFollowers,
                'registration.avgViews': newViews,
                'level': determineBloggerLevel(newFollowers).level,
                'lastActivity': new Date().toISOString()
            };

            const newPassword = document.getElementById('editPassword').value.trim();
            if (validatePassword(newPassword)) {
                updates['registration.password'] = hashPassword(newPassword);
            }
            
            await db.collection(COLLECTIONS.USERS).doc(currentUserId).update(updates);
            
            closeEditProfile();
            showSuccessMessage('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        });
    }

    function logout() {
        if (userListenerUnsubscribe) {
            userListenerUnsubscribe();
            userListenerUnsubscribe = null;
        }
        userData = {};
        currentUserId = null;
        telegramUser = null;
        isCurrentUserAdmin = false;
        window.location.reload();
    }

    // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ---
    function showSuccessModal() {
        document.getElementById('successTitle').textContent = '–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!';
        document.getElementById('successMessage').textContent = '–ö–æ–≥–¥–∞ –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Å–¥–∞—á–∏ –æ—Ç—á–µ—Ç–∞.';
        document.getElementById('successModal').style.display = 'flex';
    }
    function showSuccessMessage(message) {
        document.getElementById('successTitle').textContent = '–£—Å–ø–µ—à–Ω–æ!';
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successModal').style.display = 'flex';
    }
    function showError(title, message) {
        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').style.display = 'flex';
    }
    async function showOrderDetailModal(orderId) {
        currentEditingOrderId = orderId;
        const orderDoc = await db.collection(COLLECTIONS.ORDERS).doc(orderId).get();
        if(!orderDoc.exists) return showError('–û—à–∏–±–∫–∞', '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        
        const order = orderDoc.data();
        const body = document.getElementById('orderDetailBody');
        const statusInfo = getStatusInfo(order.status);
        
        document.getElementById('orderDetailTitle').textContent = `–ó–∞–∫–∞–∑ ${order.orderNumber}`;
        let reportHTML = '';
        if(order.reportLink) {
            reportHTML = `
                <strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç:</strong>
                <a href="${order.reportLink}" target="_blank" class="report-link">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç</a>`;
        }
        
        body.innerHTML = `
            <strong>–ë–ª–æ–≥–µ—Ä:</strong> ${order.userName}<br>
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone}<br>
            <strong>Instagram:</strong> @${order.instagram}<br>
            <strong>–ì–æ—Ä–æ–¥:</strong> ${order.city}<br>
            <strong>–ê–¥—Ä–µ—Å:</strong> ${order.street}<br>
            <strong>–ü–æ–¥—ä–µ–∑–¥:</strong> ${order.entrance || '-'}<br>
            <strong>–≠—Ç–∞–∂:</strong> ${order.floor || '-'}<br>
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong> ${order.recipientPhone}<br>
            <strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> ${order.date} –≤ ${order.time}<br>
            <strong>–ù–∞–±–æ—Ä:</strong> ${order.setName || (order.set ? order.set.replace('set', '–ù–∞–±–æ—Ä ') : '–ó–∞–∫–∞–∑ –º–∞–∫—Ä–æ–±–ª–æ–≥–µ—Ä–∞')}<br>
            <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment || '-'}<br>
            <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="order-status ${statusInfo.className}" style="display:inline-block;">${statusInfo.text}</span>
            ${reportHTML}
        `;
        
        document.getElementById('orderStatusSelect').value = order.status;
        
        const noReportBtn = document.getElementById('markNoReportBtn');
        noReportBtn.onclick = () => markNoReport(order.id);
        if (order.reportMissed) {
            noReportBtn.disabled = true;
            noReportBtn.style.color = '#999';
            noReportBtn.title = '–®—Ç—Ä–∞—Ñ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω';
        } else {
            noReportBtn.disabled = false;
            noReportBtn.style.color = '#ffc107';
            noReportBtn.title = '–û—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –æ—Ç—á–µ—Ç –Ω–µ —Å–¥–∞–Ω';
        }

        document.getElementById('deleteOrderBtn').onclick = () => removeOrder(order.id);
        document.getElementById('orderDetailModal').style.display = 'flex';
    }

    async function showAddAdminModal() { 
        const list = document.getElementById('adminUsersList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
        document.getElementById('addAdminModal').style.display = 'flex';
        
        const [usersSnapshot, adminsSnapshot] = await Promise.all([
             db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get(),
             db.collection(COLLECTIONS.ADMINS).get()
        ]);
        
        const adminIds = new Set(adminsSnapshot.docs.map(doc => doc.id));
        
         if (usersSnapshot.empty) {
            list.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.</div>';
            return;
        }
        list.innerHTML = '';
        usersSnapshot.forEach(doc => {
            const user = { userId: doc.id, ...doc.data() };
            const reg = user.registration || user;
            if (!reg.firstName || !user.telegramId) return;

            const isAlreadyAdmin = adminIds.has(String(user.telegramId));
            
            const el = document.createElement('div');
            el.className = 'user-item';
            el.dataset.search = `${reg.firstName} ${reg.instagramLogin}`.toLowerCase();
            el.innerHTML = `
                <div>
                    <strong>${reg.firstName}</strong>
                    <div style="font-size: 12px; color: #999;">@${reg.instagramLogin}</div>
                </div>
                ${isAlreadyAdmin 
                    ? '<span class="user-admin-badge">–£–∂–µ –∞–¥–º–∏–Ω</span>'
                    : `<button class="btn-primary btn-small" onclick="app.addAdmin('${user.userId}', '${reg.firstName}')">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>`
                }`;
            list.appendChild(el);
        });
    }
    
    function showRejectionModal() { document.getElementById('rejectionModal').style.display = 'flex'; }
    function closeModal() { 
        document.getElementById('successModal').style.display = 'none';
        showDashboard();
    }
    function closeErrorModal() { document.getElementById('errorModal').style.display = 'none'; }
    function closeRejectionModal() { document.getElementById('rejectionModal').style.display = 'none'; }
    function closeOrderHistory() { document.getElementById('orderHistoryModal').style.display = 'none'; }
    function closeEditProfile() { document.getElementById('editProfileModal').style.display = 'none'; }
    function contactAdmin() { document.getElementById('contactModal').style.display = 'flex'; }
    function closeContactModal() { document.getElementById('contactModal').style.display = 'none'; }
    function closeOrderDetailModal() { 
        document.getElementById('orderDetailModal').style.display = 'none';
        currentEditingOrderId = null;
    }
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        currentReportingOrderId = null;
    }
    function closeUserDetailModal() {
        document.getElementById('userDetailModal').style.display = 'none';
        currentUserDetailId = null;
    }

    function toggleBlockTime() {
        const type = document.getElementById('blockType').value;
        document.getElementById('blockTimeGroup').style.display = type === 'time' ? 'block' : 'none';
    }

    function showAddBlockModal() { 
        document.getElementById('addBlockModal').style.display = 'flex';
        document.getElementById('addBlockForm').reset();
        toggleBlockTime();
    }
    function closeAddBlockModal() { document.getElementById('addBlockModal').style.display = 'none'; }
    function closeAddAdminModal() { document.getElementById('addAdminModal').style.display = 'none'; }
    
    function setupPhoneMask(inputId) {
        const phoneInput = document.getElementById(inputId);
        if (!phoneInput) return;
        
        const format = (input) => {
            let digits = input.value.replace(/\D/g, '');
            if (digits.startsWith('7') || digits.startsWith('8')) {
                digits = digits.substring(1);
            }
            let formatted = '+7 (';
            if (digits.length > 0) formatted += digits.substring(0, 3);
            if (digits.length > 3) formatted += ') ' + digits.substring(3, 6);
            if (digits.length > 6) formatted += '-' + digits.substring(6, 8);
            if (digits.length > 8) formatted += '-' + digits.substring(8, 10);
            input.value = formatted;
        };
        
        phoneInput.addEventListener('input', () => format(phoneInput));
    }

    async function initializeApp() {
        initTelegram();
        if (await attemptTelegramAutoLogin()) {
            showDashboard();
        } else {
            showWelcomeScreen();
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ---
    function showScheduleForCity(city, element) {
        document.querySelectorAll('.schedule-city-tab').forEach(t => t.classList.remove('active'));
        element.classList.add('active');
        document.querySelectorAll('.schedule-form').forEach(f => f.classList.remove('active'));
        document.getElementById(`schedule-form-${city}`).classList.add('active');
    }

    async function loadSchedule() {
        const tabsContainer = document.getElementById('scheduleCityTabs');
        const formsContainer = document.getElementById('scheduleFormsContainer');
        tabsContainer.innerHTML = '';
        formsContainer.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';
        
        const days = { monday: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", tuesday: "–í—Ç–æ—Ä–Ω–∏–∫", wednesday: "–°—Ä–µ–¥–∞", thursday: "–ß–µ—Ç–≤–µ—Ä–≥", friday: "–ü—è—Ç–Ω–∏—Ü–∞", saturday: "–°—É–±–±–æ—Ç–∞", sunday: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ" };
        let formsHtml = '';

        for (const city of CITIES) {
             const tab = document.createElement('button');
             tab.className = 'schedule-city-tab';
             tab.textContent = city;
             tab.onclick = () => showScheduleForCity(city, tab);
             tabsContainer.appendChild(tab);

            let formHtml = `<div class="schedule-form" id="schedule-form-${city}">`;
            const scheduleDoc = await db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
            const scheduleData = scheduleDoc.exists ? scheduleDoc.data() : {};
            
            for (const dayKey in days) {
                formHtml += `
                    <div class="form-group">
                        <label for="schedule_${city}_${dayKey}">${days[dayKey]}</label>
                        <input type="text" id="schedule_${city}_${dayKey}" value="${scheduleData[dayKey] || ''}" placeholder="12:00-18:00">
                    </div>`;
            }
            formHtml += `</div>`;
            formsHtml += formHtml;
        }
        formsContainer.innerHTML = formsHtml;
        
        const firstTab = tabsContainer.querySelector('.schedule-city-tab');
        if(firstTab) firstTab.click();
    }

    async function saveSchedule(button) {
        await withLoading(button, async() => {
            const batch = db.batch();
            for (const city of CITIES) {
                const scheduleRef = db.collection(COLLECTIONS.SCHEDULES).doc(city);
                const scheduleData = {};
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(dayKey => {
                    const input = document.getElementById(`schedule_${city}_${dayKey}`);
                    scheduleData[dayKey] = input.value.trim();
                });
                batch.set(scheduleRef, scheduleData);
            }
            await batch.commit();
            showSuccessMessage("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        });
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ–≥–æ–≤ ---
    async function showUserDetailModal(userId) {
        currentUserDetailId = userId;
        const userDoc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
        if (!userDoc.exists) return showError('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        
        const user = userDoc.data();
        const reg = user.registration || user;
        
        document.getElementById('userDetailTitle').textContent = reg.firstName;
        document.getElementById('userDetailBody').innerHTML = `
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${reg.phone}<br>
            <strong>Instagram:</strong> @${reg.instagramLogin}<br>
            <strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê ${calculateBloggerRating(user)}
        `;
        renderTags(user.tags || []);
        document.getElementById('userDetailModal').style.display = 'flex';
    }

    function renderTags(tags) {
        const container = document.getElementById('userTagsContainer');
        container.innerHTML = '';
        tags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag';
            tagEl.innerHTML = `${tag} <span class="remove-tag" onclick="app.removeUserTag('${tag}')">√ó</span>`;
            container.appendChild(tagEl);
        });
    }

    async function addUserTag() {
        const input = document.getElementById('newTagInput');
        const newTag = input.value.trim().toLowerCase();
        if (!newTag || !currentUserDetailId) return;

        const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw "User not found";
            const tags = userDoc.data().tags || [];
            if (!tags.includes(newTag)) {
                tags.push(newTag);
                transaction.update(userRef, { tags: tags });
                renderTags(tags);
            }
        });
        input.value = '';
    }

    async function removeUserTag(tagToRemove) {
        if (!tagToRemove || !currentUserDetailId) return;

        const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw "User not found";
            const tags = userDoc.data().tags || [];
            const updatedTags = tags.filter(t => t !== tagToRemove);
            transaction.update(userRef, { tags: updatedTags });
            renderTags(updatedTags);
        });
    }
    
    function showReportModal(orderId, orderNumber) {
        currentReportingOrderId = orderId;
        document.getElementById('reportModalTitle').textContent = `–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É ${orderNumber}`;
        document.getElementById('reportLink').value = '';
        document.getElementById('reportModal').style.display = 'flex';
    }

    async function submitReport(button) {
        await withLoading(button, async() => {
            const reportLink = document.getElementById('reportLink').value.trim();
            if (!reportLink || !reportLink.startsWith('http')) {
                return showError('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É.');
            }

            const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentReportingOrderId);
            const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserId);
            
            const batch = db.batch();
            batch.update(orderRef, { status: 'awaiting_review', reportLink: reportLink });
            
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const userDataFromDB = userDoc.data();
                const orders = userDataFromDB.orders || [];
                const orderIndex = orders.findIndex(o => o.id === currentReportingOrderId);
                if (orderIndex > -1) {
                    orders[orderIndex].status = 'awaiting_review';
                    batch.update(userRef, { orders: orders });
                }
            }

            await batch.commit();

            closeReportModal();
            showSuccessMessage('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupPhoneMask('loginPhone');
        setupPhoneMask('phone');
        setupPhoneMask('recipientPhone');
        setupPhoneMask('editPhone');
        
        setupAnalyticsSlider();
        
        setTimeout(initializeApp, 100);
    });

    return {
        showRegistration, showLogin, showWelcomeScreen, submitLogin, submitRegistration, 
        submitMigration, showDashboard, logout, startCollaboration, showOrderHistory, editProfile,
        contactAdmin, showCRM, showCrmTab, filterOrders, filterUsers, filterAdminUsers,
        removeBlock, removeAdmin, removeUser, toggleUserBlock, sendBroadcast,
        addBlock, addAdmin, selectSet, showSetSelection, showAddressForm, showDateTimeSelection, showInstructions,
        handleCityChange, submitAddressAndShowDateTime, updateTimeSlots, submitOrder, saveProfile,
        closeModal, closeErrorModal, closeRejectionModal, closeOrderHistory, closeEditProfile,
        closeContactModal, showAddBlockModal, closeAddBlockModal, showAddAdminModal, closeAddAdminModal,
        closeOrderDetailModal, toggleBlockTime,
        updateOrderStatus, showReportModal, closeReportModal, submitReport,
        loadSchedule, saveSchedule, showUserDetailModal, closeUserDetailModal, addUserTag, removeUserTag,
        showScheduleForCity
    };
})();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бартер для блогеров</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === НАЧАЛО ОБНОВЛЕНИЯ ДИЗАЙНА === */
        /* Design System: Vesla Premium */

        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        :root {
            /* Основная палитра */
            --background-color: #0f172a;
            /* Deep Slate Blue */
            --surface-color: #1e293b;
            /* Lighter Slate */
            --surface-light-color: #334155;
            --border-color: rgba(255, 255, 255, 0.1);

            /* Текст */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;

            /* Акцентные цвета (Градиенты) */
            --accent-primary: #6366f1;
            --accent-primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --accent-secondary: #f43f5e;
            --accent-secondary-gradient: linear-gradient(135deg, #f43f5e 0%, #fb7185 100%);

            /* Статусы */
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-success: #10b981;

            /* Шрифты и скругления */
            --font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --border-radius: 24px;
            --border-radius-small: 16px;

            /* Эффекты */
            --shadow-primary: 0 10px 30px -10px rgba(99, 102, 241, 0.4);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --backdrop-blur: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* --- Конец общих стилей --- */

        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-body,
        .order-info,
        .user-details,
        .blocked-slot-info,
        .report-link,
        .user-name-phone,
        .order-id,
        .subtitle,
        p,
        h1,
        h2,
        h3,
        h4,
        label,
        li,
        a,
        span {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        input,
        textarea,
        select {
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* === Обновленные анимации === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(99, 102, 241, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .logo-container {
            width: 140px;
            height: 140px;
            background: var(--surface-color);
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            box-shadow: var(--shadow-primary);
            position: relative;
            z-index: 1;
        }

        .logo-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 42px;
            background: var(--accent-primary-gradient);
            z-index: -1;
            opacity: 0.5;
        }

        .logo-icon {
            font-size: 70px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 38px;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1,
        h2,
        h3,
        h4 {
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 48px;
            line-height: 1.6;
            font-weight: 300;
            max-width: 300px;
        }

        /* === Обновленные кнопки === */
        .btn-primary {
            background: var(--accent-primary-gradient);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-primary);
            width: 100%;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-primary:hover:not(:disabled)::after {
            opacity: 1;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            filter: grayscale(1);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px -5px rgba(99, 102, 241, 0.5);
        }

        .btn-primary:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 16px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            margin: 4px;
            border-radius: 12px;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger-icon {
            background: rgba(239, 68, 68, 0.1);
            border: none;
            color: var(--accent-danger);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .btn-danger-icon:hover {
            background: var(--accent-danger);
            color: white;
        }

        .btn-icon,
        .btn-icon-block,
        .btn-icon-unblock {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon-block {
            color: var(--accent-warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .btn-icon-block:hover:not(:disabled) {
            background: var(--accent-warning);
            color: white;
        }

        .btn-icon-unblock {
            color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .btn-icon-unblock:hover:not(:disabled) {
            background: var(--accent-success);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .form-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .form-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        /* === Обновленные поля ввода === */
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 16px 20px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-family: var(--font-family);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .input-error {
            border-color: var(--accent-danger) !important;
            background: rgba(239, 68, 68, 0.05) !important;
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .error-message {
            color: var(--accent-danger);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            padding-left: 4px;
            font-weight: 500;
        }

        .btn-back {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 10px 0;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 24px;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back::before {
            content: '←';
            font-size: 20px;
            transition: transform 0.3s;
        }

        .btn-back:hover {
            color: var(--text-primary);
            background: transparent;
        }

        .btn-back:hover::before {
            transform: translateX(-4px);
        }

        /* --- Конец секции полей ввода --- */

        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        /* === Обновленные карточки === */
        .user-card {
            background: var(--glass-bg);
            padding: 32px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: var(--glass-border);
            backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--shadow-card);
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            opacity: 0.8;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .user-avatar {
            width: 96px;
            height: 96px;
            border-radius: 32px;
            background: var(--surface-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 24px;
            position: relative;
            z-index: 1;
            padding: 4px;
            box-shadow: var(--shadow-primary);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 34px;
            background: var(--accent-primary-gradient);
            z-index: -1;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 28px;
        }

        .user-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            letter-spacing: -0.02em;
        }

        .user-level {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-primary);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 24px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 16px 8px;
            border-radius: var(--border-radius-small);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .dashboard-actions {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .action-card {
            background: var(--surface-color);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-card::after {
            content: '';
            position: absolute;
            right: -20px;
            bottom: -20px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            transition: transform 0.5s;
        }

        .action-card:hover::after {
            transform: scale(1.5);
        }

        .report-action-card {
            border-color: rgba(245, 158, 11, 0.3);
            background: linear-gradient(to right, rgba(245, 158, 11, 0.05), transparent);
        }

        .strikes-panel {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            padding: 16px;
            border-radius: var(--border-radius-small);
            margin-bottom: 24px;
            text-align: center;
            font-size: 14px;
            color: #fbbf24;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px -10px rgba(0, 0, 0, 0.3);
        }

        .action-icon {
            font-size: 28px;
            margin-bottom: 12px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            color: var(--accent-primary);
        }

        .action-icon svg {
            stroke: var(--accent-primary);
            stroke-width: 2;
        }

        .action-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .action-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* --- Конец секции карточек --- */

        /* === Обновления для CRM === */
        .crm-screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .crm-header {
            background: transparent;
            padding: 0;
            margin-bottom: 24px;
            text-align: center;
        }

        .crm-tabs,
        .schedule-city-tabs {
            display: flex;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            padding: 6px;
            gap: 4px;
            backdrop-filter: blur(10px);
        }

        .crm-tab,
        .schedule-city-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 18px;
        }

        .crm-tab.active,
        .schedule-city-tab.active {
            background: var(--accent-primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .crm-tab:hover:not(.active),
        .schedule-city-tab:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .schedule-form {
            display: none;
        }

        .schedule-form.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .crm-content {
            display: none;
        }

        .crm-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .crm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .crm-stat-card {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-card);
        }

        .crm-stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .crm-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .orders-list {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-card);
        }

        .order-item {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .order-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-id {
            font-weight: 700;
            color: var(--accent-primary);
            font-family: monospace;
            font-size: 16px;
        }

        .order-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Статусы заказов */
        .status-new {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        .status-confirmed {
            background: rgba(99, 102, 241, 0.15);
            color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .status-delivered {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-awaiting_review {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .status-completed {
            background: rgba(6, 182, 212, 0.15);
            color: #06b6d4;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .status-rejected {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }


        .order-info {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .order-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .report-link {
            display: inline-block;
            margin-top: 12px;
            color: var(--accent-primary);
            font-weight: 600;
            word-break: break-all;
            text-decoration: none;
            border-bottom: 1px dashed var(--accent-primary);
            transition: all 0.2s;
        }

        .report-link:hover {
            border-bottom-style: solid;
            opacity: 0.8;
        }

        .blocked-slots {
            margin-bottom: 24px;
        }

        .blocked-slot,
        .user-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .user-item {
            cursor: pointer;
        }

        .user-item.blocked {
            border-left: 4px solid var(--accent-danger);
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), var(--surface-color));
        }

        .user-item.hidden-item {
            opacity: 0.6;
            background: #1e1e1e;
            border-style: dashed;
        }

        .user-item:hover {
            background: var(--surface-light-color);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .blocked-slot-info {
            flex: 1;
        }

        .blocked-slot-city {
            font-weight: 700;
            color: var(--accent-primary);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .blocked-slot-time {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-details {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .user-name-phone {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .user-rating {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-warning);
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .user-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-admin-badge {
            font-size: 11px;
            color: var(--accent-success);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .user-blocked-badge {
            font-size: 11px;
            color: var(--accent-danger);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(239, 68, 68, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }

        /* --- Конец секции CRM --- */

        /* === Обновленные модальные окна === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 32px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-body {
            text-align: left;
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-body strong {
            color: var(--text-primary);
        }

        .modal-button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .modal-button-group>.btn-primary,
        .modal-button-group>.btn-secondary {
            flex: 1;
            margin-top: 0;
        }

        .tags-container {
            margin-top: 10px;
            min-height: 30px;
        }

        .tag {
            display: inline-block;
            background-color: var(--accent-primary);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }

        .tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .input-with-button {
            display: flex;
            align-items: center;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            transition: border-color 0.3s ease;
            margin-top: 15px;
            overflow: hidden;
        }

        .input-with-button:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.2);
        }

        .input-with-button input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 15px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .input-with-button button {
            background: var(--accent-primary);
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 0 20px;
            height: 52px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .input-with-button button:hover {
            background: var(--accent-primary-dark);
        }

        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--accent-success);
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--accent-danger);
        }

        .warning-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--accent-warning);
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            background: var(--surface-color);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-small);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            border-color: var(--accent-primary);
        }

        .warning-message {
            background: var(--accent-danger);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius-small);
            margin: 20px 0;
            text-align: center;
        }

        .blocked-message {
            background: var(--accent-danger);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.5;
        }

        /* --- Конец секции модальных окон --- */

        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }

        .admin-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }

        /* === Обновленный экран выбора сета === */
        .set-selection {
            display: none;
        }

        .set-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .set-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .set-item.selected {
            border-color: var(--accent-secondary);
            background: rgba(255, 107, 53, 0.1);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .set-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .set-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        /* --- Конец экрана выбора --- */

        .datetime-selection {
            display: none;
        }

        .instructions,
        .telegram-info,
        .admin-contact {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius-small);
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .telegram-info {
            border-left: 4px solid var(--accent-primary);
        }

        .admin-contact {
            text-align: center;
        }

        .checklist {
            list-style: none;
            margin: 15px 0;
        }

        .checklist li {
            padding: 8px 0;
            position: relative;
            padding-left: 30px;
        }

        .checklist li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .loading-indicator {
            color: var(--accent-primary);
            font-size: 14px;
            padding: 15px;
            text-align: center;
            background: rgba(0, 180, 216, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .empty-state {
            color: var(--text-secondary);
            font-size: 14px;
            padding: 40px 20px;
            text-align: center;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px dashed var(--border-color);
        }

        .contact-link {
            display: inline-block;
            background: var(--accent-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .contact-link:hover {
            background: var(--accent-primary-dark);
            transform: translateY(-2px);
        }

        .migration-info {
            background: var(--accent-secondary);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius-small);
            margin: 20px 0;
            text-align: center;
        }

        /* === НОВЫЕ/ИЗМЕНЕННЫЕ СТИЛИ ДЛЯ МЕНЮ === */
        .menu-screen {
            padding-bottom: 150px;
        }

        .menu-header-sticky {
            position: sticky;
            top: 0;
            background: var(--background-color);
            padding-top: 5px;
            z-index: 100;
            margin: -20px -20px 0 -20px;
            padding: 0 20px 0 20px;
            display: flex;
            flex-direction: column;
        }

        .menu-top-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-top: 15px;
        }

        .menu-top-bar .btn-back {
            margin-bottom: 0;
            margin-right: 10px;
            padding: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-info-bar {
            flex-grow: 1;
            text-align: left;
        }

        .menu-info-bar h2 {
            font-size: 20px;
            margin-bottom: 4px;
            text-align: left;
        }

        .menu-budget-display {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 6px 12px;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--accent-warning);
        }

        .menu-categories {
            display: flex;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 15px;
        }

        .menu-categories::-webkit-scrollbar {
            display: none;
        }

        .menu-category-tab {
            padding: 8px 18px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            text-decoration: none;
            margin-right: 10px;
        }

        .menu-category-tab.active {
            color: white;
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .menu-category-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .menu-section {
            margin-bottom: 30px;
            padding-top: 10px;
        }

        .menu-category-title {
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-subcategory-title {
            font-size: 18px;
            color: var(--text-secondary);
            margin-top: 20px;
            margin-bottom: 15px;
        }

        .menu-items-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .menu-item-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            border: 1px solid var(--border-color);
            align-items: center;
        }

        .menu-item-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .menu-item-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 120px;
        }

        .menu-item-content-wrapper {
            flex-grow: 1;
        }

        .menu-item-name {
            font-weight: 600;
            font-size: 16px;
            line-height: 1.3;
            margin-bottom: 5px;
        }

        .menu-item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 34px;
        }

        .menu-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 8px;
        }

        .menu-item-price {
            font-weight: bold;
            font-size: 18px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .menu-item-controls {
            display: flex;
            align-items: center;
            background: var(--surface-light-color);
            border-radius: 20px;
        }

        .quantity-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: 400;
            cursor: pointer;
            padding: 4px 14px;
        }

        .item-quantity {
            padding: 0 5px;
            font-size: 16px;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        .cart-fab {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 20px 20px 20px;
            z-index: 998;
            border-top: 1px solid var(--border-color);
        }

        .cart-fab-content {
            max-width: 380px;
            margin: 0 auto;
        }

        .cart-fab-content button {
            margin-top: 15px;
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cart-summary-value {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .cart-overdraft-text {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-left: 8px;
        }

        .cart-progress-bar-container {
            height: 6px;
            background-color: var(--surface-light-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .cart-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-primary-dark));
            border-radius: 3px;
            transition: width 0.3s ease-out;
        }

        .cart-progress-bar.overdraft {
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-danger));
        }

        .v-bonus-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ffdd7a, var(--accent-warning));
            border-radius: 50%;
            color: #4a2b00;
            font-weight: bold;
            font-size: 13px;
            margin-left: 4px;
            vertical-align: -3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* --- КОНЕЦ НОВЫХ СТИЛЕЙ МЕНЮ --- */

        @media (max-width: 380px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .btn-primary {
                padding: 15px 30px;
                font-size: 16px;
            }
        }

        /* === Обновленные скроллбары === */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-light-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-container .search-input {
            margin-bottom: 0;
            flex-grow: 1;
        }

        .search-container .btn-secondary {
            margin-top: 0;
            width: auto;
            flex-shrink: 0;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: var(--border-radius-small);
        }

        .search-input {
            width: 100%;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 10px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.2);
        }

        .analytics-filters,
        .chart-container {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .analytics-filters {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .chart-container {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chart-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }

        .chart-container canvas {
            max-height: 220px;
        }

        .tag-suggestions-container {
            max-height: 150px;
            overflow-y: auto;
            background: var(--surface-light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            margin-top: 5px;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 1001;
        }

        .tag-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-suggestion-item:hover {
            background: #5a5a5a;
        }

        .tag-suggestion-item .user-count {
            color: var(--text-secondary);
            font-size: 12px;
            background: var(--surface-color);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .placeholder-tag {
            cursor: pointer;
            background: var(--surface-light-color);
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .placeholder-tag:hover {
            background: #5a5a5a;
        }

        .vcoin-management-block {
            text-align: left;
        }

        .vcoin-management-block input {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 12px;
        }

        .vcoin-management-block .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .vcoin-management-block .button-group .btn-small {
            flex: 1;
            margin: 0;
            padding: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ЭКРАН: Для критических ошибок -->
        <div id="criticalErrorScreen" class="welcome-screen" style="display: none;">
            <div class="logo-container" style="background: var(--accent-danger);">
                <div class="logo-icon" style="font-size: 50px;">🔌</div>
            </div>
            <h1>Ошибка подключения</h1>
            <p class="subtitle" id="criticalErrorMessage">Потеряна связь с Telegram.<br>Пожалуйста, перезагрузите
                приложение.</p>
            <button class="btn-primary" onclick="window.location.reload()">Перезагрузить</button>
        </div>

        <!-- ЭКРАН: Приветственный -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="logo.jpg" alt="logo">
                </div>
            </div>
            <h1>Бартер для блогеров</h1>
            <p class="subtitle">Эксклюзивное предложение<br>для блогеров и инфлюенсеров</p>
            <div class="welcome-buttons">
                <button class="btn-primary" onclick="app.showRegistration()">Начать</button>
                <button class="btn-secondary" onclick="app.showLogin()">У меня уже есть аккаунт</button>
            </div>
            <div class="auto-login-info" id="autoLoginInfo" style="display: none;">
                <div class="loading-indicator">
                    🔄 Выполняется автоматический вход через Telegram...
                </div>
            </div>
        </div>

        <!-- ЭКРАН: Вход -->
        <div id="loginScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Вход в аккаунт</h2>
                <p class="subtitle">Для старых аккаунтов с паролем</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">Номер телефона *</label>
                    <input type="tel" id="loginPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="loginInstagram">Логин Instagram *</label>
                    <input type="text" id="loginInstagram" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль *</label>
                    <input type="password" id="loginPassword" required placeholder="Введите пароль">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitLogin(this)">Войти</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
            <div class="telegram-info">
                <h4 style="color: var(--accent-primary); margin-bottom: 10px;">💡 Автоматический вход</h4>
                <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                    Если вы открыли приложение через Telegram бот, система попытается найти ваш аккаунт автоматически.
                    Эта форма входа нужна только для аккаунтов, у которых был установлен пароль.
                </p>
            </div>
        </div>

        <!-- ЭКРАН: Регистрация -->
        <div id="registrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Регистрация</h2>
                <p class="subtitle">Заполните информацию о себе</p>
            </div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">Имя *</label>
                    <input type="text" id="firstName" required placeholder="Ваше имя">
                </div>
                <div class="form-group">
                    <label for="phone">Номер телефона *</label>
                    <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="instagramLogin">Логин Instagram *</label>
                    <input type="text" id="instagramLogin" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="followersCount">Количество подписчиков *</label>
                    <input type="number" id="followersCount" required placeholder="Например: 5000" min="1"
                        max="10000000">
                </div>
                <div class="form-group">
                    <label for="avgViews">Среднее количество просмотров сторис *</label>
                    <input type="number" id="avgViews" required placeholder="Например: 500" min="1" max="10000000">
                </div>
                <div class="form-group">
                    <label for="invitationCode">Пригласительный код *</label>
                    <input type="text" id="invitationCode" required placeholder="Введите ваш код">
                </div>
                <div class="form-group">
                    <label for="regPassword">Пароль *</label>
                    <input type="password" id="regPassword" required
                        placeholder="Придумайте пароль (минимум 6 символов)">
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">Повторите пароль *</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="Повторите пароль">
                </div>
                <button type="button" class="btn-primary"
                    onclick="app.submitRegistration(this)">Зарегистрироваться</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
        </div>

        <!-- ЭКРАН: Миграция (установка пароля) -->
        <div id="migrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>Установка пароля</h2>
                <p class="subtitle">Для вашего старого аккаунта нужно установить пароль</p>
            </div>
            <div class="migration-info">
                <p>Мы нашли ваш аккаунт, но у него нет пароля. Пожалуйста, установите новый пароль для безопасности.</p>
            </div>
            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationPassword">Новый пароль *</label>
                    <input type="password" id="migrationPassword" required
                        placeholder="Придумайте пароль (минимум 6 символов)">
                </div>
                <div class="form-group">
                    <label for="migrationPasswordConfirm">Повторите пароль *</label>
                    <input type="password" id="migrationPasswordConfirm" required placeholder="Повторите пароль">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitMigration(this)">Установить пароль</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">← Назад</button>
            </form>
        </div>

        <!-- ЭКРАН: Личный кабинет -->
        <div id="dashboardScreen" class="dashboard" style="display: none;">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">👤</div>
                <div class="user-name" id="userName"></div>
                <div id="userLevel" class="user-level"></div>
                <div class="user-stats">
                    <div class="stat-item" id="vcoinStatItem" style="display: none;">
                        <div class="stat-number" id="vcoinBalanceDisplay">0</div>
                        <div class="stat-label">V-Бонусы</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="followersDisplay">0</div>
                        <div class="stat-label">Подписчики</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="viewsDisplay">0</div>
                        <div class="stat-label">Просмотры</div>
                    </div>
                </div>
            </div>
            <div id="blockedPanel" class="blocked-message" style="display: none;"></div>
            <div id="strikesPanel" class="strikes-panel" style="display: none;"></div>
            <div id="statusPanel" class="action-card"
                style="display: none; border-color: var(--accent-primary); text-align: left;"></div>
            <div id="cooldownPanel" class="action-card"
                style="display: none; background: var(--surface-light-color); border-color: var(--border-color); text-align: center; cursor: default;">
            </div>
            <div id="loyaltyPanel" class="action-card"
                style="display: none; border-color: var(--accent-warning); text-align: center; cursor: default;"></div>
            <div id="reportActionsPanel" class="dashboard-actions" style="margin-top: 20px;"></div>
            <div class="dashboard-actions">
                <div id="newCollaborationBtn" class="action-card" onclick="app.startCollaboration()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="6"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </div>
                    <div class="action-title">Новое сотрудничество</div>
                    <div class="action-desc">Оформить заказ на бартер</div>
                </div>
                <div class="action-card" onclick="app.showOrderHistory()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                            <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                    </div>
                    <div class="action-title">История заказов</div>
                    <div class="action-desc">Просмотреть предыдущие заказы</div>
                </div>
                <div class="action-card" onclick="app.editProfile()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </div>
                    <div class="action-title">Редактировать профиль</div>
                    <div class="action-desc">Изменить данные аккаунта</div>
                </div>
                <div class="action-card" onclick="app.contactAdmin()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                            </path>
                        </svg>
                    </div>
                    <div class="action-title">Связаться с администратором</div>
                    <div class="action-desc">Задать вопрос или получить помощь</div>
                </div>
            </div>
            <button class="btn-secondary" onclick="app.logout()">Выйти из аккаунта</button>
        </div>

        <!-- ЭКРАН: CRM -->
        <div id="crmScreen" class="crm-screen" style="display: none;">
            <div class="crm-header">
                <h2>🔧 Панель управления</h2>
                <button class="btn-back" onclick="app.showDashboard()">← В личный кабинет</button>
            </div>
            <div class="crm-tabs">
                <button class="crm-tab active" data-tab="overview"
                    onclick="app.showCrmTab('overview', this)">Обзор</button>
                <button class="crm-tab" data-tab="analytics"
                    onclick="app.showCrmTab('analytics', this)">Аналитика</button>
                <button class="crm-tab" data-tab="orders" onclick="app.showCrmTab('orders', this)">Заказы</button>
                <button class="crm-tab" data-tab="users" onclick="app.showCrmTab('users', this)">Пользователи</button>
                <button class="crm-tab" data-tab="schedule"
                    onclick="app.showCrmTab('schedule', this)">Расписание</button>
                <button class="crm-tab" data-tab="blocks" onclick="app.showCrmTab('blocks', this)">Блокировки</button>
                <button class="crm-tab" data-tab="broadcast"
                    onclick="app.showCrmTab('broadcast', this)">Рассылка</button>
                <button class="crm-tab" data-tab="menu" onclick="app.showCrmTab('menu', this)">Меню</button>
                <button class="crm-tab" data-tab="admins" onclick="app.showCrmTab('admins', this)">Админы</button>
            </div>
            <div id="crmOverview" class="crm-content active">
                <div class="crm-stats">
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Пользователи</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Заказы</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="newOrders">0</div>
                        <div class="stat-label">Новые</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="blockedSlots">0</div>
                        <div class="stat-label">Блокировки</div>
                    </div>
                </div>
                <div class="admin-contact">
                    <h3>Контакты для пользователей</h3>
                    <a href="https://t.me/oderefyu" class="contact-link" target="_blank">💬 Telegram поддержка</a>
                </div>
                <div
                    style="background: var(--surface-color); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid var(--border-color);">
                    <h3>Общие настройки</h3>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cooldownSetting">Период ожидания между заказами (в днях, для микроблогеров)</label>
                        <input type="number" id="cooldownSetting" min="0" placeholder="Например: 7">
                        <button class="btn-primary" onclick="app.saveSettings(this)" style="margin-top: 15px;">Сохранить
                            настройку</button>
                    </div>
                </div>
            </div>
            <div id="crmAnalytics" class="crm-content">
                <div class="analytics-filters">
                    <div class="form-group">
                        <label>Период:</label>
                        <div class="form-row">
                            <input type="date" id="analyticsStartDate">
                            <input type="date" id="analyticsEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="analyticsCity">Город:</label>
                        <select id="analyticsCity" onchange="app.applyAnalyticsFilters()">
                            <option value="all">Все города</option>
                            <option value="Павлодар">Павлодар</option>
                            <option value="Петропавловск">Петропавловск</option>
                            <option value="Кокшетау">Кокшетау</option>
                            <option value="Костанай">Костанай</option>
                            <option value="Усть-Каменогорск">Усть-Каменогорск</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="app.applyAnalyticsFilters()">Применить</button>
                </div>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>Динамика заказов</h3>
                        <canvas id="ordersTrendChart"></canvas>
                    </div>
                    <div class="chart-container" id="cityChartContainer">
                        <h3>Заказы по городам</h3>
                        <canvas id="cityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Уровни блогеров</h3>
                        <canvas id="bloggerLevelChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Распределение подписчиков</h3>
                        <canvas id="followersDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="crmOrders" class="crm-content">
                <div class="search-container">
                    <input type="text" id="orderSearch" class="search-input"
                        placeholder="Поиск по имени, телефону, Instagram или номеру заказа..."
                        onkeyup="app.filterOrders()">
                    <button id="exportOrdersBtn" class="btn-secondary" onclick="app.exportOrdersToExcel(this)">Экспорт в
                        Excel</button>
                </div>
                <div class="orders-list" id="ordersList"></div>
            </div>
            <div id="crmUsers" class="crm-content">
                <div class="search-container">
                    <input type="text" id="userSearch" class="search-input" placeholder="Поиск пользователей..."
                        onkeyup="app.filterUsers()">
                    <button id="exportUsersBtn" class="btn-secondary" onclick="app.exportUsersToExcel(this)">Экспорт в
                        Excel</button>
                </div>
                <div id="usersList"></div>
            </div>
            <div id="crmSchedule" class="crm-content">
                <div class="form-header">
                    <h2>Управление расписанием</h2>
                    <p class="subtitle">Укажите доступные часы для доставки в формате "10:00-14:00" или "10:00-12:00,
                        14:00-18:00".<br>Оставьте поле пустым, чтобы сделать день недоступным.</p>
                </div>
                <div id="scheduleCityTabs" class="schedule-city-tabs"></div>
                <div id="scheduleFormsContainer"></div>
                <button class="btn-primary" onclick="app.saveSchedule(this)">Сохранить расписание</button>
            </div>
            <div id="crmBlocks" class="crm-content">
                <button class="btn-primary" onclick="app.showAddBlockModal()" style="margin-bottom: 20px;">+ Добавить
                    блокировку</button>
                <div id="blockedSlotsList"></div>
            </div>
            <div id="crmBroadcast" class="crm-content">
                <div class="form-header">
                    <h2>Массовая рассылка</h2>
                    <p class="subtitle">Отправьте сообщение пользователям бота</p>
                </div>
                <div class="form-group">
                    <label>Фильтр по тегам (рассылка будет отправлена пользователям, имеющим хотя бы один из выбранных
                        тегов)</label>
                    <div id="broadcastTagsContainer" class="tags-container"
                        style="min-height: 40px; background: var(--surface-color); padding: 5px; border-radius: var(--border-radius-small); border: 1px solid var(--border-color);">
                    </div>
                    <div style="position: relative;">
                        <input type="text" id="broadcastTagInput" placeholder="Добавьте тег для рассылки..."
                            style="margin-top: 10px;">
                        <div id="tagSuggestions" class="tag-suggestions-container"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">Текст сообщения</label>
                    <textarea id="broadcastMessage" rows="6" placeholder="Введите ваше сообщение здесь..."></textarea>
                </div>
                <div class="telegram-info"
                    style="margin-top: -10px; margin-bottom: 20px; font-size: 13px; padding: 15px; border-left-color: var(--accent-warning);">
                    <h4 style="color: var(--accent-primary); margin-bottom: 10px;">✨ Персонализация (нажмите, чтобы
                        скопировать)</h4>
                    <p style="color: var(--text-secondary); line-height: 1.8;">
                        Используйте плейсхолдеры, и система автоматически подставит данные пользователя.
                        <br><strong>Доступные плейсхолдеры:</strong><br>
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{firstName}</code>,
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{instagramLogin}</code>,
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{followersCount}</code>,
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{level}</code>,
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{rating}</code>
                    </p>
                </div>
                <button class="btn-primary" onclick="app.sendBroadcast(this)">Отправить рассылку</button>
                <div class="telegram-info" style="margin-top: 20px;">
                    <h4 style="color: var(--accent-warning); margin-bottom: 10px;">⚠️ Внимание!</h4>
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                        Эта функция запускает рассылку на сервере. Вы можете закрыть окно после нажатия кнопки. Отчет
                        придет в личные сообщения.
                    </p>
                </div>
            </div>
            <div id="crmAdmins" class="crm-content">
                <button class="btn-primary" onclick="app.showAddAdminModal()" style="margin-bottom: 20px;">+ Добавить
                    сотрудника</button>
                <div id="adminsList"></div>
            </div>
            <div id="crmMenu" class="crm-content">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-primary" onclick="app.showMenuItemModal()" style="flex: 1;">+ Добавить
                        блюдо</button>
                    <input type="file" id="menuFileInput" onchange="app.handleMenuFileSelect(event)"
                        accept=".xlsx, .xls" style="display: none;" />
                    <button id="importMenuBtn" class="btn-secondary" onclick="app.triggerMenuImport()"
                        style="flex: 1;">Импорт из файла</button>
                </div>
                <div class="search-container" style="margin-bottom: 20px;">
                    <input type="text" id="menuSearch" class="search-input" placeholder="Поиск по названию блюда..."
                        onkeyup="app.filterMenuItems()">
                </div>
                <div id="menuItemsListCrm"></div>
            </div>
        </div>

        <!-- ЭКРАНЫ Процесса заказа -->
        <div id="setSelectionScreen" class="form-screen set-selection" style="display: none;">
            <button class="btn-back" onclick="app.showDashboard()">← Назад</button>
            <div class="form-header">
                <h2>Выберите набор</h2>
            </div>
            <div class="set-item" data-set-name="Сет 1" onclick="app.selectSet(this, 'set1')">
                <div class="set-title">Сет 1</div>
                <div class="set-description">Филадельфия с огурцом, Гейша, Лосось с чукой и миндалём</div>
            </div>
            <div class="set-item" data-set-name="Сет 2" onclick="app.selectSet(this, 'set2')">
                <div class="set-title">Сет 2</div>
                <div class="set-description">Классическая Фила, Запечённый с креветкой, Сэндвич с курицей</div>
            </div>
            <button type="button" id="nextFromSet" class="btn-primary" onclick="app.proceedToAddressFromSet()"
                disabled>Далее</button>
        </div>

        <div id="addressScreen" class="form-screen" style="display: none;">
            <button class="btn-back" id="backFromAddress" onclick="app.showDashboard()">← В главное меню</button>
            <div class="form-header">
                <h2>Адрес доставки</h2>
            </div>
            <form id="addressForm">
                <div class="form-group">
                    <label for="city">Город *</label>
                    <select id="city" required onchange="app.handleCityChange()">
                        <option value="">Выберите город</option>
                        <option value="Павлодар">Павлодар</option>
                        <option value="Петропавловск">Петропавловск</option>
                        <option value="Кокшетау">Кокшетау</option>
                        <option value="Костанай">Костанай</option>
                        <option value="Усть-Каменогорск">Усть-Каменогорск</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="street">Улица, дом *</label>
                    <input type="text" id="street" required placeholder="ул. Пушкина, д. 10">
                </div>
                <div class="form-group">
                    <label for="entrance">Подъезд</label>
                    <input type="text" id="entrance" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="floor">Этаж</label>
                    <input type="text" id="floor" placeholder="5">
                </div>
                <div class="form-group">
                    <label for="recipientPhone">Телефон получателя *</label>
                    <input type="tel" id="recipientPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="comment">Дополнительный комментарий</label>
                    <textarea id="comment" rows="3" placeholder="Особые пожелания или комментарии"></textarea>
                </div>
                <button type="button" class="btn-primary" onclick="app.submitAddressAndShowDateTime()">Далее</button>
            </form>
        </div>

        <div id="menuSelectionScreen" class="form-screen menu-screen" style="display: none;">
            <div class="menu-header-sticky">
                <div class="menu-top-bar">
                    <button class="btn-back" onclick="app.showAddressForm()">←</button>
                    <div class="menu-info-bar">
                        <h2>Соберите ваш заказ</h2>
                        <div id="menuBudgetDisplay" class="menu-budget-display">Ваш бюджет: 0</div>
                    </div>
                </div>
                <div id="menu-categories" class="menu-categories"></div>
            </div>
            <div id="menu-items-container"></div>
            <div id="cart-fab" class="cart-fab" style="display: none;">
                <div class="cart-fab-content">
                    <div class="cart-summary">
                        <span class="cart-summary-label">Итого / Бюджет</span>
                        <span id="cart-summary-value" class="cart-summary-value"></span>
                    </div>
                    <div class="cart-progress-bar-container">
                        <div id="cart-progress-bar" class="cart-progress-bar"></div>
                    </div>
                    <button class="btn-primary" onclick="app.checkBalanceAndProceed()">Далее</button>
                </div>
            </div>
        </div>

        <div id="dateTimeScreen" class="form-screen datetime-selection" style="display: none;">
            <button class="btn-back" id="backFromDateTime">← Назад</button>
            <div class="form-header">
                <h2>Время доставки</h2>
                <h4 id="todaysDateHeader" style="color: var(--text-secondary); font-weight: 400; margin-top: -15px;">
                </h4>
            </div>
            <div class="form-group">
                <label for="deliveryTime">Выберите удобное время</label>
                <input type="time" id="deliveryTime" required onchange="app.validateTimeSelection()">
                <div id="timeSelectionInfo" class="telegram-info"
                    style="font-size: 14px; padding: 15px; margin-top: 15px; display: none;"></div>
            </div>
            <button type="button" id="nextFromDateTime" class="btn-primary" onclick="app.showInstructions()"
                disabled>Далее</button>
        </div>

        <div id="instructionsScreen" class="form-screen" style="display: none;">
            <button class="btn-back" onclick="app.showDateTimeSelection()">← Назад</button>
            <div class="form-header">
                <h2>Инструкция для сторис</h2>
            </div>
            <div class="instructions">
                <h3>Чек-лист для сторис:</h3>
                <ul class="checklist">
                    <li>Упомянуть бренд в сторис</li>
                    <li>Отметить наш Instagram @vesla.kz</li>
                    <li>Показывать упаковку и еду</li>
                    <li>Разместить пост до указанного времени</li>
                </ul>
                <div style="margin-top: 20px;">
                    <strong>Пример тезиса:</strong><br>
                    <em>"Я заказала у @vesla.kz — это просто космос! Очень вкусно и качественно!"</em>
                </div>
            </div>
            <div class="warning-message" id="warningMessage">
                ⚠️ Пожалуйста, помните: 3 несданных отчета — и вы будете исключены из программы. Мы уверены, до этого не
                дойдет! 😊
            </div>
            <button type="button" class="btn-primary" onclick="app.submitOrder(this)">Оформить заказ</button>
        </div>

        <!-- Модальные окна -->
        <div id="successModal" class="modal">
            <div class="modal-content">
                <div class="success-icon">✅</div>
                <h2 id="successTitle">Заказ оформлен!</h2>
                <p class="subtitle" id="successMessage">Через 24 часа после доставки вам придет напоминание об отчете
                </p>
                <button id="successModalCloseBtn" class="btn-primary" onclick="app.closeModal()">Закрыть</button>
            </div>
        </div>
        <div id="errorModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">❌</div>
                <h2 id="errorTitle">Ошибка</h2>
                <p class="subtitle" id="errorMessage"></p>
                <button class="btn-primary" onclick="app.closeErrorModal()">Понятно</button>
            </div>
        </div>
        <div id="overdraftModal" class="modal">
            <div class="modal-content">
                <div class="warning-icon">⚠️</div>
                <h2 id="overdraftTitle">Требуется доплата</h2>
                <p class="subtitle" id="overdraftMessage" style="text-align: left; line-height: 1.6;"></p>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.proceedToDateTimeSelection()">Продолжить</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('overdraftModal')">Отмена</button>
                </div>
            </div>
        </div>
        <div id="rejectionModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">😔</div>
                <h2>Спасибо за интерес!</h2>
                <p class="subtitle">На данный момент сотрудничество доступно для блогеров со средней аудиторией от 300
                    просмотров сторис. Следите за нашими обновлениями — возможно, скоро это изменится!</p>
                <button class="btn-primary" onclick="app.closeRejectionModal()">Понятно</button>
            </div>
        </div>
        <div id="orderHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>История заказов</h2>
                <div id="orderHistoryList"
                    style="text-align: left; max-height: 40vh; overflow-y: auto; margin: 20px 0;"></div>
                <button class="btn-primary" onclick="app.closeOrderHistory()">Закрыть</button>
            </div>
        </div>
        <div id="orderDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 id="orderDetailTitle">Детали заказа</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="markReportAcceptedBtn" class="btn-icon btn-icon-unblock"
                            title="Отчет сдан и принят">✔️</button>
                        <button id="markNoReportBtn" class="btn-icon btn-icon-block" title="Отчет не сдан">🚩</button>
                        <button class="btn-danger-icon" id="deleteOrderBtn" title="Удалить заказ">🗑️</button>
                    </div>
                </div>
                <div id="orderDetailBody" class="modal-body"></div>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label for="orderStatusSelect">Изменить статус:</label>
                    <select id="orderStatusSelect" style="width: 100%;">
                        <option value="new">Новый</option>
                        <option value="confirmed">Подтвержден</option>
                        <option value="delivered">Доставлен</option>
                        <option value="awaiting_review">Отчет на проверке</option>
                        <option value="completed">Завершен</option>
                        <option value="rejected">Отчет отклонен</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="app.updateOrderStatus(this)">Сохранить статус</button>
                <button class="btn-secondary" onclick="app.closeOrderDetailModal()"
                    style="margin-top: 10px;">Закрыть</button>
            </div>
        </div>
        <div id="userDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 id="userDetailTitle">Карточка пользователя</h2>
                </div>
                <div id="userDetailBody" class="modal-body"></div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div style="text-align: left;">
                    <label>Добавленные теги:</label>
                    <div id="userTagsContainer" class="tags-container"></div>
                    <div class="form-group">
                        <label for="newTagInput" style="margin-top: 15px;">Добавить тег вручную</label>
                        <div class="input-with-button">
                            <input type="text" id="newTagInput" placeholder="Название тега">
                            <button onclick="app.addUserTag()">+</button>
                        </div>
                    </div>
                </div>

                <hr style="border-color: var(--border-color); margin: 20px 0;">

                <div id="vcoinManagementBlock" class="vcoin-management-block" style="display: none;">
                    <label for="vcoinManageAmount">Управление V-Бонусами</label>
                    <div class="form-group" style="margin-top: 8px;">
                        <input type="number" id="vcoinManageAmount" placeholder="0">
                    </div>
                    <div class="button-group">
                        <button class="btn-primary btn-small" onclick="app.manageVcoins('add')">Начислить</button>
                        <button class="btn-danger btn-small" onclick="app.manageVcoins('remove')">Списать</button>
                    </div>
                </div>

                <button class="btn-secondary" id="resetCooldownBtn" onclick="app.resetOrderCooldown()"
                    style="margin-top: 20px; display: none;">Сбросить ограничение заказа</button>
                <button class="btn-secondary" onclick="app.closeUserDetailModal()"
                    style="margin-top: 10px;">Закрыть</button>
            </div>
        </div>
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <h2 id="reportModalTitle">Сдать отчет</h2>
                <p class="subtitle">Вставьте ссылку на сторис или пост</p>
                <div class="form-group" style="text-align: left;">
                    <label for="reportLink">Ссылка на отчет *</label>
                    <input type="text" id="reportLink" placeholder="https://instagram.com/stories/...">
                </div>
                <button class="btn-primary" onclick="app.submitReport(this)">Отправить</button>
                <button class="btn-secondary" onclick="app.closeReportModal()">Отмена</button>
            </div>
        </div>
        <div id="editProfileModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Редактировать профиль</h2>
                <form id="editProfileForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="editFirstName">Имя *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Телефон *</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editInstagram">Instagram *</label>
                        <input type="text" id="editInstagram" required>
                    </div>
                    <div class="form-group">
                        <label for="editFollowers">Подписчики *</label>
                        <input type="number" id="editFollowers" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editViews">Просмотры *</label>
                        <input type="number" id="editViews" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editPassword">Новый пароль (оставьте пустым, если не меняете)</label>
                        <input type="password" id="editPassword" placeholder="Новый пароль">
                    </div>
                    <div class="form-group">
                        <label for="editVcoinAllowance">Еженедельный лимит V-Бонусов (только для админов)</label>
                        <input type="number" id="editVcoinAllowance" min="0">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.saveProfile(this)">Сохранить</button>
                    <button class="btn-secondary" onclick="app.closeEditProfile()">Отмена</button>
                </div>
            </div>
        </div>

        <div id="addBlockModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Добавить блокировку</h2>
                <form id="addBlockForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="blockCity">Город *</label>
                        <select id="blockCity" required>
                            <option value="">Выберите город</option>
                            <option value="Павлодар">Павлодар</option>
                            <option value="Петропавловск">Петропавловск</option>
                            <option value="Кокшетау">Кокшетау</option>
                            <option value="Костанай">Костанай</option>
                            <option value="Усть-Каменогорск">Усть-Каменогорск</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockDate">Дата *</label>
                        <input type="date" id="blockDate" required>
                    </div>
                    <div class="form-group">
                        <label for="blockType">Тип блокировки *</label>
                        <select id="blockType" required onchange="app.toggleBlockTime()">
                            <option value="range">Диапазон времени</option>
                            <option value="fullday">Весь день</option>
                        </select>
                    </div>
                    <div id="blockTimeGroup">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="blockStartTime">С *</label>
                                <input type="time" id="blockStartTime">
                            </div>
                            <div class="form-group">
                                <label for="blockEndTime">До *</label>
                                <input type="time" id="blockEndTime">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="blockReason">Причина</label>
                        <input type="text" id="blockReason" placeholder="Причина блокировки (необязательно)">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.addBlock(this)">Добавить</button>
                    <button class="btn-secondary" onclick="app.closeAddBlockModal()">Отмена</button>
                </div>
            </div>
        </div>

        <div id="addAdminModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Добавить сотрудника</h2>
                <div class="form-group" style="text-align: left;">
                    <label for="adminRoleSelect">Роль</label>
                    <select id="adminRoleSelect">
                        <option value="operator">Оператор</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                <input type="text" id="adminUserSearch" class="search-input"
                    placeholder="Поиск пользователя для назначения..." onkeyup="app.filterAdminUsers()">
                <div id="adminUsersList" style="text-align: left; max-height: 40vh; overflow-y: auto;"></div>
                <button class="btn-secondary" onclick="app.closeAddAdminModal()"
                    style="margin-top: 20px;">Закрыть</button>
            </div>
        </div>
        <div id="contactModal" class="modal">
            <div class="modal-content">
                <h2>Связаться с администратором</h2>
                <p class="subtitle">Напишите нам в Telegram</p>
                <a href="https://t.me/oderefyu" class="contact-link" target="_blank">💬 Telegram поддержка</a>
                <button class="btn-secondary" onclick="app.closeContactModal()">Закрыть</button>
            </div>
        </div>

        <div id="menuItemModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2 id="menuItemModalTitle">Добавить блюдо</h2>
                <form id="menuItemForm" style="margin: 20px 0; text-align: left;">
                    <input type="hidden" id="menuItemEditId">
                    <input type="hidden" id="menuItemOldImageUrl">
                    <div class="form-group">
                        <label for="menuItemName">Название</label>
                        <input type="text" id="menuItemName" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemDesc">Описание</label>
                        <textarea id="menuItemDesc" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="menuItemPrice">Цена (в тенге)</label>
                        <input type="number" id="menuItemPrice" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemCategory">Категория</label>
                        <select id="menuItemCategory" required>
                            <option value="Сеты">Сеты</option>
                            <option value="Роллы">Роллы</option>
                            <option value="Пицца">Пицца</option>
                            <option value="ВОК / ТОМ-ЯМ">ВОК / ТОМ-ЯМ</option>
                            <option value="Закуски">Закуски</option>
                            <option value="Напитки">Напитки</option>
                            <option value="Дополнительно">Дополнительно</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="menuItemSubcategory">Подкатегория (например, для роллов)</label>
                        <input type="text" id="menuItemSubcategory" placeholder="Например: Филадельфия, Запечённые">
                    </div>
                    <div class="form-group">
                        <label for="menuItemImage">Изображение (будет обрезано до квадрата)</label>
                        <input type="file" id="menuItemImage" accept="image/*">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.saveMenuItem(this)">Сохранить</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('menuItemModal')">Отмена</button>
                </div>
            </div>
        </div>

    </div>

    <div class="admin-panel" id="adminPanel" style="display: none;">
        <button class="admin-btn" onclick="app.showCRM()" title="Панель управления">⚙️</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const app = (function () {

            const BACKEND_URL = 'https://vesla.onrender.com';

            const firebaseConfig = {
                apiKey: "AIzaSyATmIapS6SJi7KnvKrJp5sfD9VMXxKMCgA",
                authDomain: "vesla-barter.firebaseapp.com",
                projectId: "vesla-barter",
                storageBucket: "vesla-barter.appspot.com",
                messagingSenderId: "730193371508",
                appId: "1:730193371508:web:a6517d156f2766ece50c21",
                measurementId: "G-1QJ9RRS1L6"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const FieldValue = firebase.firestore.FieldValue;

            const COLLECTIONS = {
                USERS: 'users',
                ORDERS: 'orders',
                ADMINS: 'admins',
                BLOCKED_SLOTS: 'blockedSlots',
                SCHEDULES: 'schedules',
                SETTINGS: 'settings',
                MENU: 'menu',
                INVITATION_CODES: 'invitationCodes'
            };
            const SCREENS = {
                WELCOME: 'welcomeScreen',
                REGISTRATION: 'registrationScreen',
                LOGIN: 'loginScreen',
                MIGRATION: 'migrationScreen',
                DASHBOARD: 'dashboardScreen',
                CRM: 'crmScreen',
                SET_SELECTION: 'setSelectionScreen',
                ADDRESS: 'addressScreen',
                MENU_SELECTION: 'menuSelectionScreen',
                DATE_TIME: 'dateTimeScreen',
                INSTRUCTIONS: 'instructionsScreen',
                CRITICAL_ERROR: 'criticalErrorScreen'
            };

            let tg;
            let telegramUser = null;
            let currentUserId = null;
            let userData = {};
            let migrationUser = null;
            let currentOrderData = {};
            let currentUserRole = null;
            let cityChart, ordersTrendChart, bloggerLevelChart, followersDistributionChart;
            let currentEditingOrderId = null;
            let currentReportingOrderId = null;
            let currentUserDetailId = null;
            let userListenerUnsubscribe = null;
            let menuObserver = null;
            let appSettings = { orderCooldownDays: 7 };
            let cart = {};
            const LOYALTY_THRESHOLD = 5;
            const VCOIN_RATE = 10;

            const CITIES = ["Павлодар", "Петропавловск", "Кокшетау", "Костанай", "Усть-Каменогорск"];

            function showCriticalError(message) {
                document.getElementById('criticalErrorMessage').innerHTML = message;
                document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen').forEach(s => s.style.display = 'none');
                document.getElementById(SCREENS.CRITICAL_ERROR).style.display = 'flex';
            }

            async function apiFetch(endpoint, options = {}) {
                if (!tg || !tg.initData) {
                    showCriticalError("Данные авторизации Telegram не найдены. Пожалуйста, перезапустите приложение.");
                    throw new Error("Telegram initData is missing.");
                }

                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${tg.initData}`
                };

                if (options.body instanceof FormData) {
                    delete defaultHeaders['Content-Type'];
                }

                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `Сервер вернул ошибку ${response.status}`);
                }

                if (response.status === 204) return;
                return response.json();
            }

            function ensureAuthenticated() {
                if (!currentUserId || !telegramUser) {
                    console.error("Authentication lost. Reloading...");
                    window.location.reload();
                    return false;
                }
                return true;
            }

            async function generateOrderNumber(city) {
                const cityCodes = { 'Павлодар': 'PVL', 'Петропавловск': 'PPK', 'Кокшетау': 'KOK', 'Костанай': 'KSN', 'Усть-Каменогорск': 'UKK' };
                const cityCode = cityCodes[city] || 'UNK';

                const counterRef = db.collection(COLLECTIONS.SETTINGS).doc('orderCounter');

                const newOrderNumber = await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let nextNumber;
                    if (!counterDoc.exists) {
                        nextNumber = 101;
                    } else {
                        const current = counterDoc.data().currentNumber || 100;
                        nextNumber = current + 1;
                    }
                    transaction.set(counterRef, { currentNumber: nextNumber }, { merge: true });
                    return nextNumber;
                });

                return `${cityCode}-${newOrderNumber}`;
            }

            function initTelegram() {
                try {
                    if (window.Telegram && window.Telegram.WebApp) {
                        tg = window.Telegram.WebApp;
                        tg.ready();
                        tg.expand();
                        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                            telegramUser = tg.initDataUnsafe.user;
                            currentUserId = 'tg_' + telegramUser.id;
                            return true;
                        }
                    }
                } catch (error) {
                    console.error('Error initializing Telegram:', error);
                }
                return false;
            }

            function attachUserListener(userId) {
                if (userListenerUnsubscribe) userListenerUnsubscribe();
                userListenerUnsubscribe = db.collection(COLLECTIONS.USERS).doc(userId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            userData = { userId: doc.id, ...doc.data() };
                            updateDashboard();
                        } else {
                            logout();
                        }
                    }, (error) => {
                        console.error("Error with real-time listener: ", error);
                    });
            }

            function hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash &= hash;
                }
                return hash.toString();
            }

            function validatePassword(password) { return password && password.length >= 6; }

            async function getUserRole(userId) {
                if (!userId) return null;
                const checkId = String(userId).replace('tg_', '');
                try {
                    const adminDoc = await db.collection(COLLECTIONS.ADMINS).doc(checkId).get();
                    return adminDoc.exists ? adminDoc.data().role : null;
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    return null;
                }
            }

            async function checkAndSetUserRole() {
                const checkId = telegramUser ? telegramUser.id : (userData.telegramId || null);
                currentUserRole = await getUserRole(checkId);
            }

            function migrateOldAccount(userInfo) {
                if (userInfo && userInfo.registration && !userInfo.registration.password) {
                    migrationUser = userInfo;
                    return true;
                }
                return false;
            }

            async function saveUser(userId, data) {
                if (!userId) throw new Error("User ID is missing");
                try {
                    await db.collection(COLLECTIONS.USERS).doc(userId).set(data, { merge: true });
                } catch (error) {
                    console.error("Error saving data to Firestore: ", error);
                    showError("Ошибка сохранения", "Не удалось сохранить ваши данные. Проверьте интернет-соединение.");
                    throw error;
                }
            }

            async function loadUser(userId) {
                try {
                    const doc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
                    return doc.exists ? { userId: doc.id, ...doc.data() } : null;
                } catch (error) {
                    console.error("Error loading user from Firestore:", error);
                    return null;
                }
            }

            async function findUserByCredentials(phone, instagram, password) {
                try {
                    const snapshot = await db.collection(COLLECTIONS.USERS)
                        .where('registration.phone', '==', phone)
                        .where('registration.instagramLogin', '==', instagram.toLowerCase())
                        .get();
                    if (snapshot.empty) return null;
                    for (const doc of snapshot.docs) {
                        const foundUser = { userId: doc.id, ...doc.data() };
                        if (foundUser.registration.password === hashPassword(password)) return foundUser;
                    }
                    return null;
                } catch (error) {
                    console.error("Error finding user by credentials:", error);
                    return null;
                }
            }

            async function findUserByPhoneAndInstagram(phone, instagram) {
                try {
                    const snapshot = await db.collection(COLLECTIONS.USERS)
                        .where('registration.phone', '==', phone)
                        .where('registration.instagramLogin', '==', instagram.toLowerCase())
                        .get();
                    if (snapshot.empty) return null;
                    const userDoc = snapshot.docs[0];
                    const foundUser = { userId: userDoc.id, ...userDoc.data() };
                    return !foundUser.registration.password ? foundUser : null;
                } catch (error) {
                    console.error("Error finding user for migration:", error);
                    return null;
                }
            }

            async function checkForDuplicateRegistration(phone, instagram, excludeUserId = null) {
                try {
                    const phoneQuery = db.collection(COLLECTIONS.USERS).where('registration.phone', '==', phone).get();
                    const instagramQuery = db.collection(COLLECTIONS.USERS).where('registration.instagramLogin', '==', instagram.toLowerCase()).get();
                    const [phoneSnapshot, instagramSnapshot] = await Promise.all([phoneQuery, instagramQuery]);
                    const phoneExists = !phoneSnapshot.empty && phoneSnapshot.docs[0].id !== excludeUserId;
                    const instagramExists = !instagramSnapshot.empty && instagramSnapshot.docs[0].id !== excludeUserId;
                    return { phoneExists, instagramExists, canRegister: !phoneExists && !instagramExists };
                } catch (error) {
                    console.error("Error checking for duplicates:", error);
                    return { phoneExists: true, instagramExists: true, canRegister: false };
                }
            }

            async function attemptTelegramAutoLogin() {
                if (!telegramUser) return false;
                document.getElementById('autoLoginInfo').style.display = 'block';
                const existingUser = await loadUser('tg_' + telegramUser.id);
                document.getElementById('autoLoginInfo').style.display = 'none';

                if (existingUser) {
                    if (migrateOldAccount(existingUser)) {
                        showScreen(SCREENS.MIGRATION);
                        return false;
                    }
                    currentUserId = existingUser.userId;
                    await saveUser(currentUserId, { lastActivity: FieldValue.serverTimestamp() });
                    await checkAndSetUserRole();
                    attachUserListener(currentUserId);
                    return true;
                }
                return false;
            }

            function fillTelegramData() {
                if (telegramUser && telegramUser.first_name) {
                    document.getElementById('firstName').value = telegramUser.first_name;
                }
            }

            function determineBloggerLevel(followersCount) {
                const count = Number(followersCount) || 0;
                if (count <= 6000) return { level: 'micro', text: 'Микроблогер' };
                if (count <= 10500) return { level: 'macro-a', text: 'Макроблогер тип A' };
                return { level: 'macro-b', text: 'Макроблогер тип B' };
            }

            function showScreen(screenId) {
                document.querySelectorAll('.form-screen, .dashboard, .welcome-screen, .crm-screen, #criticalErrorScreen').forEach(s => s.style.display = 'none');
                document.getElementById(screenId).style.display = (screenId === SCREENS.WELCOME || screenId === SCREENS.CRITICAL_ERROR) ? 'flex' : 'block';
            }

            function showDashboard() {
                if (!ensureAuthenticated()) return;
                showScreen(SCREENS.DASHBOARD);
                document.getElementById('adminPanel').style.display = currentUserRole ? 'block' : 'none';
            }

            function showWelcomeScreen() { showScreen(SCREENS.WELCOME); }
            function showRegistration() {
                if (!telegramUser) {
                    return showCriticalError("Не удалось получить данные Telegram для регистрации. Пожалуйста, перезапустите приложение.");
                }
                showScreen(SCREENS.REGISTRATION);
                fillTelegramData();
            }
            function showLogin() { showScreen(SCREENS.LOGIN); }
            function showSetSelection() { showScreen(SCREENS.SET_SELECTION); }
            function showAddressForm() { showScreen(SCREENS.ADDRESS); }
            function showDateTimeSelection() { showScreen(SCREENS.DATE_TIME); }
            function showInstructions() { showScreen(SCREENS.INSTRUCTIONS); }
            function showMenuScreen() { showScreen(SCREENS.MENU_SELECTION); loadAndRenderMenu(); }


            async function showCRM() {
                if (!ensureAuthenticated()) return;
                if (!currentUserRole) {
                    showError('Доступ запрещен', 'У вас нет прав для доступа к CRM.');
                    return;
                }
                showScreen(SCREENS.CRM);

                document.querySelectorAll('.crm-tab').forEach(tab => {
                    const tabName = tab.dataset.tab;
                    let isVisible = false;
                    if (currentUserRole === 'admin') {
                        isVisible = true;
                    } else if (currentUserRole === 'operator') {
                        const operatorTabs = ['overview', 'orders', 'users', 'schedule', 'blocks'];
                        isVisible = operatorTabs.includes(tabName);
                    }
                    tab.style.display = isVisible ? 'flex' : 'none';
                });

                const firstVisibleTab = document.querySelector('.crm-tab[style*="display: flex"]');
                if (firstVisibleTab) {
                    showCrmTab(firstVisibleTab.dataset.tab, firstVisibleTab);
                }
                updateCRMData();
            }

            function showCrmTab(tabName, element) {
                if (!ensureAuthenticated()) return;
                document.querySelectorAll('.crm-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('crm' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
                element.classList.add('active');

                switch (tabName) {
                    case 'overview':
                        updateCRMStats();
                        document.getElementById('cooldownSetting').value = appSettings.orderCooldownDays;
                        break;
                    case 'analytics': applyAnalyticsFilters(); break;
                    case 'orders': updateOrdersList(); break;
                    case 'users': updateUsersList(); break;
                    case 'schedule': loadSchedule(); break;
                    case 'blocks': updateBlockedSlotsList(); break;
                    case 'admins': updateAdminsList(); break;
                    case 'broadcast': setupBroadcastTagInput(); break;
                    case 'menu': updateMenuItemsListCrm(); break;
                }
            }

            async function withLoading(button, asyncFunction) {
                if (!button || button.disabled) return;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = 'Загрузка...';
                try {
                    await asyncFunction();
                } catch (error) {
                    console.error("Operation failed:", error);
                    showError("Произошла ошибка", error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async function submitLogin(button) {
                await withLoading(button, async () => {
                    const phone = document.getElementById('loginPhone').value.trim();
                    const instagram = document.getElementById('loginInstagram').value.trim();
                    const password = document.getElementById('loginPassword').value.trim();
                    if (!phone || !instagram || !password) return showError('Ошибка', 'Пожалуйста, заполните все поля');

                    const oldUser = await findUserByPhoneAndInstagram(phone, instagram);
                    if (oldUser) {
                        migrationUser = oldUser;
                        showScreen(SCREENS.MIGRATION);
                        return;
                    }

                    const existingUser = await findUserByCredentials(phone, instagram, password);
                    if (existingUser) {
                        currentUserId = existingUser.userId;
                        if (telegramUser && !existingUser.telegramId) {
                            await saveUser(currentUserId, { telegramId: telegramUser.id, merge: true });
                        }
                        await saveUser(currentUserId, { lastActivity: FieldValue.serverTimestamp() });
                        await checkAndSetUserRole();
                        attachUserListener(currentUserId);
                        showDashboard();
                    } else {
                        showError('Неверные данные', 'Проверьте правильность введенных данных.');
                    }
                });
            }

            async function submitMigration(button) {
                await withLoading(button, async () => {
                    const password = document.getElementById('migrationPassword').value.trim();
                    const passwordConfirm = document.getElementById('migrationPasswordConfirm').value.trim();
                    if (!validatePassword(password) || password !== passwordConfirm) {
                        return showError('Ошибка пароля', 'Пароли не совпадают или короче 6 символов.');
                    }

                    if (migrationUser) {
                        migrationUser.registration.password = hashPassword(password);
                        migrationUser.lastActivity = FieldValue.serverTimestamp();
                        if (telegramUser && !migrationUser.telegramId) migrationUser.telegramId = telegramUser.id;
                        await saveUser(migrationUser.userId, migrationUser);
                        currentUserId = migrationUser.userId;
                        migrationUser = null;
                        await checkAndSetUserRole();
                        attachUserListener(currentUserId);
                        showDashboard();
                    }
                });
            }

            // ==============================================================================
            // ======================= ГАРАНТИРОВАННО РАБОЧАЯ ВЕРСИЯ ========================
            // ==============================================================================
            // ==============================================================================
            // ======================= ИСПРАВЛЕННАЯ ВЕРСИЯ РЕГИСТРАЦИИ ======================
            // ==============================================================================
            async function submitRegistration(button) {
                if (!ensureAuthenticated()) return;

                const formValues = {
                    firstName: document.getElementById('firstName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    instagramLogin: document.getElementById('instagramLogin').value.trim().toLowerCase(),
                    followersCount: parseInt(document.getElementById('followersCount').value),
                    avgViews: parseInt(document.getElementById('avgViews').value),
                    password: document.getElementById('regPassword').value.trim(),
                    passwordConfirm: document.getElementById('regPasswordConfirm').value.trim(),
                    invitationCode: document.getElementById('invitationCode').value.trim()
                };

                // --- Валидация осталась прежней ---
                if (!formValues.firstName || !formValues.phone || !formValues.instagramLogin || !formValues.invitationCode || isNaN(formValues.followersCount) || isNaN(formValues.avgViews)) {
                    return showError('Ошибка', 'Пожалуйста, заполните все обязательные поля, включая код приглашения.');
                }
                if (formValues.avgViews < 300) {
                    return showRejectionModal();
                }
                if (!validatePassword(formValues.password) || formValues.password !== formValues.passwordConfirm) {
                    return showError('Ошибка пароля', 'Пароли не совпадают или короче 6 символов.');
                }

                await withLoading(button, async () => {
                    const newUserId = 'tg_' + telegramUser.id;
                    const codesRef = db.collection(COLLECTIONS.INVITATION_CODES);
                    const usersRef = db.collection(COLLECTIONS.USERS);

                    try {
                        // <<< ИЗМЕНЕНИЕ 1: Все проверки выполняются ДО транзакции >>>

                        // 1. Проверяем код приглашения
                        const codeQuery = codesRef.where('code', '==', formValues.invitationCode);
                        const codeSnapshot = await codeQuery.get();
                        if (codeSnapshot.empty) {
                            throw new Error('Неверный пригласительный код.');
                        }
                        const codeDoc = codeSnapshot.docs[0];
                        if (codeDoc.data().isUsed) {
                            throw new Error('Этот пригласительный код уже был использован.');
                        }

                        // 2. Проверяем на дубликаты
                        const { phoneExists, instagramExists } = await checkForDuplicateRegistration(formValues.phone, formValues.instagramLogin);
                        if (phoneExists) {
                            throw new Error('Этот номер телефона уже зарегистрирован.');
                        }
                        if (instagramExists) {
                            throw new Error('Этот логин Instagram уже зарегистрирован.');
                        }

                        // <<< ИЗМЕНЕНИЕ 2: Транзакция теперь только для записи >>>
                        await db.runTransaction(async (transaction) => {
                            // 3. Перепроверяем код внутри транзакции (чтобы избежать гонки запросов)
                            const codeDocRef = codesRef.doc(codeDoc.id);
                            const freshCodeDoc = await transaction.get(codeDocRef);
                            if (freshCodeDoc.data().isUsed) {
                                throw new Error('Этот код только что использовали. Попробуйте другой.');
                            }

                            // 4. Готовим данные для записи
                            const registrationTimestamp = new Date();
                            const bloggerData = determineBloggerLevel(formValues.followersCount);
                            const newUser = {
                                registration: {
                                    firstName: formValues.firstName,
                                    phone: formValues.phone,
                                    instagramLogin: formValues.instagramLogin,
                                    followersCount: formValues.followersCount,
                                    avgViews: formValues.avgViews,
                                    password: hashPassword(formValues.password)
                                },
                                level: bloggerData.level,
                                orders: [],
                                telegramId: telegramUser.id,
                                registrationDate: registrationTimestamp,
                                lastActivity: registrationTimestamp,
                                isBlocked: false, blockReason: '', strikes: 0,
                                tags: [bloggerData.level],
                                loyaltyStatus: 'standard', lastOrderTimestamp: null,
                                cooldownNotified: true, vcoin_balance: 0, vcoin_allowance: 0,
                                usedInvitationCode: formValues.invitationCode
                            };

                            if (bloggerData.level.startsWith('macro')) {
                                newUser.vcoin_balance = 1000;
                                newUser.vcoin_allowance = 1000;
                                newUser.last_allowance_grant = registrationTimestamp;
                            }

                            // 5. Выполняем запись
                            const userDocRef = usersRef.doc(newUserId);
                            transaction.set(userDocRef, newUser);
                            transaction.update(codeDocRef, { isUsed: true, usedBy: newUserId });
                        });

                        // Если транзакция прошла успешно
                        currentUserId = newUserId;
                        await checkAndSetUserRole();
                        attachUserListener(currentUserId);
                        showDashboard();

                    } catch (e) {
                        // Все ошибки (и от проверок, и от транзакции) будут пойманы здесь
                        console.error("Registration failed: ", e);
                        showError('Ошибка регистрации', e.message);
                    }
                });
            }

            function getStatusInfo(status) {
                const statuses = {
                    'new': { text: 'Новый', className: 'status-new' },
                    'confirmed': { text: 'Подтвержден', className: 'status-confirmed' },
                    'delivered': { text: 'Доставлен', className: 'status-delivered' },
                    'awaiting_review': { text: 'На проверке', className: 'status-awaiting_review' },
                    'completed': { text: 'Завершен', className: 'status-completed' },
                    'rejected': { text: 'Отклонен', className: 'status-rejected' }
                };
                return statuses[status] || { text: status, className: '' };
            }

            function formatVBonus(amount) {
                return `<span>${Number(amount).toFixed(1)}</span><span class="v-bonus-icon">V</span>`;
            }

            function updateDashboard() {
                const dataSource = userData.registration || userData;
                if (!dataSource || !dataSource.firstName) return;

                const { firstName, followersCount, avgViews } = dataSource;

                document.getElementById('blockedPanel').style.display = userData.isBlocked ? 'block' : 'none';
                if (userData.isBlocked) {
                    document.getElementById('blockedPanel').innerHTML = `<h4>🔒 Ваш аккаунт заблокирован</h4><p>${userData.blockReason || 'Свяжитесь с администратором.'}</p>`;
                }

                const strikesPanel = document.getElementById('strikesPanel');
                if (userData.strikes && userData.strikes > 0) {
                    strikesPanel.innerHTML = `⚠️ У вас <strong>${userData.strikes}</strong> несданных отчетов. Помните: 3 штрафа приведут к блокировке.`;
                    strikesPanel.style.display = 'block';
                } else {
                    strikesPanel.style.display = 'none';
                }

                document.getElementById('userName').textContent = firstName;
                const userAvatar = document.getElementById('userAvatar');
                userAvatar.innerHTML = telegramUser?.photo_url ? `<img src="${telegramUser.photo_url}" alt="${firstName}">` : (firstName ? firstName.charAt(0).toUpperCase() : '👤');

                const pleasantTitles = ['Инфлюенсер', 'Лидер мнений', 'Создатель контента', 'Трендсеттер', 'Амбассадор'];
                const randomTitle = pleasantTitles[Math.floor(Math.random() * pleasantTitles.length)];
                document.getElementById('userLevel').textContent = randomTitle;

                const vcoinStatBlock = document.getElementById('vcoinStatItem');
                const userStatsGrid = document.querySelector('.user-stats');
                const isMacro = userData.level && userData.level.startsWith('macro');

                if (isMacro) {
                    vcoinStatBlock.style.display = 'block';
                    userStatsGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                } else {
                    vcoinStatBlock.style.display = 'none';
                    userStatsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
                }

                document.getElementById('vcoinBalanceDisplay').innerHTML = formatVBonus(userData.vcoin_balance || 0);
                document.getElementById('followersDisplay').textContent = (followersCount || 0).toLocaleString('ru-RU');
                document.getElementById('viewsDisplay').textContent = (avgViews || 0).toLocaleString('ru-RU');

                const statusPanel = document.getElementById('statusPanel');
                statusPanel.style.display = 'none';
                if (userData.orders && userData.orders.length > 0) {
                    const latestOrder = [...userData.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                    let statusMessage = '';
                    if (latestOrder.status === 'new') statusMessage = `⏳ <strong>Ваш заказ #${latestOrder.orderNumber} в обработке.</strong>`;
                    if (latestOrder.status === 'confirmed') statusMessage = `✅ <strong>Ваш заказ #${latestOrder.orderNumber} подтвержден!</strong>`;
                    if (latestOrder.status === 'delivered') statusMessage = `🚚 <strong>Ваш заказ #${latestOrder.orderNumber} доставлен!</strong>`;

                    if (statusMessage) {
                        statusPanel.innerHTML = statusMessage;
                        statusPanel.style.display = 'block';
                    }
                }

                const reportPanel = document.getElementById('reportActionsPanel');
                reportPanel.innerHTML = '';
                (userData.orders || []).filter(o => o.status === 'delivered').forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'action-card report-action-card';
                    card.onclick = () => showReportModal(order.id, order.orderNumber);
                    card.innerHTML = `<div class="action-icon">📤</div><div class="action-title">Сдать отчет по заказу</div><div class="action-desc">${order.orderNumber}</div>`;
                    reportPanel.appendChild(card);
                });

                const newCollabCard = document.getElementById('newCollaborationBtn');
                const cooldownPanel = document.getElementById('cooldownPanel');
                cooldownPanel.style.display = 'none';
                newCollabCard.style.opacity = '1';
                newCollabCard.style.cursor = 'pointer';
                newCollabCard.onclick = () => app.startCollaboration(); // Reset onclick handler

                if (userData.level === 'micro') {
                    if (userData.lastOrderTimestamp && userData.lastOrderTimestamp.toDate) { // Проверка на timestamp
                        const lastOrderDate = userData.lastOrderTimestamp.toDate();
                        const nextAvailableDate = new Date(new Date(lastOrderDate).setDate(lastOrderDate.getDate() + appSettings.orderCooldownDays));

                        if (new Date() < nextAvailableDate) {
                            newCollabCard.style.opacity = '0.5';
                            newCollabCard.style.cursor = 'not-allowed';
                            newCollabCard.onclick = null; // Prevent click
                            cooldownPanel.innerHTML = `⏳ Следующий заказ будет доступен: <strong>${nextAvailableDate.toLocaleDateString('ru-RU')}</strong>`;
                            cooldownPanel.style.display = 'block';
                        }
                    }
                } else if (userData.level && userData.level.startsWith('macro')) {
                    if (!userData.vcoin_balance || userData.vcoin_balance <= 0) {
                        newCollabCard.style.opacity = '0.5';
                        newCollabCard.style.cursor = 'not-allowed';
                        newCollabCard.onclick = null; // Prevent click
                        cooldownPanel.innerHTML = `💰 Для оформления заказа пополните ваш баланс V-Coin.`;
                        cooldownPanel.style.display = 'block';
                    }
                }
            }

            async function updateCRMData() { updateCRMStats(); }

            async function updateCRMStats() {
                try {
                    const [usersSnap, ordersSnap, newOrdersSnap, blocksSnap] = await Promise.all([
                        db.collection(COLLECTIONS.USERS).get(),
                        db.collection(COLLECTIONS.ORDERS).get(),
                        db.collection(COLLECTIONS.ORDERS).where('status', '==', 'new').get(),
                        db.collection(COLLECTIONS.BLOCKED_SLOTS).get()
                    ]);
                    document.getElementById('totalUsers').textContent = usersSnap.size;
                    document.getElementById('totalOrders').textContent = ordersSnap.size;
                    document.getElementById('newOrders').textContent = newOrdersSnap.size;
                    document.getElementById('blockedSlots').textContent = blocksSnap.size;
                } catch (error) { console.error("Error updating CRM stats:", error); }
            }

            async function applyAnalyticsFilters() {
                const startDate = document.getElementById('analyticsStartDate').value;
                const endDate = document.getElementById('analyticsEndDate').value;
                const city = document.getElementById('analyticsCity').value;
                document.getElementById('cityChartContainer').style.display = (city && city !== 'all') ? 'none' : 'flex';
                updateAllAnalytics({ startDate, endDate, city });
            }

            async function updateAllAnalytics(filters = {}) {
                try {
                    let ordersQuery = db.collection(COLLECTIONS.ORDERS);
                    if (filters.startDate) ordersQuery = ordersQuery.where('createdAt', '>=', new Date(filters.startDate));
                    if (filters.endDate) ordersQuery = ordersQuery.where('createdAt', '<=', new Date(filters.endDate));
                    if (filters.city && filters.city !== 'all') ordersQuery = ordersQuery.where('city', '==', filters.city);

                    const [ordersSnap, usersSnap] = await Promise.all([ordersQuery.get(), db.collection(COLLECTIONS.USERS).get()]);

                    const ordersByDate = {};
                    ordersSnap.forEach(doc => {
                        const dateString = doc.data().createdAt.toDate().toISOString().split('T')[0];
                        ordersByDate[dateString] = (ordersByDate[dateString] || 0) + 1;
                    });
                    const sortedDates = Object.keys(ordersByDate).sort();
                    renderChart('ordersTrendChart', 'line', sortedDates, sortedDates.map(date => ordersByDate[date]), 'Динамика заказов');

                    const cityCounts = {};
                    ordersSnap.forEach(doc => {
                        const city = doc.data().city;
                        if (city) cityCounts[city] = (cityCounts[city] || 0) + 1;
                    });
                    renderChart('cityChart', 'bar', Object.keys(cityCounts), Object.values(cityCounts), 'Заказы по городам');

                    const levelCounts = { 'Микроблогер': 0, 'Макроблогер тип A': 0, 'Макроблогер тип B': 0 };
                    const followerRanges = { '1-5k': 0, '5-10k': 0, '10-20k': 0, '20k+': 0 };
                    usersSnap.forEach(doc => {
                        const followers = (doc.data().registration || doc.data()).followersCount || 0;
                        const levelText = determineBloggerLevel(followers).text;
                        if (levelCounts.hasOwnProperty(levelText)) levelCounts[levelText]++;
                        if (followers <= 5000) followerRanges['1-5k']++;
                        else if (followers <= 10000) followerRanges['5-10k']++;
                        else if (followers <= 20000) followerRanges['10-20k']++;
                        else followerRanges['20k+']++;
                    });
                    renderChart('bloggerLevelChart', 'doughnut', Object.keys(levelCounts), Object.values(levelCounts), 'Уровни блогеров');
                    renderChart('followersDistributionChart', 'pie', Object.keys(followerRanges), Object.values(followerRanges), 'Подписчики');

                } catch (e) { console.error("Analytics error:", e) }
            }

            function renderChart(canvasId, type, labels, data, label) {
                let chartInstance;
                if (canvasId === 'cityChart') chartInstance = cityChart;
                else if (canvasId === 'ordersTrendChart') chartInstance = ordersTrendChart;
                else if (canvasId === 'bloggerLevelChart') chartInstance = bloggerLevelChart;
                else if (canvasId === 'followersDistributionChart') chartInstance = followersDistributionChart;

                const ctx = document.getElementById(canvasId)?.getContext('2d');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();

                const chartColors = ['rgba(0, 180, 216, 0.7)', 'rgba(255, 107, 53, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)'];
                const newChartInstance = new Chart(ctx, {
                    type: type,
                    data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: chartColors, borderColor: chartColors, borderWidth: 1, tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: (type === 'line' || type === 'bar') ? { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } : {}, plugins: { legend: { labels: { color: '#fff' } } } }
                });

                if (canvasId === 'cityChart') cityChart = newChartInstance;
                else if (canvasId === 'ordersTrendChart') ordersTrendChart = newChartInstance;
                else if (canvasId === 'bloggerLevelChart') bloggerLevelChart = newChartInstance;
                else if (canvasId === 'followersDistributionChart') followersDistributionChart = newChartInstance;
            }

            async function updateOrdersList() {
                const list = document.getElementById('ordersList');
                list.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                try {
                    const snapshot = await db.collection(COLLECTIONS.ORDERS).orderBy('createdAt', 'desc').get();
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="empty-state">Нет заказов.</div>';
                        return;
                    }
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const order = { id: doc.id, ...doc.data() };
                        const statusInfo = getStatusInfo(order.status);
                        const el = document.createElement('div');
                        el.className = 'order-item';
                        el.dataset.search = `${order.userName} ${order.phone} ${order.instagram} ${order.orderNumber}`.toLowerCase();
                        el.onclick = () => showOrderDetailModal(order.id);
                        el.innerHTML = `
                        <div class="order-header">
                            <span class="order-id">${order.orderNumber}</span>
                            <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                        </div>
                        <div class="order-info">
                            <strong>${order.userName}</strong> (${order.city})<br>
                            <small>Создан: ${order.createdAt.toDate().toLocaleString('ru-RU')}</small>
                        </div>`;
                        list.appendChild(el);
                    });
                } catch (error) {
                    console.error("Error fetching orders:", error);
                    list.innerHTML = '<div class="empty-state">Ошибка загрузки.</div>';
                }
            }

            function calculateBloggerRating(user) {
                const { followersCount = 0, avgViews = 0 } = user.registration || user;
                const strikes = user.strikes || 0;
                const followersScore = followersCount > 0 ? Math.log10(followersCount) * 2.5 : 0;
                const viewsScore = avgViews > 0 ? Math.log10(avgViews) * 4.5 : 0;
                let rating = ((followersScore + viewsScore - (strikes * 1.5)) / 25) * 10;
                return Math.max(1, Math.min(10, rating)).toFixed(1);
            }

            async function updateUsersList() {
                const list = document.getElementById('usersList');
                list.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                try {
                    const [usersSnapshot, adminsSnapshot] = await Promise.all([
                        db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get(),
                        db.collection(COLLECTIONS.ADMINS).get()
                    ]);
                    const adminData = new Map(adminsSnapshot.docs.map(doc => [doc.id, doc.data()]));
                    if (usersSnapshot.empty) {
                        list.innerHTML = '<div class="empty-state">Нет пользователей.</div>';
                        return;
                    }
                    list.innerHTML = '';
                    usersSnapshot.forEach(doc => {
                        const user = { userId: doc.id, ...doc.data() };
                        const reg = user.registration || user;
                        if (!reg.firstName) return;

                        const adminInfo = adminData.get(String(user.telegramId));
                        const rating = calculateBloggerRating(user);
                        const el = document.createElement('div');
                        el.className = `user-item ${user.isBlocked ? 'blocked' : ''}`;
                        el.dataset.search = `${reg.firstName} ${reg.phone} ${reg.instagramLogin}`.toLowerCase();
                        el.onclick = () => showUserDetailModal(user.userId);

                        let badges = '';
                        if (user.loyaltyStatus === 'premium') badges += `<span class="user-admin-badge" style="background-color: #ffc107;">Premium</span>`;
                        if (adminInfo) badges += `<span class="user-admin-badge" style="margin-left: 5px;">${adminInfo.role}</span>`;
                        if (user.isBlocked) badges += `<span class="user-blocked-badge" style="margin-left: 5px;">Заблокирован</span>`;

                        el.innerHTML = `
                        <div class="user-details">
                            <div class="user-header">
                               <span class="user-name-phone">${reg.firstName}</span>
                               <span class="user-rating">⭐ ${rating}</span>
                            </div>
                            <div style="font-size: 14px; color: #ccc;">
                                <a href="https://www.instagram.com/${reg.instagramLogin.replace('@', '')}" target="_blank" style="color: #ccc; text-decoration: none;">
                                    @${reg.instagramLogin}
                                </a>
                            </div>
                            ${badges ? `<div style="margin-top:5px;">${badges}</div>` : ''}
                        </div>
                        <div class="user-controls">
                           ${user.isBlocked
                                ? `<button class="btn-icon-unblock" title="Разблокировать" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', false)">🔓</button>`
                                : `<button class="btn-icon-block" title="Заблокировать" onclick="event.stopPropagation(); app.toggleUserBlock('${user.userId}', true)">🔒</button>`
                            }
                           <button class="btn-danger-icon" title="Удалить" onclick="event.stopPropagation(); app.removeUser('${user.userId}', '${reg.firstName}')">🗑️</button>
                        </div>`;
                        list.appendChild(el);
                    });
                } catch (error) {
                    console.error("Error fetching users:", error);
                    list.innerHTML = '<div class="empty-state">Ошибка загрузки.</div>';
                }
            }

            async function updateBlockedSlotsList() {
                const list = document.getElementById('blockedSlotsList');
                list.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                try {
                    const snapshot = await db.collection(COLLECTIONS.BLOCKED_SLOTS).get();
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="empty-state">Нет блокировок.</div>';
                        return;
                    }
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const block = { id: doc.id, ...doc.data() };
                        let timeInfo = 'Весь день';
                        if (block.type === 'range') {
                            timeInfo = `с ${block.startTime} до ${block.endTime}`;
                        }

                        const el = document.createElement('div');
                        el.className = 'blocked-slot';
                        el.innerHTML = `
                        <div class="blocked-slot-info">
                            <div class="blocked-slot-city">${block.city}</div>
                            <div class="blocked-slot-time">${block.date} (${timeInfo})</div>
                        </div>
                        <button class="btn-danger-icon" onclick="app.removeBlock('${block.id}')">🗑️</button>`;
                        list.appendChild(el);
                    });
                } catch (error) {
                    console.error("Error fetching blocks:", error);
                    list.innerHTML = '<div class="empty-state">Ошибка загрузки.</div>';
                }
            }

            async function updateAdminsList() {
                const list = document.getElementById('adminsList');
                list.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                try {
                    const snapshot = await db.collection(COLLECTIONS.ADMINS).get();
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="empty-state">Нет сотрудников.</div>';
                        return;
                    }
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const admin = { id: doc.id, ...doc.data() };
                        const receivesNotifications = admin.receivesNotifications !== false;
                        const el = document.createElement('div');
                        el.className = 'user-item';
                        el.innerHTML = `
                        <div class="user-details">
                            <span class="user-name-phone">${admin.name || 'Сотрудник'}</span>
                            <div style="margin-top: 5px;"><span class="user-admin-badge">${admin.role}</span></div>
                        </div>
                        <div class="user-controls">
                            <button class="btn-icon" 
                                    title="${receivesNotifications ? 'Отключить уведомления' : 'Включить уведомления'}" 
                                    onclick="event.stopPropagation(); app.toggleAdminNotifications('${admin.id}', ${receivesNotifications})">
                                ${receivesNotifications ? '🔔' : '🔕'}
                            </button>
                            ${admin.id !== '1345815453' ? `<button class="btn-danger-icon" onclick="event.stopPropagation(); app.removeAdmin('${admin.id}')">🗑️</button>` : ''}
                        </div>`;
                        list.appendChild(el);
                    });
                } catch (error) {
                    console.error("Error fetching admins:", error);
                    list.innerHTML = '<div class="empty-state">Ошибка загрузки.</div>';
                }
            }

            async function updateOrderStatus(button) {
                await withLoading(button, async () => {
                    if (!currentEditingOrderId) return;
                    const newStatus = document.getElementById('orderStatusSelect').value;

                    await apiFetch('/api/update-order-status', {
                        method: 'POST',
                        body: JSON.stringify({
                            orderId: currentEditingOrderId,
                            newStatus: newStatus
                        })
                    });

                    closeOrderDetailModal();
                    showCrmSuccess('Статус обновлен!');
                    updateOrdersList();
                });
            }

            function filter(inputId, listSelector, itemSelector) {
                const query = document.getElementById(inputId).value.toLowerCase();
                document.querySelectorAll(`${listSelector} ${itemSelector}`).forEach(item => {
                    item.style.display = (item.dataset.search || '').includes(query) ? '' : 'none';
                });
            }
            function filterOrders() { filter('orderSearch', '#ordersList', '.order-item'); }
            function filterUsers() { filter('userSearch', '#usersList', '.user-item'); }
            function filterAdminUsers() { filter('adminUserSearch', '#adminUsersList', '.user-item'); }
            function filterMenuItems() { filter('menuSearch', '#menuItemsListCrm', '.user-item'); }

            async function addBlock(button) {
                await withLoading(button, async () => {
                    const city = document.getElementById('blockCity').value;
                    const date = document.getElementById('blockDate').value;
                    const type = document.getElementById('blockType').value;
                    const reason = document.getElementById('blockReason').value.trim();

                    if (!city || !date) {
                        return showError('Ошибка', 'Город и дата обязательны для заполнения.');
                    }

                    let blockData;
                    let blockId;

                    if (type === 'fullday') {
                        blockId = `${city}_${date}_fullday`;
                        blockData = { city, date, type, reason };
                    } else { // type is 'range'
                        const startTime = document.getElementById('blockStartTime').value;
                        const endTime = document.getElementById('blockEndTime').value;
                        if (!startTime || !endTime || startTime >= endTime) {
                            return showError('Ошибка', 'Укажите корректный диапазон времени (время начала должно быть раньше времени окончания).');
                        }
                        blockId = db.collection('blockedSlots').doc().id;
                        blockData = { city, date, type, reason, startTime, endTime };
                    }

                    await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).set(blockData);
                    closeAddBlockModal();
                    updateBlockedSlotsList();
                    showCrmSuccess('Блокировка добавлена!');
                });
            }

            async function removeBlock(blockId) {
                if (confirm('Удалить блокировку?')) {
                    await db.collection(COLLECTIONS.BLOCKED_SLOTS).doc(blockId).delete();
                    updateBlockedSlotsList();
                }
            }

            async function toggleUserBlock(userId, shouldBlock) {
                const reason = shouldBlock ? prompt("Причина блокировки:", "") : '';
                if (shouldBlock && reason === null) return;
                await db.collection(COLLECTIONS.USERS).doc(userId).update({ isBlocked: shouldBlock, blockReason: shouldBlock ? reason : '' });
                showCrmSuccess(`Пользователь ${shouldBlock ? 'заблокирован' : 'разблокирован'}.`);
                updateUsersList();
            }

            async function removeUser(userId, userName) {
                const confirmationText = 'УДАЛИТЬ';
                const promptResult = prompt(`Это действие необратимо. Чтобы удалить пользователя ${userName}, введите "${confirmationText}" в поле ниже.`);

                if (promptResult === confirmationText) {
                    const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                    const userDoc = await userRef.get();
                    if (!userDoc.exists) return;

                    const user = userDoc.data();
                    if (user.telegramId) {
                        const adminRole = await getUserRole(user.telegramId);
                        if (adminRole) {
                            showError("Действие запрещено", "Нельзя удалить пользователя, который является сотрудником. Сначала снимите с него права в разделе 'Админы'.");
                            return;
                        }
                    }

                    const batch = db.batch();
                    batch.delete(userRef);
                    (user.orders || []).forEach(order => {
                        batch.delete(db.collection(COLLECTIONS.ORDERS).doc(order.id));
                    });
                    await batch.commit();
                    showCrmSuccess(`Пользователь ${userName} удален.`);
                    updateUsersList();
                } else if (promptResult !== null) {
                    showError("Удаление отменено", "Текст подтверждения введен неверно.");
                }
            }

            async function addAdmin(userId, userName, role) {
                if (!userId) return;
                const userDoc = await loadUser(userId);
                const telegramId = userDoc?.telegramId;
                if (!telegramId) return showError("Ошибка", "У пользователя нет Telegram ID.");

                const newAdmin = {
                    name: userName,
                    role: role,
                    addedAt: FieldValue.serverTimestamp(),
                    receivesNotifications: true
                };
                await db.collection(COLLECTIONS.ADMINS).doc(String(telegramId)).set(newAdmin);

                const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                const tags = userDoc.tags || [];
                if (!tags.includes(role)) tags.push(role);
                await userRef.update({ tags: tags });

                closeAddAdminModal();
                updateAdminsList();
                showCrmSuccess(`${userName} назначен на роль: ${role}!`);
            }

            async function toggleAdminNotifications(adminId, currentState) {
                const adminRef = db.collection(COLLECTIONS.ADMINS).doc(adminId);
                try {
                    await adminRef.update({ receivesNotifications: !currentState });
                    showCrmSuccess('Настройки уведомлений обновлены.');
                    updateAdminsList();
                } catch (error) {
                    console.error('Ошибка при изменении настроек уведомлений:', error);
                    showError('Ошибка', 'Не удалось обновить настройки.');
                }
            }

            async function removeAdmin(adminId) {
                if (adminId === '1345815453') return showError('Ошибка', 'Нельзя удалить главного администратора');
                if (confirm(`Удалить сотрудника?`)) {
                    const adminRef = db.collection(COLLECTIONS.ADMINS).doc(adminId);
                    const adminDoc = await adminRef.get();
                    if (!adminDoc.exists) return;
                    const role = adminDoc.data().role;

                    const usersSnapshot = await db.collection(COLLECTIONS.USERS).where('telegramId', '==', Number(adminId)).get();
                    if (!usersSnapshot.empty) {
                        const userDoc = usersSnapshot.docs[0];
                        const tags = userDoc.data().tags.filter(t => t !== role);
                        await db.collection(COLLECTIONS.USERS).doc(userDoc.id).update({ tags: tags });
                    }

                    await adminRef.delete();
                    updateAdminsList();
                    showCrmSuccess('Сотрудник удален!');
                }
            }

            async function removeOrder(orderId) {
                if (confirm('Удалить этот заказ? Действие необратимо.')) {
                    await withLoading(document.getElementById('deleteOrderBtn'), async () => {
                        const orderRef = db.collection(COLLECTIONS.ORDERS).doc(orderId);
                        const orderDoc = await orderRef.get();
                        if (!orderDoc.exists) return;
                        const userId = orderDoc.data().userId;
                        const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                        const batch = db.batch();
                        batch.delete(orderRef);
                        const userDoc = await userRef.get();
                        if (userDoc.exists) {
                            const updatedOrders = (userDoc.data().orders || []).filter(o => o.id !== orderId);
                            batch.update(userRef, { orders: updatedOrders });
                        }
                        await batch.commit();
                        closeOrderDetailModal();
                        updateOrdersList();
                        showCrmSuccess('Заказ удален.');
                    });
                }
            }

            async function markReportAccepted(button) {
                if (button.disabled) return;
                if (!confirm('Отчет принят? Это засчитает заказ в программе лояльности.')) return;
                await withLoading(button, async () => {
                    const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentEditingOrderId);
                    const orderDoc = await orderRef.get();
                    if (!orderDoc.exists) return;
                    const orderData = orderDoc.data();
                    const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);

                    const batch = db.batch();
                    batch.update(orderRef, { status: 'completed', reportAccepted: true });

                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const orders = (userDoc.data().orders || []).map(o => o.id === currentEditingOrderId ? { ...o, status: 'completed' } : o);
                        batch.update(userRef, { orders: orders });
                    }
                    await batch.commit();
                    await checkAndUpgradeLoyaltyStatus(orderData.userId);

                    showCrmSuccess('Отчет принят, заказ завершен.');
                    closeOrderDetailModal();
                    updateOrdersList();
                    updateUsersList();
                });
            }

            async function checkAndUpgradeLoyaltyStatus(userId) {
                const userRef = db.collection(COLLECTIONS.USERS).doc(userId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;

                const user = userDoc.data();
                if (user.loyaltyStatus === 'premium') return;

                const completedOrders = (user.orders || []).filter(o => o.status === 'completed').length;

                if (completedOrders >= LOYALTY_THRESHOLD) {
                    await userRef.update({ loyaltyStatus: 'premium' });
                    if (user.telegramId) {
                        const message = `⭐ Поздравляем, ${user.registration.firstName}! Вы достигли премиум-статуса. Спасибо за ваше активное участие!`;
                        await sendTelegramNotification(user.telegramId, message);
                    }
                }
            }

            async function markNoReport(button, orderId, orderNumber) {
                if (button.disabled) return;
                const orderRef = db.collection(COLLECTIONS.ORDERS).doc(orderId);
                const orderDoc = await orderRef.get();
                if (orderDoc.exists && orderDoc.data().reportMissed) {
                    showError('Ошибка', 'На этот заказ уже был наложен штраф.');
                    return;
                }

                if (!confirm('Отчет по заказу не сдан? Это добавит штрафной балл.')) return;

                await withLoading(button, async () => {
                    const orderData = orderDoc.data();
                    const userRef = db.collection(COLLECTIONS.USERS).doc(orderData.userId);

                    const userDoc = await userRef.get();
                    if (!userDoc.exists) throw new Error("User not found!");

                    const newStrikes = (userDoc.data().strikes || 0) + 1;
                    const updates = { strikes: newStrikes };
                    if (newStrikes >= 3) {
                        updates.isBlocked = true;
                        updates.blockReason = `Автоматическая блокировка: ${newStrikes} несданных отчета.`;
                    }

                    const batch = db.batch();
                    batch.update(userRef, updates);
                    const orders = (userDoc.data().orders || []).map(o => o.id === orderId ? { ...o, status: 'completed' } : o);
                    batch.update(userRef, { orders: orders });
                    batch.update(orderRef, { reportMissed: true, status: 'completed' });

                    await batch.commit();

                    if (userDoc.data().telegramId) {
                        const message = `🚩 Внимание: Вы не сдали отчет по заказу #${orderNumber} вовремя. Вам начислен 1 штрафной балл. После 3-х штрафов ваш аккаунт будет заблокирован.`;
                        await sendTelegramNotification(userDoc.data().telegramId, message);
                    }

                    showCrmSuccess('Штрафной балл добавлен, заказ закрыт.');
                    closeOrderDetailModal();
                    updateUsersList();
                });
            }

            async function sendBroadcast(button) {
                await withLoading(button, async () => {
                    const message = document.getElementById('broadcastMessage').value.trim();
                    const selectedTags = Array.from(document.querySelectorAll('#broadcastTagsContainer .tag')).map(el => el.textContent.replace(' ×', ''));

                    if (!message) {
                        return showError('Ошибка', 'Сообщение не может быть пустым.');
                    }

                    await apiFetch('/api/broadcast', {
                        method: 'POST',
                        body: JSON.stringify({
                            message: message,
                            tags: selectedTags,
                            senderChatId: telegramUser.id
                        })
                    });

                    showCrmSuccess("Запрос принят!", "Рассылка запущена на сервере. Отчет придет в личные сообщения.");
                });
            }

            function startCollaboration() {
                if (userData.isBlocked) return;
                currentOrderData = {};
                cart = {};

                if (userData.level === 'micro') {
                    if (userData.lastOrderTimestamp && userData.lastOrderTimestamp.toDate) {
                        const lastOrderDate = userData.lastOrderTimestamp.toDate();
                        const nextAvailableDate = new Date(new Date(lastOrderDate).setDate(lastOrderDate.getDate() + appSettings.orderCooldownDays));
                        if (new Date() < nextAvailableDate) {
                            showError("Заказ недоступен", `Следующий заказ будет доступен ${nextAvailableDate.toLocaleDateString('ru-RU')}.`);
                            return;
                        }
                    }
                    showSetSelection();
                }
                else if (userData.level && userData.level.startsWith('macro')) {
                    if (!userData.vcoin_balance || userData.vcoin_balance <= 0) {
                        showError("Нет бонусов", "Для оформления заказа пополните ваш баланс V-Coin.");
                        return;
                    }
                    showAddressForm();
                    document.getElementById('backFromAddress').onclick = () => app.showDashboard();
                }
                else {
                    showError("Ошибка", "Не удалось определить ваш уровень. Свяжитесь с поддержкой.");
                }
            }

            function proceedToAddressFromSet() {
                document.getElementById('backFromAddress').onclick = () => app.showSetSelection();
                showAddressForm();
            }

            function handleCityChange() { }

            function selectSet(element, setId) {
                document.querySelectorAll('.set-item').forEach(item => item.classList.remove('selected'));
                element.classList.add('selected');
                currentOrderData.set = setId;
                currentOrderData.setName = element.dataset.setName;
                document.getElementById('nextFromSet').disabled = false;
            }

            function submitAddressAndShowDateTime() {
                if (!validateAddressForm()) return;
                currentOrderData.city = document.getElementById('city').value;
                currentOrderData.street = document.getElementById('street').value;
                currentOrderData.entrance = document.getElementById('entrance').value;
                currentOrderData.floor = document.getElementById('floor').value;
                currentOrderData.recipientPhone = document.getElementById('recipientPhone').value;
                currentOrderData.comment = document.getElementById('comment').value;

                const backButton = document.getElementById('backFromDateTime');

                const isMacro = userData.level && userData.level.startsWith('macro');

                if (isMacro) {
                    backButton.onclick = () => app.showMenuScreen();
                    showMenuScreen();
                }
                else { // isMicro
                    backButton.onclick = () => app.showAddressForm();
                    showDateTimeSelection();
                    setupTimeSelection();
                }
            }

            async function setupTimeSelection() {
                currentOrderData.time = '';
                const nextButton = document.getElementById('nextFromDateTime');
                const timeInput = document.getElementById('deliveryTime');
                const timeInfo = document.getElementById('timeSelectionInfo');

                nextButton.disabled = true;
                timeInput.value = '';
                timeInfo.style.display = 'none';
                timeInfo.style.color = '#ccc';

                const today = new Date();
                const dateValue = today.toISOString().split('T')[0];
                const formattedDate = today.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                document.getElementById('todaysDateHeader').textContent = `Доставка на сегодня, ${formattedDate}`;
                currentOrderData.date = dateValue;

                const city = currentOrderData.city;

                const schedulePromise = db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
                const blocksPromise = db.collection(COLLECTIONS.BLOCKED_SLOTS).where('city', '==', city).where('date', '==', dateValue).get();
                const [scheduleDoc, blocksSnapshot] = await Promise.all([schedulePromise, blocksPromise]);

                const blockedRanges = [];
                blocksSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'fullday') {
                        timeInfo.innerHTML = 'К сожалению, на сегодня доставка в этом городе полностью недоступна.';
                        timeInfo.style.display = 'block';
                        timeInput.disabled = true;
                        return;
                    }
                    if (data.type === 'range') {
                        blockedRanges.push({ start: data.startTime, end: data.endTime });
                    }
                });
                currentOrderData.blockedRanges = blockedRanges;

                if (!scheduleDoc.exists) {
                    timeInfo.innerHTML = 'Расписание для этого города не настроено.';
                    timeInfo.style.display = 'block';
                    timeInput.disabled = true;
                    return;
                }

                const scheduleData = scheduleDoc.data();
                const dayKey = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][today.getDay()];
                const daySchedule = scheduleData[dayKey] || '';

                if (!daySchedule) {
                    timeInfo.innerHTML = 'Сегодня выходной. Доставка недоступна.';
                    timeInfo.style.display = 'block';
                    timeInput.disabled = true;
                    return;
                }

                const availableRanges = daySchedule.split(',').map(rangeStr => {
                    const [start, end] = rangeStr.trim().split('-');
                    return { start, end };
                }).filter(range => range.start && range.end);

                if (availableRanges.length === 0) {
                    timeInfo.innerHTML = 'Сегодня нет доступных слотов для доставки.';
                    timeInfo.style.display = 'block';
                    timeInput.disabled = true;
                    return;
                }

                currentOrderData.availableRanges = availableRanges;

                const now = new Date();
                now.setMinutes(now.getMinutes() + 45); // Буфер
                const earliestTime = now.toTimeString().slice(0, 5);

                const firstAvailableSlotStart = availableRanges[0].start;
                const lastAvailableSlotEnd = availableRanges[availableRanges.length - 1].end;

                const effectiveMinTime = earliestTime > firstAvailableSlotStart ? earliestTime : firstAvailableSlotStart;

                if (effectiveMinTime >= lastAvailableSlotEnd) {
                    timeInfo.innerHTML = 'К сожалению, все слоты на сегодня уже прошли. Попробуйте завтра!';
                    timeInfo.style.display = 'block';
                    timeInput.disabled = true;
                    return;
                }

                timeInput.min = effectiveMinTime;
                timeInput.max = lastAvailableSlotEnd;
                timeInput.disabled = false;

                timeInfo.innerHTML = `Доступное время: <strong>${daySchedule}</strong>.`;
                timeInfo.style.display = 'block';
            }

            function validateTimeSelection() {
                const timeInput = document.getElementById('deliveryTime');
                const timeInfo = document.getElementById('timeSelectionInfo');
                const nextButton = document.getElementById('nextFromDateTime');
                const selectedTime = timeInput.value;

                nextButton.disabled = true;
                timeInfo.style.color = '#ccc';
                const scheduleText = currentOrderData.availableRanges.map(r => `${r.start}-${r.end}`).join(', ');
                timeInfo.innerHTML = `Доступное время: <strong>${scheduleText}</strong>.`;

                if (!selectedTime) return;

                const isInSchedule = currentOrderData.availableRanges.some(range => {
                    return selectedTime >= range.start && selectedTime < range.end;
                });

                if (!isInSchedule) {
                    timeInfo.innerHTML = `Выбранное время (${selectedTime}) не входит в рабочие часы.`;
                    timeInfo.style.color = '#dc3545';
                    timeInput.value = '';
                    return;
                }

                for (const range of currentOrderData.blockedRanges) {
                    if (selectedTime >= range.start && selectedTime < range.end) {
                        timeInfo.innerHTML = `Выбранное время (${selectedTime}) временно недоступно.`;
                        timeInfo.style.color = '#dc3545';
                        timeInput.value = '';
                        return;
                    }
                }

                const now = new Date();
                now.setMinutes(now.getMinutes() + 45);
                const earliestTime = now.toTimeString().slice(0, 5);
                if (selectedTime < earliestTime) {
                    timeInfo.innerHTML = `Минимальное время для заказа — ${earliestTime}.`;
                    timeInfo.style.color = '#dc3545';
                    timeInput.value = '';
                    return;
                }

                currentOrderData.time = selectedTime;
                nextButton.disabled = false;
            }

            function validateAddressForm() {
                const city = document.getElementById('city').value;
                const street = document.getElementById('street').value;
                const phone = document.getElementById('recipientPhone').value;
                if (!city || !street || !phone) {
                    showError('Ошибка', 'Заполните: город, улица, телефон.');
                    return false;
                }
                return true;
            }

            async function submitOrder(button) {
                await withLoading(button, async () => {
                    const orderId = db.collection(COLLECTIONS.ORDERS).doc().id;
                    const dataSource = userData.registration || userData;

                    const newOrder = {
                        ...currentOrderData,
                        id: orderId,
                        status: 'new',
                        orderNumber: await generateOrderNumber(currentOrderData.city),
                        userId: currentUserId,
                        userName: dataSource.firstName,
                        instagram: dataSource.instagramLogin,
                        phone: dataSource.phone,
                        followersCount: dataSource.followersCount,
                        createdAt: FieldValue.serverTimestamp(),
                        reminderSent: false,
                        reportMissed: false,
                        budget: currentOrderData.budget
                    };

                    await apiFetch('/api/create-order', {
                        method: 'POST',
                        body: JSON.stringify({ order: newOrder })
                    });

                    showSuccessMessage("Заказ успешно оформлен!", "Вам придет уведомление в Telegram. Ожидайте подтверждения от оператора.");
                });
            }

            function showOrderHistory() {
                const list = document.getElementById('orderHistoryList');
                const sortedOrders = (userData.orders || []).sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                if (sortedOrders.length === 0) {
                    list.innerHTML = '<div class="empty-state">Нет заказов.</div>';
                } else {
                    list.innerHTML = sortedOrders.map(order => {
                        const statusInfo = getStatusInfo(order.status);
                        return `<div class="order-item">
                        <div class="order-header">
                            <span class="order-id">${order.orderNumber}</span>
                            <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                        </div>
                    </div>`;
                    }).join('');
                }
                document.getElementById('orderHistoryModal').style.display = 'flex';
            }

            function editProfile() {
                const reg = userData.registration || userData;
                document.getElementById('editFirstName').value = reg.firstName;
                document.getElementById('editPhone').value = reg.phone;
                document.getElementById('editInstagram').value = reg.instagramLogin;
                document.getElementById('editFollowers').value = reg.followersCount;
                document.getElementById('editViews').value = reg.avgViews;
                document.getElementById('editPassword').value = '';

                const vcoinInput = document.getElementById('editVcoinAllowance');
                vcoinInput.value = userData.vcoin_allowance || 0;
                vcoinInput.parentElement.style.display = currentUserRole === 'admin' ? 'block' : 'none';

                document.getElementById('editProfileModal').style.display = 'flex';
            }

            async function saveProfile(button) {
                await withLoading(button, async () => {
                    const reg = userData.registration || userData;
                    const newPhone = document.getElementById('editPhone').value.trim();
                    const newInstagram = document.getElementById('editInstagram').value.trim().toLowerCase();
                    if (newPhone !== reg.phone || newInstagram !== reg.instagramLogin) {
                        const { canRegister } = await checkForDuplicateRegistration(newPhone, newInstagram, currentUserId);
                        if (!canRegister) return showError('Данные заняты', 'Телефон или Instagram уже используются.');
                    }

                    const newFollowers = parseInt(document.getElementById('editFollowers').value);
                    const levelData = determineBloggerLevel(newFollowers);
                    const oldLevelTags = ['micro', 'macro-a', 'macro-b'];
                    const currentTags = userData.tags || [];
                    const updatedTags = currentTags.filter(t => !oldLevelTags.includes(t));
                    if (!updatedTags.includes(levelData.level)) updatedTags.push(levelData.level);

                    const updates = {
                        'registration.firstName': document.getElementById('editFirstName').value.trim(),
                        'registration.phone': newPhone, 'registration.instagramLogin': newInstagram,
                        'registration.followersCount': newFollowers,
                        'registration.avgViews': parseInt(document.getElementById('editViews').value),
                        'level': levelData.level, 'tags': updatedTags
                    };

                    if (currentUserRole === 'admin') {
                        updates.vcoin_allowance = parseInt(document.getElementById('editVcoinAllowance').value) || 0;
                    }

                    const newPassword = document.getElementById('editPassword').value.trim();
                    if (validatePassword(newPassword)) updates['registration.password'] = hashPassword(newPassword);

                    await db.collection(COLLECTIONS.USERS).doc(currentUserId).update(updates);
                    closeEditProfile();
                    showSuccessMessage('Профиль обновлен!');
                });
            }

            function logout() {
                if (userListenerUnsubscribe) userListenerUnsubscribe();
                userData = {}; currentUserId = null; telegramUser = null; currentUserRole = null;
                window.location.reload();
            }

            function showSuccessMessage(title, message) {
                document.getElementById('successTitle').textContent = title;
                document.getElementById('successMessage').textContent = message;
                document.getElementById('successModalCloseBtn').onclick = () => app.closeModal();
                document.getElementById('successModal').style.display = 'flex';
            }

            function showCrmSuccess(title, message) {
                document.getElementById('successTitle').textContent = title;
                document.getElementById('successMessage').textContent = message || '';
                document.getElementById('successModalCloseBtn').onclick = () => app.closeSimpleModal('successModal');
                document.getElementById('successModal').style.display = 'flex';
            }

            function showError(title, message) {
                document.getElementById('errorTitle').textContent = title;
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorModal').style.display = 'flex';
            }

            async function showOrderDetailModal(orderId) {
                currentEditingOrderId = orderId;
                const orderDoc = await db.collection(COLLECTIONS.ORDERS).doc(orderId).get();
                if (!orderDoc.exists) return;
                const order = orderDoc.data();

                let itemsHtml = '';
                if (order.vcoin_cost) {
                    const itemsList = order.items.map(item => `<li>${item.name} (x${item.quantity}) - ${formatVBonus((item.price / VCOIN_RATE) * item.quantity)}</li>`).join('');
                    itemsHtml = `<strong>Заказ:</strong><ul>${itemsList}</ul>`
                        + `<strong>Итого:</strong> ${formatVBonus(order.vcoin_cost)}<br>`
                        + `<strong>К доплате:</strong> ${(order.payment_due_tenge || 0).toFixed(0)} ₸<br>`;
                } else if (order.setName) {
                    itemsHtml = `<strong>Выбранный набор:</strong> ${order.setName}<br>`;
                }

                document.getElementById('orderDetailTitle').textContent = `Заказ ${order.orderNumber}`;
                document.getElementById('orderDetailBody').innerHTML = `<strong>Блогер:</strong> ${order.userName}<br><strong>Instagram:</strong> <a href="https://www.instagram.com/${order.instagram.replace('@', '')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${order.instagram}</a><br><strong>Телефон:</strong> ${order.phone}<br><strong>Город:</strong> ${order.city}<br><strong>Адрес:</strong> ${order.street}<br>${itemsHtml}<strong>Комментарий:</strong> ${order.comment || '-'}<br><strong>Ссылка на отчет:</strong> ${order.reportLink ? `<a href="${order.reportLink}" target="_blank" class="report-link">${order.reportLink}</a>` : '-'}`;
                document.getElementById('orderStatusSelect').value = order.status;

                const markNoReportBtn = document.getElementById('markNoReportBtn');
                const markReportAcceptedBtn = document.getElementById('markReportAcceptedBtn');

                const isActionable = !order.reportMissed && order.status !== 'completed';

                markNoReportBtn.disabled = !isActionable;
                markReportAcceptedBtn.disabled = !isActionable;

                document.getElementById('deleteOrderBtn').onclick = () => removeOrder(order.id);
                markNoReportBtn.onclick = () => markNoReport(markNoReportBtn, order.id, order.orderNumber);
                markReportAcceptedBtn.onclick = () => markReportAccepted(markReportAcceptedBtn);

                document.getElementById('orderDetailModal').style.display = 'flex';
            }
            async function showAddAdminModal() {
                document.getElementById('addAdminModal').style.display = 'flex';
                const list = document.getElementById('adminUsersList');
                list.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                const [usersSnapshot, adminsSnapshot] = await Promise.all([
                    db.collection(COLLECTIONS.USERS).get(), db.collection(COLLECTIONS.ADMINS).get()
                ]);
                const adminIds = new Set(adminsSnapshot.docs.map(doc => doc.id));
                list.innerHTML = '';
                usersSnapshot.forEach(doc => {
                    const user = { userId: doc.id, ...doc.data() };
                    const reg = user.registration || user;
                    if (!reg.firstName || !user.telegramId) return;
                    const isAlreadyAdmin = adminIds.has(String(user.telegramId));
                    const el = document.createElement('div');
                    el.className = 'user-item';
                    el.dataset.search = `${reg.firstName} ${reg.instagramLogin}`.toLowerCase();
                    el.innerHTML = `<div><strong>${reg.firstName}</strong><div style="font-size: 12px; color: #999;">@${reg.instagramLogin}</div></div>
                    ${isAlreadyAdmin ? '<span class="user-admin-badge">Сотрудник</span>' : `<button class="btn-primary btn-small" onclick="app.addAdmin('${user.userId}', '${reg.firstName}', document.getElementById('adminRoleSelect').value)">Назначить</button>`}`;
                    list.appendChild(el);
                });
            }

            async function resetOrderCooldown() {
                if (!currentUserDetailId) return;
                if (confirm("Вы уверены, что хотите сбросить ограничение на следующий заказ для этого пользователя?")) {
                    const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        await userRef.update({
                            lastOrderTimestamp: FieldValue.delete()
                        });
                        if (userData.telegramId) {
                            const message = `🎉 Отличные новости, ${userData.registration.firstName}! Мы сбросили для вас ограничение на следующий заказ. Теперь вы можете снова оформить сотрудничество!`;
                            await sendTelegramNotification(userData.telegramId, message);
                        }
                        showCrmSuccess("Ограничение сброшено, уведомление отправлено.");
                    } else {
                        showError("Ошибка", "Пользователь не найден.");
                    }
                    closeUserDetailModal();
                }
            }

            function closeModal() { document.getElementById('successModal').style.display = 'none'; showDashboard(); }
            function closeSimpleModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
            function showRejectionModal() { document.getElementById('rejectionModal').style.display = 'flex'; }
            function closeErrorModal() { document.getElementById('errorModal').style.display = 'none'; }
            function closeRejectionModal() { document.getElementById('rejectionModal').style.display = 'none'; }
            function closeOrderHistory() { document.getElementById('orderHistoryModal').style.display = 'none'; }
            function closeEditProfile() { document.getElementById('editProfileModal').style.display = 'none'; }
            function contactAdmin() { document.getElementById('contactModal').style.display = 'flex'; }
            function closeContactModal() { document.getElementById('contactModal').style.display = 'none'; }
            function closeOrderDetailModal() { document.getElementById('orderDetailModal').style.display = 'none'; }
            function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
            function closeUserDetailModal() { document.getElementById('userDetailModal').style.display = 'none'; }

            function toggleBlockTime() {
                document.getElementById('blockTimeGroup').style.display = document.getElementById('blockType').value === 'range' ? 'block' : 'none';
            }

            function showAddBlockModal() { document.getElementById('addBlockModal').style.display = 'flex'; toggleBlockTime(); }
            function closeAddBlockModal() { document.getElementById('addBlockModal').style.display = 'none'; }
            function closeAddAdminModal() { document.getElementById('addAdminModal').style.display = 'none'; }

            function setupPhoneMask(inputId) {
                const phoneInput = document.getElementById(inputId);
                if (phoneInput) phoneInput.addEventListener('input', () => {
                    let digits = phoneInput.value.replace(/\D/g, '');
                    if (digits.startsWith('7') || digits.startsWith('8')) digits = digits.substring(1);
                    let formatted = '+7 (';
                    if (digits.length > 0) formatted += digits.substring(0, 3);
                    if (digits.length > 3) formatted += `) ${digits.substring(3, 6)}`;
                    if (digits.length > 6) formatted += `-${digits.substring(6, 8)}`;
                    if (digits.length > 8) formatted += `-${digits.substring(8, 10)}`;
                    phoneInput.value = formatted;
                });
            }

            async function fetchSettings() {
                try {
                    const settingsDoc = await db.collection(COLLECTIONS.SETTINGS).doc('config').get();
                    if (settingsDoc.exists) {
                        appSettings = { ...appSettings, ...settingsDoc.data() };
                    }
                } catch (error) {
                    console.error("Error fetching settings:", error);
                }
            }

            async function saveSettings(button) {
                await withLoading(button, async () => {
                    const cooldownInput = document.getElementById('cooldownSetting');
                    const newCooldown = parseInt(cooldownInput.value);
                    if (isNaN(newCooldown) || newCooldown < 0) {
                        return showError("Ошибка", "Введите корректное число дней (0 или больше).");
                    }
                    await db.collection(COLLECTIONS.SETTINGS).doc('config').set({ orderCooldownDays: newCooldown }, { merge: true });
                    appSettings.orderCooldownDays = newCooldown;
                    showCrmSuccess("Настройки сохранены!");
                });
            }

            async function initializeApp() {
                await fetchSettings();
                if (!initTelegram()) {
                    showCriticalError("Приложение можно запустить только внутри Telegram.");
                    return;
                }

                if (!(await attemptTelegramAutoLogin())) {
                    showWelcomeScreen();
                } else {
                    showDashboard();
                }
            }

            function showScheduleForCity(city, element) {
                document.querySelectorAll('.schedule-city-tab, .schedule-form').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                document.getElementById(`schedule-form-${city}`).classList.add('active');
            }

            async function loadSchedule() {
                const tabsContainer = document.getElementById('scheduleCityTabs');
                const formsContainer = document.getElementById('scheduleFormsContainer');
                tabsContainer.innerHTML = '';
                formsContainer.innerHTML = '<div class="loading-indicator">Загрузка...</div>';
                const days = { monday: "Пн", tuesday: "Вт", wednesday: "Ср", thursday: "Чт", friday: "Пт", saturday: "Сб", sunday: "Вс" };
                let formsHtml = '';
                for (const city of CITIES) {
                    const tab = document.createElement('button');
                    tab.className = 'schedule-city-tab';
                    tab.textContent = city;
                    tab.onclick = () => showScheduleForCity(city, tab);
                    tabsContainer.appendChild(tab);
                    let formHtml = `<div class="schedule-form" id="schedule-form-${city}">`;
                    const scheduleDoc = await db.collection(COLLECTIONS.SCHEDULES).doc(city).get();
                    const scheduleData = scheduleDoc.exists ? scheduleDoc.data() : {};
                    for (const dayKey in days) {
                        formHtml += `<div class="form-group"><label>${days[dayKey]}</label><input type="text" id="schedule_${city}_${dayKey}" value="${scheduleData[dayKey] || ''}" placeholder="12:00-18:00"></div>`;
                    }
                    formsHtml += formHtml + `</div>`;
                }
                formsContainer.innerHTML = formsHtml;
                if (tabsContainer.firstChild) tabsContainer.firstChild.click();
            }

            async function saveSchedule(button) {
                await withLoading(button, async () => {
                    const batch = db.batch();
                    for (const city of CITIES) {
                        const scheduleRef = db.collection(COLLECTIONS.SCHEDULES).doc(city);
                        const scheduleData = {};
                        ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(dayKey => {
                            scheduleData[dayKey] = document.getElementById(`schedule_${city}_${dayKey}`).value.trim();
                        });
                        batch.set(scheduleRef, scheduleData);
                    }
                    await batch.commit();
                    showCrmSuccess("Расписание сохранено!");
                });
            }

            async function showUserDetailModal(userId) {
                currentUserDetailId = userId;
                const userDoc = await db.collection(COLLECTIONS.USERS).doc(userId).get();
                if (!userDoc.exists) return;
                const user = userDoc.data();
                const reg = user.registration || user;
                document.getElementById('userDetailTitle').textContent = reg.firstName;
                document.getElementById('userDetailBody').innerHTML = `<strong>Телефон:</strong> ${reg.phone}<br><strong>Instagram:</strong> <a href="https://www.instagram.com/${reg.instagramLogin.replace('@', '')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${reg.instagramLogin}</a><br><strong>Подписчики:</strong> ${reg.followersCount}<br><strong>Просмотры:</strong> ${reg.avgViews}<br><strong>Рейтинг:</strong> ⭐ ${calculateBloggerRating(user)}<br><strong>Баланс V-Бонусов:</strong> ${formatVBonus(user.vcoin_balance || 0)}<br><strong>Лимит V-Бонусов:</strong> ${formatVBonus(user.vcoin_allowance || 0)}`;

                const resetCooldownBtn = document.getElementById('resetCooldownBtn');
                const vcoinManagementBlock = document.getElementById('vcoinManagementBlock');
                if (user.level === 'micro') {
                    resetCooldownBtn.style.display = 'block';
                    vcoinManagementBlock.style.display = 'none';
                } else if (user.level && user.level.startsWith('macro')) {
                    resetCooldownBtn.style.display = 'none';
                    vcoinManagementBlock.style.display = 'block';
                } else {
                    resetCooldownBtn.style.display = 'none';
                    vcoinManagementBlock.style.display = 'none';
                }

                renderTags(user.tags || []);
                document.getElementById('userDetailModal').style.display = 'flex';
            }

            async function manageVcoins(action) {
                if (!currentUserDetailId) return;
                const amountInput = document.getElementById('vcoinManageAmount');
                const amount = parseInt(amountInput.value);

                if (isNaN(amount) || amount <= 0) {
                    return showError("Ошибка ввода", "Пожалуйста, введите положительное число.");
                }

                const actionText = action === 'add' ? 'начислить' : 'списать';
                if (!confirm(`Вы уверены, что хотите ${actionText} ${amount} V-Бонусов?`)) {
                    return;
                }

                try {
                    const response = await apiFetch('/api/manage-vcoins', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: currentUserDetailId,
                            amount: amount,
                            action: action
                        })
                    });

                    showCrmSuccess("Баланс обновлен!", response.message);
                    amountInput.value = '';
                    await showUserDetailModal(currentUserDetailId);
                } catch (error) {
                    console.error(`Ошибка при ${action === 'add' ? 'начислении' : 'списании'} V-Бонусов:`, error);
                    showError("Ошибка сервера", error.message);
                }
            }

            function renderTags(tags) {
                const container = document.getElementById('userTagsContainer');
                container.innerHTML = tags.length ? tags.map(tag => `<span class="tag">${tag} <span class="remove-tag" onclick="app.removeUserTag('${tag}')">×</span></span>`).join('') : `<p style="font-size: 12px; color: #999;">Тегов нет.</p>`;
            }

            async function addUserTag() {
                const input = document.getElementById('newTagInput');
                const newTag = input.value.trim().toLowerCase();
                if (!newTag || !currentUserDetailId) return;

                const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User not found";
                    const tags = userDoc.data().tags || [];
                    if (!tags.includes(newTag)) {
                        tags.push(newTag);
                        transaction.update(userRef, { tags: tags });
                        renderTags(tags);
                    }
                });
                input.value = '';
            }

            async function removeUserTag(tagToRemove) {
                if (!tagToRemove || !currentUserDetailId) return;
                const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserDetailId);
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User not found";
                    const tags = userDoc.data().tags || [];
                    const updatedTags = tags.filter(t => t !== tagToRemove);
                    transaction.update(userRef, { tags: updatedTags });
                    renderTags(updatedTags);
                });
            }

            function showReportModal(orderId, orderNumber) {
                currentReportingOrderId = orderId;
                document.getElementById('reportModalTitle').textContent = `Отчет по заказу ${orderNumber}`;
                document.getElementById('reportModal').style.display = 'flex';
            }

            async function submitReport(button) {
                await withLoading(button, async () => {
                    const reportLink = document.getElementById('reportLink').value.trim();
                    if (!reportLink.startsWith('http')) return showError('Ошибка', 'Введите корректную ссылку.');
                    const orderRef = db.collection(COLLECTIONS.ORDERS).doc(currentReportingOrderId);
                    const userRef = db.collection(COLLECTIONS.USERS).doc(currentUserId);
                    const batch = db.batch();
                    batch.update(orderRef, { status: 'awaiting_review', reportLink: reportLink });
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const orders = (userDoc.data().orders || []).map(o => o.id === currentReportingOrderId ? { ...o, status: 'awaiting_review' } : o);
                        batch.update(userRef, { orders: orders });
                    }
                    await batch.commit();
                    closeReportModal();
                    showSuccessMessage("Ваш отчет отправлен на проверку!");
                });
            }

            async function getTagStats() {
                const tagStats = {};
                const usersSnapshot = await db.collection(COLLECTIONS.USERS).get();
                usersSnapshot.forEach(doc => {
                    (doc.data().tags || []).forEach(tag => {
                        tagStats[tag] = (tagStats[tag] || 0) + 1;
                    });
                });
                return tagStats;
            }

            async function setupBroadcastTagInput() {
                const input = document.getElementById('broadcastTagInput');
                const suggestionsContainer = document.getElementById('tagSuggestions');
                const selectedContainer = document.getElementById('broadcastTagsContainer');
                const tagStats = await getTagStats();
                const availableTags = Object.keys(tagStats);

                const addTag = (tag) => {
                    if (!tag || Array.from(selectedContainer.children).some(el => el.dataset.tag === tag)) return;
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.dataset.tag = tag;
                    tagEl.innerHTML = `${tag} <span class="remove-tag">×</span>`;
                    tagEl.querySelector('.remove-tag').onclick = () => {
                        tagEl.remove();
                    };
                    selectedContainer.appendChild(tagEl);
                    input.value = '';
                    suggestionsContainer.style.display = 'none';
                };

                input.addEventListener('focus', () => {
                    renderSuggestions('');
                    suggestionsContainer.style.display = 'block';
                });

                input.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') addTag(input.value.trim().toLowerCase());
                    else renderSuggestions(input.value.toLowerCase());
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#broadcastTagInput') && !e.target.closest('#tagSuggestions')) {
                        suggestionsContainer.style.display = 'none';
                    }
                });

                function renderSuggestions(filter) {
                    suggestionsContainer.innerHTML = '';
                    availableTags.filter(tag => tag.includes(filter)).forEach(tag => {
                        const item = document.createElement('div');
                        item.className = 'tag-suggestion-item';
                        item.innerHTML = `<span>${tag}</span> <span class="user-count">${tagStats[tag]} чел.</span>`;
                        item.onclick = () => addTag(tag);
                        suggestionsContainer.appendChild(item);
                    });
                }
            }

            function copyPlaceholder(element) {
                const textToCopy = element.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = element.textContent;
                    element.textContent = 'Скопировано!';
                    element.style.background = '#28a745';
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.style.background = '#4a4a4a';
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            }

            async function updateMenuItemsListCrm() {
                const list = document.getElementById('menuItemsListCrm');
                list.innerHTML = '<div class="loading-indicator">Загрузка меню...</div>';
                try {
                    const snapshot = await db.collection(COLLECTIONS.MENU).orderBy('name').get();
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="empty-state">Блюд пока нет. Добавьте первое!</div>';
                        return;
                    }
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = { id: doc.id, ...doc.data() };
                        const el = document.createElement('div');
                        el.className = `user-item ${item.isVisible === false ? 'hidden-item' : ''}`;
                        el.dataset.search = item.name.toLowerCase();

                        const imageHtml = item.imageUrl
                            ? `<img src="${item.imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px;">`
                            : `<div style="width: 50px; height: 50px; background: #4a4a4a; border-radius: 8px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🍴</div>`;

                        el.innerHTML = `
                        <div class="user-details">
                            ${imageHtml}
                            <div>
                                <span class="user-name-phone">${item.name}</span>
                                <div style="font-size: 14px; color: #ccc;">
                                    Категория: ${item.category} | Цена: ${item.price} ₸
                                </div>
                            </div>
                        </div>
                        <div class="user-controls">
                           <button class="btn-secondary btn-small" onclick="event.stopPropagation(); app.toggleMenuItemVisibility('${item.id}', ${item.isVisible !== false})">
                                ${item.isVisible !== false ? '👁️ Скрыть' : '🙈 Показать'}
                           </button>
                           <button class="btn-secondary btn-small" onclick="event.stopPropagation(); app.showMenuItemModal('${item.id}')">Ред.</button>
                           <button class="btn-danger-icon" title="Удалить" onclick="event.stopPropagation(); app.deleteMenuItem('${item.id}')">🗑️</button>
                        </div>`;
                        list.appendChild(el);
                    });
                } catch (error) {
                    console.error("Error fetching menu items:", error);
                    list.innerHTML = '<div class="empty-state">Ошибка загрузки меню.</div>';
                }
            }

            async function toggleMenuItemVisibility(itemId, currentVisibility) {
                const itemRef = db.collection(COLLECTIONS.MENU).doc(itemId);
                try {
                    await itemRef.update({ isVisible: !currentVisibility });
                    updateMenuItemsListCrm();
                } catch (error) {
                    console.error("Error toggling visibility:", error);
                    showError("Ошибка", "Не удалось изменить видимость блюда.");
                }
            }


            async function showMenuItemModal(itemId = null) {
                const form = document.getElementById('menuItemForm');
                form.reset();
                const title = document.getElementById('menuItemModalTitle');
                const idField = document.getElementById('menuItemEditId');
                const oldImageUrlField = document.getElementById('menuItemOldImageUrl');

                if (itemId) {
                    title.textContent = "Редактировать блюдо";
                    idField.value = itemId;
                    const doc = await db.collection(COLLECTIONS.MENU).doc(itemId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('menuItemName').value = data.name;
                        document.getElementById('menuItemDesc').value = data.description || '';
                        document.getElementById('menuItemPrice').value = data.price;
                        document.getElementById('menuItemCategory').value = data.category;
                        document.getElementById('menuItemSubcategory').value = data.subcategory || '';
                        oldImageUrlField.value = data.imageUrl || '';
                    }
                } else {
                    title.textContent = "Добавить блюдо";
                    idField.value = '';
                    oldImageUrlField.value = '';
                }
                document.getElementById('menuItemModal').style.display = 'flex';
            }

            async function saveMenuItem(button) {
                await withLoading(button, async () => {
                    const editId = document.getElementById('menuItemEditId').value;
                    const name = document.getElementById('menuItemName').value;
                    const description = document.getElementById('menuItemDesc').value;
                    const price = parseFloat(document.getElementById('menuItemPrice').value);
                    const category = document.getElementById('menuItemCategory').value;
                    const subcategory = document.getElementById('menuItemSubcategory').value;
                    const imageFile = document.getElementById('menuItemImage').files[0];
                    let imageUrl = document.getElementById('menuItemOldImageUrl').value;

                    if (!name || isNaN(price)) {
                        return showError("Ошибка", "Название и цена обязательны для заполнения.");
                    }

                    if (imageFile) {
                        const formData = new FormData();
                        formData.append('image', imageFile);

                        try {
                            button.innerHTML = 'Обработка фото...';
                            const result = await apiFetch('/api/upload-menu-image', {
                                method: 'POST',
                                body: formData
                            });
                            if (!result.success) {
                                throw new Error(result.error || 'Ошибка при загрузке изображения на сервер.');
                            }
                            imageUrl = result.imageUrl;
                        } catch (error) {
                            console.error(error);
                            return showError('Ошибка загрузки', error.message);
                        }
                    }

                    const menuItemData = { name, description, price, category, subcategory, imageUrl, isVisible: true };

                    if (editId) {
                        await db.collection(COLLECTIONS.MENU).doc(editId).set(menuItemData, { merge: true });
                    } else {
                        await db.collection(COLLECTIONS.MENU).add(menuItemData);
                    }

                    closeSimpleModal('menuItemModal');
                    showCrmSuccess("Блюдо сохранено!");
                    updateMenuItemsListCrm();
                });
            }

            async function deleteMenuItem(itemId) {
                if (confirm('Вы уверены, что хотите удалить это блюдо? Примечание: само изображение с хостинга не удаляется.')) {
                    try {
                        await db.collection(COLLECTIONS.MENU).doc(itemId).delete();
                        showCrmSuccess("Блюдо удалено.");
                        updateMenuItemsListCrm();
                    } catch (error) {
                        console.error("Error deleting menu item:", error);
                        showError("Ошибка", "Не удалось удалить блюдо.");
                    }
                }
            }

            async function exportToExcel(button, dataType) {
                await withLoading(button, async () => {
                    let data;
                    if (dataType === 'orders') {
                        const snapshot = await db.collection(COLLECTIONS.ORDERS).orderBy('createdAt', 'desc').get();
                        data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                        const snapshot = await db.collection(COLLECTIONS.USERS).orderBy('registrationDate', 'desc').get();
                        data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }

                    await apiFetch(`/api/export-${dataType}`, {
                        method: 'POST',
                        body: JSON.stringify({ data: data, chatId: telegramUser.id })
                    });

                    showCrmSuccess("Запрос отправлен!", `Excel-файл будет отправлен вам в личные сообщения.`);
                });
            }

            async function loadAndRenderMenu() {
                const container = document.getElementById('menu-items-container');
                const mainTabsContainer = document.getElementById('menu-categories');

                container.innerHTML = '<div class="loading-indicator">Загрузка меню...</div>';
                mainTabsContainer.innerHTML = '';
                cart = {};

                const budget = userData.vcoin_balance || 0;
                currentOrderData.budget = budget;
                document.getElementById('menuBudgetDisplay').innerHTML = `Ваш бюджет: <strong>${formatVBonus(budget)}</strong>`;

                updateCartView();

                try {
                    const snapshot = await db.collection(COLLECTIONS.MENU).where("isVisible", "==", true).get();
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="empty-state">Меню пока пустое.</div>';
                        return;
                    }
                    container.innerHTML = '';

                    const menuData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const categoryOrder = ["Сеты", "Роллы", "Пицца", "ВОК / ТОМ-ЯМ", "Закуски", "Напитки", "Дополнительно"];
                    const categories = {};
                    menuData.forEach(item => {
                        if (!categories[item.category]) categories[item.category] = {};
                        const subcategory = item.subcategory || 'Основное';
                        if (!categories[item.category][subcategory]) categories[item.category][subcategory] = [];
                        categories[item.category][subcategory].push(item);
                    });

                    const sortedCategories = Object.keys(categories).sort((a, b) => {
                        const indexA = categoryOrder.indexOf(a);
                        const indexB = categoryOrder.indexOf(b);
                        if (indexA === -1) return 1; if (indexB === -1) return -1;
                        return indexA - indexB;
                    });

                    sortedCategories.forEach((catName) => {
                        const categoryId = `category-${catName.replace(/[\s/]/g, '-')}`;
                        const tab = document.createElement('a');
                        tab.className = 'menu-category-tab';
                        tab.textContent = catName;
                        tab.href = `#${categoryId}`;
                        tab.dataset.categoryId = categoryId;
                        mainTabsContainer.appendChild(tab);

                        const section = document.createElement('div');
                        section.className = 'menu-section';
                        section.id = categoryId;

                        const catTitle = document.createElement('h2');
                        catTitle.className = 'menu-category-title';
                        catTitle.textContent = catName;
                        section.appendChild(catTitle);

                        for (const subcatName in categories[catName]) {
                            if (Object.keys(categories[catName]).length > 1 && subcatName !== 'Основное') {
                                const subcatTitle = document.createElement('h3');
                                subcatTitle.className = 'menu-subcategory-title';
                                subcatTitle.textContent = subcatName;
                                section.appendChild(subcatTitle);
                            }

                            const grid = document.createElement('div');
                            grid.className = 'menu-items-grid';
                            categories[catName][subcatName].forEach(item => {
                                grid.appendChild(createMenuItemCard(item));
                            });
                            section.appendChild(grid);
                        }
                        container.appendChild(section);
                    });
                    setupMenuObserver();

                } catch (error) {
                    console.error("Error loading menu:", error);
                    container.innerHTML = '<div class="empty-state">Не удалось загрузить меню.</div>';
                }
            }

            function setupMenuObserver() {
                if (menuObserver) menuObserver.disconnect();

                const options = {
                    root: null,
                    rootMargin: '-40% 0px -60% 0px',
                    threshold: 0
                };

                menuObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        const id = entry.target.getAttribute('id');
                        const tab = document.querySelector(`.menu-category-tab[data-category-id="${id}"]`);
                        if (entry.isIntersecting && tab) {
                            document.querySelectorAll('.menu-category-tab').forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                        }
                    });
                }, options);

                document.querySelectorAll('.menu-section').forEach(section => {
                    menuObserver.observe(section);
                });
            }

            function createMenuItemCard(item) {
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.dataset.id = item.id;
                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" class="menu-item-image" alt="${item.name}">
                    <div class="menu-item-info">
                        <div class="menu-item-content-wrapper">
                            <div class="menu-item-name">${item.name}</div>
                            <div class="menu-item-desc">${item.description || ''}</div>
                        </div>
                        <div class="menu-item-footer">
                            <div class="menu-item-price">${formatVBonus(item.price / VCOIN_RATE)}</div>
                            <div class="menu-item-controls">
                                <button class="quantity-btn" onclick="app.removeFromCart('${item.id}')">-</button>
                                <span class="item-quantity">0</span>
                                <button class="quantity-btn" onclick="app.addToCart({id: '${item.id}', name: '${item.name}', price: ${item.price}})">+</button>
                            </div>
                        </div>
                    </div>
                `;
                return card;
            }

            function addToCart(item) {
                if (!cart[item.id]) {
                    cart[item.id] = { ...item, quantity: 0 };
                }
                cart[item.id].quantity++;
                updateCartView();
            }

            function removeFromCart(itemId) {
                if (cart[itemId]) {
                    cart[itemId].quantity--;
                    if (cart[itemId].quantity <= 0) {
                        delete cart[itemId];
                    }
                    updateCartView();
                }
            }

            function updateCartView() {
                let totalVCoins = 0;
                let count = 0;

                document.querySelectorAll('.menu-item-card').forEach(card => {
                    const itemId = card.dataset.id;
                    const quantityEl = card.querySelector('.item-quantity');
                    quantityEl.textContent = cart[itemId] ? cart[itemId].quantity : 0;
                });

                for (const itemId in cart) {
                    totalVCoins += (cart[itemId].price / VCOIN_RATE) * cart[itemId].quantity;
                    count += cart[itemId].quantity;
                }

                const cartFab = document.getElementById('cart-fab');
                if (count > 0) {
                    const budget = currentOrderData.budget || 0;
                    const summaryEl = document.getElementById('cart-summary-value');
                    let summaryHTML = `${formatVBonus(totalVCoins)} / ${formatVBonus(budget)}`;

                    const progressBar = document.getElementById('cart-progress-bar');
                    const progressPercent = Math.min((totalVCoins / budget) * 100, 100);
                    progressBar.style.width = `${progressPercent}%`;

                    if (totalVCoins > budget) {
                        const overdraftTenge = (totalVCoins - budget) * VCOIN_RATE;
                        summaryHTML += `<span class="cart-overdraft-text">(+${overdraftTenge.toFixed(0)} ₸)</span>`;
                        progressBar.classList.add('overdraft');
                    } else {
                        progressBar.classList.remove('overdraft');
                    }
                    summaryEl.innerHTML = summaryHTML;
                    cartFab.style.display = 'block';
                } else {
                    cartFab.style.display = 'none';
                }
            }

            function checkBalanceAndProceed() {
                const totalVCoins = Object.values(cart).reduce((sum, item) => sum + (item.price / VCOIN_RATE) * item.quantity, 0);
                const budget = currentOrderData.budget || 0;

                currentOrderData.items = Object.values(cart).map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity }));
                currentOrderData.vcoin_cost = totalVCoins;
                currentOrderData.payment_due_tenge = 0;

                if (totalVCoins > budget) {
                    const overdraftVCoins = totalVCoins - budget;
                    const overdraftTenge = overdraftVCoins * VCOIN_RATE;
                    currentOrderData.payment_due_tenge = overdraftTenge;

                    const totalTenge = totalVCoins * VCOIN_RATE;
                    const message = `
                    <strong>Сумма заказа:</strong> ${formatVBonus(totalVCoins)} (~${totalTenge.toLocaleString('ru-RU')} ₸)<br>
                    <strong>Ваш бюджет:</strong> ${formatVBonus(budget)}<br>
                    <hr style="border-color: #4a4a4a; margin: 10px 0;">
                    <strong>К доплате: ${overdraftTenge.toLocaleString('ru-RU')} ₸</strong><br><br>
                    Сумму превышения необходимо будет оплатить отдельно. Продолжить?
                `;
                    document.getElementById('overdraftMessage').innerHTML = message;
                    document.getElementById('overdraftModal').style.display = 'flex';
                } else {
                    proceedToDateTimeSelection();
                }
            }

            function proceedToDateTimeSelection() {
                closeSimpleModal('overdraftModal');
                showDateTimeSelection();
                setupTimeSelection();
            }

            const exportOrdersToExcel = (btn) => exportToExcel(btn, 'orders');
            const exportUsersToExcel = (btn) => exportToExcel(btn, 'users');

            function triggerMenuImport() {
                document.getElementById('menuFileInput').click();
            }

            async function handleMenuFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const importButton = document.getElementById('importMenuBtn');

                await withLoading(importButton, async () => {
                    const formData = new FormData();
                    formData.append('menuFile', file);

                    const result = await apiFetch('/api/import-menu-from-file', {
                        method: 'POST',
                        body: formData
                    });

                    showCrmSuccess("Импорт завершен!", result.message);
                    updateMenuItemsListCrm();
                });
                event.target.value = '';
            }

            document.addEventListener('DOMContentLoaded', () => {
                ['loginPhone', 'phone', 'recipientPhone', 'editPhone'].forEach(setupPhoneMask);
                setTimeout(initializeApp, 100);
            });

            return {
                showRegistration, showLogin, showWelcomeScreen, submitLogin, submitRegistration,
                submitMigration, showDashboard, logout, startCollaboration, proceedToAddressFromSet,
                showOrderHistory, editProfile, contactAdmin, showCRM, showCrmTab, filterOrders,
                filterUsers, filterAdminUsers, filterMenuItems, removeBlock, removeAdmin, removeUser, toggleUserBlock,
                sendBroadcast, saveSettings, addBlock, addAdmin, selectSet, showSetSelection,
                showAddressForm, showDateTimeSelection, showInstructions, handleCityChange,
                submitAddressAndShowDateTime, setupTimeSelection, validateTimeSelection, submitOrder, saveProfile, closeModal,
                closeSimpleModal, closeErrorModal, closeRejectionModal, closeOrderHistory,
                closeEditProfile, closeContactModal, showAddBlockModal, closeAddBlockModal,
                showAddAdminModal, closeAddAdminModal, closeOrderDetailModal, toggleBlockTime,
                updateOrderStatus, showReportModal, closeReportModal, submitReport, loadSchedule,
                saveSchedule, showUserDetailModal, closeUserDetailModal, addUserTag, removeUserTag,
                resetOrderCooldown, showScheduleForCity, applyAnalyticsFilters, toggleAdminNotifications,
                markNoReport, markReportAccepted, copyPlaceholder,
                exportOrdersToExcel, exportUsersToExcel,
                updateMenuItemsListCrm, showMenuItemModal, saveMenuItem, deleteMenuItem,
                showMenuScreen, addToCart, removeFromCart,
                triggerMenuImport, handleMenuFileSelect, toggleMenuItemVisibility,
                manageVcoins,
                checkBalanceAndProceed, proceedToDateTimeSelection
            };
        })();
    </script>
</body>

</html>

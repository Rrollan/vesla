<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–ö–†–ê–ù: –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ -->
        <div id="criticalErrorScreen" class="welcome-screen" style="display: none;">
            <div class="logo-container" style="background: var(--accent-danger);">
                <div class="logo-icon" style="font-size: 50px;">üîå</div>
            </div>
            <h1>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h1>
            <p class="subtitle" id="criticalErrorMessage">–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å Telegram.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
            <button class="btn-primary" onclick="window.location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <!-- –≠–ö–†–ê–ù: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="logo.jpg" alt="logo">
                </div>
            </div>
            <h1>–ë–∞—Ä—Ç–µ—Ä –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤</h1>
            <p class="subtitle">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ<br>–¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ –∏ –∏–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä–æ–≤</p>
            <div class="welcome-buttons">
                 <button class="btn-primary" onclick="app.showRegistration()">–ù–∞—á–∞—Ç—å</button>
                 <button class="btn-secondary" onclick="app.showLogin()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
            <div class="auto-login-info" id="autoLoginInfo" style="display: none;">
                <div class="loading-indicator">
                    üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram...
                </div>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù: –í—Ö–æ–¥ -->
        <div id="loginScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <p class="subtitle">–î–ª—è —Å—Ç–∞—Ä—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –ø–∞—Ä–æ–ª–µ–º</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="loginPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="loginInstagram">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="loginInstagram" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="loginPassword" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitLogin(this)">–í–æ–π—Ç–∏</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
            <div class="telegram-info">
                <h4 style="color: var(--accent-primary); margin-bottom: 10px;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</h4>
                <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                    –ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. 
                    –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–æ–ª—å.
                </p>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="registrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</p>
            </div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="firstName">–ò–º—è *</label>
                    <input type="text" id="firstName" required placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                    <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="instagramLogin">–õ–æ–≥–∏–Ω Instagram *</label>
                    <input type="text" id="instagramLogin" required placeholder="@username">
                </div>
                <div class="form-group">
                    <label for="followersCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ *</label>
                    <input type="number" id="followersCount" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" min="1" max="10000000">
                </div>
                <div class="form-group">
                    <label for="avgViews">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å *</label>
                    <input type="number" id="avgViews" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" min="1" max="10000000">
                </div>
                 <div class="form-group">
                    <label for="regPassword">–ü–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="regPassword" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitRegistration(this)">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <!-- –≠–ö–†–ê–ù: –ú–∏–≥—Ä–∞—Ü–∏—è (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è) -->
        <div id="migrationScreen" class="form-screen" style="display: none;">
            <div class="form-header">
                <h2>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–æ–ª—è</h2>
                <p class="subtitle">–î–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</p>
            </div>
            <div class="migration-info">
                <p>–ú—ã –Ω–∞—à–ª–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø–∞—Ä–æ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
            </div>
            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPassword" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                <div class="form-group">
                    <label for="migrationPasswordConfirm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                    <input type="password" id="migrationPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button type="button" class="btn-primary" onclick="app.submitMigration(this)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button type="button" class="btn-secondary" onclick="app.showWelcomeScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </form>
        </div>

        <!-- –≠–ö–†–ê–ù: –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
        <div id="dashboardScreen" class="dashboard" style="display: none;">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-name" id="userName"></div>
                <div id="userLevel" class="user-level"></div>
                <div class="user-stats">
                    <div class="stat-item" id="vcoinStatItem" style="display: none;">
                        <div class="stat-number" id="vcoinBalanceDisplay">0</div>
                        <div class="stat-label">V-–ë–æ–Ω—É—Å—ã</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="followersDisplay">0</div>
                        <div class="stat-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="viewsDisplay">0</div>
                        <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                    </div>
                </div>
            </div>
             <div id="blockedPanel" class="blocked-message" style="display: none;"></div>
             <div id="strikesPanel" class="strikes-panel" style="display: none;"></div>
             <div id="statusPanel" class="action-card" style="display: none; border-color: var(--accent-primary); text-align: left;"></div>
             <div id="cooldownPanel" class="action-card" style="display: none; background: var(--surface-light-color); border-color: var(--border-color); text-align: center; cursor: default;"></div>
             <div id="loyaltyPanel" class="action-card" style="display: none; border-color: var(--accent-warning); text-align: center; cursor: default;"></div>
             <div id="reportActionsPanel" class="dashboard-actions" style="margin-top: 20px;"></div>
            <div class="dashboard-actions">
                <div id="newCollaborationBtn" class="action-card" onclick="app.startCollaboration()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                    </div>
                    <div class="action-title">–ù–æ–≤–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</div>
                    <div class="action-desc">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –±–∞—Ä—Ç–µ—Ä</div>
                </div>
                <div class="action-card" onclick="app.showOrderHistory()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    </div>
                    <div class="action-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="action-desc">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–∫–∞–∑—ã</div>
                </div>
                <div class="action-card" onclick="app.editProfile()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </div>
                    <div class="action-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <div class="action-desc">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                </div>
                <div class="action-card" onclick="app.contactAdmin()">
                    <div class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <div class="action-title">–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</div>
                    <div class="action-desc">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å</div>
                </div>
            </div>
            <button class="btn-secondary" onclick="app.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>

        <!-- –≠–ö–†–ê–ù: CRM -->
        <div id="crmScreen" class="crm-screen" style="display: none;">
            <div class="crm-header">
                <h2>üîß –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <button class="btn-back" onclick="app.showDashboard()">‚Üê –í –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
            </div>
            <div class="crm-tabs">
                <button class="crm-tab active" data-tab="overview" onclick="app.showCrmTab('overview', this)">–û–±–∑–æ—Ä</button>
                <button class="crm-tab" data-tab="analytics" onclick="app.showCrmTab('analytics', this)">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
                <button class="crm-tab" data-tab="orders" onclick="app.showCrmTab('orders', this)">–ó–∞–∫–∞–∑—ã</button>
                <button class="crm-tab" data-tab="users" onclick="app.showCrmTab('users', this)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="crm-tab" data-tab="schedule" onclick="app.showCrmTab('schedule', this)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                <button class="crm-tab" data-tab="blocks" onclick="app.showCrmTab('blocks', this)">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</button>
                <button class="crm-tab" data-tab="broadcast" onclick="app.showCrmTab('broadcast', this)">–†–∞—Å—Å—ã–ª–∫–∞</button>
                <button class="crm-tab" data-tab="menu" onclick="app.showCrmTab('menu', this)">–ú–µ–Ω—é</button>
                <button class="crm-tab" data-tab="admins" onclick="app.showCrmTab('admins', this)">–ê–¥–º–∏–Ω—ã</button>
            </div>
            <div id="crmOverview" class="crm-content active">
                <div class="crm-stats">
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalUsers">0</div>
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="totalOrders">0</div>
                        <div class="stat-label">–ó–∞–∫–∞–∑—ã</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="newOrders">0</div>
                        <div class="stat-label">–ù–æ–≤—ã–µ</div>
                    </div>
                    <div class="crm-stat-card">
                        <div class="crm-stat-number" id="blockedSlots">0</div>
                        <div class="stat-label">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                    </div>
                </div>
                <div class="admin-contact">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <a href="https://t.me/oderefyu" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                </div>
                <div style="background: var(--surface-color); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid var(--border-color);">
                    <h3>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cooldownSetting">–ü–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏ (–≤ –¥–Ω—è—Ö, –¥–ª—è –º–∏–∫—Ä–æ–±–ª–æ–≥–µ—Ä–æ–≤)</label>
                        <input type="number" id="cooldownSetting" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7">
                        <button class="btn-primary" onclick="app.saveSettings(this)" style="margin-top: 15px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
                    </div>
                </div>
            </div>
            <div id="crmAnalytics" class="crm-content">
                 <div class="analytics-filters">
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥:</label>
                        <div class="form-row">
                            <input type="date" id="analyticsStartDate">
                            <input type="date" id="analyticsEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="analyticsCity">–ì–æ—Ä–æ–¥:</label>
                        <select id="analyticsCity" onchange="app.applyAnalyticsFilters()">
                            <option value="all">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                            <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                            <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="app.applyAnalyticsFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h3>
                        <canvas id="ordersTrendChart"></canvas>
                    </div>
                    <div class="chart-container" id="cityChartContainer">
                        <h3>–ó–∞–∫–∞–∑—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º</h3>
                        <canvas id="cityChart"></canvas>
                    </div>
                     <div class="chart-container">
                        <h3>–£—Ä–æ–≤–Ω–∏ –±–ª–æ–≥–µ—Ä–æ–≤</h3>
                        <canvas id="bloggerLevelChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</h3>
                        <canvas id="followersDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="crmOrders" class="crm-content">
                <div class="search-container">
                    <input type="text" id="orderSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, Instagram –∏–ª–∏ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞..." onkeyup="app.filterOrders()">
                    <button id="exportOrdersBtn" class="btn-secondary" onclick="app.exportOrdersToExcel(this)">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </div>
                <div class="orders-list" id="ordersList"></div>
            </div>
            <div id="crmUsers" class="crm-content">
                <div class="search-container">
                    <input type="text" id="userSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." onkeyup="app.filterUsers()">
                    <button id="exportUsersBtn" class="btn-secondary" onclick="app.exportUsersToExcel(this)">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                </div>
                <div id="usersList"></div>
            </div>
             <div id="crmSchedule" class="crm-content">
                 <div class="form-header">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h2>
                    <p class="subtitle">–£–∫–∞–∂–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Å—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "10:00-14:00" –∏–ª–∏ "10:00-12:00, 14:00-18:00".<br>–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º.</p>
                </div>
                <div id="scheduleCityTabs" class="schedule-city-tabs"></div>
                <div id="scheduleFormsContainer"></div>
                <button class="btn-primary" onclick="app.saveSchedule(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            </div>
            <div id="crmBlocks" class="crm-content">
                <button class="btn-primary" onclick="app.showAddBlockModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</button>
                <div id="blockedSlotsList"></div>
            </div>
             <div id="crmBroadcast" class="crm-content">
                <div class="form-header">
                    <h2>–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h2>
                    <p class="subtitle">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</p>
                </div>
                <div class="form-group">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º (—Ä–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∏–º–µ—é—â–∏–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤)</label>
                    <div id="broadcastTagsContainer" class="tags-container" style="min-height: 40px; background: var(--surface-color); padding: 5px; border-radius: var(--border-radius-small); border: 1px solid var(--border-color);">
                    </div>
                    <div style="position: relative;">
                         <input type="text" id="broadcastTagInput" placeholder="–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–≥ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..." style="margin-top: 10px;">
                         <div id="tagSuggestions" class="tag-suggestions-container"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                    <textarea id="broadcastMessage" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..."></textarea>
                </div>
                <div class="telegram-info" style="margin-top: -10px; margin-bottom: 20px; font-size: 13px; padding: 15px; border-left-color: var(--accent-warning);">
                    <h4 style="color: var(--accent-primary); margin-bottom: 10px;">‚ú® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)</h4>
                    <p style="color: var(--text-secondary); line-height: 1.8;">
                        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                        <br><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã:</strong><br>
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{firstName}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{instagramLogin}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{followersCount}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{level}</code>, 
                        <code class="placeholder-tag" onclick="app.copyPlaceholder(this)">{rating}</code>
                    </p>
                </div>
                <button class="btn-primary" onclick="app.sendBroadcast(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
                <div class="telegram-info" style="margin-top: 20px;">
                     <h4 style="color: var(--accent-warning); margin-bottom: 10px;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</h4>
                     <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                         –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏. –û—Ç—á–µ—Ç –ø—Ä–∏–¥–µ—Ç –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
                     </p>
                </div>
            </div>
            <div id="crmAdmins" class="crm-content">
                <button class="btn-primary" onclick="app.showAddAdminModal()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
                <div id="adminsList"></div>
            </div>
            <div id="crmMenu" class="crm-content">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-primary" onclick="app.showMenuItemModal()" style="flex: 1;">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
                    <input type="file" id="menuFileInput" onchange="app.handleMenuFileSelect(event)" accept=".xlsx, .xls" style="display: none;" />
                    <button id="importMenuBtn" class="btn-secondary" onclick="app.triggerMenuImport()" style="flex: 1;">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>
                </div>
                <div class="search-container" style="margin-bottom: 20px;">
                    <input type="text" id="menuSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –±–ª—é–¥–∞..." onkeyup="app.filterMenuItems()">
                </div>
                <div id="menuItemsListCrm"></div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù–´ –ü—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞ -->
        <div id="setSelectionScreen" class="form-screen set-selection" style="display: none;">
            <button class="btn-back" onclick="app.showDashboard()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–±–æ—Ä</h2>
            </div>
            <div class="set-item" data-set-name="–°–µ—Ç 1" onclick="app.selectSet(this, 'set1')">
                <div class="set-title">–°–µ—Ç 1</div>
                <div class="set-description">–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è —Å –æ–≥—É—Ä—Ü–æ–º, –ì–µ–π—à–∞, –õ–æ—Å–æ—Å—å —Å —á—É–∫–æ–π –∏ –º–∏–Ω–¥–∞–ª—ë–º</div>
            </div>
            <div class="set-item" data-set-name="–°–µ—Ç 2" onclick="app.selectSet(this, 'set2')">
                <div class="set-title">–°–µ—Ç 2</div>
                <div class="set-description">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –§–∏–ª–∞, –ó–∞–ø–µ—á—ë–Ω–Ω—ã–π —Å –∫—Ä–µ–≤–µ—Ç–∫–æ–π, –°—ç–Ω–¥–≤–∏—á —Å –∫—É—Ä–∏—Ü–µ–π</div>
            </div>
            <button type="button" id="nextFromSet" class="btn-primary" onclick="app.proceedToAddressFromSet()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="addressScreen" class="form-screen" style="display: none;">
            <button class="btn-back" id="backFromAddress" onclick="app.showDashboard()">‚Üê –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            <div class="form-header">
                <h2>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
            </div>
            <form id="addressForm">
                <div class="form-group">
                    <label for="city">–ì–æ—Ä–æ–¥ *</label>
                    <select id="city" required onchange="app.handleCityChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                        <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                        <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                        <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                        <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                        <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="street">–£–ª–∏—Ü–∞, –¥–æ–º *</label>
                    <input type="text" id="street" required placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10">
                </div>
                <div class="form-group">
                    <label for="entrance">–ü–æ–¥—ä–µ–∑–¥</label>
                    <input type="text" id="entrance" placeholder="1">
                </div>
                <div class="form-group">
                    <label for="floor">–≠—Ç–∞–∂</label>
                    <input type="text" id="floor" placeholder="5">
                </div>
                <div class="form-group">
                    <label for="recipientPhone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</label>
                    <input type="tel" id="recipientPhone" required placeholder="+7 (___) ___-__-__">
                </div>
                <div class="form-group">
                    <label for="comment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"></textarea>
                </div>
                <button type="button" class="btn-primary" onclick="app.submitAddressAndShowDateTime()">–î–∞–ª–µ–µ</button>
            </form>
        </div>

        <div id="menuSelectionScreen" class="form-screen menu-screen" style="display: none;">
            <div class="menu-header-sticky">
                <div class="menu-top-bar">
                    <button class="btn-back" onclick="app.showAddressForm()">‚Üê</button>
                    <div class="menu-info-bar">
                        <h2>–°–æ–±–µ—Ä–∏—Ç–µ –≤–∞—à –∑–∞–∫–∞–∑</h2>
                        <div id="menuBudgetDisplay" class="menu-budget-display">–í–∞—à –±—é–¥–∂–µ—Ç: 0</div>
                    </div>
                </div>
                <div id="menu-categories" class="menu-categories"></div>
            </div>
            <div id="menu-items-container"></div>
            <div id="cart-fab" class="cart-fab" style="display: none;">
                <div class="cart-fab-content">
                    <div class="cart-summary">
                        <span class="cart-summary-label">–ò—Ç–æ–≥–æ / –ë—é–¥–∂–µ—Ç</span>
                        <span id="cart-summary-value" class="cart-summary-value"></span>
                    </div>
                    <div class="cart-progress-bar-container">
                        <div id="cart-progress-bar" class="cart-progress-bar"></div>
                    </div>
                    <button class="btn-primary" onclick="app.checkBalanceAndProceed()">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        </div>

        <div id="dateTimeScreen" class="form-screen datetime-selection" style="display: none;">
            <button class="btn-back" id="backFromDateTime">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
                <h4 id="todaysDateHeader" style="color: var(--text-secondary); font-weight: 400; margin-top: -15px;"></h4>
            </div>
            <div class="form-group">
                <label for="deliveryTime">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</label>
                <input type="time" id="deliveryTime" required onchange="app.validateTimeSelection()">
                <div id="timeSelectionInfo" class="telegram-info" style="font-size: 14px; padding: 15px; margin-top: 15px; display: none;"></div>
            </div>
            <button type="button" id="nextFromDateTime" class="btn-primary" onclick="app.showInstructions()" disabled>–î–∞–ª–µ–µ</button>
        </div>

        <div id="instructionsScreen" class="form-screen" style="display: none;">
            <button class="btn-back" onclick="app.showDateTimeSelection()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="form-header">
                <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å—Ç–æ—Ä–∏—Å</h2>
            </div>
            <div class="instructions">
                <h3>–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏—Å:</h3>
                <ul class="checklist">
                    <li>–£–ø–æ–º—è–Ω—É—Ç—å –±—Ä–µ–Ω–¥ –≤ —Å—Ç–æ—Ä–∏—Å</li>
                    <li>–û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—à Instagram @vesla.kz</li>
                    <li>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É –∏ –µ–¥—É</li>
                    <li>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–æ—Å—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</li>
                </ul>
                <div style="margin-top: 20px;">
                    <strong>–ü—Ä–∏–º–µ—Ä —Ç–µ–∑–∏—Å–∞:</strong><br>
                    <em>"–Ø –∑–∞–∫–∞–∑–∞–ª–∞ —É @vesla.kz ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–æ—Å–º–æ—Å! –û—á–µ–Ω—å –≤–∫—É—Å–Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ!"</em>
                </div>
            </div>
            <div class="warning-message" id="warningMessage">
                ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–Ω–∏—Ç–µ: 3 –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞ ‚Äî –∏ –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ú—ã —É–≤–µ—Ä–µ–Ω—ã, –¥–æ —ç—Ç–æ–≥–æ –Ω–µ –¥–æ–π–¥–µ—Ç! üòä
            </div>
            <button type="button" class="btn-primary" onclick="app.submitOrder(this)">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div id="successModal" class="modal">
            <div class="modal-content">
                <div class="success-icon">‚úÖ</div>
                <h2 id="successTitle">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>
                <p class="subtitle" id="successMessage">–ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤–∞–º –ø—Ä–∏–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ—Ç—á–µ—Ç–µ</p>
                <button id="successModalCloseBtn" class="btn-primary" onclick="app.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="errorModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">‚ùå</div>
                <h2 id="errorTitle">–û—à–∏–±–∫–∞</h2>
                <p class="subtitle" id="errorMessage"></p>
                <button class="btn-primary" onclick="app.closeErrorModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
        <div id="overdraftModal" class="modal">
            <div class="modal-content">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h2 id="overdraftTitle">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–ª–∞—Ç–∞</h2>
                <p class="subtitle" id="overdraftMessage" style="text-align: left; line-height: 1.6;"></p>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.proceedToDateTimeSelection()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('overdraftModal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        <div id="rejectionModal" class="modal">
            <div class="modal-content">
                <div class="error-icon">üòî</div>
                <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å!</h2>
                <p class="subtitle">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π –æ—Ç 300 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å—Ç–æ—Ä–∏—Å. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞—à–∏–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å–∫–æ—Ä–æ —ç—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è!</p>
                <button class="btn-primary" onclick="app.closeRejectionModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
        <div id="orderHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
                <div id="orderHistoryList" style="text-align: left; max-height: 40vh; overflow-y: auto; margin: 20px 0;"></div>
                <button class="btn-primary" onclick="app.closeOrderHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="orderDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="orderDetailTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
                     <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="markReportAcceptedBtn" class="btn-icon btn-icon-unblock" title="–û—Ç—á–µ—Ç —Å–¥–∞–Ω –∏ –ø—Ä–∏–Ω—è—Ç">‚úîÔ∏è</button>
                        <button id="markNoReportBtn" class="btn-icon btn-icon-block" title="–û—Ç—á–µ—Ç –Ω–µ —Å–¥–∞–Ω">üö©</button>
                        <button class="btn-danger-icon" id="deleteOrderBtn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑">üóëÔ∏è</button>
                     </div>
                </div>
                <div id="orderDetailBody" class="modal-body"></div>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label for="orderStatusSelect">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <select id="orderStatusSelect" style="width: 100%;">
                         <option value="new">–ù–æ–≤—ã–π</option>
                         <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                         <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                         <option value="awaiting_review">–û—Ç—á–µ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                         <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                         <option value="rejected">–û—Ç—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="app.updateOrderStatus(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn-secondary" onclick="app.closeOrderDetailModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="userDetailModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                     <h2 id="userDetailTitle">–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                </div>
                <div id="userDetailBody" class="modal-body"></div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div style="text-align: left;">
                    <label>–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏:</label>
                    <div id="userTagsContainer" class="tags-container"></div>
                    <div class="form-group">
                        <label for="newTagInput" style="margin-top: 15px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥ –≤—Ä—É—á–Ω—É—é</label>
                        <div class="input-with-button">
                            <input type="text" id="newTagInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞">
                            <button onclick="app.addUserTag()">+</button>
                        </div>
                    </div>
                </div>
                
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                
                <div id="vcoinManagementBlock" class="vcoin-management-block" style="display: none;">
                    <label for="vcoinManageAmount">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ V-–ë–æ–Ω—É—Å–∞–º–∏</label>
                    <div class="form-group" style="margin-top: 8px;">
                        <input type="number" id="vcoinManageAmount" placeholder="0">
                    </div>
                    <div class="button-group">
                        <button class="btn-primary btn-small" onclick="app.manageVcoins('add')">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                        <button class="btn-danger btn-small" onclick="app.manageVcoins('remove')">–°–ø–∏—Å–∞—Ç—å</button>
                    </div>
                </div>
                
                <button class="btn-secondary" id="resetCooldownBtn" onclick="app.resetOrderCooldown()" style="margin-top: 20px; display: none;">–°–±—Ä–æ—Å–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</button>
                <button class="btn-secondary" onclick="app.closeUserDetailModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <h2 id="reportModalTitle">–°–¥–∞—Ç—å –æ—Ç—á–µ—Ç</h2>
                <p class="subtitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–æ—Ä–∏—Å –∏–ª–∏ –ø–æ—Å—Ç</p>
                <div class="form-group" style="text-align: left;">
                    <label for="reportLink">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç *</label>
                    <input type="text" id="reportLink" placeholder="https://instagram.com/stories/...">
                </div>
                <button class="btn-primary" onclick="app.submitReport(this)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn-secondary" onclick="app.closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div id="editProfileModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <form id="editProfileForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="editFirstName">–ò–º—è *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editInstagram">Instagram *</label>
                        <input type="text" id="editInstagram" required>
                    </div>
                    <div class="form-group">
                        <label for="editFollowers">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ *</label>
                        <input type="number" id="editFollowers" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editViews">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã *</label>
                        <input type="number" id="editViews" required min="1" max="10000000">
                    </div>
                    <div class="form-group">
                        <label for="editPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ)</label>
                        <input type="password" id="editPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label for="editVcoinAllowance">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç V-–ë–æ–Ω—É—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)</label>
                        <input type="number" id="editVcoinAllowance" min="0">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.saveProfile(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeEditProfile()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="addBlockModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</h2>
                <form id="addBlockForm" style="margin: 20px 0; text-align: left;">
                    <div class="form-group">
                        <label for="blockCity">–ì–æ—Ä–æ–¥ *</label>
                        <select id="blockCity" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫</option>
                            <option value="–ö–æ–∫—à–µ—Ç–∞—É">–ö–æ–∫—à–µ—Ç–∞—É</option>
                            <option value="–ö–æ—Å—Ç–∞–Ω–∞–π">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫">–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockDate">–î–∞—Ç–∞ *</label>
                        <input type="date" id="blockDate" required>
                    </div>
                    <div class="form-group">
                        <label for="blockType">–¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ *</label>
                        <select id="blockType" required onchange="app.toggleBlockTime()">
                            <option value="range">–î–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏</option>
                            <option value="fullday">–í–µ—Å—å –¥–µ–Ω—å</option>
                        </select>
                    </div>
                    <div id="blockTimeGroup">
                        <div class="form-row">
                             <div class="form-group">
                                <label for="blockStartTime">–° *</label>
                                <input type="time" id="blockStartTime">
                             </div>
                             <div class="form-group">
                                <label for="blockEndTime">–î–æ *</label>
                                <input type="time" id="blockEndTime">
                             </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="blockReason">–ü—Ä–∏—á–∏–Ω–∞</label>
                        <input type="text" id="blockReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.addBlock(this)">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeAddBlockModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="addAdminModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <div class="form-group" style="text-align: left;">
                    <label for="adminRoleSelect">–†–æ–ª—å</label>
                    <select id="adminRoleSelect">
                        <option value="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <input type="text" id="adminUserSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è..." onkeyup="app.filterAdminUsers()">
                <div id="adminUsersList" style="text-align: left; max-height: 40vh; overflow-y: auto;"></div>
                <button class="btn-secondary" onclick="app.closeAddAdminModal()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="contactModal" class="modal">
            <div class="modal-content">
                <h2>–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h2>
                <p class="subtitle">–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram</p>
                <a href="https://t.me/oderefyu" class="contact-link" target="_blank">üí¨ Telegram –ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                <button class="btn-secondary" onclick="app.closeContactModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="menuItemModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <h2 id="menuItemModalTitle">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h2>
                <form id="menuItemForm" style="margin: 20px 0; text-align: left;">
                    <input type="hidden" id="menuItemEditId">
                    <input type="hidden" id="menuItemOldImageUrl">
                    <div class="form-group">
                        <label for="menuItemName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="menuItemName" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="menuItemDesc" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="menuItemPrice">–¶–µ–Ω–∞ (–≤ —Ç–µ–Ω–≥–µ)</label>
                        <input type="number" id="menuItemPrice" required>
                    </div>
                    <div class="form-group">
                        <label for="menuItemCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="menuItemCategory" required>
                            <option value="–°–µ—Ç—ã">–°–µ—Ç—ã</option>
                            <option value="–†–æ–ª–ª—ã">–†–æ–ª–ª—ã</option>
                            <option value="–ü–∏—Ü—Ü–∞">–ü–∏—Ü—Ü–∞</option>
                            <option value="–í–û–ö / –¢–û–ú-–Ø–ú">–í–û–ö / –¢–û–ú-–Ø–ú</option>
                            <option value="–ó–∞–∫—É—Å–∫–∏">–ó–∞–∫—É—Å–∫–∏</option>
                            <option value="–ù–∞–ø–∏—Ç–∫–∏">–ù–∞–ø–∏—Ç–∫–∏</option>
                            <option value="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label for="menuItemSubcategory">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ä–æ–ª–ª–æ–≤)</label>
                         <input type="text" id="menuItemSubcategory" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è, –ó–∞–ø–µ—á—ë–Ω–Ω—ã–µ">
                     </div>
                     <div class="form-group">
                        <label for="menuItemImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–±—É–¥–µ—Ç –æ–±—Ä–µ–∑–∞–Ω–æ –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞)</label>
                        <input type="file" id="menuItemImage" accept="image/*">
                    </div>
                </form>
                <div class="modal-button-group">
                    <button class="btn-primary" onclick="app.saveMenuItem(this)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-secondary" onclick="app.closeSimpleModal('menuItemModal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
    </div>

    <div class="admin-panel" id="adminPanel" style="display: none;">
        <button class="admin-btn" onclick="app.showCRM()" title="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">‚öôÔ∏è</button>
    </div>

   <!-- –í –∫–æ–Ω—Ü–µ body, –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º —Ç–µ–≥–æ–º </body> -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
<script type="module">
    import * as Main from './js/main.js';
    import * as UI from './js/ui.js';
    import * as API from './js/api.js';

    // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç app –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ inline –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    window.app = {
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        showRegistration: () => {
            if (!Main.appState.telegramUser) {
                return UI.showCriticalError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
            }
            UI.showScreen('registrationScreen');
            fillTelegramData();
        },
        showLogin: () => UI.showScreen('loginScreen'),
        showWelcomeScreen: () => UI.showScreen('welcomeScreen'),
        showDashboard: () => UI.showDashboard(Main.appState),
        showCRM: async () => {
            if (!Main.ensureAuthenticated()) return;
            if (!Main.appState.currentUserRole) {
                UI.showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ CRM.');
                return;
            }
            UI.showScreen('crmScreen');
            setupCRMTabs();
            await Main.updateCRMStats();
        },
        showSetSelection: () => UI.showScreen('setSelectionScreen'),
        showAddressForm: () => UI.showScreen('addressScreen'),
        showDateTimeSelection: () => UI.showScreen('dateTimeScreen'),
        showInstructions: () => UI.showScreen('instructionsScreen'),
        showMenuScreen: () => {
            UI.showScreen('menuSelectionScreen');
            UI.loadAndRenderMenu(Main.appState, Main.VCOIN_RATE);
        },

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        submitLogin: async (button) => await withLoading(button, () => Main.submitLogin()),
        submitMigration: async (button) => await withLoading(button, () => Main.submitMigration()),
        submitRegistration: async (button) => await withLoading(button, () => Main.submitRegistration()),
        logout: () => Main.logout(),

        // –ó–∞–∫–∞–∑—ã
        startCollaboration: () => Main.startCollaboration(),
        submitOrder: async (button) => await withLoading(button, () => Main.submitOrder()),
        submitAddressAndShowDateTime: () => submitAddressAndShowDateTime(),
        validateTimeSelection: () => Main.validateTimeSelection(),
        selectSet: (element, setId) => selectSet(element, setId),
        proceedToAddressFromSet: () => proceedToAddressFromSet(),

        // –ö–æ—Ä–∑–∏–Ω–∞
        addToCart: (item) => Main.addToCart(item),
        removeFromCart: (itemId) => Main.removeFromCart(itemId),
        checkBalanceAndProceed: () => Main.checkBalanceAndProceed(),
        proceedToDateTimeSelection: () => Main.proceedToDateTimeSelection(),

        // –ü—Ä–æ—Ñ–∏–ª—å
        editProfile: () => editProfile(),
        saveProfile: async (button) => await withLoading(button, () => Main.saveProfile()),
        showOrderHistory: () => showOrderHistory(),

        // –û—Ç—á–µ—Ç—ã
        showReportModal: (orderId, orderNumber) => showReportModal(orderId, orderNumber),
        submitReport: async (button) => await withLoading(button, () => Main.submitReport()),
        closeReportModal: () => UI.closeModal('reportModal'),

        // CRM - –ó–∞–∫–∞–∑—ã
        showCrmTab: (tabName, element) => showCrmTab(tabName, element),
        filterOrders: () => UI.filterList('orderSearch', '#ordersList', '.order-item'),
        showOrderDetailModal: async (orderId) => await showOrderDetailModal(orderId),
        closeOrderDetailModal: () => UI.closeModal('orderDetailModal'),
        updateOrderStatus: async (button) => {
            await withLoading(button, async () => {
                const newStatus = document.getElementById('orderStatusSelect').value;
                await Main.updateOrderStatus(newStatus);
                await UI.updateOrdersList(Main.getStatusInfo);
            });
        },
        removeOrder: async (orderId) => await removeOrder(orderId),
        markReportAccepted: async (button) => await markReportAccepted(button),
        markNoReport: async (button, orderId, orderNumber) => await markNoReport(button, orderId, orderNumber),

        // CRM - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        filterUsers: () => UI.filterList('userSearch', '#usersList', '.user-item'),
        showUserDetailModal: async (userId) => await showUserDetailModal(userId),
        closeUserDetailModal: () => UI.closeModal('userDetailModal'),
        toggleUserBlock: async (userId, shouldBlock) => {
            await Main.toggleUserBlock(userId, shouldBlock);
            await UI.updateUsersList(Main.calculateBloggerRating);
        },
        removeUser: async (userId, userName) => {
            await Main.removeUser(userId, userName);
            await UI.updateUsersList(Main.calculateBloggerRating);
        },
        addUserTag: async () => await addUserTag(),
        removeUserTag: async (tag) => await removeUserTag(tag),
        resetOrderCooldown: async () => await resetOrderCooldown(),
        manageVcoins: async (action) => await manageVcoins(action),

        // CRM - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        showAddBlockModal: () => {
            document.getElementById('addBlockModal').style.display = 'flex';
            toggleBlockTime();
        },
        closeAddBlockModal: () => UI.closeModal('addBlockModal'),
        toggleBlockTime: () => toggleBlockTime(),
        addBlock: async (button) => await addBlock(button),
        removeBlock: async (blockId) => {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?')) {
                await API.removeBlockedSlot(blockId);
                await UI.updateBlockedSlotsList();
            }
        },

        // CRM - –ê–¥–º–∏–Ω—ã
        showAddAdminModal: async () => await showAddAdminModal(),
        closeAddAdminModal: () => UI.closeModal('addAdminModal'),
        filterAdminUsers: () => UI.filterList('adminUserSearch', '#adminUsersList', '.user-item'),
        addAdmin: async (userId, userName, role) => await addAdmin(userId, userName, role),
        removeAdmin: async (adminId) => await removeAdmin(adminId),
        toggleAdminNotifications: async (adminId, currentState) => {
            await API.toggleAdminNotifications(adminId, currentState);
            UI.showCrmSuccess('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
            await UI.updateAdminsList();
        },

        // CRM - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        loadSchedule: async () => await loadSchedule(),
        saveSchedule: async (button) => await withLoading(button, () => saveSchedule()),
        showScheduleForCity: (city, element) => showScheduleForCity(city, element),

        // CRM - –ú–µ–Ω—é
        filterMenuItems: () => UI.filterList('menuSearch', '#menuItemsListCrm', '.user-item'),
        updateMenuItemsListCrm: () => UI.updateMenuItemsListCrm(),
        showMenuItemModal: async (itemId = null) => await showMenuItemModal(itemId),
        saveMenuItem: async (button) => await saveMenuItem(button),
        deleteMenuItem: async (itemId) => {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ?')) {
                await API.deleteMenuItem(itemId);
                UI.showCrmSuccess("–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ.");
                await UI.updateMenuItemsListCrm();
            }
        },
        toggleMenuItemVisibility: async (itemId, currentVisibility) => {
            await API.toggleMenuItemVisibility(itemId, currentVisibility);
            await UI.updateMenuItemsListCrm();
        },
        triggerMenuImport: () => document.getElementById('menuFileInput').click(),
        handleMenuFileSelect: async (event) => await handleMenuFileSelect(event),

        // CRM - –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        saveSettings: async (button) => await saveSettings(button),
        applyAnalyticsFilters: async () => {
            const startDate = document.getElementById('analyticsStartDate').value;
            const endDate = document.getElementById('analyticsEndDate').value;
            const city = document.getElementById('analyticsCity').value;
            document.getElementById('cityChartContainer').style.display = 
                (city && city !== 'all') ? 'none' : 'flex';
            await UI.updateAllAnalytics({ startDate, endDate, city });
        },

        // CRM - –†–∞—Å—Å—ã–ª–∫–∞
        sendBroadcast: async (button) => await sendBroadcast(button),

        // CRM - –≠–∫—Å–ø–æ—Ä—Ç
        exportOrdersToExcel: async (btn) => await exportToExcel(btn, 'orders'),
        exportUsersToExcel: async (btn) => await exportToExcel(btn, 'users'),

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        closeModal: () => {
            UI.closeModal('successModal');
            UI.showDashboard(Main.appState);
        },
        closeSimpleModal: (modalId) => UI.closeModal(modalId),
        closeErrorModal: () => UI.closeModal('errorModal'),
        closeRejectionModal: () => UI.closeModal('rejectionModal'),
        closeOrderHistory: () => UI.closeModal('orderHistoryModal'),
        closeEditProfile: () => UI.closeModal('editProfileModal'),
        contactAdmin: () => document.getElementById('contactModal').style.display = 'flex',
        closeContactModal: () => UI.closeModal('contactModal'),

        // –£—Ç–∏–ª–∏—Ç—ã
        copyPlaceholder: (element) => copyPlaceholder(element)
    };

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    async function withLoading(button, asyncFunction) {
        if (!button || button.disabled) return;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        try {
            await asyncFunction();
        } catch (error) {
            console.error("Operation failed:", error);
            UI.showError("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞", error.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    function fillTelegramData() {
        if (Main.appState.telegramUser && Main.appState.telegramUser.first_name) {
            document.getElementById('firstName').value = Main.appState.telegramUser.first_name;
        }
    }

    function selectSet(element, setId) {
        document.querySelectorAll('.set-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        Main.appState.currentOrderData.set = setId;
        Main.appState.currentOrderData.setName = element.dataset.setName;
        document.getElementById('nextFromSet').disabled = false;
    }

    function proceedToAddressFromSet() {
        document.getElementById('backFromAddress').onclick = () => app.showSetSelection();
        UI.showScreen('addressScreen');
    }

    function submitAddressAndShowDateTime() {
        if (!validateAddressForm()) return;
        Main.appState.currentOrderData.city = document.getElementById('city').value;
        Main.appState.currentOrderData.street = document.getElementById('street').value;
        Main.appState.currentOrderData.entrance = document.getElementById('entrance').value;
        Main.appState.currentOrderData.floor = document.getElementById('floor').value;
        Main.appState.currentOrderData.recipientPhone = document.getElementById('recipientPhone').value;
        Main.appState.currentOrderData.comment = document.getElementById('comment').value;

        const backButton = document.getElementById('backFromDateTime');
        const isMacro = Main.appState.userData.level && Main.appState.userData.level.startsWith('macro');

        if (isMacro) {
            backButton.onclick = () => app.showMenuScreen();
            app.showMenuScreen();
        } else {
            backButton.onclick = () => app.showAddressForm();
            UI.showScreen('dateTimeScreen');
            Main.setupTimeSelection();
        }
    }

    function validateAddressForm() {
        const city = document.getElementById('city').value;
        const street = document.getElementById('street').value;
        const phone = document.getElementById('recipientPhone').value;
        if (!city || !street || !phone) {
            UI.showError('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, —Ç–µ–ª–µ—Ñ–æ–Ω.');
            return false;
        }
        return true;
    }

    function editProfile() {
        const reg = Main.appState.userData.registration || Main.appState.userData;
        document.getElementById('editFirstName').value = reg.firstName;
        document.getElementById('editPhone').value = reg.phone;
        document.getElementById('editInstagram').value = reg.instagramLogin;
        document.getElementById('editFollowers').value = reg.followersCount;
        document.getElementById('editViews').value = reg.avgViews;
        document.getElementById('editPassword').value = '';
        
        const vcoinInput = document.getElementById('editVcoinAllowance');
        vcoinInput.value = Main.appState.userData.vcoin_allowance || 0;
        vcoinInput.parentElement.style.display = Main.appState.currentUserRole === 'admin' ? 'block' : 'none';

        document.getElementById('editProfileModal').style.display = 'flex';
    }

    function showOrderHistory() {
        const list = document.getElementById('orderHistoryList');
        const sortedOrders = (Main.appState.userData.orders || [])
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if (sortedOrders.length === 0) {
            list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
        } else {
            list.innerHTML = sortedOrders.map(order => {
                const statusInfo = Main.getStatusInfo(order.status);
                return `<div class="order-item">
                    <div class="order-header">
                        <span class="order-id">${order.orderNumber}</span>
                        <span class="order-status ${statusInfo.className}">${statusInfo.text}</span>
                    </div>
                </div>`;
            }).join('');
        }
        document.getElementById('orderHistoryModal').style.display = 'flex';
    }

    function showReportModal(orderId, orderNumber) {
        Main.appState.currentReportingOrderId = orderId;
        document.getElementById('reportModalTitle').textContent = `–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É ${orderNumber}`;
        document.getElementById('reportModal').style.display = 'flex';
    }

    // CRM —Ñ—É–Ω–∫—Ü–∏–∏
    function setupCRMTabs() {
        document.querySelectorAll('.crm-tab').forEach(tab => {
            const tabName = tab.dataset.tab;
            let isVisible = false;
            if (Main.appState.currentUserRole === 'admin') {
                isVisible = true;
            } else if (Main.appState.currentUserRole === 'operator') {
                const operatorTabs = ['overview', 'orders', 'users', 'schedule', 'blocks'];
                isVisible = operatorTabs.includes(tabName);
            }
            tab.style.display = isVisible ? 'flex' : 'none';
        });

        const firstVisibleTab = document.querySelector('.crm-tab[style*="display: flex"]');
        if (firstVisibleTab) {
            showCrmTab(firstVisibleTab.dataset.tab, firstVisibleTab);
        }
    }

    function showCrmTab(tabName, element) {
        if (!Main.ensureAuthenticated()) return;
        document.querySelectorAll('.crm-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('crm' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        element.classList.add('active');
        
        switch(tabName) {
            case 'overview':
                Main.updateCRMStats();
                document.getElementById('cooldownSetting').value = Main.appState.appSettings.orderCooldownDays;
                break;
            case 'analytics':
                app.applyAnalyticsFilters();
                break;
            case 'orders':
                UI.updateOrdersList(Main.getStatusInfo);
                break;
            case 'users':
                UI.updateUsersList(Main.calculateBloggerRating);
                break;
            case 'schedule':
                app.loadSchedule();
                break;
            case 'blocks':
                UI.updateBlockedSlotsList();
                break;
            case 'admins':
                UI.updateAdminsList();
                break;
            case 'broadcast':
                setupBroadcastTagInput();
                break;
            case 'menu':
                UI.updateMenuItemsListCrm();
                break;
        }
    }

    async function showOrderDetailModal(orderId) {
        Main.appState.currentEditingOrderId = orderId;
        const orderDoc = await API.db.collection(API.COLLECTIONS.ORDERS).doc(orderId).get();
        if(!orderDoc.exists) return;
        const order = orderDoc.data();
        
        let itemsHtml = '';
        if (order.vcoin_cost) {
            const itemsList = order.items.map(item => 
                `<li>${item.name} (x${item.quantity}) - ${UI.formatVBonus((item.price / Main.VCOIN_RATE) * item.quantity)}</li>`
            ).join('');
            itemsHtml = `<strong>–ó–∞–∫–∞–∑:</strong><ul>${itemsList}</ul>`
                + `<strong>–ò—Ç–æ–≥–æ:</strong> ${UI.formatVBonus(order.vcoin_cost)}<br>`
                + `<strong>–ö –¥–æ–ø–ª–∞—Ç–µ:</strong> ${(order.payment_due_tenge || 0).toFixed(0)} ‚Ç∏<br>`;
        } else if (order.setName) {
            itemsHtml = `<strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä:</strong> ${order.setName}<br>`;
        }

        document.getElementById('orderDetailTitle').textContent = `–ó–∞–∫–∞–∑ ${order.orderNumber}`;
        document.getElementById('orderDetailBody').innerHTML = 
            `<strong>–ë–ª–æ–≥–µ—Ä:</strong> ${order.userName}<br>`
            + `<strong>Instagram:</strong> <a href="https://www.instagram.com/${order.instagram.replace('@','')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${order.instagram}</a><br>`
            + `<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.phone}<br>`
            + `<strong>–ì–æ—Ä–æ–¥:</strong> ${order.city}<br>`
            + `<strong>–ê–¥—Ä–µ—Å:</strong> ${order.street}<br>`
            + itemsHtml
            + `<strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment || '-'}<br>`
            + `<strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç:</strong> ${order.reportLink ? `<a href="${order.reportLink}" target="_blank" class="report-link">${order.reportLink}</a>` : '-'}`;
        
        document.getElementById('orderStatusSelect').value = order.status;
        
        const markNoReportBtn = document.getElementById('markNoReportBtn');
        const markReportAcceptedBtn = document.getElementById('markReportAcceptedBtn');
        const isActionable = !order.reportMissed && order.status !== 'completed';
        
        markNoReportBtn.disabled = !isActionable;
        markReportAcceptedBtn.disabled = !isActionable;

        document.getElementById('deleteOrderBtn').onclick = () => app.removeOrder(order.id);
        markNoReportBtn.onclick = () => app.markNoReport(markNoReportBtn, order.id, order.orderNumber);
        markReportAcceptedBtn.onclick = () => app.markReportAccepted(markReportAcceptedBtn);
        
        document.getElementById('orderDetailModal').style.display = 'flex';
    }

    async function removeOrder(orderId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
            await withLoading(document.getElementById('deleteOrderBtn'), async () => {
                const orderRef = API.db.collection(API.COLLECTIONS.ORDERS).doc(orderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) return;
                
                const userId = orderDoc.data().userId;
                const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(userId);
                const batch = API.db.batch();
                
                batch.delete(orderRef);
                const userDoc = await userRef.get();
                if (userDoc.exists) {
                    const updatedOrders = (userDoc.data().orders || []).filter(o => o.id !== orderId);
                    batch.update(userRef, { orders: updatedOrders });
                }
                
                await batch.commit();
                UI.closeModal('orderDetailModal');
                UI.updateOrdersList(Main.getStatusInfo);
                UI.showCrmSuccess('–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω.');
            });
        }
    }

    async function markReportAccepted(button) {
        if (button.disabled || !confirm('–û—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç? –≠—Ç–æ –∑–∞—Å—á–∏—Ç–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.')) return;
        
        await withLoading(button, async () => {
            const orderRef = API.db.collection(API.COLLECTIONS.ORDERS).doc(Main.appState.currentEditingOrderId);
            const orderDoc = await orderRef.get();
            if (!orderDoc.exists) return;
            
            const orderData = orderDoc.data();
            const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(orderData.userId);
            const batch = API.db.batch();
            
            batch.update(orderRef, { status: 'completed', reportAccepted: true });
            const userDoc = await userRef.get();
            if(userDoc.exists) {
                const orders = (userDoc.data().orders || []).map(o => 
                    o.id === Main.appState.currentEditingOrderId ? {...o, status: 'completed'} : o
                );
                batch.update(userRef, { orders: orders });
            }
            
            await batch.commit();
            await Main.checkAndUpgradeLoyaltyStatus(orderData.userId);
            
            UI.showCrmSuccess('–û—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç, –∑–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.');
            UI.closeModal('orderDetailModal');
            UI.updateOrdersList(Main.getStatusInfo);
            UI.updateUsersList(Main.calculateBloggerRating);
        });
    }

    async function markNoReport(button, orderId, orderNumber) {
        if (button.disabled) return;
        
        const orderRef = API.db.collection(API.COLLECTIONS.ORDERS).doc(orderId);
        const orderDoc = await orderRef.get();
        if (orderDoc.exists && orderDoc.data().reportMissed) {
            UI.showError('–û—à–∏–±–∫–∞', '–ù–∞ —ç—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –±—ã–ª –Ω–∞–ª–æ–∂–µ–Ω —à—Ç—Ä–∞—Ñ.');
            return;
        }

        if (!confirm('–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑—É –Ω–µ —Å–¥–∞–Ω? –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç —à—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª.')) return;
        
        await withLoading(button, async () => {
            const orderData = orderDoc.data();
            const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(orderData.userId);
            const userDoc = await userRef.get();
            if(!userDoc.exists) throw new Error("User not found!");

            const newStrikes = (userDoc.data().strikes || 0) + 1;
            const updates = { strikes: newStrikes };
            
            if (newStrikes >= 3) {
                updates.isBlocked = true;
                updates.blockReason = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: ${newStrikes} –Ω–µ—Å–¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞.`;
            }
            
            const batch = API.db.batch();
            batch.update(userRef, updates);
            const orders = (userDoc.data().orders || []).map(o => 
                o.id === orderId ? {...o, status: 'completed'} : o
            );
            batch.update(userRef, { orders: orders });
            batch.update(orderRef, { reportMissed: true, status: 'completed' });
            
            await batch.commit();
            UI.showCrmSuccess('–®—Ç—Ä–∞—Ñ–Ω–æ–π –±–∞–ª–ª –¥–æ–±–∞–≤–ª–µ–Ω, –∑–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç.');
            UI.closeModal('orderDetailModal');
            UI.updateUsersList(Main.calculateBloggerRating);
        });
    }

    async function showUserDetailModal(userId) {
        Main.appState.currentUserDetailId = userId;
        const userDoc = await API.db.collection(API.COLLECTIONS.USERS).doc(userId).get();
        if (!userDoc.exists) return;
        
        const user = userDoc.data();
        const reg = user.registration || user;
        
        document.getElementById('userDetailTitle').textContent = reg.firstName;
        document.getElementById('userDetailBody').innerHTML = 
            `<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${reg.phone}<br>`
            + `<strong>Instagram:</strong> <a href="https://www.instagram.com/${reg.instagramLogin.replace('@','')}" target="_blank" style="color: #00b4d8; text-decoration: none;">@${reg.instagramLogin}</a><br>`
            + `<strong>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:</strong> ${reg.followersCount}<br>`
            + `<strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${reg.avgViews}<br>`
            + `<strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê ${Main.calculateBloggerRating(user)}<br>`
            + `<strong>–ë–∞–ª–∞–Ω—Å V-–ë–æ–Ω—É—Å–æ–≤:</strong> ${UI.formatVBonus(user.vcoin_balance || 0)}<br>`
            + `<strong>–õ–∏–º–∏—Ç V-–ë–æ–Ω—É—Å–æ–≤:</strong> ${UI.formatVBonus(user.vcoin_allowance || 0)}`;
        
        const resetCooldownBtn = document.getElementById('resetCooldownBtn');
        const vcoinManagementBlock = document.getElementById('vcoinManagementBlock');
        
        if (user.level === 'micro') {
            resetCooldownBtn.style.display = 'block';
            vcoinManagementBlock.style.display = 'none';
        } else if (user.level && user.level.startsWith('macro')) {
            resetCooldownBtn.style.display = 'none';
            vcoinManagementBlock.style.display = 'block';
        } else {
            resetCooldownBtn.style.display = 'none';
            vcoinManagementBlock.style.display = 'none';
        }

        renderTags(user.tags || []);
        document.getElementById('userDetailModal').style.display = 'flex';
    }

    function renderTags(tags) {
        const container = document.getElementById('userTagsContainer');
        container.innerHTML = tags.length 
            ? tags.map(tag => `<span class="tag">${tag} <span class="remove-tag" onclick="app.removeUserTag('${tag}')">√ó</span></span>`).join('') 
            : `<p style="font-size: 12px; color: #999;">–¢–µ–≥–æ–≤ –Ω–µ—Ç.</p>`;
    }

    async function addUserTag() {
        const input = document.getElementById('newTagInput');
        const newTag = input.value.trim().toLowerCase();
        if (!newTag || !Main.appState.currentUserDetailId) return;

        const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(Main.appState.currentUserDetailId);
        await API.db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw "User not found";
            const tags = userDoc.data().tags || [];
            if (!tags.includes(newTag)) {
                tags.push(newTag);
                transaction.update(userRef, { tags: tags });
                renderTags(tags);
            }
        });
        input.value = '';
    }

    async function removeUserTag(tagToRemove) {
        if (!tagToRemove || !Main.appState.currentUserDetailId) return;
        const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(Main.appState.currentUserDetailId);
        await API.db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) throw "User not found";
            const tags = userDoc.data().tags || [];
            const updatedTags = tags.filter(t => t !== tagToRemove);
            transaction.update(userRef, { tags: updatedTags });
            renderTags(updatedTags);
        });
    }

    async function resetOrderCooldown() {
        if (!Main.appState.currentUserDetailId || !confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
        
        const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(Main.appState.currentUserDetailId);
        const userDoc = await userRef.get();
        if (userDoc.exists) {
            await userRef.update({ lastOrderTimestamp: API.FieldValue.delete() });
            UI.showCrmSuccess("–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ.");
        } else {
            UI.showError("–û—à–∏–±–∫–∞", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        }
        UI.closeModal('userDetailModal');
    }

    async function manageVcoins(action) {
        if (!Main.appState.currentUserDetailId) return;
        const amountInput = document.getElementById('vcoinManageAmount');
        const amount = parseInt(amountInput.value);

        if (isNaN(amount) || amount <= 0) {
            return UI.showError("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.");
        }
        
        const actionText = action === 'add' ? '–Ω–∞—á–∏—Å–ª–∏—Ç—å' : '—Å–ø–∏—Å–∞—Ç—å';
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${actionText} ${amount} V-–ë–æ–Ω—É—Å–æ–≤?`)) return;

        try {
            const response = await API.apiFetch('/api/manage-vcoins', {
                method: 'POST',
                body: JSON.stringify({
                    userId: Main.appState.currentUserDetailId,
                    amount: amount,
                    action: action
                })
            }, Main.appState.tg);
            
            UI.showCrmSuccess("–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω!", response.message);
            amountInput.value = '';
            await app.showUserDetailModal(Main.appState.currentUserDetailId);
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ ${action === 'add' ? '–Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏' : '—Å–ø–∏—Å–∞–Ω–∏–∏'} V-–ë–æ–Ω—É—Å–æ–≤:`, error);
            UI.showError("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error.message);
        }
    }

    function toggleBlockTime() {
        document.getElementById('blockTimeGroup').style.display = 
            document.getElementById('blockType').value === 'range' ? 'block' : 'none';
    }

    async function addBlock(button) {
        await withLoading(button, async () => {
            const city = document.getElementById('blockCity').value;
            const date = document.getElementById('blockDate').value;
            const type = document.getElementById('blockType').value;
            const reason = document.getElementById('blockReason').value.trim();
            
            if (!city || !date) {
                return UI.showError('–û—à–∏–±–∫–∞', '–ì–æ—Ä–æ–¥ –∏ –¥–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.');
            }

            const blockData = { city, date, type, reason };

            if (type === 'range') {
                const startTime = document.getElementById('blockStartTime').value;
                const endTime = document.getElementById('blockEndTime').value;
                if (!startTime || !endTime || startTime >= endTime) {
                    return UI.showError('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏.');
                }
                blockData.startTime = startTime;
                blockData.endTime = endTime;
            }

            await API.addBlockedSlot(blockData);
            UI.closeModal('addBlockModal');
            await UI.updateBlockedSlotsList();
            UI.showCrmSuccess('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        });
    }

    async function showAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'flex';
        const list = document.getElementById('adminUsersList');
        list.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const [usersSnapshot, adminsSnapshot] = await Promise.all([
            API.db.collection(API.COLLECTIONS.USERS).get(),
            API.db.collection(API.COLLECTIONS.ADMINS).get()
        ]);
        
        const adminIds = new Set(adminsSnapshot.docs.map(doc => doc.id));
        list.innerHTML = '';
        
        usersSnapshot.forEach(doc => {
            const user = { userId: doc.id, ...doc.data() };
            const reg = user.registration || user;
            if (!reg.firstName || !user.telegramId) return;
            
            const isAlreadyAdmin = adminIds.has(String(user.telegramId));
            const el = document.createElement('div');
            el.className = 'user-item';
            el.dataset.search = `${reg.firstName} ${reg.instagramLogin}`.toLowerCase();
            el.innerHTML = `
                <div>
                    <strong>${reg.firstName}</strong>
                    <div style="font-size: 12px; color: #999;">@${reg.instagramLogin}</div>
                </div>
                ${isAlreadyAdmin 
                    ? '<span class="user-admin-badge">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>' 
                    : `<button class="btn-primary btn-small" onclick="app.addAdmin('${user.userId}', '${reg.firstName}', document.getElementById('adminRoleSelect').value)">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>`
                }`;
            list.appendChild(el);
        });
    }

    async function addAdmin(userId, userName, role) {
        if (!userId) return;
        const userDoc = await API.loadUser(userId);
        const telegramId = userDoc?.telegramId;
        if(!telegramId) return UI.showError("–û—à–∏–±–∫–∞", "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç Telegram ID.");
        
        const newAdmin = {
            name: userName,
            role: role,
            addedAt: new Date().toISOString(),
            receivesNotifications: true
        };
        await API.addAdmin(telegramId, newAdmin);

        const userRef = API.db.collection(API.COLLECTIONS.USERS).doc(userId);
        const tags = userDoc.tags || [];
        if (!tags.includes(role)) tags.push(role);
        await userRef.update({ tags: tags });

        UI.closeModal('addAdminModal');
        await UI.updateAdminsList();
        UI.showCrmSuccess(`${userName} –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ä–æ–ª—å: ${role}!`);
    }

    async function removeAdmin(adminId) {
        if (adminId === '1345815453') {
            return UI.showError('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        }
        
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?`)) return;
        
        const adminRef = API.db.collection(API.COLLECTIONS.ADMINS).doc(adminId);
        const adminDoc = await adminRef.get();
        if (!adminDoc.exists) return;
        
        const role = adminDoc.data().role;
        const usersSnapshot = await API.db.collection(API.COLLECTIONS.USERS)
            .where('telegramId', '==', Number(adminId)).get();
        
        if (!usersSnapshot.empty) {
            const userDoc = usersSnapshot.docs[0];
            const tags = userDoc.data().tags.filter(t => t !== role);
            await API.db.collection(API.COLLECTIONS.USERS).doc(userDoc.id).update({ tags: tags });
        }

        await adminRef.delete();
        await UI.updateAdminsList();
        UI.showCrmSuccess('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω!');
    }

    async function loadSchedule() {
        const tabsContainer = document.getElementById('scheduleCityTabs');
        const formsContainer = document.getElementById('scheduleFormsContainer');
        tabsContainer.innerHTML = '';
        formsContainer.innerHTML = '<div class="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const days = {
            monday: "–ü–Ω", tuesday: "–í—Ç", wednesday: "–°—Ä",
            thursday: "–ß—Ç", friday: "–ü—Ç", saturday: "–°–±", sunday: "–í—Å"
        };
        let formsHtml = '';
        
        for (const city of Main.CITIES) {
            const tab = document.createElement('button');
            tab.className = 'schedule-city-tab';
            tab.textContent = city;
            tab.onclick = () => showScheduleForCity(city, tab);
            tabsContainer.appendChild(tab);
            
            let formHtml = `<div class="schedule-form" id="schedule-form-${city}">`;
            const scheduleData = await API.getSchedule(city) || {};
            
            for (const dayKey in days) {
                formHtml += `<div class="form-group">
                    <label>${days[dayKey]}</label>
                    <input type="text" id="schedule_${city}_${dayKey}" 
                           value="${scheduleData[dayKey] || ''}" 
                           placeholder="12:00-18:00">
                </div>`;
            }
            formsHtml += formHtml + `</div>`;
        }
        
        formsContainer.innerHTML = formsHtml;
        if(tabsContainer.firstChild) tabsContainer.firstChild.click();
    }

    function showScheduleForCity(city, element) {
        document.querySelectorAll('.schedule-city-tab, .schedule-form').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById(`schedule-form-${city}`).classList.add('active');
    }

    async function saveSchedule() {
        const batch = API.db.batch();
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        for (const city of Main.CITIES) {
            const scheduleData = {};
            days.forEach(dayKey => {
                scheduleData[dayKey] = document.getElementById(`schedule_${city}_${dayKey}`).value.trim();
            });
            await API.saveSchedule(city, scheduleData);
        }
        
        UI.showCrmSuccess("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    }

    async function showMenuItemModal(itemId = null) {
        const form = document.getElementById('menuItemForm');
        form.reset();
        const title = document.getElementById('menuItemModalTitle');
        const idField = document.getElementById('menuItemEditId');
        const oldImageUrlField = document.getElementById('menuItemOldImageUrl');

        if (itemId) {
            title.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ";
            idField.value = itemId;
            const doc = await API.db.collection(API.COLLECTIONS.MENU).doc(itemId).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('menuItemName').value = data.name;
                document.getElementById('menuItemDesc').value = data.description || '';
                document.getElementById('menuItemPrice').value = data.price;
                document.getElementById('menuItemCategory').value = data.category;
                document.getElementById('menuItemSubcategory').value = data.subcategory || '';
                oldImageUrlField.value = data.imageUrl || '';
            }
        } else {
            title.textContent = "–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ";
            idField.value = '';
            oldImageUrlField.value = '';
        }
        document.getElementById('menuItemModal').style.display = 'flex';
    }

    async function saveMenuItem(button) {
        await withLoading(button, async() => {
            const editId = document.getElementById('menuItemEditId').value;
            const name = document.getElementById('menuItemName').value;
            const description = document.getElementById('menuItemDesc').value;
            const price = parseFloat(document.getElementById('menuItemPrice').value);
            const category = document.getElementById('menuItemCategory').value;
            const subcategory = document.getElementById('menuItemSubcategory').value;
            const imageFile = document.getElementById('menuItemImage').files[0];
            let imageUrl = document.getElementById('menuItemOldImageUrl').value;

            if (!name || isNaN(price)) {
                return UI.showError("–û—à–∏–±–∫–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
            }

            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);

                try {
                    button.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ...';
                    const result = await API.apiFetch('/api/upload-menu-image', {
                        method: 'POST',
                        body: formData
                    }, Main.appState.tg);
                    
                    if (!result.success) {
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.');
                    }
                    imageUrl = result.imageUrl;
                } catch (error) {
                    console.error(error);
                    return UI.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', error.message);
                }
            }
            
            const menuItemData = {
                name, description, price, category, subcategory, imageUrl, isVisible: true
            };
            
            await API.saveMenuItem(editId, menuItemData);
            UI.closeModal('menuItemModal');
            UI.showCrmSuccess("–ë–ª—é–¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            await UI.updateMenuItemsListCrm();
        });
    }

    async function handleMenuFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const importButton = document.getElementById('importMenuBtn');
        
        await withLoading(importButton, async () => {
            const formData = new FormData();
            formData.append('menuFile', file);

            const result = await API.apiFetch('/api/import-menu-from-file', {
                method: 'POST',
                body: formData
            }, Main.appState.tg);
            
            UI.showCrmSuccess("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!", result.message);
            await UI.updateMenuItemsListCrm();
        });
        event.target.value = '';
    }

    async function saveSettings(button) {
        await withLoading(button, async() => {
            const cooldownInput = document.getElementById('cooldownSetting');
            const newCooldown = parseInt(cooldownInput.value);
            
            if (isNaN(newCooldown) || newCooldown < 0) {
                return UI.showError("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π (0 –∏–ª–∏ –±–æ–ª—å—à–µ).");
            }
            
            await API.db.collection(API.COLLECTIONS.SETTINGS).doc('config')
                .set({ orderCooldownDays: newCooldown }, { merge: true });
            Main.appState.appSettings.orderCooldownDays = newCooldown;
            UI.showCrmSuccess("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        });
    }

    async function setupBroadcastTagInput() {
        const input = document.getElementById('broadcastTagInput');
        const suggestionsContainer = document.getElementById('tagSuggestions');
        const selectedContainer = document.getElementById('broadcastTagsContainer');
        const tagStats = await API.getTagStats();
        const availableTags = Object.keys(tagStats);

        const addTag = (tag) => {
            if (!tag || Array.from(selectedContainer.children).some(el => el.dataset.tag === tag)) return;
            const tagEl = document.createElement('span');
            tagEl.className = 'tag';
            tagEl.dataset.tag = tag;
            tagEl.innerHTML = `${tag} <span class="remove-tag">√ó</span>`;
            tagEl.querySelector('.remove-tag').onclick = () => tagEl.remove();
            selectedContainer.appendChild(tagEl);
            input.value = '';
            suggestionsContainer.style.display = 'none';
        };

        input.addEventListener('focus', () => {
            renderSuggestions('');
            suggestionsContainer.style.display = 'block';
        });

        input.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') addTag(input.value.trim().toLowerCase());
            else renderSuggestions(input.value.toLowerCase());
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#broadcastTagInput') && !e.target.closest('#tagSuggestions')) {
                suggestionsContainer.style.display = 'none';
            }
        });

        function renderSuggestions(filter) {
            suggestionsContainer.innerHTML = '';
            availableTags.filter(tag => tag.includes(filter)).forEach(tag => {
                const item = document.createElement('div');
                item.className = 'tag-suggestion-item';
                item.innerHTML = `<span>${tag}</span> <span class="user-count">${tagStats[tag]} —á–µ–ª.</span>`;
                item.onclick = () => addTag(tag);
                suggestionsContainer.appendChild(item);
            });
        }
    }

    async function sendBroadcast(button) {
        await withLoading(button, async () => {
            const message = document.getElementById('broadcastMessage').value.trim();
            const selectedTags = Array.from(document.querySelectorAll('#broadcastTagsContainer .tag'))
                .map(el => el.textContent.replace(' √ó', ''));
            
            if (!message) {
                return UI.showError('–û—à–∏–±–∫–∞', '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
            }

            await API.apiFetch('/api/broadcast', {
                method: 'POST',
                body: JSON.stringify({
                    message: message,
                    tags: selectedTags,
                    senderChatId: Main.appState.telegramUser.id
                })
            }, Main.appState.tg);
            
            UI.showCrmSuccess("–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç!", "–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û—Ç—á–µ—Ç –ø—Ä–∏–¥–µ—Ç –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.");
        });
    }

    async function exportToExcel(button, dataType) {
        await withLoading(button, async () => {
            let data;
            if (dataType === 'orders') {
                const snapshot = await API.db.collection(API.COLLECTIONS.ORDERS)
                    .orderBy('createdAt', 'desc').get();
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } else {
                const snapshot = await API.db.collection(API.COLLECTIONS.USERS)
                    .orderBy('registrationDate', 'desc').get();
                data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            await API.apiFetch(`/api/export-${dataType}`, {
                method: 'POST',
                body: JSON.stringify({ data: data, chatId: Main.appState.telegramUser.id })
            }, Main.appState.tg);

            UI.showCrmSuccess("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!", `Excel-—Ñ–∞–π–ª –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.`);
        });
    }

    function copyPlaceholder(element) {
        const textToCopy = element.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = element.textContent;
            element.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            element.style.background = '#28a745';
            setTimeout(() => {
                element.textContent = originalText;
                element.style.background = '#4a4a4a';
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', () => {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        ['loginPhone', 'phone', 'recipientPhone', 'editPhone'].forEach(UI.setupPhoneMask);
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        setTimeout(() => Main.initializeApp(), 100);
    });

</script> 
</body>
</html>